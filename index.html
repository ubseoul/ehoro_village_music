<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Ehoro Village ‚Äî Lo-Fi Spirits</title>
<meta name="description" content="A cozy lo-fi music companion with spirit collection. Listen, hatch, evolve, and grow your village.">
<meta property="og:title" content="Ehoro Village ‚Äî Lo-Fi Spirits">
<meta property="og:description" content="A cozy lo-fi music companion with spirit collection. Listen, hatch, evolve, and grow your village.">
<meta property="og:image" content="https://ubseoul.github.io/ehoro_village_music/sprites/timi_3.png">
<meta property="og:url" content="https://ubseoul.github.io/ehoro_village_music/">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ehoro Village ‚Äî Lo-Fi Spirits">
<meta name="twitter:description" content="A cozy lo-fi music companion with spirit collection.">
<meta name="twitter:image" content="https://ubseoul.github.io/ehoro_village_music/sprites/timi_3.png">
<link rel="icon" type="image/png" href="sprites/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,300&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
:root{--glass:rgba(12,12,12,.55);--glass-border:rgba(255,255,255,.08);--glass-hover:rgba(255,255,255,.04);--blur:blur(20px);--radius:14px;--radius-sm:10px}
[data-theme="dark"]{--bg:#050505;--surface:rgba(15,15,15,.7);--border:rgba(255,255,255,.06);--border-l:rgba(255,255,255,.12);--t1:#f5f5f5;--t2:#b0b0b0;--t3:#808080;--t4:#505050;--accent-dim:rgba(255,255,255,.04);--accent-soft:rgba(255,255,255,.08);--logo-color:#f5f5f5;--toast-bg:rgba(20,20,20,.9);--positive:#6c9;--negative:#c77;--special:#c8f;--card-bg:rgba(255,255,255,.04);--card-border:rgba(255,255,255,.08)}
[data-theme="light"]{--bg:#f0ede8;--surface:rgba(235,232,226,.75);--border:rgba(0,0,0,.06);--border-l:rgba(0,0,0,.12);--t1:#1a1816;--t2:#5a5650;--t3:#8a857e;--t4:#b0aba4;--accent-dim:rgba(0,0,0,.03);--accent-soft:rgba(0,0,0,.06);--logo-color:#1a1816;--toast-bg:rgba(224,221,214,.9);--positive:#3a7;--negative:#b55;--special:#a6c;--card-bg:rgba(0,0,0,.03);--card-border:rgba(0,0,0,.06);--glass:rgba(240,237,232,.6);--glass-border:rgba(0,0,0,.06)}
*{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;overflow:hidden}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--t1);-webkit-font-smoothing:antialiased;transition:background .4s,color .4s}
/* ONBOARD */
.onboard{position:fixed;inset:0;z-index:200;background:var(--bg);display:flex;align-items:center;justify-content:center;transition:opacity .4s}.onboard.gone{opacity:0;pointer-events:none}

  .ob-inner{width:100%;max-width:380px;padding:0 28px;text-align:center}.ob-icon{width:80px;height:80px;margin:0 auto 16px;border-radius:50%;overflow:hidden}.ob-icon img{width:100%;height:100%;object-fit:cover}
.ob-title{font-family:'Fraunces',serif;font-size:1.6rem;font-weight:500;margin-bottom:8px}.ob-desc{font-size:.85rem;color:var(--t2);line-height:1.5;margin-bottom:28px}
.ob-dots{display:flex;gap:6px;justify-content:center;margin-bottom:24px}.ob-dot{width:8px;height:8px;border-radius:50%;background:var(--t4);transition:all .2s}.ob-dot.on{background:var(--t1);width:20px;border-radius:4px}
.ob-btn{padding:13px 32px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer}.ob-skip{display:block;margin:12px auto 0;background:none;border:none;color:var(--t4);font-family:inherit;font-size:.7rem;cursor:pointer}
/* WELCOME BACK */
.wb-overlay{position:fixed;inset:0;z-index:150;background:var(--bg);display:flex;align-items:center;justify-content:center;transition:opacity .5s}.wb-overlay.gone{opacity:0;pointer-events:none}
.wb-inner{width:100%;max-width:360px;padding:0 28px;text-align:center}
.wb-portrait{width:72px;height:72px;border-radius:50%;overflow:hidden;margin:0 auto 16px;border:2px solid var(--card-border)}.wb-portrait img{width:100%;height:100%;object-fit:cover}
.wb-msg{font-family:'Fraunces',serif;font-size:1.3rem;font-weight:300;font-style:italic;color:var(--t1);margin-bottom:8px;line-height:1.4}
.wb-gains{font-size:.75rem;color:var(--t2);margin-bottom:24px;line-height:1.6}
.wb-btn{padding:13px 32px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer}
/* GUEST BANNER */
.guest-banner{position:fixed;bottom:0;left:0;right:0;z-index:60;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-top:1px solid var(--glass-border);padding:14px 20px;display:flex;align-items:center;justify-content:center;gap:16px;transform:translateY(100%);transition:transform .4s}.guest-banner.show{transform:translateY(0)}
.guest-banner-text{font-size:.8rem;color:var(--t2)}.guest-banner-text b{color:var(--t1)}.guest-banner-btn{padding:8px 20px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer}
/* LOGIN */
.login{position:fixed;inset:0;z-index:100;background:var(--bg);display:flex;align-items:center;justify-content:center;transition:opacity .5s}.login.gone{opacity:0;pointer-events:none}
.login-inner{width:100%;max-width:360px;padding:0 28px}.login-brand{text-align:center;margin-bottom:48px}
.login-brand h1{font-family:'Fraunces',serif;font-size:2rem;font-weight:300;font-style:italic;color:var(--logo-color);margin-bottom:4px}.login-brand .sub{font-size:.6rem;color:var(--t3);letter-spacing:.25em;text-transform:uppercase}
.login-field{margin-bottom:16px}.login-field label{display:block;font-size:.65rem;color:var(--t3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:7px;font-weight:500}
.login-field input{width:100%;background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius-sm);padding:12px 16px;color:var(--t1);font-family:inherit;font-size:.85rem;outline:none}.login-field input:focus{border-color:var(--border-l)}
.l-btn{width:100%;padding:13px;margin-top:8px;background:var(--t1);color:var(--bg);border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer}.l-btn:disabled{opacity:.35}
.l-div{display:flex;align-items:center;gap:14px;margin:22px 0;color:var(--t4);font-size:.6rem;text-transform:uppercase;letter-spacing:.15em}.l-div::before,.l-div::after{content:'';flex:1;height:1px;background:var(--border)}
.l-secondary{width:100%;padding:12px;background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius-sm);color:var(--t2);font-family:inherit;font-size:.85rem;cursor:pointer}.l-secondary:hover{border-color:var(--border-l);color:var(--t1)}
.l-toggle{display:block;text-align:center;margin-top:20px;background:none;border:none;color:var(--t3);font-family:inherit;font-size:.75rem;cursor:pointer;text-decoration:underline;text-underline-offset:3px}
.l-error{color:#e55;font-size:.75rem;text-align:center;margin-top:12px;min-height:18px}.l-error.ok{color:#5b5}
/* SHELL */
.shell{height:100vh;height:100dvh;display:flex;flex-direction:column;opacity:0;transition:opacity .4s .2s;overflow:hidden}.shell.on{opacity:1}
/* TOPBAR */
.topbar{height:48px;min-height:48px;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-bottom:1px solid var(--glass-border);display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:10;flex-shrink:0}
.tb-brand{font-family:'Fraunces',serif;font-size:1.05rem;font-weight:300;font-style:italic;color:var(--logo-color)}
.tb-right{display:flex;align-items:center;gap:10px}
.tb-rank{display:flex;align-items:center;gap:6px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;padding:5px 12px}
.tb-rank-name{font-size:.65rem;font-weight:500}.tb-rank-pts{font-family:'JetBrains Mono',monospace;font-size:.55rem;color:var(--t3)}
.tb-gear{background:none;border:none;color:var(--t2);cursor:pointer;padding:6px;line-height:1;border-radius:6px;display:flex;align-items:center}.tb-gear:hover{color:var(--t1);background:var(--glass-hover)}
.tb-signin{background:none;border:1px solid var(--glass-border);border-radius:6px;padding:4px 12px;color:var(--t2);font-family:inherit;font-size:.65rem;cursor:pointer}.tb-signin:hover{border-color:var(--border-l);color:var(--t1)}
.tb-user{font-size:.7rem;color:var(--t2)}
/* SETTINGS DROP */
.settings-drop{position:fixed;top:52px;right:12px;z-index:40;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:1px solid var(--glass-border);border-radius:var(--radius);padding:8px;min-width:180px;box-shadow:0 8px 32px rgba(0,0,0,.3);opacity:0;transform:translateY(-6px);pointer-events:none;transition:all .2s}.settings-drop.open{opacity:1;transform:translateY(0);pointer-events:all}
.sd-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:.75rem;color:var(--t2);transition:background .1s}.sd-item:hover{background:var(--glass-hover)}.sd-item-label{display:flex;align-items:center;gap:8px}
.sd-toggle{width:34px;height:18px;border-radius:9px;background:var(--border);position:relative;transition:background .2s;cursor:pointer}.sd-toggle.on{background:var(--t2)}.sd-toggle::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:var(--t1);transition:transform .2s}.sd-toggle.on::after{transform:translateX(16px)}.sd-divider{height:1px;background:var(--border);margin:4px 0}
/* CONTENT */
.content{flex:1;display:flex;overflow:hidden;min-height:0}
/* VIDEO */
.video-area{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden;background:#000}
.video-embed{flex:1;position:relative;min-height:0}.video-embed iframe{position:absolute;inset:0;width:100%;height:100%;border:none}
.video-placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;background:var(--bg);cursor:pointer}.video-placeholder:hover{background:var(--surface)}
.vp-play{width:64px;height:64px;border-radius:50%;border:1.5px solid var(--t4);display:flex;align-items:center;justify-content:center;font-size:1.3rem;color:var(--t3)}.vp-text{font-size:.7rem;color:var(--t4);letter-spacing:.15em;text-transform:uppercase}.video-embed.loaded .video-placeholder{display:none}
/* PLAYER STRIP ‚Äî simplified */
.player-strip{height:44px;min-height:44px;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-top:1px solid var(--glass-border);display:flex;align-items:center;padding:0 16px;gap:10px;flex-shrink:0}
.ps-play{width:28px;height:28px;background:var(--t1);color:var(--bg);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.6rem;cursor:pointer;flex-shrink:0}
.ps-info{flex:1;min-width:0}.ps-title{font-size:.7rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.ps-sub{font-size:.5rem;color:var(--positive);display:flex;align-items:center;gap:4px}
.ps-live-dot{width:5px;height:5px;border-radius:50%;background:var(--positive);animation:livePulse 2s infinite}
@keyframes livePulse{0%,100%{opacity:1}50%{opacity:.4}}
/* EGG PROGRESS ‚Äî replaces egg-mini */
.egg-progress{padding:8px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.egg-progress-label{font-size:.55rem;color:var(--t3);flex-shrink:0}.egg-progress-bar{flex:1;height:2px;background:var(--border);border-radius:2px;overflow:hidden}.egg-progress-fill{height:100%;background:var(--t1);border-radius:2px;transition:width .5s linear;width:0%}.egg-progress-time{font-family:'JetBrains Mono',monospace;font-size:.5rem;color:var(--t3);min-width:40px;text-align:right}
/* SIDEBAR */
.sidebar{width:320px;min-width:320px;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-left:1px solid var(--glass-border);display:flex;flex-direction:column;overflow:hidden}
/* TABS */
.tab-nav{display:flex;border-bottom:1px solid var(--border);padding:4px 10px;gap:2px}
.tab-btn{flex:1;padding:7px 0;background:none;border:none;border-radius:8px;color:var(--t3);font-family:inherit;font-size:.6rem;font-weight:500;letter-spacing:.06em;text-transform:uppercase;cursor:pointer}.tab-btn:hover{color:var(--t2);background:var(--glass-hover)}.tab-btn.on{color:var(--t1);background:var(--accent-soft)}
.tab-panels{flex:1;overflow:hidden;position:relative}.tab-panel{position:absolute;inset:0;overflow-y:auto;padding:10px;opacity:0;pointer-events:none;transition:opacity .2s}.tab-panel.on{opacity:1;pointer-events:all}.tab-panel::-webkit-scrollbar{width:3px}.tab-panel::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
/* SPIRIT CARDS */
.spirits-grid{display:flex;flex-direction:column;gap:5px}
.spirits-count{font-size:.5rem;color:var(--t3);text-align:center;padding:8px 0;letter-spacing:.1em}
.spirit-card{display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);cursor:pointer;transition:all .15s}.spirit-card:hover{background:var(--accent-soft);border-color:var(--border-l)}
.spirit-card-img{width:44px;height:44px;border-radius:50%;overflow:hidden;flex-shrink:0;position:relative}
.spirit-card-img img{width:100%;height:100%;object-fit:cover;position:relative;z-index:1}
.spirit-card-img::before{content:'';position:absolute;inset:-3px;border-radius:50%;z-index:0;opacity:0}
/* Shimmer auras */
.spirit-card-img.evo-1::before{opacity:1;background:conic-gradient(from 0deg,transparent,rgba(140,180,255,.3),transparent,rgba(200,220,255,.2),transparent);animation:auraRotate 4s linear infinite}
.spirit-card-img.evo-2::before{opacity:1;background:conic-gradient(from 0deg,transparent,rgba(255,215,140,.35),transparent,rgba(255,240,200,.25),transparent);animation:auraRotate 3s linear infinite}
@keyframes auraRotate{to{transform:rotate(360deg)}}
.spirit-card-info{flex:1;min-width:0}.spirit-card-name{font-size:.75rem;font-weight:600}
.spirit-card-meta{font-size:.55rem;color:var(--t3);margin-top:1px}
/* Shimmer text for evolved labels */
.evo-text-1{background:linear-gradient(90deg,#f5f5f5,#8ab4ff,#f5f5f5);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimText 3s ease infinite}
.evo-text-2{background:linear-gradient(90deg,#f5f5f5,#ffd480,#f5f5f5);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimText 3s ease infinite}
@keyframes shimText{0%{background-position:200% 0}100%{background-position:-200% 0}}
[data-theme="light"] .evo-text-1{background:linear-gradient(90deg,#1a1816,#4477cc,#1a1816);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimText 3s ease infinite}
[data-theme="light"] .evo-text-2{background:linear-gradient(90deg,#1a1816,#cc8800,#1a1816);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimText 3s ease infinite}
.spirit-card-xp{width:100%;height:2px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:3px}.spirit-card-xp-fill{height:100%;background:var(--positive);border-radius:2px;transition:width 1s linear}
.spirit-card-right{display:flex;flex-direction:column;align-items:flex-end;gap:2px}
.spirit-card-dots{display:flex;gap:3px}.spirit-card-dot{width:4px;height:4px;border-radius:50%;background:var(--t4)}.spirit-card-dot.on{background:var(--t1)}
.spirit-card-lvl{font-family:'JetBrains Mono',monospace;font-size:.5rem;color:var(--t3)}
.spirit-empty{text-align:center;padding:24px 16px}.spirit-empty-msg{font-size:.75rem;color:var(--t3);margin-bottom:4px}.spirit-empty-hint{font-size:.6rem;color:var(--t4)}
/* SPIRIT DETAIL */
.spirit-detail{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:14px;margin-top:8px;display:none}.spirit-detail.open{display:block;animation:fadeIn .2s ease-out}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:none}}
.sd-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}.sd-portrait{width:52px;height:52px;border-radius:12px;overflow:hidden;border:1px solid var(--card-border);flex-shrink:0}.sd-portrait img{width:100%;height:100%;object-fit:cover}
.sd-info{flex:1}.sd-name{font-size:.9rem;font-weight:600}.sd-stage{font-size:.55rem;color:var(--t2)}.sd-bio{font-size:.5rem;color:var(--t3);margin-top:2px;font-style:italic;line-height:1.3}
.sd-close{background:none;border:none;color:var(--t4);cursor:pointer;font-size:.8rem;padding:4px;align-self:flex-start}
.sd-section{font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.1em;margin:8px 0 4px;font-weight:500}
.sd-bar-wrap{display:flex;align-items:center;gap:8px}.sd-bar{flex:1;height:3px;background:var(--border);border-radius:3px;overflow:hidden}.sd-bar-fill{height:100%;background:var(--positive);border-radius:3px;transition:width .3s}.sd-lvl{font-family:'JetBrains Mono',monospace;font-size:.55rem;color:var(--t3)}
.trait-tags{display:flex;flex-wrap:wrap;gap:3px}.trait-tag{padding:2px 8px;border-radius:8px;font-size:.5rem;font-weight:500;background:var(--card-bg);color:var(--t2);border:1px solid var(--card-border)}.trait-tag.positive{color:var(--positive);border-color:rgba(102,187,153,.12)}.trait-tag.neutral{color:var(--t3)}
.sd-evolve-btn{width:100%;margin-top:10px;padding:10px;border-radius:var(--radius-sm);border:none;background:var(--t1);color:var(--bg);font-family:inherit;font-size:.7rem;font-weight:600;cursor:pointer}.sd-evolve-btn:disabled{opacity:.15;cursor:not-allowed}.sd-evolve-cost{font-size:.55rem;color:var(--t3);text-align:center;margin-top:4px}
/* ITEMS TAB */
.section-label{font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:6px;margin-top:10px;font-weight:500}.section-label:first-child{margin-top:0}
.hatchery-grid{display:flex;gap:5px;flex-wrap:wrap}
.hatch-slot{flex:1;min-width:50px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:8px 4px;text-align:center;cursor:pointer;transition:all .2s;min-height:65px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px}.hatch-slot:hover{border-color:var(--border-l)}.hatch-slot.locked{opacity:.25;cursor:default}.hatch-slot.unlockable{border-color:var(--special);border-style:dashed;opacity:.7;cursor:pointer}
.hatch-slot.ready{border-color:var(--positive);animation:readyPulse 2s infinite}
.hatch-slot.starter{border-color:var(--positive);animation:starterGlow 1.5s ease-in-out infinite}
@keyframes readyPulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 10px rgba(102,187,153,.12)}}
@keyframes starterGlow{0%,100%{box-shadow:0 0 6px rgba(102,187,153,.1)}50%{box-shadow:0 0 14px rgba(102,187,153,.2)}}
.hatch-slot-icon{font-size:.9rem}.hatch-slot-label{font-size:.45rem;color:var(--t3)}.hatch-slot-timer{font-family:'JetBrains Mono',monospace;font-size:.45rem;color:var(--t3)}.hatch-slot-rarity{font-size:.45rem;font-weight:500}
.hatch-slot-bar{width:80%;height:2px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:2px}.hatch-slot-bar-fill{height:100%;background:var(--t2);border-radius:2px}
.hatch-slot-eggs{font-size:.4rem;color:var(--t3);margin-top:1px}
.ing-grid{display:flex;flex-direction:column;gap:4px}.ing-row{display:flex;align-items:center;gap:8px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:7px 10px}
.ing-icon{font-size:.8rem;flex-shrink:0}.ing-name{font-size:.6rem;color:var(--t2);flex:1}.ing-count{font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:500}
.ing-swap{background:none;border:none;color:var(--t4);cursor:pointer;font-size:.65rem;padding:2px 6px;border-radius:4px}.ing-swap:hover{color:var(--t2);background:var(--glass-hover)}
.pill-grid{display:flex;flex-direction:column;gap:4px}
.pill-row{display:flex;align-items:center;gap:8px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:7px 10px;cursor:pointer;transition:border-color .15s}.pill-row:hover{border-color:var(--border-l)}.pill-row.disabled{opacity:.35;pointer-events:none}
.pill-icon{font-size:.8rem}.pill-info{flex:1}.pill-name{font-size:.6rem;font-weight:500}.pill-desc{font-size:.45rem;color:var(--t3)}.pill-cost{font-size:.45rem;color:var(--t3);white-space:nowrap}
/* VILLAGE */
.village-rank-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:14px;text-align:center;margin-bottom:10px}
.village-rank-label{font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:4px}.village-rank-name{font-family:'Fraunces',serif;font-size:1.2rem;font-weight:500;margin-bottom:2px}.village-rank-desc{font-size:.55rem;color:var(--t2)}
.village-stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:10px}.village-stat{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:8px;text-align:center}
.village-stat-num{font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:500}.village-stat-label{font-size:.45rem;color:var(--t3);text-transform:uppercase;letter-spacing:.05em}
/* TOAST */
.toast{position:fixed;top:56px;left:16px;z-index:50;background:var(--toast-bg);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:1px solid var(--glass-border);border-radius:var(--radius);padding:12px 16px;display:flex;align-items:center;gap:10px;box-shadow:0 12px 40px rgba(0,0,0,.3);opacity:0;transform:translateX(-20px);transition:all .4s cubic-bezier(.34,1.56,.64,1);pointer-events:none}.toast.show{opacity:1;transform:translateX(0)}.toast-icon{font-size:1.2rem}.toast-text{font-size:.8rem;font-weight:500}.toast-sub{font-size:.5rem;color:var(--t3)}
/* MODAL */
.modal-bg{position:fixed;inset:0;z-index:50;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}.modal-bg.open{opacity:1;pointer-events:all}
.modal-box{background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:1px solid var(--glass-border);border-radius:var(--radius);width:90%;max-width:360px;padding:20px;text-align:center;transform:scale(.95);transition:transform .25s;max-height:80vh;overflow-y:auto}.modal-bg.open .modal-box{transform:scale(1)}
.modal-title{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:500;margin-bottom:10px}.modal-desc{font-size:.7rem;color:var(--t2);margin-bottom:12px;line-height:1.5}.modal-desc b{color:var(--t1)}
.modal-btn{padding:10px 20px;border-radius:var(--radius-sm);border:none;background:var(--t1);color:var(--bg);font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;margin:4px}.modal-btn:disabled{opacity:.15}.modal-btn.secondary{background:transparent;border:1px solid var(--glass-border);color:var(--t2)}
.modal-select-grid{display:flex;flex-direction:column;gap:5px;margin:8px 0;text-align:left}.modal-select-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);cursor:pointer}.modal-select-row:hover{border-color:var(--border-l)}
.pp-content{text-align:left;font-size:.65rem;color:var(--t2);line-height:1.6;max-height:60vh;overflow-y:auto}.pp-content h3{font-size:.75rem;color:var(--t1);margin:10px 0 4px}.pp-content p{margin-bottom:8px}
/* HATCH ANIM */
.hatch-overlay{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;opacity:0;pointer-events:none;transition:opacity .4s}.hatch-overlay.show{opacity:1;pointer-events:all}
.hatch-egg-anim{width:120px;height:120px;display:flex;align-items:center;justify-content:center;font-size:4rem;animation:eggShake .3s ease-in-out infinite}
@keyframes eggShake{0%,100%{transform:rotate(0)}25%{transform:rotate(-5deg)}75%{transform:rotate(5deg)}}
.hatch-egg-anim.crack{animation:eggCrack .6s ease-out forwards}
@keyframes eggCrack{0%{transform:scale(1)}30%{transform:scale(1.15)}60%{transform:scale(1.3);opacity:.8}100%{transform:scale(1.6);opacity:0}}
.hatch-reveal{opacity:0;transform:scale(.5);transition:all .6s cubic-bezier(.34,1.56,.64,1)}.hatch-reveal.show{opacity:1;transform:scale(1)}
.hatch-reveal img{width:128px;height:128px;border-radius:50%;border:3px solid var(--t1)}.hatch-reveal-name{font-family:'Fraunces',serif;font-size:1.4rem;margin-top:12px;color:var(--t1)}.hatch-reveal-rarity{font-size:.7rem;margin-top:4px;font-weight:500}.hatch-reveal-tap{font-size:.55rem;color:var(--t4);margin-top:16px}
/* MOBILE */
@media(max-width:768px){
.content{flex-direction:column}
.video-area{flex:none;height:50vh;min-height:220px}
.sidebar{width:100%;min-width:unset;flex:1;border-left:none;border-top:1px solid var(--glass-border);min-height:0}
.player-strip{height:36px;min-height:36px;padding:0 10px;gap:6px}
.ps-play{width:24px;height:24px;font-size:.5rem}
.ps-title{font-size:.65rem}.ps-sub{font-size:.45rem}
.topbar{height:40px;min-height:40px;padding:0 12px}
.tb-brand{font-size:.85rem}
.tb-rank{padding:4px 8px}.tb-rank-name{font-size:.6rem}.tb-rank-pts{font-size:.5rem}
.tab-nav{padding:3px 8px}.tab-btn{padding:6px 0;font-size:.55rem}
.tab-panel{padding:8px}
.egg-progress{padding:6px 10px}
.spirit-card{padding:7px 8px;gap:8px}.spirit-card-img{width:38px;height:38px}.spirit-card-name{font-size:.7rem}.spirit-card-meta{font-size:.5rem}
.spirit-detail{padding:10px}.sd-portrait{width:44px;height:44px}
.hatch-slot{min-height:58px;padding:6px 3px}
.toast{top:44px;left:8px;padding:10px 12px}.toast-icon{font-size:1rem}.toast-text{font-size:.7rem}
.ing-row{padding:6px 8px}.pill-row{padding:6px 8px}
.section-label{font-size:.45rem;margin-bottom:4px}
.village-rank-card{padding:10px}.village-rank-name{font-size:1rem}
.village-stat{padding:6px}.village-stat-num{font-size:.7rem}
.wb-inner{padding:0 20px}.wb-msg{font-size:1.1rem}.wb-portrait{width:60px;height:60px}
}
@media(max-width:420px){.video-area{height:48vh;min-height:200px}}
/* Rank colors on topbar badge */
.tb-rank{transition:border-color .3s}
/* Spirit jiggle */
@keyframes spiritJiggle{0%{transform:rotate(0)}20%{transform:rotate(-3deg)}40%{transform:rotate(3deg)}60%{transform:rotate(-2deg)}80%{transform:rotate(1deg)}100%{transform:rotate(0)}}
.spirit-jiggle img{animation:spiritJiggle .4s ease-in-out}
/* Guest banner entrance */
@keyframes bannerSlideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
.guest-banner.show{animation:bannerSlideUp .6s cubic-bezier(.34,1.56,.64,1) forwards}
/* Craft hint pulse on Items tab */
@keyframes craftHintPulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 8px rgba(102,187,153,.4)}}
.tab-btn.hint{animation:craftHintPulse 2s ease-in-out 3;color:var(--positive)}
/* Spirit arrival overlay */
.spirit-arrival{position:fixed;inset:0;z-index:180;background:var(--bg);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .6s;pointer-events:none}.spirit-arrival.show{opacity:1;pointer-events:all}
.sa-inner{text-align:center;max-width:340px;padding:0 28px}
.sa-portrait{width:100px;height:100px;border-radius:50%;overflow:hidden;margin:0 auto 16px;border:2px solid var(--card-border)}.sa-portrait img{width:100%;height:100%;object-fit:cover}
.sa-name{font-family:'Fraunces',serif;font-size:1.5rem;font-weight:500;margin-bottom:6px}
.sa-bio{font-size:.8rem;color:var(--t2);line-height:1.6;font-style:italic;margin-bottom:24px}
.sa-welcome{font-size:.65rem;color:var(--t3);margin-bottom:20px}
.sa-btn{padding:13px 32px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer}
/* Smoother XP bar transitions */
.spirit-card-xp-fill{transition:width 3s linear}
.sd-bar-fill{transition:width 3s linear}
/* Bio readability */
.sd-bio{color:var(--t2);font-size:.55rem}
/* Patch Notes */
.patch-overlay{position:fixed;inset:0;z-index:160;background:var(--bg);overflow-y:auto;opacity:0;pointer-events:none;transition:opacity .3s}.patch-overlay.show{opacity:1;pointer-events:all}
.patch-inner{max-width:600px;margin:0 auto;padding:24px 20px 60px}
.patch-close{position:fixed;top:12px;right:16px;z-index:161;background:var(--glass);border:1px solid var(--glass-border);border-radius:8px;color:var(--t2);font-size:.8rem;padding:6px 14px;cursor:pointer;font-family:inherit;backdrop-filter:var(--blur)}.patch-close:hover{color:var(--t1)}
.patch-banner{width:100%;border-radius:var(--radius);overflow:hidden;margin-bottom:20px;aspect-ratio:16/7;background:linear-gradient(135deg,#1a1028,#2a1a3a,#1a2030);display:flex;align-items:center;justify-content:center}
.patch-banner-text{font-family:'Fraunces',serif;font-size:1.8rem;font-weight:500;color:#f5f5f5;text-align:center;line-height:1.3}
.patch-banner-sub{font-size:.7rem;color:var(--t3);text-align:center;margin-top:4px}
.patch-author{display:flex;align-items:center;gap:10px;margin-bottom:20px;padding:12px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm)}
.patch-author-img{width:36px;height:36px;border-radius:50%;overflow:hidden}.patch-author-img img{width:100%;height:100%;object-fit:cover}
.patch-author-name{font-size:.75rem;font-weight:600;color:var(--t1)}.patch-author-role{font-size:.5rem;color:var(--t3)}
.patch-date{font-size:.55rem;color:var(--t4);margin-left:auto}
.patch-body{font-size:.8rem;color:var(--t2);line-height:1.8}
.patch-body p{margin-bottom:14px}
.patch-body .patch-heading{font-family:'Fraunces',serif;font-size:1rem;font-weight:500;color:var(--t1);margin:20px 0 8px}
.patch-social{display:flex;gap:8px;margin-top:20px;flex-wrap:wrap}
.patch-social a{padding:8px 16px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;color:var(--t2);font-size:.7rem;text-decoration:none;font-family:inherit}.patch-social a:hover{border-color:var(--border-l);color:var(--t1)}
/* PROFESSOR MOWANG TUTORIAL */
.prof-overlay{position:fixed;inset:0;z-index:190;background:var(--bg);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .5s}.prof-overlay.show{opacity:1;pointer-events:all}
.prof-inner{width:100%;max-width:400px;padding:0 28px;text-align:center}
.prof-portrait{width:88px;height:88px;border-radius:50%;overflow:hidden;margin:0 auto 12px;border:2px solid var(--card-border);position:relative}.prof-portrait img{width:100%;height:100%;object-fit:cover;position:relative;z-index:1}
.prof-portrait::after{content:'';position:absolute;inset:-4px;border-radius:50%;background:conic-gradient(from 0deg,transparent,rgba(255,215,140,.25),transparent,rgba(255,240,200,.15),transparent);animation:auraRotate 3s linear infinite;z-index:0}
.prof-name{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:500;color:var(--t1);margin-bottom:2px}
.prof-role{font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.15em;margin-bottom:16px}
.prof-bubble{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:16px 18px;margin-bottom:20px;text-align:left;position:relative}
.prof-bubble::before{content:'';position:absolute;top:-6px;left:50%;transform:translateX(-50%) rotate(45deg);width:12px;height:12px;background:var(--card-bg);border-left:1px solid var(--card-border);border-top:1px solid var(--card-border)}
.prof-bubble-text{font-size:.8rem;color:var(--t2);line-height:1.65}.prof-bubble-text b{color:var(--t1);font-weight:600}.prof-bubble-text .prof-highlight{color:var(--positive);font-weight:500}
.prof-dots{display:flex;gap:6px;justify-content:center;margin-bottom:18px}.prof-dot{width:8px;height:8px;border-radius:50%;background:var(--t4);transition:all .25s}.prof-dot.on{background:var(--t1);width:20px;border-radius:4px}
.prof-btn{padding:13px 32px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer;transition:transform .1s}.prof-btn:active{transform:scale(.97)}
.prof-skip{display:block;margin:10px auto 0;background:none;border:none;color:var(--t4);font-family:inherit;font-size:.65rem;cursor:pointer}
.prof-spirit-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0}
.prof-spirit-pick{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 4px;background:var(--card-bg);border:2px solid var(--card-border);border-radius:var(--radius-sm);cursor:pointer;transition:all .2s}
.prof-spirit-pick:hover{border-color:var(--border-l);background:var(--accent-soft)}
.prof-spirit-pick.selected{border-color:var(--positive);background:rgba(102,187,153,.08)}
.prof-spirit-pick img{width:48px;height:48px;border-radius:50%;object-fit:cover}
.prof-spirit-pick-name{font-size:.6rem;font-weight:600;color:var(--t1)}
.prof-spirit-pick-bio{font-size:.4rem;color:var(--t3);line-height:1.3;max-height:0;overflow:hidden;transition:max-height .3s}
.prof-spirit-pick.selected .prof-spirit-pick-bio{max-height:40px;margin-top:2px}
@media(max-width:768px){.prof-inner{padding:0 20px}.prof-portrait{width:72px;height:72px}.prof-bubble-text{font-size:.75rem}.prof-spirit-grid{gap:6px}.prof-spirit-pick img{width:40px;height:40px}}
/* ‚ïê‚ïê‚ïê EXPEDITIONS ‚ïê‚ïê‚ïê */
.exped-section{margin-top:14px}
.exped-slot{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:10px;margin-bottom:6px;position:relative}
.exped-slot.locked{opacity:.3;pointer-events:none}
.exped-slot-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.exped-slot-title{font-size:.6rem;font-weight:500;color:var(--t2)}
.exped-slot-status{font-size:.5rem;color:var(--t3)}
.exped-spirits{display:flex;gap:4px;margin-bottom:6px}
.exped-spirit-img{width:28px;height:28px;border-radius:50%;overflow:hidden;border:1px solid var(--card-border)}.exped-spirit-img img{width:100%;height:100%;object-fit:cover}
.exped-bar{width:100%;height:3px;background:var(--border);border-radius:3px;overflow:hidden;margin-bottom:4px}
.exped-bar-fill{height:100%;border-radius:3px;transition:width 1s linear}
.exped-bar-fill.active{background:var(--positive)}
.exped-bar-fill.resting{background:var(--special)}
.exped-timer{font-family:'JetBrains Mono',monospace;font-size:.5rem;color:var(--t3);text-align:center}
.exped-btn{width:100%;padding:8px;border-radius:var(--radius-sm);border:none;background:var(--t1);color:var(--bg);font-family:inherit;font-size:.6rem;font-weight:600;cursor:pointer}.exped-btn:disabled{opacity:.15;cursor:not-allowed}
.exped-btn.claim{background:var(--positive);color:#050505;animation:readyPulse 2s infinite}
.exped-btn.secondary{background:transparent;border:1px solid var(--glass-border);color:var(--t2)}
/* Expedition send modal */
.exped-dur-grid{display:flex;gap:6px;margin:10px 0}
.exped-dur-opt{flex:1;padding:10px 6px;background:var(--card-bg);border:2px solid var(--card-border);border-radius:var(--radius-sm);cursor:pointer;text-align:center;transition:all .2s}
.exped-dur-opt:hover{border-color:var(--border-l)}
.exped-dur-opt.selected{border-color:var(--positive);background:rgba(102,187,153,.08)}
.exped-dur-label{font-size:.6rem;font-weight:600;color:var(--t1)}.exped-dur-time{font-size:.45rem;color:var(--t3)}
.exped-spirit-select{display:flex;flex-wrap:wrap;gap:5px;margin:8px 0;max-height:200px;overflow-y:auto}
.exped-spirit-opt{display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--card-bg);border:2px solid var(--card-border);border-radius:var(--radius-sm);cursor:pointer;transition:all .15s;width:100%}
.exped-spirit-opt:hover{border-color:var(--border-l)}
.exped-spirit-opt.selected{border-color:var(--positive);background:rgba(102,187,153,.06)}
.exped-spirit-opt.unavailable{opacity:.3;pointer-events:none}
.exped-spirit-opt img{width:28px;height:28px;border-radius:50%;object-fit:cover}
.exped-spirit-opt-info{flex:1;min-width:0}
.exped-spirit-opt-name{font-size:.6rem;font-weight:500}.exped-spirit-opt-lvl{font-size:.45rem;color:var(--t3)}
.exped-spirit-opt-check{width:14px;height:14px;border-radius:50%;border:1.5px solid var(--t4);display:flex;align-items:center;justify-content:center;font-size:.5rem;color:var(--positive);flex-shrink:0}
.exped-spirit-opt.selected .exped-spirit-opt-check{border-color:var(--positive);background:rgba(102,187,153,.15)}
/* On-expedition indicator on spirit cards */
.spirit-card.on-expedition{opacity:.55}.spirit-card.on-expedition::after{content:'üß≠';position:absolute;top:6px;right:8px;font-size:.55rem}
.spirit-card{position:relative}
/* ‚ïê‚ïê‚ïê CULTIVATION STAGE (Spirit Detail) ‚ïê‚ïê‚ïê */
.sd-cult-stage{display:flex;align-items:center;gap:6px;margin:4px 0}
.sd-cult-label{font-size:.55rem;color:var(--t2);font-weight:500}
.sd-cult-dots{display:flex;gap:3px}
.sd-cult-dot{width:6px;height:6px;border-radius:50%;background:var(--t4);transition:all .3s}
.sd-cult-dot.on{background:var(--special);box-shadow:0 0 4px rgba(200,136,255,.3)}
.sd-cult-advance{width:100%;margin-top:6px;padding:8px;border-radius:var(--radius-sm);border:1px solid rgba(200,136,255,.2);background:rgba(200,136,255,.06);color:var(--special);font-family:inherit;font-size:.6rem;font-weight:600;cursor:pointer}.sd-cult-advance:disabled{opacity:.15;cursor:not-allowed}
.sd-cult-cost{font-size:.5rem;color:var(--t3);text-align:center;margin-top:3px}
/* √Ä·π£·∫π ingredient row highlight */
.ing-row.rare{border-color:rgba(200,136,255,.15);background:rgba(200,136,255,.04)}
/* ‚ïê‚ïê‚ïê V1.5 SESSION 7 ‚Äî new styles below ‚ïê‚ïê‚ïê */
/* Reconnecting overlay */
.reconnect-overlay{position:fixed;inset:0;z-index:250;background:var(--bg);display:flex;align-items:center;justify-content:center;transition:opacity .4s}
.reconnect-overlay.gone{opacity:0;pointer-events:none}
.reconnect-inner{text-align:center;padding:0 28px}
.reconnect-icon{font-size:2.5rem;margin-bottom:12px;animation:reconnectSpin 1.5s linear infinite}
@keyframes reconnectSpin{to{transform:rotate(360deg)}}
.reconnect-title{font-family:'Fraunces',serif;font-size:1.3rem;font-weight:500;margin-bottom:6px}
.reconnect-sub{font-size:.7rem;color:var(--t3)}
/* Hatch share button */
.hatch-share-btn{display:inline-block;margin-top:12px;padding:8px 18px;background:var(--glass);border:1px solid var(--glass-border);border-radius:8px;color:var(--t2);font-family:inherit;font-size:.65rem;cursor:pointer;transition:all .2s}
.hatch-share-btn:hover{border-color:var(--border-l);color:var(--t1)}
.hatch-share-btn.copied{color:var(--positive);border-color:rgba(102,187,153,.3)}
/* YouTube fallback */
.yt-fallback{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;background:var(--bg)}
.yt-fallback-msg{font-size:.75rem;color:var(--t3);text-align:center;line-height:1.5}
.yt-fallback-btn{padding:10px 22px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer}
/* Disabled button feedback */
button.action-busy{opacity:.5;pointer-events:none}
/* Empty state action buttons */
.empty-action{padding:8px 16px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;color:var(--t2);font-family:inherit;font-size:.65rem;cursor:pointer;margin-top:8px;transition:all .15s}
.empty-action:hover{border-color:var(--border-l);color:var(--t1)}
/* Mobile touch targets ‚Äî min 44px */
@media(max-width:768px){
  .spirit-card{min-height:52px}
  .hatch-slot{min-height:62px;min-width:54px}
  .pill-row{min-height:44px;padding:8px 10px}
  .ing-row{min-height:44px}
  .ing-swap{min-width:32px;min-height:32px;display:flex;align-items:center;justify-content:center}
  .exped-btn{min-height:40px}
  .sd-evolve-btn{min-height:44px}
  .sd-cult-advance{min-height:40px}
  .modal-btn{min-height:44px}
  .modal-select-row{min-height:44px}
  .tab-btn{min-height:36px}
}
/* Trait effect indicator */
.trait-tag.has-effect{position:relative}.trait-tag.has-effect::after{content:'‚ú¶';margin-left:3px;font-size:.4rem;opacity:.6}

</style>
</head>
<body>

<div class="onboard gone" id="onboard"><div class="ob-inner"><div class="ob-icon" id="obIcon"></div><div class="ob-title" id="obTitle"></div><div class="ob-desc" id="obDesc"></div><div class="ob-dots"><div class="ob-dot on" id="obD0"></div><div class="ob-dot" id="obD1"></div><div class="ob-dot" id="obD2"></div></div><button class="ob-btn" id="obBtn" onclick="nextOnboard()">Next</button><button class="ob-skip" onclick="finishOnboard()">Skip</button></div></div>

<div class="wb-overlay gone" id="welcomeBack"><div class="wb-inner"><div class="wb-portrait" id="wbPortrait"></div><div class="wb-msg" id="wbMsg"></div><div class="wb-gains" id="wbGains"></div><button class="wb-btn" onclick="dismissWB()">Enter Village</button></div></div>
<div class="guest-banner" id="guestBanner"><span class="guest-banner-text"><b>Create an Account</b> for a free spirit and newbie pack!</span><button class="guest-banner-btn" onclick="showLogin()">Sign Up</button></div>
<div class="toast" id="toast"><div class="toast-icon" id="toastI"></div><div><div class="toast-text" id="toastT"></div><div class="toast-sub" id="toastS"></div></div></div>
<div class="modal-bg" id="modal" onclick="if(event.target===this)closeModal()"><div class="modal-box" id="modalBox"></div></div>
<div class="hatch-overlay" id="hatchOverlay" onclick="closeHatchAnim()"><div class="hatch-egg-anim" id="hatchEgg">&#x1F95A;</div><div class="hatch-reveal" id="hatchReveal"><img id="hatchImg" src=""><div class="hatch-reveal-name" id="hatchName"></div><div class="hatch-reveal-rarity" id="hatchRarity"></div><div class="hatch-share-btn" id="hatchShare" onclick="event.stopPropagation();shareHatch()">üìã Share</div><div class="hatch-reveal-tap">tap anywhere to continue</div></div></div>
<div class="reconnect-overlay gone" id="reconnectOverlay"><div class="reconnect-inner"><div class="reconnect-icon">üîÑ</div><div class="reconnect-title">Reconnecting‚Ä¶</div><div class="reconnect-sub" id="reconnectMsg">Trying to reach Ehoro Village servers</div></div></div>
<div class="spirit-arrival" id="spiritArrival"><div class="sa-inner"><div class="sa-portrait" id="saPortrait"></div><div class="sa-name" id="saName"></div><div class="sa-bio" id="saBio"></div><div class="sa-welcome" id="saWelcome">found their way to your village</div><button class="sa-btn" onclick="dismissSpiritArrival()">Welcome Home</button></div></div>
<div class="prof-overlay" id="profOverlay"><div class="prof-inner"><div class="prof-portrait"><img src="sprites/mowang_3.png"></div><div class="prof-name">Professor Mowang</div><div class="prof-role">Village Elder</div><div class="prof-bubble"><div class="prof-bubble-text" id="profText"></div></div><div id="profExtra"></div><div class="prof-dots" id="profDots"></div><button class="prof-btn" id="profBtn" onclick="nextProfStep()">Next</button><button class="prof-skip" onclick="finishProf()">Skip tutorial</button></div></div>
<div class="settings-drop" id="settingsDrop"><div class="sd-item" onclick="toggleTheme()"><span class="sd-item-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg> Theme</span><div class="sd-toggle" id="themeToggle"></div></div><div class="sd-divider"></div><div class="sd-item" onclick="showPrivacy()"><span class="sd-item-label">Privacy</span></div><div class="sd-divider"></div><div class="sd-item" onclick="showPatchNotes()"><span class="sd-item-label">Patch Notes</span></div><div class="sd-divider sdLogoutDiv"></div><div class="sd-item sdLogoutItem" onclick="doLogout()"><span class="sd-item-label">Logout</span></div></div>
<div class="patch-overlay" id="patchNotes"><button class="patch-close" onclick="closePatchNotes()">‚úï Close</button><div class="patch-inner">
<div class="patch-banner"><div><div class="patch-banner-text">Ehoro Village<br>Patch V1.5</div><div class="patch-banner-sub">Launch Day</div></div></div>
<div class="patch-author"><div class="patch-author-img"><img src="sprites/mowang_3.png"></div><div><div class="patch-author-name">Purple Prince</div><div class="patch-author-role">Lead Designer</div></div><span class="patch-date">February 2026</span></div>
<div class="patch-body">
<p>Hello villagers! We've been polishing every corner of Ehoro Village for this launch, and I'm thrilled to finally open the gates wide.</p>
<div class="patch-heading">What's New in V1.5</div>
<p><b>Expeditions</b> ‚Äî Send your spirits on timed journeys to gather materials and earn bonus XP. Short, Medium, and Long expeditions offer different rewards, and longer ones have a rare chance to drop √Ä·π£·∫π Essence.</p>
<p><b>Spirit Cultivation</b> ‚Äî A brand new xianxia-inspired progression system. Spend √Ä·π£·∫π Essence to advance your spirits through cultivation stages from Unrefined all the way to Spirit Sovereign.</p>
<p><b>Professor Mowang's Tutorial</b> ‚Äî New villagers are now greeted by Professor Mowang, the village elder, who walks them through everything and lets them pick their very first companion spirit.</p>
<div class="patch-heading">Launch Polish</div>
<p>This patch is all about reliability. We've hardened network error handling, added a reconnecting overlay, made buttons feel snappier with optimistic UI, and ensured timers work properly even when you switch tabs or come back from the background.</p>
<p>Traits now have gameplay effects ‚Äî Focused spirits gain bonus XP from active cultivation, and Wild spirits bring back extra materials from expeditions. More trait effects are coming soon.</p>
<div class="patch-heading">What's Next</div>
<p>We're working on our own lo-fi stream, more spirit types, deeper social features, and cosmetic customization. The village is just getting started.</p>
<p>Thank you for being here from the beginning. Take care of your spirits!</p>
<p style="color:var(--t3);font-style:italic">‚Äî Purple Prince</p>
</div>
<div class="patch-social"><a href="https://www.instagram.com/ehorovillage?igsh=cTBuaGpoaWVpdXQy&utm_source=qr" target="_blank">Instagram</a><a href="https://x.com/purpleprinceev?s=21" target="_blank">X (Twitter)</a><a href="https://www.facebook.com/share/1DGDwJyMcN/?mibextid=wwXIfr" target="_blank">Facebook</a></div>
</div></div>
<div class="login gone" id="login"><div class="login-inner"><div class="login-brand"><h1>Ehoro Village</h1><p class="sub">lo-fi &middot; spirits &middot; cultivate</p></div><div class="login-field" id="usernameField" style="display:none"><label>Username</label><input type="text" id="inUser" placeholder="pick a username"></div><div class="login-field"><label>Email</label><input type="email" id="inEmail" placeholder="you@email.com"></div><div class="login-field"><label>Password</label><input type="password" id="inPass" placeholder="&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;" minlength="6"></div><button class="l-btn" id="authBtn" onclick="doAuth()">Sign In</button><div class="l-error" id="authError"></div><div class="l-div">or</div><button class="l-secondary" onclick="doGoogleAuth()" style="display:flex;align-items:center;justify-content:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18A11.96 11.96 0 0 0 0 12c0 1.94.46 3.77 1.28 5.4l3.56-2.77.01-.54z" fill="#FBBC05"/><path d="M12 4.75c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 1.09 14.97 0 12 0 7.7 0 3.99 2.47 2.18 6.07l3.66 2.84c.87-2.6 3.3-4.16 6.16-4.16z" fill="#EA4335"/></svg> Continue with Google</button><button class="l-secondary" onclick="enterGuest()" style="margin-top:8px">Watch as Guest</button><button class="l-toggle" id="authToggle" onclick="toggleAuthMode()">Need an account? Sign up</button></div></div>
<div class="shell on" id="shell">
<div class="topbar"><div class="tb-brand">Ehoro Village</div><div class="tb-right"><div class="tb-rank"><span class="tb-rank-name" id="tbRankName">Ember</span><span class="tb-rank-pts" id="tbRankPts">0 prestige</span></div><button class="tb-gear" onclick="toggleSettings()" title="Settings"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></button><div id="tbAuth"><button class="tb-signin" onclick="showLogin()">Sign In</button></div></div></div>
<div class="content">
<div class="video-area"><div class="video-embed" id="videoEmbed"><div class="video-placeholder" id="videoPlaceholder" onclick="startStream()"><div class="vp-play">&#x25B6;</div><div class="vp-text">Start Lo-Fi Stream</div></div></div><div class="player-strip"><button class="ps-play" id="psPlay" onclick="startStream()">&#x25B6;</button><div class="ps-info"><div class="ps-title">Lofi Girl</div><div class="ps-sub"><span class="ps-live-dot"></span> live</div></div></div></div>
<div class="sidebar"><div class="egg-progress"><span class="egg-progress-label">Next egg</span><div class="egg-progress-bar"><div class="egg-progress-fill" id="eggFill"></div></div><span class="egg-progress-time" id="eggTimer">&mdash;</span></div><div class="tab-nav"><button class="tab-btn on" data-tab="spirits" onclick="switchTab(this)">Spirits</button><button class="tab-btn" data-tab="items" onclick="switchTab(this)">Items</button><button class="tab-btn" data-tab="village" onclick="switchTab(this)">Village</button></div><div class="tab-panels"><div class="tab-panel on" id="tab-spirits"></div><div class="tab-panel" id="tab-items"></div><div class="tab-panel" id="tab-village"></div></div></div>
</div></div>

<script>
const SUPABASE_URL='https://eyqddqtlgthgkiqjavyx.supabase.co';
const SUPABASE_ANON_KEY='sb_publishable_CsTLSJj1YwgiHMxUTa685Q_2TVvZa2Q';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{auth:{autoRefreshToken:true,persistSession:true,detectSessionInUrl:true}});
// Utility: wrap any promise with a timeout to prevent hangs (especially on mobile with ad blockers)
function withTimeout(promise,ms=8000){return Promise.race([promise,new Promise((_,reject)=>setTimeout(()=>reject(new Error('Request timed out ‚Äî check your connection or disable ad blockers for this site')),ms))])}
// Detect if Supabase is being blocked
let _supabaseBlocked=false;
async function checkSupabaseConnectivity(){try{const r=await fetch(SUPABASE_URL+'/rest/v1/',{method:'HEAD',headers:{'apikey':SUPABASE_ANON_KEY}});_supabaseBlocked=!r.ok}catch(e){_supabaseBlocked=true}if(_supabaseBlocked)console.warn('‚ö†Ô∏è Supabase appears blocked (ad blocker?). Some features may not work.')}
checkSupabaseConnectivity();
const STREAM_YT='jfKfPfyJRdk';
const STREAM_YT_FALLBACK='5qap5aO4i9A'; // Lofi Girl backup playlist
const RARITY_COLORS={mundane:'#888',adept:'#8ab',refined:'#7a7',illustrious:'#ba8',sovereign:'#a8c',celestial:'#8cf',transcendent:'#fc8',mysterious:'#c8f',ancestral:'#f88',paradox:'#fff'};
const INCUB_MINS={mundane:3,adept:7,refined:14,illustrious:20,sovereign:30,celestial:45,transcendent:60,mysterious:90,ancestral:90,paradox:90};
const VILLAGE_RANKS=[{name:'Ember',min:0,desc:'Your village is a spark.',color:'#a08070'},{name:'Stone',min:50,desc:'Solid foundation.',color:'#909090'},{name:'Bronze',min:150,desc:'A real village.',color:'#cd8c52'},{name:'Silver',min:400,desc:'Respected.',color:'#b8c0cc'},{name:'Gold',min:800,desc:'Prosperous.',color:'#d4a843'},{name:'Emerald',min:1500,desc:'A beacon.',color:'#4cba8a'},{name:'Celestial',min:3000,desc:'Transcendent.',color:'#7cb8f0'}];
const SLOT_UNLOCK={3:50,4:150,5:400};
const SPIRIT_DATA={timi:{name:'Timi',bio:'Pulled into the spirit realm by a terrible accident. Curious and restless, she believes there\'s more to Ehoro Village than meets the eye.',img:['sprites/timi_1.png','sprites/timi_2.png','sprites/timi_3.png']},bayo:{name:'Bayo',bio:'Arrived after a life behind glass at the zoo. Shy but deeply intelligent, he\'s learning what it means to be free.',img:['sprites/bayo_1.png','sprites/bayo_2.png','sprites/bayo_3.png']},mowang:{name:'Mowang',bio:'Banished by a foolish adventurer, Mowang harbors fierce ambition for gleaming steel.',img:['sprites/mowang_1.png','sprites/mowang_2.png','sprites/mowang_3.png']},florita:{name:'Florita',bio:'Forgotten by accident, she drifted quietly into the spirit realm. Her old owner loved pink, but Florita always felt different on the inside.',img:['sprites/florita_1.png','sprites/florita_2.png','sprites/florita_3.png']},simi:{name:'Simi',bio:'One wrong piece of cheese sent him tumbling into the spirit realm. Endlessly cheerful, he came to Ehoro Village sure he\'d find a world full of friends.',img:['sprites/simi_1.png','sprites/simi_2.png','sprites/simi_3.png']},basu_basu:{name:'Basu Basu',bio:'Felt empty for a long time before finding his way to the village. He hopes that making new friends will finally make him feel whole again.',img:['sprites/basu_basu_1.png','sprites/basu_basu_2.png','sprites/basu_basu_3.png']}};
const TYPE_MAP={fox_lavender:'timi',fox_fire:'timi',panda:'bayo',slime:'mowang',timi:'timi',bayo:'bayo',mowang:'mowang',florita:'florita',simi:'simi',basu_basu:'basu_basu'};
function spiritKey(t){return TYPE_MAP[t]||t}
function spiritImg(t,s){const k=spiritKey(t),d=SPIRIT_DATA[k];return d?d.img[Math.min(s,2)]:'sprites/timi_1.png'}
function spiritName(t){return SPIRIT_DATA[spiritKey(t)]?.name||t}
function spiritBio(t){return SPIRIT_DATA[spiritKey(t)]?.bio||''}
const EVO_LABELS=['Seedling','Awakened','Ascended'];
const CULT_STAGES=['Unrefined','Qi Condensation','Foundation','Core Formation','Nascent Soul','Spirit Sovereign'];
const CULT_COSTS=[3,8,15,25,40]; // √Ä·π£·∫π Essence cost per advancement
const CULT_LVL_REQ=[3,6,10,15,20]; // Min spirit level per advancement
const EXPED_CONFIG={short:{label:'Short',minutes:10,restMinutes:3,baseMats:[2,4],bonusXp:5,asheChance:0},medium:{label:'Medium',minutes:20,restMinutes:5,baseMats:[4,8],bonusXp:10,asheChance:0.02},long:{label:'Long',minutes:45,restMinutes:10,baseMats:[8,14],bonusXp:20,asheChance:0.05}};
const EXPED_SLOT_UNLOCK={2:400}; // Slot 2 unlocks at Silver (400 prestige)
const WB_MESSAGES=['The village rested while you were away...','Your spirits kept watch in the quiet hours...','The lo-fi played on while you were gone...','A gentle hum welcomes you home...','The spirits sensed your return...'];

let S={user:null,profile:null,spirits:[],traits:{},emblems:{cafe_bean:0,wild_essence:0,focus_shard:0,ashe_essence:0},hatchery:[],pendingEggs:[],allEggs:[],pillRecipes:[],expeditions:[],playing:false,eggT:0,eggAnchor:null,EGG_SEC:3600,FIRST_EGG_SEC:240,GUEST_EGG_SEC:30,sessionId:null,sessionStartedAt:null,ticker:null,hatchTicker:null,cultTicker:null,jiggleTicker:null,expedTicker:null,authMode:'login',isGuest:true,guestEggGiven:false,theme:'dark',obStep:0,settingsOpen:false,selectedSpirit:null,firstIngredientGiven:false,craftHintShown:false,wbTimer:null,profStep:0,chosenStarter:null};

// ‚ïê‚ïê‚ïê DEBOUNCE FLAGS ‚Äî prevent double-clicks ‚ïê‚ïê‚ïê
let _busy={};
function setBusy(key,ms){_busy[key]=true;setTimeout(()=>{_busy[key]=false},ms||3000)}
function isBusy(key){return !!_busy[key]}

// ‚ïê‚ïê‚ïê TRAIT EFFECTS CONFIG ‚Äî minimal gameplay impact ‚ïê‚ïê‚ïê
const TRAIT_EFFECTS={
  'Focused':{type:'xp_bonus',value:0.10,desc:'+10% active cultivation XP'},
  'Studious':{type:'xp_bonus',value:0.05,desc:'+5% pill XP'},
  'Wild':{type:'exped_bonus_mats',value:0.15,desc:'+15% expedition materials'},
  'Adventurous':{type:'exped_bonus_mats',value:0.10,desc:'+10% expedition materials'},
  'Resilient':{type:'rest_reduction',value:0.20,desc:'-20% expedition rest time'},
  'Calm':{type:'passive_xp_bonus',value:0.15,desc:'+15% passive XP'},
  'Gentle':{type:'hatch_speed',value:0.05,desc:'-5% hatch time'}
};
function spiritHasTraitEffect(spiritId,effectType){
  const tr=S.traits[spiritId]||[];
  return tr.some(t=>TRAIT_EFFECTS[t.trait_name]?.type===effectType);
}
function spiritTraitBonus(spiritId,effectType){
  const tr=S.traits[spiritId]||[];
  let bonus=0;
  tr.forEach(t=>{const eff=TRAIT_EFFECTS[t.trait_name];if(eff&&eff.type===effectType)bonus+=eff.value});
  return bonus;
}

// ‚ïê‚ïê‚ïê ONBOARDING (legacy ‚Äî kept for old refs) ‚ïê‚ïê‚ïê
function showGiftToastIfClaimed(){if(S.isGuest||!S.profile?.newbie_gift_claimed)return;const key='gift_toast_shown_'+S.user.id;if(localStorage.getItem(key))return;showToast('gift');localStorage.setItem(key,'1')}

// ‚ïê‚ïê‚ïê PROFESSOR MOWANG TUTORIAL ‚ïê‚ïê‚ïê
const PROF_STEPS=[
{text:'Welcome to <b>Ehoro Village</b>! I\'m <b>Professor Mowang</b>, the village elder. I arrived here long ago as a humble slime, but this village changed me. Let me show you how things work around here.'},
{text:'In this village, <b>spirits</b> are your companions. Each one has a unique personality and story. They grow alongside you ‚Äî the more time you spend here, the stronger they become. You don\'t need to do anything special. Just <span class="prof-highlight">be present</span>.'},
{text:'While you listen to lo-fi music, <b>eggs</b> will drop over time. Place them in your <b>hatchery</b> and they\'ll incubate on their own ‚Äî even when you\'re away. When they\'re ready, hatch them to discover new spirits!'},
{text:'As your spirits grow, they gain <b>spirit levels</b>. You\'ll also collect <b>ingredients</b> ‚Äî Caf√© Beans ‚òï, Wild Essence üåø, and Focus Shards ‚ö°. Use these to craft <b>spirit pills</b> that boost your spirits\' XP. Later, you can send spirits on <b>expeditions</b> to gather even rarer materials.'},
{text:'When a spirit reaches the right level and you have enough ingredients, you can <b>evolve</b> them into a stronger form. Stage 1 at Level 3, Stage 2 at Level 5. Each evolution unlocks new traits and transforms their appearance.'},
{text:'Now then ‚Äî every new villager gets to choose their <b>first spirit companion</b>. Take your time. Each one is special.',extra:'picker'},
{text:'Excellent choice! Your starter spirit, your first ingredients, and your first egg are all ready. The village awaits you. Remember ‚Äî <span class="prof-highlight">just be here</span>. That\'s all your spirits need.',extra:'final'}
];
function showProfTutorial(){S.profStep=0;S.chosenStarter=null;renderProfStep();document.getElementById('profOverlay').classList.add('show')}
function renderProfStep(){
  const step=PROF_STEPS[S.profStep],total=PROF_STEPS.length;
  document.getElementById('profText').innerHTML=step.text;
  let dots='';for(let i=0;i<total;i++)dots+='<div class="prof-dot'+(i===S.profStep?' on':'')+'"></div>';
  document.getElementById('profDots').innerHTML=dots;
  const extra=document.getElementById('profExtra');
  if(step.extra==='picker'){
    const types=['timi','bayo','mowang','florita','simi','basu_basu'];
    let grid='<div class="prof-spirit-grid">';
    types.forEach(t=>{const d=SPIRIT_DATA[t];grid+='<div class="prof-spirit-pick'+(S.chosenStarter===t?' selected':'')+'" onclick="pickStarter(\''+t+'\')" id="profPick_'+t+'"><img src="'+d.img[0]+'"><div class="prof-spirit-pick-name">'+d.name+'</div><div class="prof-spirit-pick-bio">'+d.bio.slice(0,60)+'...</div></div>'});
    grid+='</div>';extra.innerHTML=grid;
    document.getElementById('profBtn').textContent=S.chosenStarter?'Choose '+SPIRIT_DATA[S.chosenStarter].name:'Pick a spirit';
    document.getElementById('profBtn').disabled=!S.chosenStarter;
  }else if(step.extra==='final'){
    extra.innerHTML='';document.getElementById('profBtn').textContent='Enter the Village';document.getElementById('profBtn').disabled=false;
  }else{
    extra.innerHTML='';document.getElementById('profBtn').textContent='Next';document.getElementById('profBtn').disabled=false;
  }
}
function pickStarter(type){
  S.chosenStarter=type;
  document.querySelectorAll('.prof-spirit-pick').forEach(el=>el.classList.remove('selected'));
  const el=document.getElementById('profPick_'+type);if(el)el.classList.add('selected');
  document.getElementById('profBtn').textContent='Choose '+SPIRIT_DATA[type].name;
  document.getElementById('profBtn').disabled=false;
  const d=SPIRIT_DATA[type];
  document.getElementById('profText').innerHTML='Now then ‚Äî every new villager gets to choose their <b>first spirit companion</b>. Take your time. Each one is special.<br><br><b>'+d.name+'</b> ‚Äî <i>'+d.bio+'</i>';
}
async function nextProfStep(){
  const step=PROF_STEPS[S.profStep];
  if(step.extra==='picker'&&!S.chosenStarter)return;
  if(step.extra==='final'||S.profStep>=PROF_STEPS.length-1){finishProf();return}
  S.profStep++;renderProfStep();
}
async function finishProf(){
  document.getElementById('profOverlay').classList.remove('show');
  if(!S.isGuest&&S.user){
    const uid=S.user.id;
    // 1) Mark onboarding complete
    try{await sb.from('profiles').update({onboarding_done:true}).eq('id',uid)}catch(e){console.warn('finishProf: onboarding update failed',e)}
    if(S.profile)S.profile.onboarding_done=true;
    // 2) Grant chosen starter spirit ‚Äî multi-attempt with retries
    const pick=S.chosenStarter||['timi','bayo','mowang','florita','simi','basu_basu'][Math.floor(Math.random()*6)];
    const d=SPIRIT_DATA[pick];
    const{data:existing}=await sb.from('spirits').select('id').eq('user_id',uid);
    let spiritCreated=!!(existing&&existing.length>0);
    if(!spiritCreated){
      // Attempt 1: direct insert
      try{
        const{error:e1}=await withTimeout(sb.from('spirits').insert({user_id:uid,spirit_type:pick,name:d?.name||pick,evo_stage:0,xp:0}),6000);
        if(!e1)spiritCreated=true;
        else console.warn('finishProf: insert attempt 1 failed',e1);
      }catch(e){console.warn('finishProf: insert attempt 1 exception',e.message)}
      // Attempt 2: delay + retry
      if(!spiritCreated){
        await new Promise(r=>setTimeout(r,1500));
        try{
          const{error:e2}=await withTimeout(sb.from('spirits').insert({user_id:uid,spirit_type:pick,name:d?.name||pick,evo_stage:0,xp:0}),6000);
          if(!e2)spiritCreated=true;
          else console.warn('finishProf: insert attempt 2 failed',e2);
        }catch(e){console.warn('finishProf: insert attempt 2 exception',e.message)}
      }
      // Attempt 3: RPC (no params ‚Äî picks random spirit)
      if(!spiritCreated){
        try{
          const{data:rpcData,error:rpcErr}=await withTimeout(sb.rpc('claim_starter_spirit'),6000);
          if(!rpcErr&&rpcData&&!rpcData.error)spiritCreated=true;
          else console.warn('finishProf: RPC failed',rpcErr||rpcData?.error);
        }catch(e){console.warn('finishProf: RPC exception',e.message)}
      }
      if(spiritCreated){try{await sb.from('profiles').update({starter_claimed:true}).eq('id',uid)}catch(e){}}
    }
    // 3) Grant starter emblems (15 each)
    try{const{error}=await sb.rpc('ensure_newbie_pack');if(error)throw error}catch(e){
      for(const t of['cafe_bean','wild_essence','focus_shard']){try{await sb.from('emblems').upsert({user_id:uid,emblem_type:t,quantity:15},{onConflict:'user_id,emblem_type'})}catch(e2){}}
    }
    try{await sb.from('profiles').update({starter_claimed:true,newbie_gift_claimed:true}).eq('id',uid)}catch(e){}
    // 4) Grant starter egg + auto-place
    try{await sb.rpc('claim_egg_drop',{p_playlist:'cafe'})}catch(e){
      try{await sb.from('eggs').insert({user_id:uid,rarity:'mundane',playlist:'cafe',status:'pending'})}catch(e2){}
    }
    // 5) Reload everything
    await loadUserData();
    await autoPlaceEggs();
    updateAllUI();
    localStorage.setItem('starter_pack_done_'+uid,'1');
    // 6) Show spirit arrival or error
    if(S.spirits.length>0){
      const sp=S.spirits.find(s=>s.spirit_type===pick)||S.spirits[0];
      showSpiritArrival(sp.spirit_type);
    }else{
      console.error('finishProf: Spirit creation failed after all attempts. User has 0 spirits');
      // Show user-facing error with ad blocker hint
      const errEl=document.getElementById('authError');
      if(errEl){errEl.textContent='Spirit creation failed ‚Äî if you have an ad blocker, please disable it for this site and refresh.';errEl.className='l-error'}
      showToast('new_user_gift');
    }
    // 7) Start all game tickers
    startHatcheryTicker();startCultivationTicker();startSpiritJiggle();startVillageTicker();startExpeditionTicker();
  }
}

// ‚ïê‚ïê‚ïê STARTER PACK ‚Äî bulletproof fallback (returning users only) ‚ïê‚ïê‚ïê
async function ensureStarterPack(){
  if(!S.user||S.isGuest)return;
  const uid=S.user.id;
  const lsKey='starter_pack_done_'+uid;
  if(localStorage.getItem(lsKey))return;
  try{
    // 1) Ensure profile exists (handle_new_user trigger may have failed)
    if(!S.profile||!S.profile.id){
      const uname=S.user.user_metadata?.username||'user_'+uid.slice(0,6);
      await sb.from('profiles').upsert({id:uid,username:uname,starter_claimed:false,newbie_gift_claimed:false,onboarding_done:false,total_eggs:0,total_listen_seconds:0,first_egg_claimed:false},{onConflict:'id'});
      const{data:p}=await sb.from('profiles').select('*').eq('id',uid).maybeSingle();
      S.profile=p||S.profile;
    }
    let gaveGifts=false;
    let starterSpiritType=null;
    // 2) Reload spirits fresh to avoid duplicates
    const{data:freshSpirits}=await sb.from('spirits').select('*').eq('user_id',uid);
    S.spirits=freshSpirits||[];
    // Only grant random starter if zero spirits AND onboarding already done (returning user edge case)
    if(S.spirits.length===0&&S.profile?.onboarding_done===true){
      try{
        const{data,error}=await sb.rpc('claim_starter_spirit');
        if(error)throw error;
        if(data&&!data.error){gaveGifts=true;starterSpiritType=data.spirit_type}
      }catch(e){
        // Re-check in case RPC partially succeeded
        const{data:recheck}=await sb.from('spirits').select('id').eq('user_id',uid);
        if(!recheck||recheck.length===0){
          const types=['timi','bayo','mowang','florita','simi','basu_basu'];
          const pick=types[Math.floor(Math.random()*types.length)];
          try{
            await sb.from('spirits').insert({user_id:uid,spirit_type:pick,name:SPIRIT_DATA[pick]?.name||pick,evo_stage:0,xp:0});
            gaveGifts=true;starterSpiritType=pick;
          }catch(e2){console.warn('ensureStarterPack: spirit insert failed',e2)}
        }
      }
    }
    // 3) Check emblems ‚Äî if any are below 15, top them up
    const low=S.emblems.cafe_bean<15||S.emblems.wild_essence<15||S.emblems.focus_shard<15;
    if(low){
      // Try RPC first
      try{
        const{data,error}=await sb.rpc('ensure_newbie_pack');
        if(error)throw error;
        if(data&&!data.error)gaveGifts=true;
      }catch(e){
        // RPC failed ‚Äî direct upsert fallback for each emblem type
        const types=['cafe_bean','wild_essence','focus_shard'];
        for(const t of types){
          if(S.emblems[t]<15){
            try{
              await sb.from('emblems').upsert({user_id:uid,emblem_type:t,quantity:15},{onConflict:'user_id,emblem_type'});
              gaveGifts=true;
            }catch(e2){console.warn('ensureStarterPack: emblem upsert failed for '+t,e2)}
          }
        }
      }
      // Mark profile flags
      try{await sb.from('profiles').update({starter_claimed:true,newbie_gift_claimed:true}).eq('id',uid)}catch(e){}
    }
    // 4) Ensure hatchery rows exist (trigger may have failed)
    if(!S.hatchery.length){
      try{
        // Check if rows exist in DB even though S.hatchery was empty at load time
        const{data:existingH}=await sb.from('hatchery').select('*').eq('user_id',uid).order('slot_number');
        if(!existingH||existingH.length===0){
          // Create the 5 default slots
          for(let sn=1;sn<=5;sn++){
            try{await sb.from('hatchery').insert({user_id:uid,slot_number:sn,unlocked:sn<=2,hatch_duration_minutes:5})}catch(e){}
          }
          const{data:h}=await sb.from('hatchery').select('*').eq('user_id',uid).order('slot_number');
          S.hatchery=h||[];
        }else{
          S.hatchery=existingH;
        }
      }catch(e){console.warn('ensureStarterPack: hatchery check failed',e)}
    }
    // 5) Ensure user has at least one egg ‚Äî if not, grant a mundane egg
    if(!S.pendingEggs.length&&S.hatchery.every(s=>!s.egg_id)){
      try{
        const{data,error}=await sb.rpc('claim_egg_drop',{p_playlist:'cafe'});
        if(!error&&data&&!data.error){gaveGifts=true;await loadUserData()}
      }catch(e){
        // Direct insert fallback
        try{await sb.from('eggs').insert({user_id:uid,rarity:'mundane',playlist:'cafe',status:'pending'});gaveGifts=true}catch(e2){}
      }
      // Auto-place it
      await loadUserData();
      await autoPlaceEggs();
    }
    // 6) Reload and show spirit arrival or gift toast
    if(gaveGifts){
      await loadUserData();
      updateAllUI();
      if(starterSpiritType){showSpiritArrival(starterSpiritType)}else{showToast('new_user_gift')}
    }
    // 5) Mark as done
    localStorage.setItem(lsKey,'1');
  }catch(e){console.warn('ensureStarterPack error:',e)}
}

// ‚ïê‚ïê‚ïê SPIRIT ARRIVAL SCREEN ‚ïê‚ïê‚ïê
function showSpiritArrival(spiritType){
  const k=spiritKey(spiritType),d=SPIRIT_DATA[k];
  if(!d)return showToast('new_user_gift');
  document.getElementById('saPortrait').innerHTML='<img src="'+d.img[0]+'">';
  document.getElementById('saName').textContent=d.name;
  document.getElementById('saBio').textContent=d.bio;
  document.getElementById('saWelcome').textContent=d.name+' found their way to your village';
  document.getElementById('spiritArrival').classList.add('show');
}
function dismissSpiritArrival(){document.getElementById('spiritArrival').classList.remove('show');showToast('new_user_gift')}

// ‚ïê‚ïê‚ïê WELCOME BACK ‚ïê‚ïê‚ïê
function showWelcomeBack(xpGained,hoursAway,spiritData){const wb=document.getElementById('welcomeBack');if(!wb)return;
  // Show the spirit that gained XP if available, else random
  const sp=spiritData||( S.spirits.length?S.spirits[Math.floor(Math.random()*S.spirits.length)]:null);
  const msg=WB_MESSAGES[Math.floor(Math.random()*WB_MESSAGES.length)];
  document.getElementById('wbMsg').textContent=msg;
  if(sp)document.getElementById('wbPortrait').innerHTML='<img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'">';
  let gains='';
  if(xpGained>0)gains+=(sp?sp.name+' gained':'Your spirits gained')+' +'+xpGained+' XP';
  if(hoursAway>0)gains+=(gains?' \u00b7 ':'')+Math.round(hoursAway)+'h away';
  // Village gift for 5+ hour returns
  if(hoursAway>=5&&!S.isGuest){
    const bonus=Math.min(Math.floor(hoursAway),8);
    S.emblems.cafe_bean+=bonus;S.emblems.wild_essence+=bonus;S.emblems.focus_shard+=bonus;
    gains+=' \u00b7 Village gift: +'+bonus+'\u00d7 each ingredient';
    const types=['cafe_bean','wild_essence','focus_shard'];
    types.forEach(t=>{sb.from('emblems').upsert({user_id:S.user.id,emblem_type:t,quantity:S.emblems[t]},{onConflict:'user_id,emblem_type'}).then(()=>{}).catch(e=>console.warn('village gift persist error:',e))});
    renderItemsTab();
  }
  document.getElementById('wbGains').textContent=gains||'Everything is as you left it.';
  wb.classList.remove('gone');
  // Auto-dismiss after 10 seconds
  S.wbTimer=setTimeout(()=>dismissWB(),10000);
}
function dismissWB(){if(S.wbTimer)clearTimeout(S.wbTimer);document.getElementById('welcomeBack').classList.add('gone')}

// ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê
function toggleSettings(){S.settingsOpen=!S.settingsOpen;document.getElementById('settingsDrop').classList.toggle('open',S.settingsOpen)}
document.addEventListener('click',e=>{if(S.settingsOpen&&!e.target.closest('.settings-drop')&&!e.target.closest('.tb-gear')){S.settingsOpen=false;document.getElementById('settingsDrop').classList.remove('open')}});
function toggleTheme(){S.theme=S.theme==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',S.theme);document.getElementById('themeToggle').classList.toggle('on',S.theme==='light')}
function switchTab(btn){document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('on'));document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('on'));btn.classList.add('on');document.getElementById('tab-'+btn.dataset.tab).classList.add('on')}
function showPrivacy(){toggleSettings();const box=document.getElementById('modalBox');box.innerHTML='<div class="modal-title">Privacy Policy</div><div class="pp-content"><h3>Super Ube LLC</h3><p>Ehoro Village is operated by Super Ube LLC, based in Georgia, United States.</p><h3>What We Collect</h3><p>When you create an account, we store your email address, username, and gameplay data (spirits, eggs, ingredients, listening time). We use Supabase for authentication and data storage.</p><h3>How We Use Your Data</h3><p>Your data is used solely to provide and improve the Ehoro Village experience. We do not sell, share, or distribute your personal information to third parties.</p><h3>Analytics</h3><p>We collect anonymized gameplay analytics to improve game balance. No personal information is included.</p><h3>Cookies</h3><p>We use essential cookies for authentication only. No tracking cookies.</p><h3>Data Deletion</h3><p>Request deletion of your account and data by contacting support@superube.com.</p><p style="color:var(--t4);margin-top:12px">Last updated: February 2026</p></div><button class="modal-btn secondary" onclick="closeModal()">Close</button>';document.getElementById('modal').classList.add('open')}
function showPatchNotes(){toggleSettings();document.getElementById('patchNotes').classList.add('show')}
function closePatchNotes(){document.getElementById('patchNotes').classList.remove('show')}

// ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
function showLogin(){document.getElementById('login').classList.remove('gone');S.authMode='signup';document.getElementById('authBtn').textContent='Create Account';document.getElementById('authToggle').textContent='Already have an account? Sign in';document.getElementById('usernameField').style.display=''}
function toggleAuthMode(){S.authMode=S.authMode==='login'?'signup':'login';const u=S.authMode==='signup';document.getElementById('authBtn').textContent=u?'Create Account':'Sign In';document.getElementById('authToggle').textContent=u?'Already have an account? Sign in':'Need an account? Sign up';document.getElementById('usernameField').style.display=u?'':'none';document.getElementById('authError').textContent=''}
async function doAuth(){const email=document.getElementById('inEmail').value.trim(),pass=document.getElementById('inPass').value,btn=document.getElementById('authBtn'),err=document.getElementById('authError');err.textContent='';err.className='l-error';if(!email||!pass){err.textContent='Email and password required';return}if(pass.length<6){err.textContent='Password must be 6+ characters';return}
if(_supabaseBlocked){err.textContent='Connection blocked ‚Äî please disable your ad blocker for this site and refresh.';return}
btn.disabled=true;btn.textContent='Loading...';try{let r;if(S.authMode==='signup'){const un=document.getElementById('inUser').value.trim()||'user_'+Math.random().toString(36).slice(2,8);r=await withTimeout(sb.auth.signUp({email,password:pass,options:{data:{username:un}}}),10000);if(r.data?.user&&!r.data.session){err.className='l-error ok';err.textContent='Check email to confirm!';btn.disabled=false;btn.textContent='Create Account';return}}else{r=await withTimeout(sb.auth.signInWithPassword({email,password:pass}),10000)}if(r.error)throw r.error;S.user=r.data.user;S.isGuest=false;await loadUserData();updateTopBar();enterApp()}catch(e){const msg=e.message||'Auth failed';err.textContent=msg.includes('abort')||msg.includes('timed out')?'Connection issue ‚Äî try disabling ad blockers or check your internet':msg}finally{btn.disabled=false;btn.textContent=S.authMode==='signup'?'Create Account':'Sign In'}}
async function doGoogleAuth(){try{const{error}=await sb.auth.signInWithOAuth({provider:'google',options:{redirectTo:window.location.origin}});if(error)throw error}catch(e){document.getElementById('authError').textContent=e.message||'Google sign-in failed'}}
function enterGuest(){document.getElementById('login').classList.add('gone');document.getElementById('shell').classList.add('on');S.isGuest=true;S.user=null;updateTopBar();loadGuestDefaults()}
function loadGuestDefaults(){S.spirits=[];S.traits={};S.emblems={cafe_bean:0,wild_essence:0,focus_shard:0,ashe_essence:0};S.profile={total_eggs:0,total_listen_seconds:0,username:'guest'};S.hatchery=[{id:'gs1',slot_number:1,unlocked:true,egg_id:null},{id:'gs2',slot_number:2,unlocked:true,egg_id:null},{id:'gs3',slot_number:3,unlocked:false},{id:'gs4',slot_number:4,unlocked:false},{id:'gs5',slot_number:5,unlocked:false}];S.pendingEggs=[];S.expeditions=[];S.pillRecipes=[{id:'d1',pill_name:'Spirit Pill',pill_type:'growth',description:'Grants 50 XP to a spirit.',effect_type:'xp_flat',effect_value:50,cost_cafe_bean:4,cost_wild_essence:2,cost_focus_shard:2},{id:'d2',pill_name:'Greater Spirit Pill',pill_type:'clarity',description:'Grants 100 XP to a spirit.',effect_type:'xp_flat',effect_value:100,cost_cafe_bean:6,cost_wild_essence:6,cost_focus_shard:6},{id:'d3',pill_name:'Village Spirit Pill',pill_type:'harmony',description:'Grants 25 XP to ALL spirits.',effect_type:'xp_all',effect_value:25,cost_cafe_bean:3,cost_wild_essence:3,cost_focus_shard:8}];updateAllUI();document.getElementById('guestBanner').classList.add('show')}
async function doLogout(){toggleSettings();
// Persist listen time before logout
if(S.sessionStartedAt&&S.profile&&S.user&&!S.isGuest){const sec=Math.floor((Date.now()-S.sessionStartedAt)/1000);const newTotal=(S.profile.total_listen_seconds||0)+sec;try{await sb.from('profiles').update({total_listen_seconds:newTotal}).eq('id',S.user.id)}catch(e){}}
if(S.sessionId){try{await sb.rpc('end_session',{p_session_id:S.sessionId})}catch(e){}S.sessionId=null}
await sb.auth.signOut();S.user=null;S.playing=false;S.isGuest=true;S.spirits=[];S.hatchery=[];S.pendingEggs=[];S.allEggs=[];S.expeditions=[];
S.emblems={cafe_bean:0,wild_essence:0,focus_shard:0,ashe_essence:0};S.profile=null;S.sessionStartedAt=null;S.eggAnchor=null;S.profStep=0;S.chosenStarter=null;
[S.ticker,S.hatchTicker,S.cultTicker,S.jiggleTicker,S.expedTicker].forEach(t=>{if(t)clearInterval(t)});S.ticker=S.hatchTicker=S.cultTicker=S.jiggleTicker=S.expedTicker=null;
const em=document.getElementById('videoEmbed'),ifr=em.querySelector('iframe');if(ifr)ifr.remove();em.classList.remove('loaded');
document.getElementById('guestBanner').classList.remove('show');
document.getElementById('login').classList.remove('gone');updateTopBar()}
async function checkSession(){
  for(let attempt=0;attempt<2;attempt++){
    try{
      const{data:{session}}=await withTimeout(sb.auth.getSession(),5000);
      if(session?.user){S.user=session.user;S.isGuest=false;await loadUserData();enterApp();return true}
      return false;
    }catch(e){
      console.warn('checkSession attempt '+(attempt+1)+' error:',e.message);
      if(attempt<1)await new Promise(r=>setTimeout(r,1000));
    }
  }
  return false;
}
async function loadUserData(){if(!S.user)return;
  try{
  const sIds=(await sb.from('spirits').select('id').eq('user_id',S.user.id)).data?.map(s=>s.id)||[];const[{data:prof},{data:spirits},{data:emb},{data:hatch},{data:traits},{data:eggs},{data:pills},{data:expeds}]=await Promise.all([sb.from('profiles').select('*').eq('id',S.user.id).maybeSingle(),sb.from('spirits').select('*').eq('user_id',S.user.id),sb.from('emblems').select('*').eq('user_id',S.user.id),sb.from('hatchery').select('*').eq('user_id',S.user.id).order('slot_number'),sb.from('spirit_traits').select('*').in('spirit_id',sIds.length?sIds:['00000000-0000-0000-0000-000000000000']),sb.from('eggs').select('*').eq('user_id',S.user.id).in('status',['pending','incubating']).limit(30),sb.from('pill_recipes').select('*'),sb.from('expeditions').select('*').eq('user_id',S.user.id)]);
  // Only overwrite S if we got valid data back (never overwrite with nulls from failed fetch)
  if(prof!==undefined)S.profile=prof||S.profile;
  if(S.profile&&S.profile.starter_claimed===undefined)S.profile.starter_claimed=false;
  if(spirits)S.spirits=spirits.map(sp=>({...sp,cultivation_stage:sp.cultivation_stage||0}));
  if(hatch)S.hatchery=hatch;
  const allEggs=eggs||[];S.pendingEggs=allEggs.filter(e=>e.status==='pending');S.allEggs=allEggs;
  if(pills)S.pillRecipes=pills.map(p=>({...p,pill_name:mapPillName(p.pill_name)}));
  if(expeds!==undefined)S.expeditions=expeds||[];
  if(emb)emb.forEach(e=>{S.emblems[e.emblem_type]=e.quantity});
  S.traits={};if(traits)traits.forEach(t=>{if(!S.traits[t.spirit_id])S.traits[t.spirit_id]=[];S.traits[t.spirit_id].push(t)});
  // Dismiss reconnect overlay on success
  hideReconnectOverlay();
  }catch(e){
    console.warn('loadUserData failed:',e);
    showReconnectOverlay();
    throw e; // Re-throw so callers know it failed
  }
}

// ‚ïê‚ïê‚ïê RECONNECTING OVERLAY ‚ïê‚ïê‚ïê
let _reconnectRetry=null;
function showReconnectOverlay(){
  const ov=document.getElementById('reconnectOverlay');if(!ov)return;
  ov.classList.remove('gone');
  if(!_reconnectRetry){
    let attempts=0;
    _reconnectRetry=setInterval(async()=>{
      attempts++;
      const msg=document.getElementById('reconnectMsg');
      if(msg)msg.textContent='Retry attempt '+attempts+'‚Ä¶';
      try{
        await loadUserData();
        updateAllUI();
        // If we get here, it worked
        hideReconnectOverlay();
      }catch(e){/* still failing, keep retrying */}
    },4000);
  }
}
function hideReconnectOverlay(){
  const ov=document.getElementById('reconnectOverlay');if(ov)ov.classList.add('gone');
  if(_reconnectRetry){clearInterval(_reconnectRetry);_reconnectRetry=null}
}

// ‚ïê‚ïê‚ïê ENTER APP ‚ïê‚ïê‚ïê
async function enterApp(){
document.getElementById('login').classList.add('gone');
document.getElementById('shell').classList.add('on');
document.getElementById('guestBanner').classList.remove('show');
updateTopBar();updateAllUI();
// New user detection: profile doesn't exist OR onboarding_done is false/null
// AND user has no spirits yet
const hasNoProfile=!S.profile||!S.profile.id;
const onboardingNotDone=!S.profile||S.profile.onboarding_done===false||S.profile.onboarding_done===null;
const hasNoSpirits=!S.spirits||S.spirits.length===0;
const isNewUser=(hasNoProfile||onboardingNotDone)&&hasNoSpirits;
if(isNewUser){
  await ensureBasicsOnly();
  showProfTutorial();return}
// Returning user flow
await ensureStarterPack();
checkOfflineHatches();startHatcheryTicker();startCultivationTicker();startSpiritJiggle();startVillageTicker();startExpeditionTicker();
// Only show welcome back / passive cultivation for returning users
try{const{data}=await sb.rpc('claim_passive_cultivation');if(data&&data.xp_granted>0&&data.hours_away>=1){await loadUserData();updateAllUI();
const topSpirit=S.spirits.length?S.spirits.reduce((a,b)=>(b.xp||0)>(a.xp||0)?b:a):null;showWelcomeBack(data.xp_granted,data.hours_away,topSpirit)}else{showToast('welcome')}}catch(e){console.warn('passive cultivation error:',e)}}

// Lightweight setup for new users ‚Äî profile + hatchery only, no spirits/eggs/emblems
async function ensureBasicsOnly(){
  if(!S.user||S.isGuest)return;const uid=S.user.id;
  try{
    if(!S.profile||!S.profile.id){
      const uname=S.user.user_metadata?.username||'user_'+uid.slice(0,6);
      await sb.from('profiles').upsert({id:uid,username:uname,starter_claimed:false,newbie_gift_claimed:false,onboarding_done:false,total_eggs:0,total_listen_seconds:0,first_egg_claimed:false},{onConflict:'id'});
      const{data:p}=await sb.from('profiles').select('*').eq('id',uid).maybeSingle();S.profile=p||S.profile;
    }
    if(!S.hatchery.length){
      const{data:existingH}=await sb.from('hatchery').select('*').eq('user_id',uid).order('slot_number');
      if(!existingH||existingH.length===0){
        for(let sn=1;sn<=5;sn++){try{await sb.from('hatchery').insert({user_id:uid,slot_number:sn,unlocked:sn<=2,hatch_duration_minutes:5})}catch(e){}}
        const{data:h}=await sb.from('hatchery').select('*').eq('user_id',uid).order('slot_number');S.hatchery=h||[];
      }else{S.hatchery=existingH}
    }
  }catch(e){console.warn('ensureBasicsOnly error:',e)}
}
// Village tab ticker for live listen time
// ‚ïê‚ïê‚ïê PILL NAME MAPPING (client-side rename) ‚ïê‚ïê‚ïê
function mapPillName(n){const m={'Cultivation Pill':'Spirit Pill','Greater Cultivation Pill':'Greater Spirit Pill','Village Cultivation Pill':'Village Spirit Pill'};return m[n]||n}

// ‚ïê‚ïê‚ïê EXPEDITION HELPERS ‚ïê‚ïê‚ïê
function spiritOnExpedition(spiritId){return S.expeditions.some(e=>{if(!e.spirit_ids)return false;const ids=Array.isArray(e.spirit_ids)?e.spirit_ids:[];return ids.includes(spiritId)})}
function spiritResting(spiritId){return S.expeditions.some(e=>{if(!e.rest_until||!e.spirit_ids)return false;const ids=Array.isArray(e.spirit_ids)?e.spirit_ids:[];return ids.includes(spiritId)&&new Date(e.rest_until).getTime()>Date.now()&&e.completed})}
function spiritUnavailable(spiritId){return spiritOnExpedition(spiritId)||spiritResting(spiritId)}

function getExpedStatus(exp){
  if(!exp.started_at)return'idle';
  const durMs=exp.duration_minutes*60*1000;
  const elapsed=Date.now()-new Date(exp.started_at).getTime();
  if(!exp.completed&&elapsed>=durMs)return'ready';
  if(!exp.completed)return'active';
  if(exp.rest_until&&new Date(exp.rest_until).getTime()>Date.now())return'resting';
  return'idle';
}

function renderExpedSlot(exp,slotNum,locked){
  if(locked)return'<div class="exped-slot locked"><div class="exped-slot-header"><span class="exped-slot-title">Expedition Slot '+slotNum+'</span><span class="exped-slot-status">üîí</span></div><div style="font-size:.5rem;color:var(--t4);text-align:center">Unlocks at Silver rank (400 prestige)</div></div>';
  if(!exp||!exp.started_at||(exp.completed&&(!exp.rest_until||new Date(exp.rest_until).getTime()<=Date.now()))){
    return'<div class="exped-slot"><div class="exped-slot-header"><span class="exped-slot-title">Expedition Slot '+slotNum+'</span><span class="exped-slot-status">Ready</span></div><button class="exped-btn" onclick="openExpedModal('+slotNum+')">Send Expedition</button></div>';
  }
  const status=getExpedStatus(exp);
  const ids=Array.isArray(exp.spirit_ids)?exp.spirit_ids:[];
  let spiritImgs=ids.map(sid=>{const sp=S.spirits.find(s=>s.id===sid);return sp?'<div class="exped-spirit-img"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'"></div>':''}).join('');
  if(status==='active'){
    const durMs=exp.duration_minutes*60*1000;const elapsed=Date.now()-new Date(exp.started_at).getTime();const pct=Math.min(100,(elapsed/durMs)*100);const remain=Math.max(0,durMs-elapsed);const rm=Math.floor(remain/60000),rs=Math.floor((remain%60000)/1000);
    return'<div class="exped-slot"><div class="exped-slot-header"><span class="exped-slot-title">Expedition Slot '+slotNum+'</span><span class="exped-slot-status">Exploring...</span></div><div class="exped-spirits">'+spiritImgs+'</div><div class="exped-bar"><div class="exped-bar-fill active" style="width:'+pct+'%"></div></div><div class="exped-timer">'+rm+'m '+rs+'s remaining</div></div>';
  }
  if(status==='ready'){
    return'<div class="exped-slot"><div class="exped-slot-header"><span class="exped-slot-title">Expedition Slot '+slotNum+'</span><span class="exped-slot-status" style="color:var(--positive)">Complete!</span></div><div class="exped-spirits">'+spiritImgs+'</div><button class="exped-btn claim" onclick="claimExpedition(\''+exp.id+'\')">Claim Rewards</button></div>';
  }
  if(status==='resting'){
    const restEnd=new Date(exp.rest_until).getTime();const remain=Math.max(0,restEnd-Date.now());const rm=Math.floor(remain/60000),rs=Math.floor((remain%60000)/1000);const restTotal=(exp._restMinutes||5)*60*1000;const pct=Math.min(100,((restTotal-remain)/restTotal)*100);
    return'<div class="exped-slot"><div class="exped-slot-header"><span class="exped-slot-title">Expedition Slot '+slotNum+'</span><span class="exped-slot-status" style="color:var(--special)">Spirits resting</span></div><div class="exped-spirits">'+spiritImgs+'</div><div class="exped-bar"><div class="exped-bar-fill resting" style="width:'+pct+'%"></div></div><div class="exped-timer">'+rm+'m '+rs+'s rest</div></div>';
  }
  return'<div class="exped-slot"><div class="exped-slot-header"><span class="exped-slot-title">Expedition Slot '+slotNum+'</span></div><button class="exped-btn" onclick="openExpedModal('+slotNum+')">Send Expedition</button></div>';
}

// ‚ïê‚ïê‚ïê EXPEDITION MODAL ‚ïê‚ïê‚ïê
let _expedModal={slot:null,duration:null,selectedSpirits:[]};
function openExpedModal(slotNum){
  if(S.isGuest||!S.spirits.length)return;
  _expedModal={slot:slotNum,duration:'medium',selectedSpirits:[]};
  const box=document.getElementById('modalBox');
  renderExpedModalContent(box);
  document.getElementById('modal').classList.add('open');
}
function renderExpedModalContent(box){
  const avail=S.spirits.filter(sp=>!spiritUnavailable(sp.id));
  let h='<div class="modal-title">Send Expedition</div>';
  h+='<div class="modal-desc">Choose duration:</div>';
  h+='<div class="exped-dur-grid">';
  for(const[key,cfg] of Object.entries(EXPED_CONFIG)){
    h+='<div class="exped-dur-opt'+(_expedModal.duration===key?' selected':'')+'" onclick="selectExpedDur(\''+key+'\')"><div class="exped-dur-label">'+cfg.label+'</div><div class="exped-dur-time">'+cfg.minutes+'m (+'+cfg.restMinutes+'m rest)</div></div>';
  }
  h+='</div>';
  h+='<div class="modal-desc" style="margin-top:8px">Choose up to 3 spirits:</div>';
  h+='<div class="exped-spirit-select">';
  S.spirits.forEach(sp=>{
    const unavail=spiritUnavailable(sp.id);
    const sel=_expedModal.selectedSpirits.includes(sp.id);
    const lvl=Math.floor((sp.xp||0)/100)+1;
    h+='<div class="exped-spirit-opt'+(sel?' selected':'')+(unavail?' unavailable':'')+'" onclick="toggleExpedSpirit(\''+sp.id+'\')">';
    h+='<img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'">';
    h+='<div class="exped-spirit-opt-info"><div class="exped-spirit-opt-name">'+sp.name+'</div><div class="exped-spirit-opt-lvl">Lv.'+lvl+(unavail?' ¬∑ On expedition':'')+'</div></div>';
    h+='<div class="exped-spirit-opt-check">'+(sel?'‚úì':'')+'</div></div>';
  });
  h+='</div>';
  const cfg=EXPED_CONFIG[_expedModal.duration];
  const selCount=_expedModal.selectedSpirits.length;
  // Preview rewards
  if(selCount>0&&cfg){
    let totalMats=0;_expedModal.selectedSpirits.forEach(sid=>{
      const sp=S.spirits.find(s=>s.id===sid);const lvl=sp?Math.floor((sp.xp||0)/100)+1:1;
      const bonus=_expedModal.duration==='short'?Math.floor(lvl/3):_expedModal.duration==='medium'?Math.floor(lvl/2):lvl;
      totalMats+=bonus;
    });
    const baseLow=cfg.baseMats[0],baseHigh=cfg.baseMats[1];
    h+='<div style="font-size:.5rem;color:var(--t3);margin:6px 0;line-height:1.5">Est. rewards: '+(baseLow+totalMats)+'‚Äì'+(baseHigh+totalMats)+' materials ¬∑ +'+cfg.bonusXp+' XP each'+(cfg.asheChance>0?' ¬∑ '+Math.round(cfg.asheChance*100)+'% √Ä·π£·∫π Essence':'')+'</div>';
  }
  h+='<button class="modal-btn" '+(selCount===0?'disabled':'')+' onclick="sendExpedition()" style="margin-top:8px">Send '+selCount+' spirit'+(selCount!==1?'s':'')+'</button>';
  h+='<button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';
  box.innerHTML=h;
}
function selectExpedDur(key){_expedModal.duration=key;renderExpedModalContent(document.getElementById('modalBox'))}
function toggleExpedSpirit(sid){
  const idx=_expedModal.selectedSpirits.indexOf(sid);
  if(idx>=0)_expedModal.selectedSpirits.splice(idx,1);
  else if(_expedModal.selectedSpirits.length<3)_expedModal.selectedSpirits.push(sid);
  renderExpedModalContent(document.getElementById('modalBox'));
}

// ‚ïê‚ïê‚ïê SEND EXPEDITION ‚ïê‚ïê‚ïê
async function sendExpedition(){
  if(S.isGuest||!_expedModal.selectedSpirits.length||isBusy('send_exped'))return;
  setBusy('send_exped',4000);
  closeModal();
  const cfg=EXPED_CONFIG[_expedModal.duration];
  const uid=S.user.id;
  try{
    const{data,error}=await sb.from('expeditions').insert({
      user_id:uid,
      slot_number:_expedModal.slot,
      spirit_ids:_expedModal.selectedSpirits,
      duration_minutes:cfg.minutes,
      started_at:new Date().toISOString(),
      completed:false,
      rest_until:null
    }).select().single();
    if(error)throw error;
    await loadUserData();updateAllUI();
    showToast('expedition_sent');
    try{sb.rpc('log_event',{p_event:'expedition_sent',p_data:{duration:_expedModal.duration,spirits:_expedModal.selectedSpirits.length}})}catch(e){}
  }catch(e){console.warn('send expedition error:',e);showToast('error')}
}

// ‚ïê‚ïê‚ïê CLAIM EXPEDITION ‚ïê‚ïê‚ïê
async function claimExpedition(expedId){
  if(S.isGuest||isBusy('claim_'+expedId))return;
  setBusy('claim_'+expedId,5000);
  const exp=S.expeditions.find(e=>e.id===expedId);
  if(!exp)return;
  const cfg=Object.values(EXPED_CONFIG).find(c=>c.minutes===exp.duration_minutes)||EXPED_CONFIG.medium;
  const ids=Array.isArray(exp.spirit_ids)?exp.spirit_ids:[];
  
  // Calculate rewards
  const types=['cafe_bean','wild_essence','focus_shard'];
  let totalMats={cafe_bean:0,wild_essence:0,focus_shard:0};
  const baseMats=cfg.baseMats[0]+Math.floor(Math.random()*(cfg.baseMats[1]-cfg.baseMats[0]+1));
  for(let i=0;i<baseMats;i++){const t=types[Math.floor(Math.random()*3)];totalMats[t]++}
  
  // Per-spirit bonus materials (+ trait effects)
  ids.forEach(sid=>{
    const sp=S.spirits.find(s=>s.id===sid);if(!sp)return;
    const lvl=Math.floor((sp.xp||0)/100)+1;
    let bonus=cfg===EXPED_CONFIG.short?Math.floor(lvl/3):cfg===EXPED_CONFIG.medium?Math.floor(lvl/2):lvl;
    // Trait effect: Wild/Adventurous add bonus mats
    const traitBonus=spiritTraitBonus(sp.id,'exped_bonus_mats');
    if(traitBonus>0)bonus+=Math.max(1,Math.floor(bonus*traitBonus));
    for(let i=0;i<bonus;i++){const t=types[Math.floor(Math.random()*3)];totalMats[t]++}
  });
  
  // √Ä·π£·∫π Essence chance
  let gotAshe=false;
  if(cfg.asheChance>0&&Math.random()<cfg.asheChance){gotAshe=true}
  
  // Apply rewards: update emblems
  try{
    for(const t of types){
      if(totalMats[t]>0){
        S.emblems[t]+=totalMats[t];
        await sb.from('emblems').upsert({user_id:S.user.id,emblem_type:t,quantity:S.emblems[t]},{onConflict:'user_id,emblem_type'});
      }
    }
    if(gotAshe){
      S.emblems.ashe_essence=(S.emblems.ashe_essence||0)+1;
      await sb.from('emblems').upsert({user_id:S.user.id,emblem_type:'ashe_essence',quantity:S.emblems.ashe_essence},{onConflict:'user_id,emblem_type'});
    }
    // Grant XP to each spirit
    for(const sid of ids){
      const sp=S.spirits.find(s=>s.id===sid);if(!sp)continue;
      const newXp=(sp.xp||0)+cfg.bonusXp;
      await sb.from('spirits').update({xp:newXp}).eq('id',sid);
    }
    // Mark expedition completed + set rest_until (trait: Resilient reduces rest)
    let restMs=cfg.restMinutes*60*1000;
    const avgRestReduction=ids.reduce((sum,sid)=>sum+spiritTraitBonus(sid,'rest_reduction'),0)/Math.max(ids.length,1);
    if(avgRestReduction>0)restMs=Math.floor(restMs*(1-avgRestReduction));
    const restUntil=new Date(Date.now()+restMs).toISOString();
    await sb.from('expeditions').update({completed:true,rest_until:restUntil}).eq('id',expedId);
    
    await loadUserData();updateAllUI();
    
    // Build reward summary
    const matTotal=totalMats.cafe_bean+totalMats.wild_essence+totalMats.focus_shard;
    let summary='+'+matTotal+' materials ¬∑ +'+cfg.bonusXp+' XP each';
    if(gotAshe)summary+=' ¬∑ +1 √Ä·π£·∫π Essence!';
    showExpedRewardToast(summary,gotAshe);
    try{sb.rpc('log_event',{p_event:'expedition_claimed',p_data:{materials:matTotal,ashe:gotAshe,xp:cfg.bonusXp}})}catch(e){}
  }catch(e){console.warn('claim expedition error:',e);showToast('error')}
}

function showExpedRewardToast(summary,gotAshe){
  const t=document.getElementById('toast');
  document.getElementById('toastI').textContent=gotAshe?'üîÆ':'üß≠';
  document.getElementById('toastT').textContent='Expedition Complete!';
  document.getElementById('toastS').textContent=summary;
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),4000);
}

// ‚ïê‚ïê‚ïê EXPEDITION TICKER ‚ïê‚ïê‚ïê
function startExpeditionTicker(){if(S.expedTicker)return;S.expedTicker=setInterval(()=>{if(!S.isGuest)renderVillageTab()},3000)}

// ‚ïê‚ïê‚ïê CULTIVATION ADVANCE ‚ïê‚ïê‚ïê
async function openCultivateModal(spiritId){
  if(S.isGuest)return;
  const sp=S.spirits.find(s=>s.id===spiritId);if(!sp)return;
  const stage=sp.cultivation_stage||0;
  if(stage>=5)return;
  const cost=CULT_COSTS[stage];
  const reqLvl=CULT_LVL_REQ[stage];
  const lvl=Math.floor((sp.xp||0)/100)+1;
  const hasAshe=(S.emblems.ashe_essence||0)>=cost;
  const hasLvl=lvl>=reqLvl;
  const can=hasAshe&&hasLvl;
  
  const box=document.getElementById('modalBox');
  box.innerHTML='<div class="modal-title">Advance Cultivation</div><div class="modal-desc"><b>'+sp.name+'</b> ‚Äî '+CULT_STAGES[stage]+' ‚Üí '+CULT_STAGES[stage+1]+'</div><div style="font-size:.6rem;color:var(--t2);line-height:1.6;margin:8px 0"><div'+(hasLvl?'':' style="color:var(--negative)"')+'>Requires: Lv.'+reqLvl+' (currently Lv.'+lvl+')</div><div'+(hasAshe?'':' style="color:var(--negative)"')+'>Cost: '+cost+' √Ä·π£·∫π Essence (have '+(S.emblems.ashe_essence||0)+')</div></div><button class="modal-btn" '+(can?'':'disabled')+' onclick="doCultivate(\''+spiritId+'\')">Advance to '+CULT_STAGES[stage+1]+'</button><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';
  document.getElementById('modal').classList.add('open');
}

async function doCultivate(spiritId){
  closeModal();
  const sp=S.spirits.find(s=>s.id===spiritId);if(!sp)return;
  const stage=sp.cultivation_stage||0;
  const cost=CULT_COSTS[stage];
  try{
    // Deduct √Ä·π£·∫π
    S.emblems.ashe_essence=Math.max(0,(S.emblems.ashe_essence||0)-cost);
    await sb.from('emblems').upsert({user_id:S.user.id,emblem_type:'ashe_essence',quantity:S.emblems.ashe_essence},{onConflict:'user_id,emblem_type'});
    // Advance cultivation stage
    const newStage=stage+1;
    await sb.from('spirits').update({cultivation_stage:newStage}).eq('id',spiritId);
    await loadUserData();updateAllUI();
    showToast('cultivation');
    if(S.selectedSpirit===spiritId)showSpiritDetail(spiritId);
  }catch(e){console.warn('cultivation advance error:',e);showToast('error')}
}

function startVillageTicker(){setInterval(()=>{if(!S.isGuest&&S.playing)renderVillageTab()},10000)}

// ‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê
function updateTopBar(){const p=calcPrestige();const rank=VILLAGE_RANKS.slice().reverse().find(r=>p>=r.min)||VILLAGE_RANKS[0];document.getElementById('tbRankName').textContent=rank.name;document.getElementById('tbRankName').style.color=rank.color||'';document.getElementById('tbRankPts').textContent=p+' prestige';const authArea=document.getElementById('tbAuth');if(S.isGuest){authArea.innerHTML='<button class="tb-signin" onclick="showLogin()">Sign In</button>'}else{const uname=S.profile?.username||S.user?.user_metadata?.username||S.user?.email?.split('@')[0]||'user';authArea.innerHTML='<span class="tb-user">'+uname+'</span>'}document.querySelectorAll('.sdLogoutDiv,.sdLogoutItem').forEach(el=>el.style.display=S.isGuest?'none':'')}
function updateAllUI(){updateTopBar();renderSpiritsTab();renderItemsTab();renderVillageTab()}

// ‚ïê‚ïê‚ïê SPIRITS TAB ‚ïê‚ïê‚ïê
function renderSpiritsTab(){const el=document.getElementById('tab-spirits');if(!S.spirits.length){el.innerHTML='<div class="spirit-empty"><div class="spirit-empty-msg">No spirits yet</div><div class="spirit-empty-hint">Hatch eggs to discover spirits</div><button class="empty-action" onclick="switchTab(document.querySelector(\'[data-tab=items]\'))">Go to Hatchery ‚Üí</button></div>';return}let h='<div class="spirits-grid">';S.spirits.forEach(sp=>{const lvl=Math.floor((sp.xp||0)/100)+1,xpP=(sp.xp||0)%100,evoClass=sp.evo_stage>0?'evo-'+sp.evo_stage:'',evoText=sp.evo_stage===1?'evo-text-1':sp.evo_stage===2?'evo-text-2':'',onExp=spiritUnavailable(sp.id);h+='<div class="spirit-card'+(onExp?' on-expedition':'')+'" onclick="selectSpirit(\''+sp.id+'\')"><div class="spirit-card-img '+evoClass+'"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'"></div><div class="spirit-card-info"><div class="spirit-card-name">'+sp.name+'</div><div class="spirit-card-meta"><span class="'+evoText+'">'+EVO_LABELS[sp.evo_stage]+'</span> \u00b7 Lv.'+lvl+'</div><div class="spirit-card-xp"><div class="spirit-card-xp-fill" style="width:'+xpP+'%"></div></div></div><div class="spirit-card-right"><div class="spirit-card-dots">'+[0,1,2].map(i=>'<div class="spirit-card-dot'+(i<=sp.evo_stage?' on':'')+'"></div>').join('')+'</div><div class="spirit-card-lvl">'+xpP+'/100</div></div></div>'});h+='</div><div class="spirits-count">'+S.spirits.length+' of 30 discovered</div>';el.innerHTML=h+'<div id="spiritDetail" class="spirit-detail"></div>';if(S.selectedSpirit)showSpiritDetail(S.selectedSpirit)}
function selectSpirit(id){S.selectedSpirit=id;showSpiritDetail(id)}
function showSpiritDetail(id){const sp=S.spirits.find(s=>s.id===id);if(!sp)return;const el=document.getElementById('spiritDetail'),lvl=Math.floor((sp.xp||0)/100)+1,xpP=(sp.xp||0)%100,tr=S.traits[sp.id]||[],cost=sp.evo_stage===0?5:12,reqLvl=sp.evo_stage===0?3:5,reqXp=(reqLvl-1)*100,meetsLvl=(sp.xp||0)>=reqXp,meetsMats=S.emblems.cafe_bean>=cost&&S.emblems.wild_essence>=cost&&S.emblems.focus_shard>=cost,can=sp.evo_stage<2&&!S.isGuest&&meetsLvl&&meetsMats,evoText=sp.evo_stage===1?'evo-text-1':sp.evo_stage===2?'evo-text-2':'';
const onExped=spiritOnExpedition(sp.id)&&!S.expeditions.find(e=>e.completed&&Array.isArray(e.spirit_ids)&&e.spirit_ids.includes(sp.id)&&getExpedStatus(e)==='idle');
const isResting=spiritResting(sp.id);
let statusLine='';
if(onExped)statusLine='<div style="font-size:.5rem;color:var(--positive);margin:4px 0">üß≠ On expedition</div>';
else if(isResting)statusLine='<div style="font-size:.5rem;color:var(--special);margin:4px 0">üí§ Resting from expedition</div>';
// Build evolution requirements text
let evoReqs='';
if(sp.evo_stage<2){
  const reqs=[];
  if(!meetsLvl)reqs.push('Requires Lv.'+reqLvl+' (currently Lv.'+lvl+')');
  reqs.push('Cost: '+cost+'\u00d7 each (\u2615'+S.emblems.cafe_bean+' \uD83C\uDF3F'+S.emblems.wild_essence+' \u26A1'+S.emblems.focus_shard+')');
  evoReqs='<button class="sd-evolve-btn" '+(can?'':'disabled')+' onclick="doEvolve(\''+sp.id+'\')">Evolve to '+EVO_LABELS[sp.evo_stage+1]+'</button><div class="sd-evolve-cost"'+(meetsLvl?'':' style="color:var(--negative)"')+'>'+reqs.join(' \u00b7 ')+'</div>';
}else{evoReqs='<div style="text-align:center;font-size:.6rem;color:var(--t3);margin-top:10px">\u2728 Fully Ascended</div>'}
// Cultivation stage section
const cultStage=sp.cultivation_stage||0;
let cultHtml='<div class="sd-section">Spirit Cultivation</div>';
cultHtml+='<div class="sd-cult-stage"><span class="sd-cult-label">'+CULT_STAGES[cultStage]+'</span><div class="sd-cult-dots">';
for(let i=0;i<5;i++)cultHtml+='<div class="sd-cult-dot'+(i<cultStage?' on':'')+'"></div>';
cultHtml+='</div></div>';
if(cultStage<5){
  const cultCost=CULT_COSTS[cultStage];const cultReqLvl=CULT_LVL_REQ[cultStage];
  const canCult=lvl>=cultReqLvl&&(S.emblems.ashe_essence||0)>=cultCost&&!S.isGuest;
  cultHtml+='<button class="sd-cult-advance" '+(canCult?'':'disabled')+' onclick="openCultivateModal(\''+sp.id+'\')">Advance to '+CULT_STAGES[cultStage+1]+'</button>';
  cultHtml+='<div class="sd-cult-cost">'+cultCost+' üîÆ √Ä·π£·∫π ¬∑ Lv.'+cultReqLvl+' required'+(lvl<cultReqLvl?' ¬∑ <span style="color:var(--negative)">need Lv.'+cultReqLvl+'</span>':'')+'</div>';
}else{
  cultHtml+='<div style="font-size:.5rem;color:var(--special);text-align:center;margin-top:4px">‚ú¶ Spirit Sovereign ‚Äî Maximum cultivation ‚ú¶</div>';
}
el.className='spirit-detail open';el.innerHTML='<div class="sd-header"><div class="sd-portrait"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'"></div><div class="sd-info"><div class="sd-name">'+sp.name+'</div><div class="sd-stage"><span class="'+evoText+'">'+EVO_LABELS[sp.evo_stage]+'</span> \u00b7 '+spiritName(sp.spirit_type)+'</div><div class="sd-bio">'+spiritBio(sp.spirit_type)+'</div></div><button class="sd-close" onclick="closeSpiritDetail()">\u2715</button></div>'+statusLine+'<div class="sd-section">Level</div><div class="sd-bar-wrap"><div class="sd-bar"><div class="sd-bar-fill" style="width:'+xpP+'%"></div></div><span class="sd-lvl">Lv.'+lvl+' ('+xpP+'/100)</span></div><div class="sd-section">Traits</div><div class="trait-tags">'+(tr.length?tr.map(t=>{const eff=TRAIT_EFFECTS[t.trait_name];return'<span class="trait-tag '+t.trait_type+(eff?' has-effect':'')+'" title="'+(eff?eff.desc:'')+'">'+t.trait_name+'</span>'}).join(''):'<span style="font-size:.5rem;color:var(--t4)">Evolve to gain traits</span>')+'</div>'+cultHtml+evoReqs}
function closeSpiritDetail(){S.selectedSpirit=null;document.getElementById('spiritDetail').className='spirit-detail'}

// ‚ïê‚ïê‚ïê ITEMS TAB ‚Äî simplified: hatchery, ingredients, pills ‚ïê‚ïê‚ïê
function renderItemsTab(){const el=document.getElementById('tab-items'),prest=calcPrestige(),pendCount=S.pendingEggs.filter(e=>e.status==='pending').length;let h='<div class="section-label">Hatchery</div><div class="hatchery-grid">';
// If hatchery is empty (new user, trigger didn't fire), show default empty slots
const slots=S.hatchery.length?S.hatchery:[{id:'def1',slot_number:1,unlocked:true,egg_id:null},{id:'def2',slot_number:2,unlocked:true,egg_id:null},{id:'def3',slot_number:3,unlocked:false},{id:'def4',slot_number:4,unlocked:false},{id:'def5',slot_number:5,unlocked:false}];
slots.forEach(slot=>{if(!slot.unlocked){const req=SLOT_UNLOCK[slot.slot_number],canU=req&&prest>=req;h+='<div class="hatch-slot '+(canU?'unlockable':'locked')+'" '+(canU?'onclick="unlockSlot('+slot.slot_number+')"':'')+'><div class="hatch-slot-icon">'+(canU?'\uD83D\uDD13':'\uD83D\uDD12')+'</div><div class="hatch-slot-label">'+(canU?'Unlock!':req?req+' prestige':'Locked')+'</div></div>';return}if(!slot.egg_id){h+='<div class="hatch-slot" onclick="openPlaceEggModal(\''+slot.id+'\')"><div class="hatch-slot-icon">\uFF0B</div><div class="hatch-slot-label">Place Egg</div>'+(pendCount>0?'<div class="hatch-slot-eggs">('+pendCount+' available)</div>':'')+'</div>';return}const egg=(S.allEggs||S.pendingEggs).find(e=>e.id===slot.egg_id)||{rarity:'mundane'},started=new Date(slot.started_at),durMs=(slot.hatch_duration_minutes||INCUB_MINS[egg.rarity]||3)*60*1000,elapsed=Date.now()-started.getTime(),ready=elapsed>=durMs,pct=Math.min(elapsed/durMs*100,100),rem=Math.max(0,Math.ceil((durMs-elapsed)/1000)),rs=rem>60?Math.ceil(rem/60)+'m':rem+'s';h+='<div class="hatch-slot'+(ready?' ready':'')+'" onclick="'+(ready?'doHatch(\''+slot.id+'\')':'')+'"><div class="hatch-slot-icon">'+(ready?'\uD83D\uDC23':'\uD83E\uDD5A')+'</div><div class="hatch-slot-rarity" style="color:'+(RARITY_COLORS[egg.rarity]||'#888')+'">'+(egg.rarity||'')+'</div>'+(ready?'<div class="hatch-slot-label" style="color:var(--positive)">Hatch!</div>':'<div class="hatch-slot-timer">'+rs+'</div><div class="hatch-slot-bar"><div class="hatch-slot-bar-fill" style="width:'+pct+'%"></div></div>')+'</div>'});
h+='</div><div class="section-label">Ingredients</div><div class="ing-grid">';
h+='<div class="ing-row"><span class="ing-icon">\u2615</span><span class="ing-name">Caf\u00e9 Bean</span><span class="ing-count">'+S.emblems.cafe_bean+'</span><button class="ing-swap" onclick="openConvertModal(\'cafe_bean\')" title="Convert">\u21C4</button></div>';
h+='<div class="ing-row"><span class="ing-icon">\uD83C\uDF3F</span><span class="ing-name">Wild Essence</span><span class="ing-count">'+S.emblems.wild_essence+'</span><button class="ing-swap" onclick="openConvertModal(\'wild_essence\')" title="Convert">\u21C4</button></div>';
h+='<div class="ing-row"><span class="ing-icon">\u26A1</span><span class="ing-name">Focus Shard</span><span class="ing-count">'+S.emblems.focus_shard+'</span><button class="ing-swap" onclick="openConvertModal(\'focus_shard\')" title="Convert">\u21C4</button></div>';
h+='<div class="ing-row rare"><span class="ing-icon">üîÆ</span><span class="ing-name">√Ä·π£·∫π Essence</span><span class="ing-count">'+(S.emblems.ashe_essence||0)+'</span><span style="font-size:.4rem;color:var(--special);padding:0 4px">Expeditions</span></div></div>';
h+='<div class="section-label">Craft Spirit Pills</div><div class="pill-grid">';
const pIcons={growth:'\uD83D\uDC8A',clarity:'\u2728',harmony:'\uD83C\uDFB5'};S.pillRecipes.forEach(p=>{const ok=S.emblems.cafe_bean>=p.cost_cafe_bean&&S.emblems.wild_essence>=p.cost_wild_essence&&S.emblems.focus_shard>=p.cost_focus_shard;h+='<div class="pill-row'+(ok?'':' disabled')+'" onclick="openCraftModal(\''+p.id+'\',\''+p.pill_name+'\',\''+p.effect_type+'\')">'+'<span class="pill-icon">'+(pIcons[p.pill_type]||'\uD83D\uDC8A')+'</span><div class="pill-info"><div class="pill-name">'+p.pill_name+'</div><div class="pill-desc">'+p.description+'</div></div><div class="pill-cost">\u2615'+p.cost_cafe_bean+' \uD83C\uDF3F'+p.cost_wild_essence+' \u26A1'+p.cost_focus_shard+'</div></div>'});
h+='</div>';el.innerHTML=h}

// ‚ïê‚ïê‚ïê VILLAGE TAB ‚ïê‚ïê‚ïê
function renderVillageTab(){const el=document.getElementById('tab-village'),p=calcPrestige(),rank=VILLAGE_RANKS.slice().reverse().find(r=>p>=r.min)||VILLAGE_RANKS[0],next=VILLAGE_RANKS[VILLAGE_RANKS.indexOf(rank)+1],totalSec=(S.profile?.total_listen_seconds||0)+(S.profile?._sessionSeconds||0),hrs=Math.floor(totalSec/3600),rmins=Math.floor((totalSec%3600)/60),timeStr=hrs>0?hrs+'h '+rmins+'m':rmins+'m';
let h='<div class="village-rank-card"><div class="village-rank-label">Village Rank</div><div class="village-rank-name">'+rank.name+'</div><div class="village-rank-desc">'+rank.desc+'</div>'+(next?'<div style="font-size:.5rem;color:var(--t4);margin-top:6px">Next: '+next.name+' ('+next.min+')</div>':'')+'</div><div class="village-stat-grid"><div class="village-stat"><div class="village-stat-num">'+p+'</div><div class="village-stat-label">Prestige</div></div><div class="village-stat"><div class="village-stat-num">'+(S.profile?.total_eggs||0)+'</div><div class="village-stat-label">Eggs</div></div><div class="village-stat"><div class="village-stat-num">'+S.spirits.length+'</div><div class="village-stat-label">Spirits</div></div><div class="village-stat"><div class="village-stat-num">'+timeStr+'</div><div class="village-stat-label">Listened</div></div></div>';

// Expeditions section
h+='<div class="section-label" style="margin-top:12px">Expeditions</div><div class="exped-section">';
const slot1Exp=S.expeditions.find(e=>e.slot_number===1&&(getExpedStatus(e)!=='idle'));
h+=renderExpedSlot(slot1Exp,1,false);
const slot2Unlocked=p>=400;
const slot2Exp=S.expeditions.find(e=>e.slot_number===2&&(getExpedStatus(e)!=='idle'));
h+=renderExpedSlot(slot2Exp,2,!slot2Unlocked);
h+='</div>';

el.innerHTML=h}
function calcPrestige(){let p=0;S.spirits.forEach(sp=>{p+=(sp.evo_stage+1)*10;p+=Math.floor((sp.xp||0)/100)*5;p+=(sp.cultivation_stage||0)*20});p+=(S.profile?.total_eggs||0)*2;p+=Math.floor((S.profile?.total_listen_seconds||0)/3600)*3;return p}

// ‚ïê‚ïê‚ïê HATCH ‚ïê‚ïê‚ïê
async function doHatch(slotId){if(S.isGuest||isBusy('hatch_'+slotId))return;setBusy('hatch_'+slotId,5000);
// Optimistic: mark slot as processing
const slotIdx=S.hatchery.findIndex(s=>s.id===slotId);
if(slotIdx>=0){const origEgg=S.hatchery[slotIdx].egg_id;S.hatchery[slotIdx]._hatching=true;renderItemsTab()}
try{const{data,error}=await sb.rpc('hatch_egg',{p_slot_id:slotId});if(error)throw error;if(data.error){showToast('error');if(slotIdx>=0)S.hatchery[slotIdx]._hatching=false;renderItemsTab();return}
_lastHatchData=data;
await loadUserData();updateAllUI();showHatchAnimation(data)}catch(e){console.warn('hatch error:',e);showToast('error');if(slotIdx>=0)S.hatchery[slotIdx]._hatching=false;renderItemsTab()}}
function showHatchAnimation(data){const ov=document.getElementById('hatchOverlay'),eg=document.getElementById('hatchEgg'),rv=document.getElementById('hatchReveal');eg.style.display='block';eg.className='hatch-egg-anim';rv.className='hatch-reveal';ov.classList.add('show');const spiritType=data.spirit_type||null;const sk=['timi','bayo','mowang','florita','simi','basu_basu'];const rk=spiritType?spiritKey(spiritType):sk[Math.floor(Math.random()*3)];const st=data.evo_stage||0;document.getElementById('hatchImg').src=SPIRIT_DATA[rk]?.img[st]||'sprites/timi_1.png';document.getElementById('hatchName').textContent=SPIRIT_DATA[rk]?.name||'Spirit';const r=data.rarity||'mundane';document.getElementById('hatchRarity').textContent=r.charAt(0).toUpperCase()+r.slice(1);document.getElementById('hatchRarity').style.color=RARITY_COLORS[r]||'#888';setTimeout(()=>eg.classList.add('crack'),1800);setTimeout(()=>{eg.style.display='none';spawnParticles(ov,'hatch');rv.classList.add('show')},2500)}
function spawnParticles(parent,type){const colors=type==='evo'?['#ffd700','#ff6b35','#fff']:['#fff','#8ab4ff','#c8f'];for(let i=0;i<12;i++){const p=document.createElement('div');p.style.cssText='position:absolute;width:6px;height:6px;border-radius:50%;pointer-events:none;z-index:999;left:50%;top:50%;background:'+colors[i%3];const a=Math.random()*Math.PI*2,d=60+Math.random()*80,dur=600+Math.random()*400;p.animate([{transform:'translate(-50%,-50%) translate(0,0) scale(1)',opacity:1},{transform:'translate(-50%,-50%) translate('+Math.cos(a)*d+'px,'+Math.sin(a)*d+'px) scale(0)',opacity:0}],{duration:dur,easing:'cubic-bezier(.34,1.56,.64,1)'});parent.appendChild(p);setTimeout(()=>p.remove(),dur)}}
function closeHatchAnim(){document.getElementById('hatchOverlay').classList.remove('show');showToast('new_spirit')}

// ‚ïê‚ïê‚ïê SLOT UNLOCK ‚ïê‚ïê‚ïê
async function unlockSlot(num){if(S.isGuest)return;try{const{data}=await sb.rpc('unlock_hatchery_slot',{p_slot_number:num});if(data?.error){showToast('error');return}await loadUserData();updateAllUI();showToast('unlock')}catch(e){showToast('error')}}

// ‚ïê‚ïê‚ïê PLACE EGG ‚ïê‚ïê‚ïê
function openPlaceEggModal(slotId){const pend=S.pendingEggs.filter(e=>e.status==='pending');if(!pend.length){showToast('no_eggs');return}const box=document.getElementById('modalBox');box.innerHTML='<div class="modal-title">Place an Egg</div><div class="modal-select-grid">'+pend.map(e=>'<div class="modal-select-row" onclick="placeEgg(\''+e.id+'\',\''+slotId+'\')"><span>\uD83E\uDD5A</span><span style="color:'+(RARITY_COLORS[e.rarity]||'#888')+'">'+e.rarity+'</span><span style="font-size:.5rem;color:var(--t4);margin-left:auto">'+(INCUB_MINS[e.rarity]||5)+'m</span></div>').join('')+'</div><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';document.getElementById('modal').classList.add('open')}
async function placeEgg(eId,sId){if(S.isGuest||isBusy('place_'+eId))return;setBusy('place_'+eId,3000);closeModal();
// Optimistic: remove from pending, mark slot as occupied
const eggIdx=S.pendingEggs.findIndex(e=>e.id===eId);const slotIdx=S.hatchery.findIndex(s=>s.id===sId);
if(eggIdx>=0&&slotIdx>=0){S.hatchery[slotIdx].egg_id=eId;S.hatchery[slotIdx].started_at=new Date().toISOString();S.pendingEggs.splice(eggIdx,1);renderItemsTab()}
try{await sb.rpc('place_egg_in_slot',{p_egg_id:eId,p_slot_id:sId});await loadUserData();updateAllUI()}catch(e){console.warn('placeEgg error:',e);showToast('error');await loadUserData();updateAllUI()}}
function startHatcheryTicker(){if(S.hatchTicker)return;S.hatchTicker=setInterval(()=>{if(!S.isGuest)renderItemsTab()},5000)}

// ‚ïê‚ïê‚ïê CRAFT PILLS ‚ïê‚ïê‚ïê
function openCraftModal(recipeId,pillName,effectType){if(S.isGuest)return;if(effectType==='xp_all'){doCraft(recipeId,null);return}const box=document.getElementById('modalBox');box.innerHTML='<div class="modal-title">Use '+pillName+'</div><div class="modal-desc">Choose a spirit:</div><div class="modal-select-grid">'+S.spirits.map(sp=>'<div class="modal-select-row" onclick="doCraft(\''+recipeId+'\',\''+sp.id+'\')"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'" style="width:28px;height:28px;border-radius:50%"><span style="font-size:.7rem">'+sp.name+'</span><span style="font-size:.5rem;color:var(--t4);margin-left:auto">Lv.'+(Math.floor((sp.xp||0)/100)+1)+'</span></div>').join('')+'</div><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';document.getElementById('modal').classList.add('open')}
async function doCraft(recipeId,spiritId){closeModal();if(isBusy('craft'))return;setBusy('craft',3000);
const recipe=S.pillRecipes.find(p=>p.id===recipeId);
// Optimistic: deduct ingredients immediately
if(recipe){S.emblems.cafe_bean=Math.max(0,S.emblems.cafe_bean-recipe.cost_cafe_bean);S.emblems.wild_essence=Math.max(0,S.emblems.wild_essence-recipe.cost_wild_essence);S.emblems.focus_shard=Math.max(0,S.emblems.focus_shard-recipe.cost_focus_shard);renderItemsTab();renderSpiritsTab()}
try{const{data,error}=await sb.rpc('craft_pill',{p_recipe_id:recipeId,p_spirit_id:spiritId});if(error)throw error;if(data?.error){showToast('error');await loadUserData();updateAllUI();return}await loadUserData();updateAllUI();showToast(data.leveled_up?'levelup':'craft')}catch(e){console.warn('craft error:',e);showToast('error');await loadUserData();updateAllUI()}}

// ‚ïê‚ïê‚ïê CONVERT ‚ïê‚ïê‚ïê
function openConvertModal(from){if(S.isGuest)return;const n={cafe_bean:'Caf\u00e9 Bean',wild_essence:'Wild Essence',focus_shard:'Focus Shard'},ic={cafe_bean:'\u2615',wild_essence:'\uD83C\uDF3F',focus_shard:'\u26A1'},oth=Object.keys(n).filter(k=>k!==from);const box=document.getElementById('modalBox');box.innerHTML='<div class="modal-title">Convert '+ic[from]+'</div><div class="modal-desc">3 <b>'+n[from]+'</b> \u2192 1 other. You have: <b>'+S.emblems[from]+'</b></div><div class="modal-select-grid">'+oth.map(to=>'<div class="modal-select-row'+(S.emblems[from]<3?' style="opacity:.3;pointer-events:none"':'')+'" onclick="doConvert(\''+from+'\',\''+to+'\')"><span>'+ic[to]+' '+n[to]+'</span></div>').join('')+'</div><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';document.getElementById('modal').classList.add('open')}
async function doConvert(from,to){closeModal();try{const{data}=await sb.rpc('convert_ingredient',{p_from:from,p_to:to,p_amount:1});if(data?.error){showToast('error');return}S.emblems[from]-=3;S.emblems[to]+=1;renderItemsTab();renderSpiritsTab()}catch(e){showToast('error')}}
function closeModal(){document.getElementById('modal').classList.remove('open')}

// ‚ïê‚ïê‚ïê ACTIVE CULTIVATION TICKER ‚ïê‚ïê‚ïê
function startCultivationTicker(){if(S.cultTicker||S.isGuest)return;S.cultTicker=setInterval(async()=>{if(!S.playing||S.isGuest)return;try{const{data}=await sb.rpc('tick_active_cultivation');if(data?.success){await loadUserData();updateAllUI()}}catch(e){console.warn('cultivation tick error:',e)}},1200000)}

// ‚ïê‚ïê‚ïê EVOLUTION ‚ïê‚ïê‚ïê
async function doEvolve(spiritId){if(S.isGuest||isBusy('evolve_'+spiritId))return;setBusy('evolve_'+spiritId,5000);try{const{data,error}=await sb.rpc('evolve_spirit',{p_spirit_id:spiritId});if(error)throw error;if(data.error){showToast('error');return}await loadUserData();updateAllUI();showToast('evolution');showEvoAnimation();if(S.selectedSpirit===spiritId)showSpiritDetail(spiritId)}catch(e){console.warn('evolve error:',e);showToast('error')}}
function showEvoAnimation(){const ov=document.createElement('div');ov.style.cssText='position:fixed;inset:0;z-index:200;pointer-events:none;';document.body.appendChild(ov);spawnParticles(ov,'evo');for(let w=0;w<3;w++){setTimeout(()=>spawnParticles(ov,'evo'),w*300)}setTimeout(()=>ov.remove(),2000)}

// ‚ïê‚ïê‚ïê STREAM ‚Äî single stream with fallback ‚ïê‚ïê‚ïê
let _lastHatchData=null;
async function startStream(){if(S.playing)return;S.playing=true;S.sessionStartedAt=Date.now();S.eggAnchor=Date.now();const embed=document.getElementById('videoEmbed');const iframe=document.createElement('iframe');iframe.src='https://www.youtube.com/embed/'+STREAM_YT+'?autoplay=1&rel=0';iframe.allow='autoplay; encrypted-media';iframe.allowFullscreen=true;
// YouTube fallback ‚Äî if iframe fails to load
iframe.onerror=function(){showYTFallback()};
// Also set a timeout in case iframe silently fails
const ytTimeout=setTimeout(()=>{if(!embed.classList.contains('loaded')){showYTFallback()}},12000);
iframe.onload=function(){clearTimeout(ytTimeout)};
embed.insertBefore(iframe,embed.firstChild);embed.classList.add('loaded');document.getElementById('psPlay').textContent='\u23F8';if(!S.isGuest){try{const{data}=await sb.rpc('start_session',{p_playlist:'cafe'});S.sessionId=data}catch(e){console.warn('start_session error:',e)}}startTicker()}
function showYTFallback(){
  const embed=document.getElementById('videoEmbed');
  const existing=embed.querySelector('.yt-fallback');if(existing)return;
  const ifr=embed.querySelector('iframe');if(ifr)ifr.remove();
  embed.classList.remove('loaded');
  const fb=document.createElement('div');fb.className='yt-fallback';
  fb.innerHTML='<div class="yt-fallback-msg">Stream couldn\'t load.<br>Try another source?</div><button class="yt-fallback-btn" onclick="retryStream()">Retry Stream</button><button class="yt-fallback-btn" style="background:transparent;border:1px solid var(--glass-border);color:var(--t2);margin-top:6px" onclick="tryFallbackStream()">Try Backup Stream</button>';
  embed.appendChild(fb);
}
function retryStream(){const fb=document.querySelector('.yt-fallback');if(fb)fb.remove();S.playing=false;startStream()}
function tryFallbackStream(){const fb=document.querySelector('.yt-fallback');if(fb)fb.remove();const embed=document.getElementById('videoEmbed');const iframe=document.createElement('iframe');iframe.src='https://www.youtube.com/embed/videoseries?list='+STREAM_YT_FALLBACK+'&autoplay=1';iframe.allow='autoplay; encrypted-media';iframe.allowFullscreen=true;embed.insertBefore(iframe,embed.firstChild);embed.classList.add('loaded')}

// ‚ïê‚ïê‚ïê SHARE HATCH ‚ïê‚ïê‚ïê
function shareHatch(){
  const name=document.getElementById('hatchName')?.textContent||'a spirit';
  const rarity=document.getElementById('hatchRarity')?.textContent||'';
  const msg='ü•ö‚ú® I just hatched '+name+(rarity?' ('+rarity+')':'')+' in Ehoro Village! Come listen to lo-fi and grow your own spirit companions ‚Üí https://ubseoul.github.io/ehoro_village_music/';
  if(navigator.clipboard){navigator.clipboard.writeText(msg).then(()=>{const btn=document.getElementById('hatchShare');if(btn){btn.textContent='‚úì Copied!';btn.classList.add('copied');setTimeout(()=>{btn.textContent='üìã Share';btn.classList.remove('copied')},2000)}}).catch(()=>{})}
}

// ‚ïê‚ïê‚ïê VISIBILITY CHANGE ‚Äî pause/resume timers on background ‚ïê‚ïê‚ïê
document.addEventListener('visibilitychange',()=>{
  if(document.hidden){
    // Tab went to background ‚Äî record the anchor time so we catch up on return
    S._hiddenAt=Date.now();
  }else{
    // Tab came back ‚Äî catch up wall-clock based timers
    if(S.playing&&S.eggAnchor){
      // eggT is re-derived from eggAnchor every tick, so it auto-catches-up already
      // Just force an immediate render
      if(!S.isGuest)renderItemsTab();
      renderVillageTab();
    }
    // Refresh expedition/hatchery display
    if(!S.isGuest&&S.user){
      renderItemsTab();renderVillageTab();
    }
  }
});

// ‚ïê‚ïê‚ïê GAME TICK ‚ïê‚ïê‚ïê
function startTicker(){if(S.ticker)return;if(!S.eggAnchor)S.eggAnchor=Date.now();const eggTime=()=>S.isGuest&&!S.guestEggGiven?S.GUEST_EGG_SEC:(!S.profile?.first_egg_claimed?S.FIRST_EGG_SEC:S.EGG_SEC);S.ticker=setInterval(async()=>{if(!S.playing)return;
const now=Date.now();S.eggT=(now-S.eggAnchor)/1000;
const total=eggTime();const pct=Math.min((S.eggT/total)*100,100);document.getElementById('eggFill').style.width=pct+'%';const rem=Math.max(0,Math.ceil(total-S.eggT));const mins=Math.floor(rem/60),secs=rem%60;document.getElementById('eggTimer').textContent=mins>0?mins+'m '+secs+'s':secs+'s';
if(S.sessionStartedAt&&S.profile){S.profile._sessionSeconds=Math.floor((now-S.sessionStartedAt)/1000)}
// Ingredient drops ‚Äî first drop guaranteed within ~60s, then ~1 per 8 min
const ingChance=(!S.isGuest&&!S.firstIngredientGiven&&S.eggT>30)?0.03:0.0015;
if(!S.isGuest&&Math.random()<ingChance){const types=['cafe_bean','wild_essence','focus_shard'];const mat=types[Math.floor(Math.random()*3)];S.emblems[mat]++;S.firstIngredientGiven=true;renderItemsTab();showToast('ing_'+mat);checkCraftHint()}
// Egg drop
if(S.eggT>=total){S.eggAnchor=Date.now();S.eggT=0;if(S.isGuest){if(!S.guestEggGiven){S.guestEggGiven=true;showToast('mundane')}}else{try{const{data,error}=await sb.rpc('claim_egg_drop',{p_playlist:'cafe'});if(error)throw error;if(data.error==='too_fast')return;if(data.error==='pending_full'){showToast('full');return}if(!S.profile.first_egg_claimed){S.profile.first_egg_claimed=true;sb.from('profiles').update({first_egg_claimed:true}).eq('id',S.user.id)}S.profile.total_eggs=data.total_eggs;const types=['cafe_bean','wild_essence','focus_shard'];const mat=types[Math.floor(Math.random()*3)];S.emblems[mat]++;await loadUserData();updateAllUI();showToast(data.rarity);autoPlaceEggs();try{sb.rpc('log_event',{p_event:'egg_drop',p_data:{rarity:data.rarity}})}catch(e){}}catch(e){console.warn('egg drop error:',e)}}}},500)}

// ‚ïê‚ïê‚ïê CRAFT HINT ‚Äî pulse Items tab when user first has enough materials ‚ïê‚ïê‚ïê
function checkCraftHint(){if(S.craftHintShown||S.isGuest)return;const r=S.pillRecipes[0];if(!r)return;if(S.emblems.cafe_bean>=r.cost_cafe_bean&&S.emblems.wild_essence>=r.cost_wild_essence&&S.emblems.focus_shard>=r.cost_focus_shard){S.craftHintShown=true;const tab=document.querySelector('[data-tab="items"]');if(tab){tab.classList.add('hint');setTimeout(()=>tab.classList.remove('hint'),6000)}}}

// ‚ïê‚ïê‚ïê TOAST ‚Äî simplified, handles all types ‚ïê‚ïê‚ïê
function showToast(type){const t=document.getElementById('toast');const ING_NAMES={cafe_bean:{i:'\u2615',n:'Caf√© Bean'},wild_essence:{i:'\uD83C\uDF3F',n:'Wild Essence'},focus_shard:{i:'\u26A1',n:'Focus Shard'}};const msgs={welcome:{i:'\uD83D\uDC4B',t:'Welcome back'},gift:{i:'\uD83C\uDF81',t:'Welcome Gift!',s:'+15 of each ingredient'},evolution:{i:'\u2728',t:'Evolution!'},craft:{i:'\uD83D\uDC8A',t:'Pill used!'},levelup:{i:'\u2B06',t:'Level up!'},unlock:{i:'\uD83D\uDD13',t:'Slot unlocked!'},ingredient:{i:'\u2728',t:'Ingredient found'},error:{i:'\u274C',t:'Something went wrong'},no_eggs:{i:'\uD83E\uDD5A',t:'No pending eggs'},full:{i:'\uD83D\uDCE6',t:'Hatch some eggs first'},new_user_gift:{i:'\uD83C\uDF81',t:'New user gifts!',s:'Starter spirit + 15√ó each ingredient'},new_spirit:{i:'\uD83C\uDF1F',t:'New spirit joined!'},village_gift:{i:'\uD83C\uDFE0',t:'Village gift!',s:'Welcome back bonus'},expedition_sent:{i:'üß≠',t:'Expedition sent!',s:'Your spirits set off...'},cultivation:{i:'üîÆ',t:'Cultivation advanced!',s:'A breakthrough!'}};
// Named ingredient toasts
if(type.startsWith('ing_')){const key=type.slice(4);const ing=ING_NAMES[key];document.getElementById('toastI').textContent=ing?.i||'\u2728';document.getElementById('toastT').textContent='Found '+(ing?.n||'ingredient')+'!';document.getElementById('toastS').textContent='';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);return}
const rr=RARITY_COLORS[type];if(rr){document.getElementById('toastI').textContent='\uD83E\uDD5A';document.getElementById('toastT').textContent=type.charAt(0).toUpperCase()+type.slice(1)+' Egg';document.getElementById('toastS').textContent=S.isGuest?'Sign up to keep!':''}else{const m=msgs[type]||msgs.welcome;document.getElementById('toastI').textContent=m.i;document.getElementById('toastT').textContent=m.t;document.getElementById('toastS').textContent=m.s||''}t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}

// ‚ïê‚ïê‚ïê PAGE CLOSE ‚Äî persist session + listen time ‚ïê‚ïê‚ïê
window.addEventListener('beforeunload',()=>{if(S.user&&!S.isGuest){
const token=sb.auth?.session?.()?.access_token||sb.realtime?.accessToken||'';
const headers={'Content-Type':'application/json','apikey':SUPABASE_ANON_KEY,'Authorization':'Bearer '+token};
if(S.sessionId){try{fetch(SUPABASE_URL+'/rest/v1/rpc/end_session',{method:'POST',headers,body:JSON.stringify({p_session_id:S.sessionId}),keepalive:true})}catch(e){}}
if(S.sessionStartedAt&&S.profile){const sec=Math.floor((Date.now()-S.sessionStartedAt)/1000);const newTotal=(S.profile.total_listen_seconds||0)+sec;try{fetch(SUPABASE_URL+'/rest/v1/profiles?id=eq.'+S.user.id,{method:'PATCH',headers,body:JSON.stringify({total_listen_seconds:newTotal}),keepalive:true})}catch(e){}}}});
// Periodic listen time save every 2 minutes
setInterval(()=>{if(S.playing&&!S.isGuest&&S.sessionStartedAt&&S.user&&S.profile){const sec=Math.floor((Date.now()-S.sessionStartedAt)/1000);const newTotal=(S.profile.total_listen_seconds||0)+sec;sb.from('profiles').update({total_listen_seconds:newTotal}).eq('id',S.user.id).then(()=>{}).catch(e=>console.warn('listen save error:',e))}},120000);

// ‚ïê‚ïê‚ïê SAFETY CHECK ‚Äî auto-place eggs if slots available ‚ïê‚ïê‚ïê
async function autoPlaceEggs(){if(S.isGuest)return;const pend=S.pendingEggs.filter(e=>e.status==='pending');const empty=S.hatchery.filter(s=>s.unlocked&&!s.egg_id);if(pend.length&&empty.length){for(let i=0;i<Math.min(pend.length,empty.length);i++){try{await sb.rpc('place_egg_in_slot',{p_egg_id:pend[i].id,p_slot_id:empty[i].id})}catch(e){}}await loadUserData();updateAllUI()}}

// ‚ïê‚ïê‚ïê OFFLINE EGG HATCH CHECK ‚ïê‚ïê‚ïê
async function checkOfflineHatches(){if(S.isGuest)return;
  const ready=S.hatchery.filter(s=>{if(!s.egg_id||!s.started_at)return false;const dur=(s.hatch_duration_minutes||INCUB_MINS['mundane'])*60*1000;return Date.now()-new Date(s.started_at).getTime()>=dur});
  for(const slot of ready){try{await sb.rpc('hatch_egg',{p_slot_id:slot.id})}catch(e){}}
  if(ready.length){await loadUserData();updateAllUI()}}

// ‚ïê‚ïê‚ïê SPIRIT JIGGLE ‚Äî subtle random wiggle every 15-20s ‚ïê‚ïê‚ïê
function startSpiritJiggle(){if(S.jiggleTicker)return;S.jiggleTicker=setInterval(()=>{const cards=document.querySelectorAll('.spirit-card-img');if(!cards.length)return;const pick=cards[Math.floor(Math.random()*cards.length)];pick.classList.add('spirit-jiggle');setTimeout(()=>pick.classList.remove('spirit-jiggle'),500)},15000+Math.random()*5000)}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
let _appEntered=false;
let _wasLoggedIn=false; // Track if user was actually logged in (prevents spurious SIGNED_OUT)
// Listen for auth state changes (OAuth redirect, cross-tab, token refresh)
sb.auth.onAuthStateChange(async(event,session)=>{
  if((event==='SIGNED_IN'||event==='TOKEN_REFRESHED')&&session?.user){
    _wasLoggedIn=true;
    // Recover from guest/stuck state
    if(!_appEntered||S.isGuest){
      S.user=session.user;S.isGuest=false;
      document.getElementById('guestBanner').classList.remove('show');
      await loadUserData();updateTopBar();
      if(!_appEntered){_appEntered=true;enterApp()}
      else{updateAllUI()}
    }
  }
  // Only handle SIGNED_OUT if user was actually logged in (ignore spurious events)
  if(event==='SIGNED_OUT'&&_wasLoggedIn){
    _wasLoggedIn=false;_appEntered=false;
    S.user=null;S.isGuest=true;
    S.playing=false;S.spirits=[];S.hatchery=[];S.pendingEggs=[];S.allEggs=[];S.expeditions=[];
    S.emblems={cafe_bean:0,wild_essence:0,focus_shard:0,ashe_essence:0};S.profile=null;
    S.sessionStartedAt=null;S.eggAnchor=null;S.profStep=0;S.chosenStarter=null;
    [S.ticker,S.hatchTicker,S.cultTicker,S.jiggleTicker,S.expedTicker].forEach(t=>{if(t)clearInterval(t)});
    S.ticker=S.hatchTicker=S.cultTicker=S.jiggleTicker=S.expedTicker=null;
    document.getElementById('guestBanner').classList.remove('show');
    document.getElementById('login').classList.remove('gone');
  }
});
// Initial session check ‚Äî show guest mode quickly if session check is slow
let _sessionResolved=false;
const _guestTimeout=setTimeout(()=>{
  if(!_sessionResolved&&!S.user){enterGuest()}
},1500); // Show guest mode after 1.5s max if session hasn't loaded
checkSession().then(ok=>{
  _sessionResolved=true;clearTimeout(_guestTimeout);
  if(ok){_appEntered=true;_wasLoggedIn=true}
  else if(!S.user&&!_appEntered){enterGuest()}
});

</script>
</body>
</html>
