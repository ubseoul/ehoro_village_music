<!DOCTYPE html>

<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' fonts.googleapis.com; font-src fonts.gstatic.com; img-src 'self' data:; frame-src www.youtube.com youtube.com; connect-src eyqddqtlgthgkiqjavyx.supabase.co *.supabase.co;">
<title>Ehoro Village ‚Äî Lo-Fi Spirits</title>
<meta name="description" content="A cozy lo-fi music companion with spirit collection. Listen, hatch, evolve, and grow your village.">
<meta property="og:title" content="Ehoro Village ‚Äî Lo-Fi Spirits">
<meta property="og:description" content="A cozy lo-fi music companion with spirit collection. Listen, hatch, evolve, and grow your village.">
<meta property="og:image" content="https://ubseoul.github.io/ehoro_village_music/sprites/timi_3.png">
<meta property="og:url" content="https://ubseoul.github.io/ehoro_village_music/">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ehoro Village ‚Äî Lo-Fi Spirits">
<meta name="twitter:description" content="A cozy lo-fi music companion with spirit collection.">
<meta name="twitter:image" content="https://ubseoul.github.io/ehoro_village_music/sprites/timi_3.png">
<link rel="icon" type="image/png" href="sprites/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,300&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/dist/umd/supabase.min.js"></script>
<style>
:root{--glass:rgba(12,12,12,.55);--glass-border:rgba(255,255,255,.08);--glass-hover:rgba(255,255,255,.04);--blur:blur(20px);--radius:14px;--radius-sm:10px}
[data-theme="dark"]{--bg:#050505;--surface:rgba(15,15,15,.7);--border:rgba(255,255,255,.06);--border-l:rgba(255,255,255,.12);--t1:#f5f5f5;--t2:#b0b0b0;--t3:#808080;--t4:#505050;--accent-dim:rgba(255,255,255,.04);--accent-soft:rgba(255,255,255,.08);--logo-color:#f5f5f5;--toast-bg:rgba(20,20,20,.9);--positive:#6c9;--negative:#c77;--special:#c8f;--card-bg:rgba(255,255,255,.04);--card-border:rgba(255,255,255,.08)}
[data-theme="light"]{--bg:#f0ede8;--surface:rgba(235,232,226,.85);--border:rgba(0,0,0,.10);--border-l:rgba(0,0,0,.20);--t1:#1a1614;--t2:#3d3830;--t3:#6b6258;--t4:#9a9088;--accent-dim:rgba(0,0,0,.04);--accent-soft:rgba(0,0,0,.07);--logo-color:#1a1614;--toast-bg:rgba(224,221,214,.95);--positive:#2a7a4a;--negative:#a83030;--special:#7040a0;--card-bg:rgba(0,0,0,.04);--card-border:rgba(0,0,0,.10);--glass:rgba(240,237,232,.75);--glass-border:rgba(0,0,0,.10)}
*{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;overflow:hidden}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--t1);-webkit-font-smoothing:antialiased;transition:background .4s,color .4s}
/* V1.3 POLISH: Better transition curves throughout */
button,input,select,.spirit-card,.hatch-slot,.pill-row,.ing-row,.tab-btn,.modal-box,.toast{transition:all .25s cubic-bezier(.4,0,.2,1)}
/* V1.3 POLISH: Tactile button feedback */
button:active,.spirit-card:active,.hatch-slot:active,.pill-row:active{transform:scale(.98)}
/* V1.3 POLISH: Focus states for accessibility */
button:focus-visible,input:focus-visible,select:focus-visible,.spirit-card:focus-visible,.hatch-slot:focus-visible{outline:2px solid var(--t1);outline-offset:2px}
/* V1.3 POLISH: Reduced motion support */
@media (prefers-reduced-motion: reduce){*,*::before,*::after{animation-duration:0.01ms !important;transition-duration:0.01ms !important}}
/* ONBOARD */
.onboard{position:fixed;inset:0;z-index:200;background:var(--bg);display:flex;align-items:center;justify-content:center;transition:opacity .4s}.onboard.gone{opacity:0;pointer-events:none}

.ob-inner{width:100%;max-width:380px;padding:0 28px;text-align:center}.ob-icon{width:80px;height:80px;margin:0 auto 16px;border-radius:50%;overflow:hidden}.ob-icon img{width:100%;height:100%;object-fit:cover}
.ob-title{font-family:‚ÄòFraunces‚Äô,serif;font-size:1.6rem;font-weight:500;margin-bottom:8px}.ob-desc{font-size:.85rem;color:var(--t2);line-height:1.5;margin-bottom:28px}
.ob-dots{display:flex;gap:6px;justify-content:center;margin-bottom:24px}.ob-dot{width:8px;height:8px;border-radius:50%;background:var(--t4);transition:all .2s}.ob-dot.on{background:var(--t1);width:20px;border-radius:4px}
.ob-btn{padding:13px 32px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer}.ob-skip{display:block;margin:12px auto 0;background:none;border:none;color:var(--t4);font-family:inherit;font-size:.7rem;cursor:pointer}
/* WELCOME BACK */
.wb-overlay{position:fixed;inset:0;z-index:150;background:var(--bg);display:flex;align-items:center;justify-content:center;transition:opacity .5s}.wb-overlay.gone{opacity:0;pointer-events:none}
.wb-inner{width:100%;max-width:360px;padding:0 28px;text-align:center}
.wb-portrait{width:72px;height:72px;border-radius:50%;overflow:hidden;margin:0 auto 16px;border:2px solid var(--card-border)}.wb-portrait img{width:100%;height:100%;object-fit:cover}
.wb-msg{font-family:‚ÄòFraunces‚Äô,serif;font-size:1.3rem;font-weight:300;font-style:italic;color:var(--t1);margin-bottom:8px;line-height:1.4}
.wb-gains{font-size:.75rem;color:var(--t2);margin-bottom:24px;line-height:1.6}
.wb-btn{padding:13px 32px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer}
/* GUEST BANNER */
.guest-banner{position:fixed;bottom:0;left:0;right:0;z-index:60;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-top:1px solid var(--glass-border);padding:14px 20px;padding-bottom:calc(14px + env(safe-area-inset-bottom));display:flex;align-items:center;justify-content:center;gap:16px;transform:translateY(100%);transition:transform .4s}.guest-banner.show{transform:translateY(0)}
.guest-banner-text{font-size:.8rem;color:var(--t2)}.guest-banner-text b{color:var(--t1)}.guest-banner-btn{padding:8px 20px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer}
/* LOGIN */
.login{position:fixed;inset:0;z-index:100;background:var(--bg);display:flex;align-items:center;justify-content:center;transition:opacity .5s}.login.gone{opacity:0;pointer-events:none}
.login-inner{width:100%;max-width:360px;padding:0 28px}.login-brand{text-align:center;margin-bottom:48px}
.login-brand h1{font-family:‚ÄòFraunces‚Äô,serif;font-size:2rem;font-weight:300;font-style:italic;color:var(--logo-color);margin-bottom:4px}.login-brand .sub{font-size:.6rem;color:var(--t3);letter-spacing:.25em;text-transform:uppercase}
.login-field{margin-bottom:16px}.login-field label{display:block;font-size:.65rem;color:var(--t3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:7px;font-weight:500}
.login-field input{width:100%;background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius-sm);padding:12px 16px;color:var(--t1);font-family:inherit;font-size:.85rem;outline:none}.login-field input:focus{border-color:var(--border-l)}
.l-btn{width:100%;padding:13px;margin-top:8px;background:var(--t1);color:var(--bg);border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer}.l-btn:disabled{opacity:.35}
.l-div{display:flex;align-items:center;gap:14px;margin:22px 0;color:var(--t4);font-size:.6rem;text-transform:uppercase;letter-spacing:.15em}.l-div::before,.l-div::after{content:‚Äô‚Äô;flex:1;height:1px;background:var(--border)}
.l-secondary{width:100%;padding:12px;background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius-sm);color:var(--t2);font-family:inherit;font-size:.85rem;cursor:pointer}.l-secondary:hover{border-color:var(--border-l);color:var(--t1)}
.l-toggle{display:block;text-align:center;margin-top:20px;background:none;border:none;color:var(--t3);font-family:inherit;font-size:.75rem;cursor:pointer;text-decoration:underline;text-underline-offset:3px}
.l-error{color:#e55;font-size:.75rem;text-align:center;margin-top:12px;min-height:18px}.l-error.ok{color:#5b5}
/* SHELL */
.shell{height:100vh;height:100dvh;display:flex;flex-direction:column;opacity:0;transition:opacity .4s .2s;overflow:hidden}.shell.on{opacity:1}
/* TOPBAR */
.topbar{height:48px;min-height:48px;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-bottom:1px solid var(--glass-border);display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:10;flex-shrink:0}
.tb-brand{font-family:‚ÄòFraunces‚Äô,serif;font-size:1.05rem;font-weight:300;font-style:italic;color:var(--logo-color)}
.tb-right{display:flex;align-items:center;gap:10px}
.tb-rank{display:flex;align-items:center;gap:6px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;padding:5px 12px}
.tb-rank-name{font-size:.65rem;font-weight:500}.tb-rank-pts{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.55rem;color:var(--t3)}
.tb-gear{background:none;border:none;color:var(--t2);cursor:pointer;padding:6px;line-height:1;border-radius:6px;display:flex;align-items:center}.tb-gear:hover{color:var(--t1);background:var(--glass-hover)}
.tb-signin{background:none;border:1px solid var(--glass-border);border-radius:6px;padding:4px 12px;color:var(--t2);font-family:inherit;font-size:.65rem;cursor:pointer}.tb-signin:hover{border-color:var(--border-l);color:var(--t1)}
.tb-user{font-size:.7rem;color:var(--t2)}
/* SETTINGS DROP */
.settings-drop{position:fixed;top:52px;right:12px;z-index:40;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:1px solid var(--glass-border);border-radius:var(--radius);padding:8px;min-width:180px;box-shadow:0 8px 32px rgba(0,0,0,.3);opacity:0;transform:translateY(-6px);pointer-events:none;transition:all .2s}.settings-drop.open{opacity:1;transform:translateY(0);pointer-events:all}
.sd-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:.75rem;color:var(--t2);transition:background .1s}.sd-item:hover{background:var(--glass-hover)}.sd-item-label{display:flex;align-items:center;gap:8px}
.sd-toggle{width:34px;height:18px;border-radius:9px;background:var(--border);position:relative;transition:background .2s;cursor:pointer}.sd-toggle.on{background:var(--t2)}.sd-toggle::after{content:‚Äô‚Äô;position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:var(--t1);transition:transform .2s}.sd-toggle.on::after{transform:translateX(16px)}.sd-divider{height:1px;background:var(--border);margin:4px 0}
/* CONTENT */
.content{flex:1;display:flex;overflow:hidden;min-height:0}
/* VIDEO */
.video-area{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden;background:#000}
.video-embed{flex:1;position:relative;min-height:0}.video-embed iframe{position:absolute;inset:0;width:100%;height:100%;border:none}
.video-placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;background:var(--bg);cursor:pointer}.video-placeholder:hover{background:var(--surface)}
.vp-play{width:64px;height:64px;border-radius:50%;border:1.5px solid var(--t4);display:flex;align-items:center;justify-content:center;font-size:1.3rem;color:var(--t3)}.vp-text{font-size:.7rem;color:var(--t4);letter-spacing:.15em;text-transform:uppercase}.video-embed.loaded .video-placeholder{display:none}
/* PLAYER STRIP ‚Äî simplified */
.player-strip{height:44px;min-height:44px;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-top:1px solid var(--glass-border);display:flex;align-items:center;padding:0 16px;gap:10px;flex-shrink:0}
.ps-play{width:28px;height:28px;background:var(--t1);color:var(--bg);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.6rem;cursor:pointer;flex-shrink:0}
.ps-info{flex:1;min-width:0}.ps-title{font-size:.7rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.ps-sub{font-size:.5rem;color:var(--positive);display:flex;align-items:center;gap:4px}
.ps-live-dot{width:5px;height:5px;border-radius:50%;background:var(--positive);animation:livePulse 2s infinite}
@keyframes livePulse{0%,100%{opacity:1}50%{opacity:.4}}
/* V1.3 POLISH: Egg progress with subtle glow at 90%+ */
.egg-progress{padding:8px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;transition:box-shadow .5s ease}
.egg-progress.near-ready{box-shadow:0 0 16px rgba(255,255,255,.08)}
[data-theme=‚Äúlight‚Äù] .egg-progress.near-ready{box-shadow:0 0 16px rgba(0,0,0,.06)}
.egg-progress-label{font-size:.55rem;color:var(--t3);flex-shrink:0}.egg-progress-bar{flex:1;height:2px;background:var(--border);border-radius:2px;overflow:hidden}.egg-progress-fill{height:100%;background:var(--t1);border-radius:2px;transition:width .8s cubic-bezier(.4,0,.2,1);width:0%}.egg-progress-time{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.5rem;color:var(--t3);min-width:40px;text-align:right}
/* SIDEBAR */
.sidebar{width:320px;min-width:320px;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-left:1px solid var(--glass-border);display:flex;flex-direction:column;overflow:hidden;padding-bottom:env(safe-area-inset-bottom)}
/* TABS */
.tab-nav{display:flex;border-bottom:1px solid var(--border);padding:4px 10px;gap:2px}
.tab-btn{flex:1;padding:7px 0;background:none;border:none;border-radius:8px;color:var(--t3);font-family:inherit;font-size:.55rem;font-weight:500;letter-spacing:.06em;text-transform:uppercase;cursor:pointer}.tab-btn:hover{color:var(--t2);background:var(--glass-hover)}.tab-btn.on{color:var(--t1);background:var(--accent-soft)}
.tab-panels{flex:1;overflow:hidden;position:relative}.tab-panel{position:absolute;inset:0;overflow-y:auto;padding:10px;opacity:0;pointer-events:none;transition:opacity .2s}.tab-panel.on{opacity:1;pointer-events:all}.tab-panel::-webkit-scrollbar{width:3px}.tab-panel::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
/* SPIRIT CARDS ‚Äî V2.4 REWORK */
.spirits-grid{display:flex;flex-direction:column;gap:8px}
.spirits-count{display:none}
.spirit-card{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);cursor:pointer;transition:all .2s cubic-bezier(.4,0,.2,1);min-height:72px}.spirit-card:hover{background:var(--accent-soft);border-color:var(--border-l);transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.12)}
[data-theme=‚Äúlight‚Äù] .spirit-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.06)}
.spirit-card-img{width:52px;height:52px;border-radius:50%;overflow:hidden;flex-shrink:0;position:relative}
.spirit-card-img img{width:100%;height:100%;object-fit:cover;position:relative;z-index:1}
.spirit-card-img::before{content:‚Äô‚Äô;position:absolute;inset:-4px;border-radius:50%;z-index:0;opacity:0}
.spirit-card-img.evo-1::before{opacity:1;background:conic-gradient(from 0deg,transparent,rgba(140,180,255,.35),transparent,rgba(200,220,255,.25),transparent);animation:auraRotate 4s linear infinite}
.spirit-card-img.evo-2::before{opacity:1;background:conic-gradient(from 0deg,transparent,rgba(255,215,140,.4),transparent,rgba(255,240,200,.3),transparent);animation:auraRotate 3s linear infinite}
@keyframes auraRotate{to{transform:rotate(360deg)}}
.spirit-card-info{flex:1;min-width:0;display:flex;flex-direction:column;gap:3px}
.spirit-card-name{font-size:.82rem;font-weight:600;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.spirit-card-meta{font-size:.58rem;color:var(--t3);display:flex;align-items:center;gap:5px}
.evo-text-1{background:linear-gradient(90deg,#f5f5f5,#8ab4ff,#f5f5f5);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimText 3s ease infinite}
.evo-text-2{background:linear-gradient(90deg,#f5f5f5,#ffd480,#f5f5f5);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimText 3s ease infinite}
@keyframes shimText{0%{background-position:200% 0}100%{background-position:-200% 0}}
[data-theme=‚Äúlight‚Äù] .evo-text-1{background:linear-gradient(90deg,#1a1816,#4477cc,#1a1816);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimText 3s ease infinite}
[data-theme=‚Äúlight‚Äù] .evo-text-2{background:linear-gradient(90deg,#1a1816,#cc8800,#1a1816);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimText 3s ease infinite}
.spirit-card-mood{font-size:.5rem;color:var(--t3);display:flex;align-items:center;gap:3px}
.spirit-card-xp-wrap{display:flex;align-items:center;gap:5px;margin-top:2px}
.spirit-card-xp{flex:1;height:4px;background:var(--border);border-radius:4px;overflow:hidden;position:relative}
.spirit-card-xp-fill{height:100%;background:var(--positive);border-radius:4px;transition:width 2s cubic-bezier(.4,0,.2,1);position:relative}
.spirit-card-xp-fill::after{content:‚Äô‚Äô;position:absolute;top:0;left:-60%;width:60%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent);border-radius:4px;opacity:0;transition:opacity .5s}
body.music-playing .spirit-card-xp-fill::after{opacity:1;animation:xpCrawl 3s linear infinite}
@keyframes xpCrawl{0%{left:-60%}100%{left:110%}}
.spirit-card-xp-num{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.45rem;color:var(--t4);flex-shrink:0;min-width:28px;text-align:right}
.spirit-card-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
.spirit-card-stars{display:flex;gap:2px;font-size:.6rem;line-height:1;letter-spacing:1px}
.spirit-card-lvl{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.5rem;color:var(--t3)}
body.music-playing .spirit-card-img:not(.mood-sleepy){animation:spiritBob 4s ease-in-out infinite}
body.music-playing .spirit-card:nth-child(2) .spirit-card-img{animation-delay:.5s}
body.music-playing .spirit-card:nth-child(3) .spirit-card-img{animation-delay:1s}
body.music-playing .spirit-card:nth-child(4) .spirit-card-img{animation-delay:1.5s}
body.music-playing .spirit-card:nth-child(5) .spirit-card-img{animation-delay:.8s}
@keyframes spiritBob{0%,100%{transform:translateY(0)}25%{transform:translateY(-2px)}75%{transform:translateY(1px)}}
.spirit-card-img.mood-happy::after{content:‚Äô‚Äô;position:absolute;top:-2px;right:-2px;width:9px;height:9px;border-radius:50%;background:var(--positive);z-index:2;animation:moodPulse 2.5s ease-in-out infinite}
.spirit-card-img.mood-energized::after{content:‚Äô‚Äô;position:absolute;top:-2px;right:-2px;width:9px;height:9px;border-radius:50%;background:var(--special);z-index:2;animation:moodPulse 2s ease-in-out infinite}
.spirit-card-img.mood-sleepy{filter:brightness(.85) saturate(.8)}
.spirit-card-img.mood-sleepy::after{content:‚Äô‚Äô;position:absolute;top:-2px;right:-2px;width:9px;height:9px;border-radius:50%;background:var(--t4);z-index:2}
@keyframes moodPulse{0%,100%{opacity:.6;transform:scale(.8)}50%{opacity:1;transform:scale(1.1)}}
.spirit-card.on-expedition{opacity:.55}.spirit-card.on-expedition::after{content:‚Äòüß≠‚Äô;position:absolute;top:6px;right:8px;font-size:.55rem}
.spirit-card{position:relative}
.spirit-empty{text-align:center;padding:40px 16px}
.spirit-empty-msg{font-size:.82rem;color:var(--t2);margin-bottom:6px;font-weight:500}
.spirit-empty-hint{font-size:.62rem;color:var(--t3);line-height:1.6;margin-bottom:16px}
.empty-action{padding:10px 20px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.7rem;font-weight:600;cursor:pointer;margin-top:8px}
/* SPIRIT DETAIL */
.spirit-detail{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:14px;margin-top:8px;display:none}.spirit-detail.open{display:block;animation:fadeIn .2s ease-out}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:none}}
.sd-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}.sd-portrait{width:52px;height:52px;border-radius:12px;overflow:hidden;border:1px solid var(--card-border);flex-shrink:0}.sd-portrait img{width:100%;height:100%;object-fit:cover}
.sd-info{flex:1}.sd-name{font-size:.9rem;font-weight:600}.sd-stage{font-size:.55rem;color:var(--t2)}.sd-bio{font-size:.5rem;color:var(--t3);margin-top:2px;font-style:italic;line-height:1.3}
.sd-close{background:none;border:none;color:var(--t4);cursor:pointer;font-size:.8rem;padding:4px;align-self:flex-start}
.sd-section{font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.15em;margin:12px 0 6px;font-weight:500}
.sd-bar-wrap{display:flex;align-items:center;gap:8px}.sd-bar{flex:1;height:3px;background:var(--border);border-radius:3px;overflow:hidden}.sd-bar-fill{height:100%;background:var(--positive);border-radius:3px;transition:width .3s}.sd-lvl{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.55rem;color:var(--t3)}
.trait-tags{display:flex;flex-wrap:wrap;gap:3px}.trait-tag{padding:2px 8px;border-radius:8px;font-size:.5rem;font-weight:500;background:var(--card-bg);color:var(--t2);border:1px solid var(--card-border)}.trait-tag.positive{color:var(--positive);border-color:rgba(102,187,153,.12)}.trait-tag.neutral{color:var(--t3)}
.sd-evolve-btn{width:100%;margin-top:10px;padding:10px;border-radius:var(--radius-sm);border:none;background:var(--t1);color:var(--bg);font-family:inherit;font-size:.7rem;font-weight:600;cursor:pointer}.sd-evolve-btn:disabled{opacity:.15;cursor:not-allowed}.sd-evolve-cost{font-size:.55rem;color:var(--t3);text-align:center;margin-top:4px}
/* V1.3 POLISH: Typography hierarchy - section headers */
.section-label{font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.15em;margin-bottom:8px;margin-top:16px;font-weight:500}.section-label:first-child{margin-top:0}
.hatchery-grid{display:flex;gap:5px;flex-wrap:wrap}
.hatch-slot{flex:1;min-width:50px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:8px 4px;text-align:center;cursor:pointer;transition:all .2s;min-height:65px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px}.hatch-slot:hover{border-color:var(--border-l)}.hatch-slot.locked{opacity:.25;cursor:default}.hatch-slot.unlockable{border-color:var(--special);border-style:dashed;opacity:.7;cursor:pointer}
.hatch-slot.ready{border-color:var(--positive);animation:readyPulse 2s infinite}
.hatch-slot.starter{border-color:var(--positive);animation:starterGlow 1.5s ease-in-out infinite}
@keyframes readyPulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 10px rgba(102,187,153,.12)}}
@keyframes starterGlow{0%,100%{box-shadow:0 0 6px rgba(102,187,153,.1)}50%{box-shadow:0 0 14px rgba(102,187,153,.2)}}
.hatch-slot-icon{font-size:.9rem}.hatch-slot-label{font-size:.45rem;color:var(--t3)}.hatch-slot-timer{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.45rem;color:var(--t3)}.hatch-slot-rarity{font-size:.45rem;font-weight:500}
.hatch-slot-bar{width:80%;height:2px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:2px}.hatch-slot-bar-fill{height:100%;background:var(--t2);border-radius:2px}
.hatch-slot-eggs{font-size:.4rem;color:var(--t3);margin-top:1px}
.ing-grid{display:flex;flex-direction:column;gap:4px}.ing-row{display:flex;align-items:center;gap:8px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:7px 10px}
.ing-icon{font-size:.8rem;flex-shrink:0}.ing-name{font-size:.6rem;color:var(--t2);flex:1}.ing-count{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.7rem;font-weight:500}
.ing-swap{background:none;border:none;color:var(--t4);cursor:pointer;font-size:.65rem;padding:2px 6px;border-radius:4px}.ing-swap:hover{color:var(--t2);background:var(--glass-hover)}
.pill-grid{display:flex;flex-direction:column;gap:4px}
.pill-row{display:flex;align-items:center;gap:8px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:7px 10px;cursor:pointer;transition:border-color .15s}.pill-row:hover{border-color:var(--border-l)}.pill-row.disabled{opacity:.35;pointer-events:none}
.pill-icon{font-size:.8rem}.pill-info{flex:1}.pill-name{font-size:.6rem;font-weight:500}.pill-desc{font-size:.45rem;color:var(--t3)}.pill-cost{font-size:.45rem;color:var(--t3);white-space:nowrap}
/* VILLAGE */
.village-rank-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:14px;text-align:center;margin-bottom:10px}
.village-rank-label{font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:4px}.village-rank-name{font-family:‚ÄòFraunces‚Äô,serif;font-size:1.2rem;font-weight:500;margin-bottom:2px}.village-rank-desc{font-size:.55rem;color:var(--t2)}
.village-stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:10px}.village-stat{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:8px;text-align:center}
.village-stat-num{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.8rem;font-weight:500}.village-stat-label{font-size:.45rem;color:var(--t3);text-transform:uppercase;letter-spacing:.05em}
/* TOAST */
.toast{position:fixed;top:56px;left:16px;z-index:50;background:var(--toast-bg);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:1px solid var(--glass-border);border-radius:var(--radius);padding:12px 16px;display:flex;align-items:center;gap:10px;box-shadow:0 12px 40px rgba(0,0,0,.3);opacity:0;transform:translateX(-20px);transition:all .4s cubic-bezier(.34,1.56,.64,1);pointer-events:none}.toast.show{opacity:1;transform:translateX(0)}.toast-icon{font-size:1.2rem}.toast-text{font-size:.8rem;font-weight:500}.toast-sub{font-size:.5rem;color:var(--t3)}
/* MODAL */
.modal-bg{position:fixed;inset:0;z-index:50;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}.modal-bg.open{opacity:1;pointer-events:all}
.modal-box{background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:1px solid var(--glass-border);border-radius:var(--radius);width:90%;max-width:360px;padding:20px;text-align:center;transform:scale(.95);transition:transform .25s;max-height:80vh;overflow-y:auto}.modal-bg.open .modal-box{transform:scale(1)}
.modal-title{font-family:‚ÄòFraunces‚Äô,serif;font-size:1.1rem;font-weight:500;margin-bottom:10px}.modal-desc{font-size:.7rem;color:var(--t2);margin-bottom:12px;line-height:1.5}.modal-desc b{color:var(--t1)}
.modal-btn{padding:10px 20px;border-radius:var(--radius-sm);border:none;background:var(--t1);color:var(--bg);font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;margin:4px}.modal-btn:disabled{opacity:.15}.modal-btn.secondary{background:transparent;border:1px solid var(--glass-border);color:var(--t2)}
.modal-select-grid{display:flex;flex-direction:column;gap:5px;margin:8px 0;text-align:left}.modal-select-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);cursor:pointer}.modal-select-row:hover{border-color:var(--border-l)}
.pp-content{text-align:left;font-size:.65rem;color:var(--t2);line-height:1.6;max-height:60vh;overflow-y:auto}.pp-content h3{font-size:.75rem;color:var(--t1);margin:10px 0 4px}.pp-content p{margin-bottom:8px}
/* HATCH ANIM */
.hatch-overlay{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;opacity:0;pointer-events:none;transition:opacity .4s}.hatch-overlay.show{opacity:1;pointer-events:all}
.hatch-egg-anim{width:120px;height:120px;display:flex;align-items:center;justify-content:center;font-size:4rem;animation:eggShake .3s ease-in-out infinite}
@keyframes eggShake{0%,100%{transform:rotate(0)}25%{transform:rotate(-5deg)}75%{transform:rotate(5deg)}}
.hatch-egg-anim.crack{animation:eggCrack .6s ease-out forwards}
@keyframes eggCrack{0%{transform:scale(1)}30%{transform:scale(1.15)}60%{transform:scale(1.3);opacity:.8}100%{transform:scale(1.6);opacity:0}}
.hatch-reveal{opacity:0;transform:scale(.5);transition:all .6s cubic-bezier(.34,1.56,.64,1)}.hatch-reveal.show{opacity:1;transform:scale(1)}
.hatch-reveal img{width:128px;height:128px;border-radius:50%;border:3px solid var(--t1)}.hatch-reveal-name{font-family:‚ÄòFraunces‚Äô,serif;font-size:1.4rem;margin-top:12px;color:var(--t1)}.hatch-reveal-rarity{font-size:.7rem;margin-top:4px;font-weight:500}.hatch-reveal-tap{font-size:.55rem;color:var(--t4);margin-top:16px}
/* MOBILE */
@media(max-width:768px){
.content{flex-direction:column}
.video-area{flex:none;height:50vh;min-height:220px}
.sidebar{width:100%;min-width:unset;flex:1;border-left:none;border-top:1px solid var(--glass-border);min-height:0}
.player-strip{height:36px;min-height:36px;padding:0 10px;gap:6px}
.ps-play{width:24px;height:24px;font-size:.5rem}
.ps-title{font-size:.65rem}.ps-sub{font-size:.45rem}
.topbar{height:40px;min-height:40px;padding:0 12px}
.tb-brand{font-size:.85rem}
.tb-rank{padding:4px 8px}.tb-rank-name{font-size:.6rem}.tb-rank-pts{font-size:.5rem}
.tab-nav{padding:3px 8px}.tab-btn{padding:6px 0;font-size:.5rem}
.tab-panel{padding:8px}
.egg-progress{padding:6px 10px}
.spirit-card{padding:7px 8px;gap:8px}.spirit-card-img{width:38px;height:38px}.spirit-card-name{font-size:.7rem}.spirit-card-meta{font-size:.5rem}
.spirit-detail{padding:10px}.sd-portrait{width:44px;height:44px}
.hatch-slot{min-height:58px;padding:6px 3px}
.toast{top:44px;left:8px;padding:10px 12px}.toast-icon{font-size:1rem}.toast-text{font-size:.7rem}
.ing-row{padding:6px 8px}.pill-row{padding:6px 8px}
.section-label{font-size:.45rem;margin-bottom:4px}
.village-rank-card{padding:10px}.village-rank-name{font-size:1rem}
.village-stat{padding:6px}.village-stat-num{font-size:.7rem}
.wb-inner{padding:0 20px}.wb-msg{font-size:1.1rem}.wb-portrait{width:60px;height:60px}
}
@media(max-width:420px){.video-area{height:48vh;min-height:200px}}
/* Rank colors on topbar badge */
.tb-rank{transition:border-color .3s}
/* Spirit jiggle */
@keyframes spiritJiggle{0%{transform:rotate(0)}20%{transform:rotate(-3deg)}40%{transform:rotate(3deg)}60%{transform:rotate(-2deg)}80%{transform:rotate(1deg)}100%{transform:rotate(0)}}
.spirit-jiggle img{animation:spiritJiggle .4s ease-in-out}
/* Guest banner entrance */
@keyframes bannerSlideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
.guest-banner.show{animation:bannerSlideUp .6s cubic-bezier(.34,1.56,.64,1) forwards}
/* ‚ïê‚ïê‚ïê V1.5: SPIRIT INTERACTION BUBBLE ‚ïê‚ïê‚ïê */
.spirit-card{position:relative;overflow:visible}
.spirit-quip{position:absolute;top:-6px;left:50%;transform:translateX(-50%) translateY(-100%);background:var(--toast-bg);border:1px solid var(--glass-border);border-radius:8px;padding:4px 10px;font-size:.45rem;color:var(--t2);white-space:nowrap;max-width:200px;overflow:hidden;text-overflow:ellipsis;pointer-events:none;opacity:0;transition:opacity .3s,transform .3s;z-index:20;backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur)}.spirit-quip.show{opacity:1;transform:translateX(-50%) translateY(-100%) translateY(-2px)}
.spirit-quip::after{content:‚Äô‚Äô;position:absolute;bottom:-4px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:4px solid transparent;border-right:4px solid transparent;border-top:4px solid var(--glass-border)}
.sd-interact-area{cursor:pointer;position:relative;transition:transform .15s}.sd-interact-area:active{transform:scale(.95)}
.sd-interact-text{font-size:.55rem;color:var(--t2);font-style:italic;text-align:center;margin:6px 0;min-height:18px;line-height:1.4;opacity:0;transition:opacity .4s}.sd-interact-text.show{opacity:1}
/* ‚ïê‚ïê‚ïê V1.5: SPIRIT ALIGNMENT INDICATOR ‚ïê‚ïê‚ïê */
.spirit-alignment{font-size:.45rem;font-weight:500;margin-top:1px;display:flex;align-items:center;gap:3px}
.spirit-alignment.wicked{color:#c77}.spirit-alignment.heavenly{color:#daa520}
.sd-alignment{display:inline-flex;align-items:center;gap:4px;font-size:.5rem;font-weight:500;padding:2px 8px;border-radius:6px;margin-top:4px}
.sd-alignment.wicked{color:#c77;background:rgba(204,119,119,.08);border:1px solid rgba(204,119,119,.15)}
.sd-alignment.heavenly{color:#daa520;background:rgba(218,165,32,.08);border:1px solid rgba(218,165,32,.15)}
/* ‚ïê‚ïê‚ïê V1.5: PILLS TAB STYLES ‚ïê‚ïê‚ïê */
.jar-section{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:12px;margin-bottom:10px;text-align:center}
.jar-title{font-family:‚ÄòFraunces‚Äô,serif;font-size:.85rem;font-weight:500;margin-bottom:4px}.jar-desc{font-size:.5rem;color:var(--t3);line-height:1.4;margin-bottom:8px}
.jar-btn{padding:8px 20px;border-radius:var(--radius-sm);border:1px solid rgba(204,119,119,.25);background:rgba(204,119,119,.06);color:#c77;font-family:inherit;font-size:.65rem;font-weight:500;cursor:pointer;transition:all .2s}.jar-btn:hover{background:rgba(204,119,119,.12);border-color:rgba(204,119,119,.4)}.jar-btn:disabled{opacity:.25;cursor:not-allowed}
.presser-section{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:12px;margin-bottom:10px;text-align:center}
.presser-title{font-family:‚ÄòFraunces‚Äô,serif;font-size:.85rem;font-weight:500;margin-bottom:4px}.presser-desc{font-size:.5rem;color:var(--t3);line-height:1.4;margin-bottom:8px}
.wicked-inv{display:flex;flex-direction:column;gap:4px;margin:8px 0}
.wicked-pill-row{display:flex;align-items:center;gap:8px;background:rgba(204,119,119,.04);border:1px solid rgba(204,119,119,.12);border-radius:var(--radius-sm);padding:7px 10px;cursor:pointer;transition:border-color .15s}.wicked-pill-row:hover{border-color:rgba(204,119,119,.3)}
.heavenly-pill-row{display:flex;align-items:center;gap:8px;background:rgba(218,165,32,.04);border:1px solid rgba(218,165,32,.12);border-radius:var(--radius-sm);padding:7px 10px;cursor:pointer;transition:border-color .15s}.heavenly-pill-row:hover{border-color:rgba(218,165,32,.3)}
.heavenly-pill-row.disabled{opacity:.35;pointer-events:none}
.wpill-icon{font-size:.8rem}.wpill-info{flex:1;text-align:left}.wpill-name{font-size:.6rem;font-weight:500}.wpill-desc{font-size:.45rem;color:var(--t3)}.wpill-cost{font-size:.45rem;color:var(--t3);white-space:nowrap}
.essence-display{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px 12px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);margin-bottom:10px}
.essence-icon{font-size:.9rem}.essence-label{font-size:.6rem;color:var(--t2)}.essence-count{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.75rem;font-weight:500}
.dismiss-btn{padding:8px 16px;border-radius:var(--radius-sm);border:1px solid rgba(204,119,119,.2);background:rgba(204,119,119,.06);color:#c77;font-family:inherit;font-size:.55rem;font-weight:500;cursor:pointer;transition:all .2s}.dismiss-btn:hover{background:rgba(204,119,119,.15);border-color:rgba(204,119,119,.4)}
/* ‚ïê‚ïê‚ïê V1.5: RARE EGG SHIMMER ‚ïê‚ïê‚ïê */
.hatch-slot.rare-shimmer{position:relative;overflow:hidden}
.hatch-slot.rare-shimmer::after{content:‚Äô‚Äô;position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg,transparent,rgba(255,215,140,.1),transparent,rgba(200,180,255,.08),transparent);animation:eggShimmer 4s linear infinite;pointer-events:none;z-index:0}
@keyframes eggShimmer{to{transform:rotate(360deg)}}
.hatch-slot.rare-shimmer>*{position:relative;z-index:1}
/* ‚ïê‚ïê‚ïê V1.5: MILESTONE TOAST VARIANT ‚ïê‚ïê‚ïê */
.toast.milestone{border-color:rgba(218,165,32,.3);box-shadow:0 12px 40px rgba(0,0,0,.3),0 0 20px rgba(218,165,32,.1)}
/* ‚ïê‚ïê‚ïê V1.5: SPIRIT MOOD ‚Äî card mood indicator ‚ïê‚ïê‚ïê */
.spirit-card-mood{font-size:.45rem;color:var(--t3);margin-top:1px}
/* Craft hint pulse on Items tab */
@keyframes craftHintPulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 8px rgba(102,187,153,.4)}}
.tab-btn.hint{animation:craftHintPulse 2s ease-in-out 3;color:var(--positive)}
/* Spirit arrival overlay */
.spirit-arrival{position:fixed;inset:0;z-index:180;background:var(--bg);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .6s;pointer-events:none}.spirit-arrival.show{opacity:1;pointer-events:all}
.sa-inner{text-align:center;max-width:340px;padding:0 28px}
.sa-portrait{width:100px;height:100px;border-radius:50%;overflow:hidden;margin:0 auto 16px;border:2px solid var(--card-border)}.sa-portrait img{width:100%;height:100%;object-fit:cover}
.sa-name{font-family:‚ÄòFraunces‚Äô,serif;font-size:1.5rem;font-weight:500;margin-bottom:6px}
.sa-bio{font-size:.8rem;color:var(--t2);line-height:1.6;font-style:italic;margin-bottom:24px}
.sa-welcome{font-size:.65rem;color:var(--t3);margin-bottom:20px}
.sa-btn{padding:13px 32px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer}
/* Smoother XP bar transitions */
.spirit-card-xp-fill{transition:width 3s linear}
.sd-bar-fill{transition:width 3s linear}
/* Bio readability */
.sd-bio{color:var(--t2);font-size:.55rem}
/* Patch Notes */
.patch-overlay{position:fixed;inset:0;z-index:160;background:var(--bg);overflow-y:auto;opacity:0;pointer-events:none;transition:opacity .3s}.patch-overlay.show{opacity:1;pointer-events:all}
.patch-inner{max-width:600px;margin:0 auto;padding:24px 20px 60px}
.patch-close{position:fixed;top:12px;right:16px;z-index:161;background:var(--glass);border:1px solid var(--glass-border);border-radius:8px;color:var(--t2);font-size:.8rem;padding:6px 14px;cursor:pointer;font-family:inherit;backdrop-filter:var(--blur)}.patch-close:hover{color:var(--t1)}
.patch-banner{width:100%;border-radius:var(--radius);overflow:hidden;margin-bottom:20px;aspect-ratio:16/7;background:linear-gradient(135deg,#1a1028,#2a1a3a,#1a2030);display:flex;align-items:center;justify-content:center}
.patch-banner-text{font-family:‚ÄòFraunces‚Äô,serif;font-size:1.8rem;font-weight:500;color:#f5f5f5;text-align:center;line-height:1.3}
.patch-banner-sub{font-size:.7rem;color:var(--t3);text-align:center;margin-top:4px}
.patch-author{display:flex;align-items:center;gap:10px;margin-bottom:20px;padding:12px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm)}
.patch-author-img{width:36px;height:36px;border-radius:50%;overflow:hidden}.patch-author-img img{width:100%;height:100%;object-fit:cover}
.patch-author-name{font-size:.75rem;font-weight:600;color:var(--t1)}.patch-author-role{font-size:.5rem;color:var(--t3)}
.patch-date{font-size:.55rem;color:var(--t4);margin-left:auto}
.patch-body{font-size:.8rem;color:var(--t2);line-height:1.8}
.patch-body p{margin-bottom:14px}
.patch-body .patch-heading{font-family:‚ÄòFraunces‚Äô,serif;font-size:1rem;font-weight:500;color:var(--t1);margin:20px 0 8px}
.patch-social{display:flex;gap:8px;margin-top:20px;flex-wrap:wrap}
.patch-social a{padding:8px 16px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;color:var(--t2);font-size:.7rem;text-decoration:none;font-family:inherit}.patch-social a:hover{border-color:var(--border-l);color:var(--t1)}
/* PROFESSOR MOWANG TUTORIAL */
.prof-overlay{position:fixed;inset:0;z-index:190;background:var(--bg);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .5s}.prof-overlay.show{opacity:1;pointer-events:all}
.prof-inner{width:100%;max-width:400px;padding:0 28px;text-align:center}
.prof-portrait{width:88px;height:88px;border-radius:50%;overflow:hidden;margin:0 auto 12px;border:2px solid var(--card-border);position:relative}.prof-portrait img{width:100%;height:100%;object-fit:cover;position:relative;z-index:1}
.prof-portrait::after{content:‚Äô‚Äô;position:absolute;inset:-4px;border-radius:50%;background:conic-gradient(from 0deg,transparent,rgba(255,215,140,.25),transparent,rgba(255,240,200,.15),transparent);animation:auraRotate 3s linear infinite;z-index:0}
.prof-name{font-family:‚ÄòFraunces‚Äô,serif;font-size:1.1rem;font-weight:500;color:var(--t1);margin-bottom:2px}
.prof-role{font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.15em;margin-bottom:16px}
.prof-bubble{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:16px 18px;margin-bottom:20px;text-align:left;position:relative}
.prof-bubble::before{content:‚Äô‚Äô;position:absolute;top:-6px;left:50%;transform:translateX(-50%) rotate(45deg);width:12px;height:12px;background:var(--card-bg);border-left:1px solid var(--card-border);border-top:1px solid var(--card-border)}
.prof-bubble-text{font-size:.8rem;color:var(--t2);line-height:1.65}.prof-bubble-text b{color:var(--t1);font-weight:600}.prof-bubble-text .prof-highlight{color:var(--positive);font-weight:500}
.prof-dots{display:flex;gap:6px;justify-content:center;margin-bottom:18px}.prof-dot{width:8px;height:8px;border-radius:50%;background:var(--t4);transition:all .25s}.prof-dot.on{background:var(--t1);width:20px;border-radius:4px}
.prof-btn{padding:13px 32px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer;transition:transform .1s}.prof-btn:active{transform:scale(.97)}
.prof-skip{display:block;margin:10px auto 0;background:none;border:none;color:var(--t4);font-family:inherit;font-size:.65rem;cursor:pointer}
.prof-spirit-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0}
.prof-spirit-pick{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 4px;background:var(--card-bg);border:2px solid var(--card-border);border-radius:var(--radius-sm);cursor:pointer;transition:all .2s}
.prof-spirit-pick:hover{border-color:var(--border-l);background:var(--accent-soft)}
.prof-spirit-pick.selected{border-color:var(--positive);background:rgba(102,187,153,.08)}
.prof-spirit-pick img{width:48px;height:48px;border-radius:50%;object-fit:cover}
.prof-spirit-pick-name{font-size:.6rem;font-weight:600;color:var(--t1)}
.prof-spirit-pick-bio{font-size:.4rem;color:var(--t3);line-height:1.3;max-height:0;overflow:hidden;transition:max-height .3s}
.prof-spirit-pick.selected .prof-spirit-pick-bio{max-height:40px;margin-top:2px}
@media(max-width:768px){.prof-inner{padding:0 20px}.prof-portrait{width:72px;height:72px}.prof-bubble-text{font-size:.75rem}.prof-spirit-grid{gap:6px}.prof-spirit-pick img{width:40px;height:40px}}
/* ‚ïê‚ïê‚ïê EXPEDITIONS ‚ïê‚ïê‚ïê */
.exped-section{margin-top:14px}
.exped-slot{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:10px;margin-bottom:6px;position:relative}
.exped-slot.locked{opacity:.3;pointer-events:none}
.exped-slot-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.exped-slot-title{font-size:.6rem;font-weight:500;color:var(--t2)}
.exped-slot-status{font-size:.5rem;color:var(--t3)}
.exped-spirits{display:flex;gap:4px;margin-bottom:6px}
.exped-spirit-img{width:28px;height:28px;border-radius:50%;overflow:hidden;border:1px solid var(--card-border)}.exped-spirit-img img{width:100%;height:100%;object-fit:cover}
.exped-bar{width:100%;height:3px;background:var(--border);border-radius:3px;overflow:hidden;margin-bottom:4px}
.exped-bar-fill{height:100%;border-radius:3px;transition:width 1s linear}
.exped-bar-fill.active{background:var(--positive)}
.exped-bar-fill.resting{background:var(--special)}
.exped-timer{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.5rem;color:var(--t3);text-align:center}
.exped-btn{width:100%;padding:8px;border-radius:var(--radius-sm);border:none;background:var(--t1);color:var(--bg);font-family:inherit;font-size:.6rem;font-weight:600;cursor:pointer}.exped-btn:disabled{opacity:.15;cursor:not-allowed}
.exped-btn.claim{background:var(--positive);color:#050505;animation:readyPulse 2s infinite}
.exped-btn.secondary{background:transparent;border:1px solid var(--glass-border);color:var(--t2)}
/* Expedition send modal */
.exped-dur-grid{display:flex;gap:6px;margin:10px 0}
.exped-dur-opt{flex:1;padding:10px 6px;background:var(--card-bg);border:2px solid var(--card-border);border-radius:var(--radius-sm);cursor:pointer;text-align:center;transition:all .2s}
.exped-dur-opt:hover{border-color:var(--border-l)}
.exped-dur-opt.selected{border-color:var(--positive);background:rgba(102,187,153,.08)}
.exped-dur-label{font-size:.6rem;font-weight:600;color:var(--t1)}.exped-dur-time{font-size:.45rem;color:var(--t3)}
.exped-spirit-select{display:flex;flex-wrap:wrap;gap:5px;margin:8px 0;max-height:200px;overflow-y:auto}
.exped-spirit-opt{display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--card-bg);border:2px solid var(--card-border);border-radius:var(--radius-sm);cursor:pointer;transition:all .15s;width:100%}
.exped-spirit-opt:hover{border-color:var(--border-l)}
.exped-spirit-opt.selected{border-color:var(--positive);background:rgba(102,187,153,.06)}
.exped-spirit-opt.unavailable{opacity:.3;pointer-events:none}
.exped-spirit-opt img{width:28px;height:28px;border-radius:50%;object-fit:cover}
.exped-spirit-opt-info{flex:1;min-width:0}
.exped-spirit-opt-name{font-size:.6rem;font-weight:500}.exped-spirit-opt-lvl{font-size:.45rem;color:var(--t3)}
.exped-spirit-opt-check{width:14px;height:14px;border-radius:50%;border:1.5px solid var(--t4);display:flex;align-items:center;justify-content:center;font-size:.5rem;color:var(--positive);flex-shrink:0}
.exped-spirit-opt.selected .exped-spirit-opt-check{border-color:var(--positive);background:rgba(102,187,153,.15)}
/* On-expedition indicator on spirit cards */
.spirit-card.on-expedition{opacity:.55}.spirit-card.on-expedition::after{content:‚Äòüß≠‚Äô;position:absolute;top:6px;right:8px;font-size:.55rem}
.spirit-card{position:relative}
/* ‚ïê‚ïê‚ïê CULTIVATION STAGE (Spirit Detail) ‚ïê‚ïê‚ïê */
.sd-cult-stage{display:flex;align-items:center;gap:6px;margin:4px 0}
.sd-cult-label{font-size:.55rem;color:var(--t2);font-weight:500}
.sd-cult-dots{display:flex;gap:3px}
.sd-cult-dot{width:6px;height:6px;border-radius:50%;background:var(--t4);transition:all .3s}
.sd-cult-dot.on{background:var(--special);box-shadow:0 0 4px rgba(200,136,255,.3)}
.sd-cult-advance{width:100%;margin-top:6px;padding:8px;border-radius:var(--radius-sm);border:1px solid rgba(200,136,255,.2);background:rgba(200,136,255,.06);color:var(--special);font-family:inherit;font-size:.6rem;font-weight:600;cursor:pointer}.sd-cult-advance:disabled{opacity:.15;cursor:not-allowed}
.sd-cult-cost{font-size:.5rem;color:var(--t3);text-align:center;margin-top:3px}
/* √Ä·π£·∫π ingredient row highlight */
.ing-row.rare{border-color:rgba(200,136,255,.15);background:rgba(200,136,255,.04)}
/* ‚ïê‚ïê‚ïê V1.5 SESSION 7 ‚Äî new styles below ‚ïê‚ïê‚ïê */
/* Reconnecting overlay */
.reconnect-overlay{position:fixed;inset:0;z-index:250;background:var(--bg);display:flex;align-items:center;justify-content:center;transition:opacity .4s}
.reconnect-overlay.gone{opacity:0;pointer-events:none}
.reconnect-inner{text-align:center;padding:0 28px}
.reconnect-icon{font-size:2.5rem;margin-bottom:12px;animation:reconnectSpin 1.5s linear infinite}
@keyframes reconnectSpin{to{transform:rotate(360deg)}}
.reconnect-title{font-family:‚ÄòFraunces‚Äô,serif;font-size:1.3rem;font-weight:500;margin-bottom:6px}
.reconnect-sub{font-size:.7rem;color:var(--t3)}
/* Hatch share button */

/* YouTube fallback */
.yt-fallback{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;background:var(--bg)}
.yt-fallback-msg{font-size:.75rem;color:var(--t3);text-align:center;line-height:1.5}
.yt-fallback-btn{padding:10px 22px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer}
/* Disabled button feedback */
button.action-busy{opacity:.5;pointer-events:none}
/* Empty state action buttons */
.empty-action{padding:8px 16px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;color:var(--t2);font-family:inherit;font-size:.65rem;cursor:pointer;margin-top:8px;transition:all .15s}
.empty-action:hover{border-color:var(--border-l);color:var(--t1)}
/* Mobile touch targets ‚Äî min 44px */
@media(max-width:768px){
.spirit-card{min-height:52px}
.hatch-slot{min-height:62px;min-width:54px}
.pill-row{min-height:44px;padding:8px 10px}
.ing-row{min-height:44px}
.ing-swap{min-width:32px;min-height:32px;display:flex;align-items:center;justify-content:center}
.exped-btn{min-height:40px}
.sd-evolve-btn{min-height:44px}
.sd-cult-advance{min-height:40px}
.modal-btn{min-height:44px}
.modal-select-row{min-height:44px}
.tab-btn{min-height:36px}
}
/* Trait effect indicator */
.trait-tag.has-effect{position:relative;cursor:pointer}.trait-tag.has-effect::after{content:‚Äò‚ú¶‚Äô;margin-left:3px;font-size:.4rem;opacity:.6}
/* V2.3: Trait tap-to-reveal tooltips */
.trait-tag-wrap{display:inline-flex;flex-direction:column;align-items:flex-start}
.trait-desc{font-size:.42rem;color:var(--t3);padding:3px 0 1px;line-height:1.3;max-height:0;overflow:hidden;opacity:0;transition:max-height .25s ease,opacity .2s ease}
.trait-desc.show{max-height:40px;opacity:1}
.trait-tags{display:flex;flex-wrap:wrap;gap:4px}
/* Expedition spirit trait hints */
.exped-spirit-traits{font-size:.4rem;color:var(--positive);margin-top:1px;opacity:.7}
/* ‚ïê‚ïê‚ïê V1.4: SPIRIT MOOD INDICATORS ‚ïê‚ïê‚ïê */
.spirit-card-mood{font-size:.5rem;color:var(--t3);display:flex;align-items:center;gap:3px;margin-top:1px}
.spirit-card-img.mood-happy::after{content:‚Äô‚Äô;position:absolute;top:-2px;right:-2px;width:8px;height:8px;border-radius:50%;background:var(--positive);z-index:2;animation:moodPulse 2.5s ease-in-out infinite}
.spirit-card-img.mood-energized::after{content:‚Äô‚Äô;position:absolute;top:-2px;right:-2px;width:8px;height:8px;border-radius:50%;background:var(--special);z-index:2;animation:moodPulse 2s ease-in-out infinite}
.spirit-card-img.mood-sleepy{filter:brightness(.85) saturate(.8)}
.spirit-card-img.mood-sleepy::after{content:‚Äô‚Äô;position:absolute;top:-2px;right:-2px;width:8px;height:8px;border-radius:50%;background:var(--t4);z-index:2}
@keyframes moodPulse{0%,100%{opacity:.6;transform:scale(.8)}50%{opacity:1;transform:scale(1.1)}}
/* ‚ïê‚ïê‚ïê V1.4: DAILY STREAK ‚ïê‚ïê‚ïê */
.streak-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:6px;display:flex;align-items:center;gap:10px}
.streak-fire{font-size:1.1rem;flex-shrink:0}
.streak-info{flex:1;min-width:0}
.streak-count{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.75rem;font-weight:600}
.streak-label{font-size:.45rem;color:var(--t3);text-transform:uppercase;letter-spacing:.06em}
.streak-bonus{font-size:.45rem;color:var(--positive);margin-top:1px}
.streak-dots{display:flex;gap:3px;margin-left:auto}
.streak-dot{width:6px;height:6px;border-radius:50%;background:var(--t4);transition:all .3s}
.streak-dot.on{background:#f59e42;box-shadow:0 0 4px rgba(245,158,66,.3)}
/* ‚ïê‚ïê‚ïê V1.4: ACHIEVEMENTS ‚ïê‚ïê‚ïê */
.achieve-section{margin-top:10px}
.achieve-grid{display:flex;flex-wrap:wrap;gap:4px}
.achieve-badge{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);font-size:.5rem;color:var(--t3);transition:all .25s}
.achieve-badge.earned{color:var(--t1);border-color:rgba(255,215,140,.15);background:rgba(255,215,140,.04)}
.achieve-badge.earned .achieve-icon{opacity:1}
.achieve-icon{font-size:.7rem;opacity:.3}
.achieve-name{font-weight:500}
/* ‚ïê‚ïê‚ïê V2.3: STREAM SWITCHER ‚ïê‚ïê‚ïê */
.stream-switcher{display:flex;gap:6px;padding:6px 12px;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-top:1px solid var(--glass-border);flex-shrink:0}
.stream-pill{flex:1;padding:6px 10px;background:transparent;border:1px solid var(--glass-border);border-radius:20px;color:var(--t3);font-family:inherit;font-size:.6rem;font-weight:500;cursor:pointer;letter-spacing:.03em;transition:all .2s cubic-bezier(.4,0,.2,1);white-space:nowrap}
.stream-pill:hover{border-color:var(--border-l);color:var(--t2);background:var(--accent-dim)}
.stream-pill.active{background:var(--accent-soft);border-color:var(--border-l);color:var(--t1)}
[data-theme=‚Äúlight‚Äù] .stream-pill.active{background:rgba(0,0,0,.06);border-color:rgba(0,0,0,.15);color:var(--t1)}

.hatch-overlay{transition:background .6s}
.hatch-overlay.rarity-mundane{background:rgba(0,0,0,.85)}
.hatch-overlay.rarity-adept{background:rgba(10,15,30,.88)}
.hatch-overlay.rarity-refined{background:rgba(10,25,15,.88)}
.hatch-overlay.rarity-illustrious{background:rgba(30,20,5,.9)}
.hatch-overlay.rarity-sovereign{background:rgba(25,15,30,.9)}
.hatch-overlay.rarity-celestial{background:rgba(5,15,35,.92)}
.hatch-overlay.rarity-transcendent{background:rgba(35,20,5,.92)}
.hatch-overlay.rarity-mysterious{background:rgba(25,10,35,.92)}
.hatch-overlay.rarity-ancestral{background:rgba(35,10,10,.92)}
.hatch-overlay.rarity-paradox{background:rgba(15,15,15,.95)}
/* Rarity bonus XP indicator on hatch reveal */
.hatch-reveal-bonus{font-size:.55rem;color:var(--positive);margin-top:6px;opacity:0;animation:bonusFadeIn .8s ease .3s forwards}
@keyframes bonusFadeIn{to{opacity:1}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
V2.6 CSS ‚Äî TRAITS, JOURNAL, CULTIVATION, LIBRARY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ‚îÄ TRAIT SECTION IN SPIRIT DETAIL ‚îÄ‚îÄ‚îÄ */
.sd-trait-slots{font-size:.42rem;color:var(--t4);font-weight:400;font-family:‚ÄòJetBrains Mono‚Äô,monospace;margin-left:6px}
.sd-traits{display:flex;flex-direction:column;gap:4px;margin-bottom:6px}
.sd-traits-empty{font-size:.5rem;color:var(--t4);padding:8px 0;font-style:italic}
.sd-trait-cat{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:6px 8px;margin-bottom:3px}
.sd-trait-cat-label{font-size:.45rem;text-transform:uppercase;letter-spacing:.1em;font-weight:600;display:block;margin-bottom:4px}
.sd-trait-row{display:flex;align-items:center;gap:6px;padding:2px 0;cursor:pointer}
.sd-trait-row:hover .sd-trait-name{text-decoration:underline}
.sd-trait-name{font-size:.62rem;font-weight:500;flex-shrink:0}
.sd-trait-effect{font-size:.48rem;color:var(--t3);flex:1;text-align:right}
.sd-trait-desc{font-size:.48rem;color:var(--t3);font-style:italic;padding:3px 6px;margin-top:1px;background:rgba(255,255,255,.02);border-radius:3px;max-height:0;overflow:hidden;opacity:0;transition:all .2s}
.sd-trait-desc.show{max-height:60px;opacity:1}
.sd-trait-slot-empty{font-size:.48rem;color:var(--t4);padding:5px 8px;border:1px dashed var(--border);border-radius:var(--radius-sm);text-align:center}

/* ‚îÄ‚îÄ‚îÄ SPIRIT JOURNAL ‚îÄ‚îÄ‚îÄ */
.sd-journal{display:flex;flex-direction:column;gap:3px}
.sd-journal-empty{font-size:.5rem;color:var(--t4);padding:6px 0;font-style:italic}
.sd-journal-entry{display:flex;align-items:baseline;gap:6px;padding:5px 8px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm)}
.sd-journal-ico{font-size:.7rem;flex-shrink:0}
.sd-journal-desc{font-size:.52rem;color:var(--t2);flex:1;line-height:1.4}
.sd-journal-date{font-size:.42rem;color:var(--t4);flex-shrink:0;font-family:‚ÄòJetBrains Mono‚Äô,monospace}

/* ‚îÄ‚îÄ‚îÄ CULTIVATION MODAL ‚îÄ‚îÄ‚îÄ */
.cult-modal-path{display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);margin:8px 0;justify-content:center}
.cult-modal-from{font-size:.62rem;color:var(--t3)}
.cult-modal-arrow{font-size:.7rem;color:var(--t4)}
.cult-modal-to{font-size:.62rem;font-weight:600;color:var(--positive)}
.cult-modal-reqs{display:flex;flex-direction:column;gap:5px;margin:8px 0}
.cult-modal-req{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-radius:var(--radius-sm);font-size:.55rem;border:1px solid var(--border)}
.cult-modal-req.met{background:rgba(102,187,153,.04);border-color:rgba(102,187,153,.15);color:var(--t2)}
.cult-modal-req.met span:last-child{color:var(--positive);font-family:‚ÄòJetBrains Mono‚Äô,monospace}
.cult-modal-req.unmet{background:rgba(204,100,100,.04);border-color:rgba(204,100,100,.15);color:var(--t3)}
.cult-modal-req.unmet span:last-child{color:var(--negative)}
.cult-modal-listen-bar{height:3px;background:var(--border);border-radius:2px;margin:-3px 0 2px;overflow:hidden}
.cult-modal-listen-fill{height:100%;background:var(--special);border-radius:2px;transition:width .4s}

/* ‚îÄ‚îÄ‚îÄ CULTIVATION LISTEN PROGRESS IN SPIRIT DETAIL ‚îÄ‚îÄ‚îÄ */
.sd-cult-listen{margin:4px 0}
.sd-cult-listen-bar{height:3px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:2px}
.sd-cult-listen-fill{height:100%;background:var(--special);border-radius:2px}

/* ‚îÄ‚îÄ‚îÄ LIBRARY LOOT REVEAL (tooltip on location in expedition modal) ‚îÄ‚îÄ‚îÄ */
.exped-loc-opt.researched .exped-loc-header::after{content:‚ÄòResearched‚Äô;font-size:.38rem;color:var(--special);margin-left:auto;padding:1px 5px;border:1px solid rgba(200,136,255,.2);border-radius:4px}
.exped-loot-item.researched{opacity:1}
.exped-loot-rate{font-size:.42rem;color:var(--t4);font-family:‚ÄòJetBrains Mono‚Äô,monospace;margin-left:4px}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
V2.5 CSS ‚Äî EXPEDITION LOCATIONS, BUILDINGS, INVENTORY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ‚îÄ EXPEDITION MODAL: LOCATION PICKER ‚îÄ‚îÄ‚îÄ */
.exped-section-label{font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:6px;font-weight:500}
.exped-loc-grid{display:flex;flex-direction:column;gap:4px}
.exped-loc-opt{padding:8px 10px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);cursor:pointer;transition:all .15s}
.exped-loc-opt:hover{border-color:var(--border-l);background:var(--accent-soft)}
.exped-loc-opt.selected{border-color:var(--positive);background:rgba(102,187,153,.06)}
.exped-loc-opt.locked{opacity:.4;cursor:default;pointer-events:none}
.exped-loc-header{display:flex;align-items:center;gap:6px;margin-bottom:2px}
.exped-loc-emoji{font-size:.9rem;flex-shrink:0}
.exped-loc-name{font-size:.65rem;font-weight:600;flex:1}
.exped-loc-req{font-size:.45rem;color:var(--negative);padding:1px 5px;border:1px solid rgba(204,100,100,.2);border-radius:4px}
.exped-loc-desc{font-size:.48rem;color:var(--t3);line-height:1.4;padding-left:2px}

/* ‚îÄ‚îÄ‚îÄ EXPEDITION MODAL: LOOT PREVIEW ‚îÄ‚îÄ‚îÄ */
.exped-loot-preview{margin:8px 0;padding:8px 10px;background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:var(--radius-sm)}
.exped-loot-title{font-size:.48rem;color:var(--t3);margin-bottom:5px;text-transform:uppercase;letter-spacing:.1em}
.exped-loot-items{display:flex;flex-wrap:wrap;gap:4px}
.exped-loot-item{font-size:.5rem;padding:2px 7px;border-radius:10px;background:var(--card-bg);border:1px solid var(--card-border)}
.exped-loot-item.rarity-common{color:var(--t2)}
.exped-loot-item.rarity-uncommon{color:var(--positive);border-color:rgba(102,187,153,.2)}
.exped-loot-item.rarity-rare{color:var(--special);border-color:rgba(200,136,255,.2)}

/* ‚îÄ‚îÄ‚îÄ EXPEDITION SLOT: LOCATION BADGE ‚îÄ‚îÄ‚îÄ */
.exped-slot-location{font-size:.45rem;color:var(--t3);margin-top:2px}

/* ‚îÄ‚îÄ‚îÄ LOOT REVEAL SCREEN ‚îÄ‚îÄ‚îÄ */
.loot-reveal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:0;opacity:0;pointer-events:none;transition:opacity .3s}
.loot-reveal-overlay.show{opacity:1;pointer-events:all}
.loot-reveal-inner{width:min(320px,90vw);display:flex;flex-direction:column;gap:10px}
.loot-reveal-header{text-align:center}
.loot-reveal-title{font-family:‚ÄòFraunces‚Äô,serif;font-size:1.2rem;font-weight:500;margin-bottom:3px}
.loot-reveal-flavor{font-size:.58rem;color:var(--t3);font-style:italic;line-height:1.5}
.loot-reveal-spirits{display:flex;justify-content:center;gap:8px;margin:8px 0}
.loot-reveal-spirit{display:flex;flex-direction:column;align-items:center;gap:3px}
.loot-reveal-spirit img{width:40px;height:40px;border-radius:50%;border:1px solid var(--card-border)}
.loot-reveal-spirit-name{font-size:.42rem;color:var(--t3)}
.loot-reveal-items{display:flex;flex-direction:column;gap:4px}
.loot-reveal-item{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);opacity:0;transform:translateY(6px);transition:all .3s}
.loot-reveal-item.visible{opacity:1;transform:translateY(0)}
.loot-reveal-item-icon{font-size:1.1rem;flex-shrink:0}
.loot-reveal-item-name{flex:1;font-size:.65rem;font-weight:500}
.loot-reveal-item-qty{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.6rem;color:var(--positive)}
.loot-reveal-item.is-rare{border-color:rgba(200,136,255,.25);background:rgba(200,136,255,.04)}
.loot-reveal-item.is-rare .loot-reveal-item-qty{color:var(--special)}
.loot-reveal-tap{font-size:.5rem;color:var(--t4);text-transform:uppercase;letter-spacing:.15em;text-align:center;margin-top:8px;animation:evoBlink 1.5s ease-in-out infinite 1s}

/* ‚îÄ‚îÄ‚îÄ INVENTORY TAB ‚îÄ‚îÄ‚îÄ */
.inv-section-label{font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.12em;margin:14px 0 6px;font-weight:500}
.inv-section-label:first-child{margin-top:0}
.inv-empty{font-size:.55rem;color:var(--t4);text-align:center;padding:10px 0;font-style:italic}

/* Drinks */
.inv-drinks-grid{display:flex;flex-direction:column;gap:4px}
.inv-drink-row{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);cursor:pointer;transition:all .15s}
.inv-drink-row:hover{border-color:var(--border-l);background:var(--accent-soft)}
.inv-drink-icon{font-size:1rem;flex-shrink:0}
.inv-drink-info{flex:1;min-width:0}
.inv-drink-name{font-size:.65rem;font-weight:500}
.inv-drink-desc{font-size:.48rem;color:var(--t3);margin-top:1px}
.inv-drink-expiry{font-size:.42rem;color:var(--t4)}
.inv-drink-use{font-size:.5rem;color:var(--positive);font-weight:500;flex-shrink:0}

/* Materials */
.inv-materials-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.inv-mat-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm)}
.inv-mat-icon{font-size:.85rem;flex-shrink:0}
.inv-mat-info{flex:1;min-width:0}
.inv-mat-name{font-size:.55rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.inv-mat-qty{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.6rem;color:var(--t2)}

/* Ingredients (moved from items tab) */
.ing-grid{display:flex;flex-direction:column;gap:4px}
.ing-row{display:flex;align-items:center;gap:8px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:8px 10px}
.ing-icon{font-size:.8rem;flex-shrink:0}.ing-name{font-size:.6rem;color:var(--t2);flex:1}
.ing-count{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.7rem;font-weight:500}
.ing-swap{background:none;border:none;color:var(--t4);cursor:pointer;font-size:.65rem;padding:2px 6px;border-radius:4px}.ing-swap:hover{color:var(--t2);background:var(--glass-hover)}

/* ‚îÄ‚îÄ‚îÄ BUILDINGS SECTION (Village tab) ‚îÄ‚îÄ‚îÄ */
.buildings-grid{display:flex;flex-direction:column;gap:8px;margin-top:4px}
.building-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:12px 14px;transition:all .2s}
.building-card.unlocked{border-color:var(--border-l)}
.building-card.locked{opacity:.7}
.building-card-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.building-card-emoji{font-size:1.2rem;flex-shrink:0}
.building-card-info{flex:1;min-width:0}
.building-card-name{font-size:.72rem;font-weight:600;line-height:1.2}
.building-card-desc{font-size:.5rem;color:var(--t3);margin-top:1px;font-style:italic}
.building-card-badge{font-size:.42rem;padding:2px 7px;border-radius:8px;font-weight:500}
.building-card-badge.active{background:rgba(102,187,153,.1);color:var(--positive);border:1px solid rgba(102,187,153,.2)}
.building-card-badge.locked{background:var(--card-bg);color:var(--t4);border:1px solid var(--border)}
.building-buff{font-size:.48rem;color:var(--t2);margin-bottom:6px;padding:5px 8px;background:rgba(255,255,255,.03);border-radius:4px;border-left:2px solid var(--border-l)}
/* Staff slots */
.building-staff-row{display:flex;align-items:center;gap:8px;padding:5px 0;border-top:1px solid var(--border)}
.building-staff-row:first-child{border-top:none}
.building-staff-label{font-size:.48rem;color:var(--t3);width:70px;flex-shrink:0}
.building-staff-slot{display:flex;align-items:center;gap:6px;flex:1}
.building-staff-spirit{display:flex;align-items:center;gap:5px;padding:3px 7px;background:var(--accent-soft);border:1px solid var(--border-l);border-radius:20px;cursor:pointer;transition:all .15s}
.building-staff-spirit:hover{background:var(--glass-hover)}
.building-staff-spirit img{width:18px;height:18px;border-radius:50%;object-fit:cover}
.building-staff-spirit-name{font-size:.5rem;font-weight:500;white-space:nowrap}
.building-staff-empty{font-size:.5rem;color:var(--t4);padding:3px 7px;background:var(--card-bg);border:1px dashed var(--border);border-radius:20px;cursor:pointer;transition:all .15s}
.building-staff-empty:hover{border-color:var(--border-l);color:var(--t2)}
/* Unlock section */
.building-unlock{margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
.building-unlock-cost{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px}
.building-unlock-mat{font-size:.48rem;padding:2px 7px;border-radius:8px;border:1px solid var(--border);display:flex;align-items:center;gap:3px}
.building-unlock-mat.has{color:var(--positive);border-color:rgba(102,187,153,.2)}
.building-unlock-mat.missing{color:var(--t4)}
.building-unlock-btn{width:100%;padding:7px;border:none;border-radius:var(--radius-sm);background:var(--t1);color:var(--bg);font-family:inherit;font-size:.6rem;font-weight:600;cursor:pointer}
.building-unlock-btn:disabled{opacity:.25;cursor:not-allowed}

/* ‚îÄ‚îÄ‚îÄ STAFF ASSIGN MODAL ‚îÄ‚îÄ‚îÄ */
.staff-modal-role{font-size:.5rem;color:var(--special);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px}
.staff-modal-current{display:flex;align-items:center;gap:8px;padding:8px;background:rgba(200,136,255,.06);border:1px solid rgba(200,136,255,.15);border-radius:var(--radius-sm);margin-bottom:10px}
.staff-modal-current img{width:28px;height:28px;border-radius:50%;object-fit:cover}
.staff-modal-unassign{font-size:.5rem;color:var(--negative);cursor:pointer;margin-left:auto;padding:3px 8px;border:1px solid rgba(204,100,100,.2);border-radius:4px}

/* ‚ïê‚ïê‚ïê V2.4: EVOLUTION CEREMONY ‚ïê‚ïê‚ïê */
.evo-ceremony{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.92);opacity:0;pointer-events:none;transition:opacity .3s}
.evo-ceremony.show{opacity:1;pointer-events:all}
.evo-ceremony-flash{position:absolute;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:1}
.evo-ceremony-content{position:relative;z-index:2;text-align:center;display:flex;flex-direction:column;align-items:center;gap:14px}
.evo-ceremony-label{font-size:.6rem;color:var(--t3);text-transform:uppercase;letter-spacing:.2em;opacity:0;transform:translateY(8px);transition:all .5s .2s}
.evo-ceremony.show .evo-ceremony-label{opacity:1;transform:translateY(0)}
.evo-ceremony-portrait{width:120px;height:120px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,.15);opacity:0;transform:scale(.7);transition:all .6s .35s cubic-bezier(.34,1.56,.64,1)}
.evo-ceremony.show .evo-ceremony-portrait{opacity:1;transform:scale(1)}
.evo-ceremony-portrait img{width:100%;height:100%;object-fit:cover}
.evo-ceremony-name{font-family:‚ÄòFraunces‚Äô,serif;font-size:1.6rem;font-weight:500;opacity:0;transform:translateY(6px);transition:all .5s .5s}
.evo-ceremony.show .evo-ceremony-name{opacity:1;transform:translateY(0)}
.evo-ceremony-stage{font-size:.75rem;font-weight:500;letter-spacing:.05em;opacity:0;transition:all .5s .65s}
.evo-ceremony.show .evo-ceremony-stage{opacity:1}
.evo-ceremony-tap{font-size:.55rem;color:var(--t4);letter-spacing:.15em;text-transform:uppercase;position:absolute;bottom:40px;left:0;right:0;text-align:center;opacity:0;animation:evoBlink 1.5s ease-in-out infinite 1.5s}
@keyframes evoBlink{0%,100%{opacity:.3}50%{opacity:.7}}
.evo-particles{position:absolute;inset:0;pointer-events:none;z-index:3}

/* ‚ïê‚ïê‚ïê V2.4: VILLAGE RANK TOOLTIP ‚ïê‚ïê‚ïê */
.tb-rank{position:relative;cursor:default}
.rank-tooltip{position:absolute;top:calc(100% + 8px);right:0;z-index:60;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:1px solid var(--glass-border);border-radius:var(--radius-sm);padding:10px 14px;min-width:200px;box-shadow:0 8px 24px rgba(0,0,0,.3);opacity:0;pointer-events:none;transform:translateY(-4px);transition:all .2s}
.rank-tooltip.show{opacity:1;pointer-events:all;transform:translateY(0)}
.rank-tooltip-title{font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:8px;font-weight:500}
.rank-tooltip-row{font-size:.6rem;color:var(--t2);padding:4px 0;display:flex;align-items:center;gap:6px;border-bottom:1px solid var(--border)}
.rank-tooltip-row:last-child{border-bottom:none}
.rank-tooltip-rank{font-weight:600}
.rank-tooltip-row.current{background:var(--accent-dim);margin:0 -4px;padding:4px 4px;border-radius:4px;border-bottom:none}
.rank-tooltip-row.current .rank-tooltip-rank{color:var(--t1)}
.rank-tooltip-pts{font-family:‚ÄòJetBrains Mono‚Äô,monospace;font-size:.5rem;color:var(--t4);margin-left:auto}

/* ‚ïê‚ïê‚ïê V2.4: XP PULSE ‚ïê‚ïê‚ïê */
.spirit-card-xp-fill::after{content:‚Äô‚Äô;position:absolute;top:0;left:-60%;width:60%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent);border-radius:4px;opacity:0;transition:opacity .5s}
body.music-playing .spirit-card-xp-fill::after{opacity:1;animation:xpCrawl 3s linear infinite}
@keyframes xpCrawl{0%{left:-60%}100%{left:110%}}
.sd-bar-fill::after{content:‚Äô‚Äô;position:absolute;top:0;left:-60%;width:60%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.45),transparent);opacity:0;transition:opacity .5s}
body.music-playing .sd-bar-fill::after{opacity:1;animation:xpCrawl 3s linear infinite}

/* ‚ïê‚ïê‚ïê V2.4: VILLAGE CLEAN ‚ïê‚ïê‚ïê */
.streak-card,.achieve-section,.achieve-grid{display:none}
.village-rank-bar{height:3px;background:var(--border);border-radius:3px;overflow:hidden;margin:8px 0 4px}
.village-rank-bar-fill{height:100%;border-radius:3px;transition:width 1s ease}
.village-rank-next{font-size:.5rem;color:var(--t4)}
.village-rank-card{padding:18px;margin-bottom:12px}

/* ‚ïê‚ïê‚ïê V2.4: SPIRIT DETAIL XP ‚ïê‚ïê‚ïê */
.sd-bar{flex:1;height:5px;background:var(--border);border-radius:5px;overflow:hidden;position:relative}
.sd-bar-fill{height:100%;background:var(--positive);border-radius:5px;transition:width 1.5s cubic-bezier(.4,0,.2,1);position:relative}

/* ‚ïê‚ïê‚ïê V2.4: MOBILE ‚ïê‚ïê‚ïê */
@media(max-width:768px){
.evo-ceremony-portrait{width:100px;height:100px}
.evo-ceremony-name{font-size:1.3rem}
.evo-ceremony-tap{bottom:60px}
}

/* ‚ïê‚ïê‚ïê SPIRIT DETAIL OVERLAY ‚ïê‚ïê‚ïê */
.spirit-overlay{position:fixed;inset:0;z-index:190;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);opacity:1;transition:opacity .3s;padding:16px;box-sizing:border-box}
.spirit-overlay.gone{opacity:0;pointer-events:none}
.spirit-overlay-inner{width:100%;max-width:420px;max-height:90dvh;overflow-y:auto;background:var(--glass);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:1px solid var(--glass-border);border-radius:var(--radius);padding:16px;animation:sdOverlayIn .3s cubic-bezier(.34,1.56,.64,1)}
@keyframes sdOverlayIn{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}

/* ‚ïê‚ïê‚ïê V2.8 CSS ‚ïê‚ïê‚ïê */

/* Rename button */
.sd-rename-btn{background:none;border:1px dashed var(--border);border-radius:6px;color:var(--t3);font-family:inherit;font-size:.55rem;padding:4px 12px;cursor:pointer;transition:all .15s}
.sd-rename-btn:hover{border-color:var(--border-l);color:var(--t2)}

/* Village buildings ‚Äî new 2√óN grid */
.buildings-grid-v2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.building-tile{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius);padding:12px 10px;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:6px;text-align:center;position:relative;min-height:90px;justify-content:center}
.building-tile:hover{border-color:var(--border-l);background:var(--accent-soft);transform:translateY(-1px)}
.building-tile.unlocked{border-color:rgba(102,187,153,.2)}
.building-tile.locked{opacity:.6}
.building-tile.cafe-default{border-color:rgba(102,187,153,.25);background:rgba(102,187,153,.04)}
.building-tile-emoji{font-size:1.6rem}
.building-tile-name{font-size:.6rem;font-weight:600;color:var(--t1)}
.building-tile-desc{font-size:.45rem;color:var(--t3);line-height:1.4}
.building-tile-badge{position:absolute;top:6px;right:6px;font-size:.38rem;padding:2px 6px;border-radius:10px;font-weight:600;letter-spacing:.04em}
.building-tile-badge.open{background:rgba(102,187,153,.15);color:var(--positive)}
.building-tile-badge.locked{background:rgba(255,255,255,.05);color:var(--t4)}
.building-tile-staff{display:flex;justify-content:center;gap:3px;margin-top:2px}
.building-tile-staff-pip{width:14px;height:14px;border-radius:50%;overflow:hidden;border:1px solid var(--card-border)}
.building-tile-staff-pip img{width:100%;height:100%;object-fit:cover}
.building-tile-staff-pip.empty{background:var(--border);display:flex;align-items:center;justify-content:center;font-size:.35rem;color:var(--t4)}

/* Building modal (full-screen Mowang-style) */
.building-modal-overlay{position:fixed;inset:0;z-index:195;background:rgba(0,0,0,.7);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .3s}
.building-modal-overlay.open{opacity:1;pointer-events:all}
.building-modal-sheet{width:100%;max-width:480px;max-height:88dvh;overflow-y:auto;background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);padding:0 0 env(safe-area-inset-bottom);animation:modalCenter .3s cubic-bezier(.34,1.4,.64,1)}@keyframes modalCenter{from{opacity:0;transform:scale(.93) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}@media(max-width:768px){.building-modal-overlay{align-items:flex-end;padding:0}.building-modal-sheet{border-radius:var(--radius) var(--radius) 0 0;animation:sheetUp .35s cubic-bezier(.34,1.4,.64,1)}}
@keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.building-modal-header{display:flex;align-items:center;gap:12px;padding:16px 16px 12px;border-bottom:1px solid var(--border)}
.building-modal-emoji{font-size:2rem;flex-shrink:0}
.building-modal-title{font-family:‚ÄòFraunces‚Äô,serif;font-size:1.15rem;font-weight:500;color:var(--t1)}
.building-modal-subtitle{font-size:.55rem;color:var(--t3);margin-top:2px}
.building-modal-close{margin-left:auto;background:none;border:none;color:var(--t3);font-size:1rem;cursor:pointer;padding:6px;line-height:1}
.building-modal-body{padding:14px 16px}
.bm-section{font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.12em;font-weight:500;margin:12px 0 6px}
.bm-section:first-child{margin-top:0}
.bm-buff{display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(102,187,153,.06);border:1px solid rgba(102,187,153,.12);border-radius:var(--radius-sm);font-size:.55rem;color:var(--positive);margin-bottom:8px}
.bm-staff-row{display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);margin-bottom:5px;cursor:pointer;transition:all .15s}
.bm-staff-row:hover{border-color:var(--border-l);background:var(--accent-soft)}
.bm-staff-role{font-size:.5rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;min-width:60px}
.bm-staff-avatar{width:28px;height:28px;border-radius:50%;overflow:hidden;border:1px solid var(--card-border);flex-shrink:0}
.bm-staff-avatar img{width:100%;height:100%;object-fit:cover}
.bm-staff-avatar.empty{background:var(--border);display:flex;align-items:center;justify-content:center;font-size:.7rem}
.bm-staff-name{font-size:.6rem;font-weight:500;flex:1}
.bm-staff-detail{font-size:.45rem;color:var(--t3)}
.bm-unlock-cost{display:flex;flex-wrap:wrap;gap:5px;margin:8px 0}
.bm-unlock-mat{font-size:.5rem;padding:4px 10px;border-radius:8px;border:1px solid var(--border);display:flex;align-items:center;gap:4px}
.bm-unlock-mat.has{color:var(--positive);border-color:rgba(102,187,153,.25);background:rgba(102,187,153,.04)}
.bm-unlock-mat.missing{color:var(--t4)}
.bm-unlock-btn{width:100%;padding:12px;border:none;border-radius:var(--radius-sm);background:var(--t1);color:var(--bg);font-family:inherit;font-size:.7rem;font-weight:600;cursor:pointer;margin-top:8px;transition:opacity .2s}
.bm-unlock-btn:disabled{opacity:.25;cursor:not-allowed}
.bm-cafe-drink{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);margin-bottom:4px}
.bm-cafe-drink-name{font-size:.6rem;font-weight:500;flex:1}
.bm-cafe-drink-desc{font-size:.45rem;color:var(--t3)}
.bm-cafe-drink-tier{font-size:.42rem;color:var(--special);padding:1px 5px;border:1px solid rgba(200,136,255,.2);border-radius:4px;flex-shrink:0}

/* Expedition loot multiplier hint */
.exped-spirit-count-hint{font-size:.5rem;color:var(--positive);text-align:center;padding:5px 8px;background:rgba(102,187,153,.06);border:1px solid rgba(102,187,153,.1);border-radius:var(--radius-sm);margin-top:4px;transition:all .2s}

/* Evolution ceremony V2.8 ‚Äî enhanced */
.evo-ceremony-ring{position:absolute;width:180px;height:180px;border-radius:50%;border:1.5px solid rgba(255,255,255,.08);top:50%;left:50%;transform:translate(-50%,-60%);z-index:1;pointer-events:none}
.evo-ceremony-ring-2{position:absolute;width:240px;height:240px;border-radius:50%;border:1px solid rgba(255,255,255,.04);top:50%;left:50%;transform:translate(-50%,-60%);z-index:1;pointer-events:none}
.evo-ceremony.show .evo-ceremony-ring{animation:ringPulse 2s ease-in-out infinite .5s}
.evo-ceremony.show .evo-ceremony-ring-2{animation:ringPulse 2s ease-in-out infinite 1s}
@keyframes ringPulse{0%,100%{opacity:.4;transform:translate(-50%,-60%) scale(1)}50%{opacity:.8;transform:translate(-50%,-60%) scale(1.06)}}
.evo-ceremony-traits{font-size:.52rem;color:var(--t3);margin-top:4px;opacity:0;transition:opacity .5s .9s}
.evo-ceremony.show .evo-ceremony-traits{opacity:1}
.evo-new-trait-badge{display:inline-block;padding:2px 9px;border-radius:10px;background:rgba(138,180,255,.12);border:1px solid rgba(138,180,255,.25);color:#8ab4ff;font-size:.5rem;font-weight:500;margin:2px 3px}

/* ‚ïê‚ïê‚ïê V2.9 CSS ‚ïê‚ïê‚ïê */

/* Village tab notification dot */
.tab-btn[data-tab=‚Äúvillage‚Äù]{position:relative}
.tab-btn[data-tab=‚Äúvillage‚Äù].has-notif::after{content:‚Äô‚Äô;position:absolute;top:5px;right:8px;width:7px;height:7px;border-radius:50%;background:var(--positive);box-shadow:0 0 6px rgba(102,187,153,.5);animation:notifPulse 2s ease-in-out infinite}
@keyframes notifPulse{0%,100%{opacity:.7;transform:scale(.85)}50%{opacity:1;transform:scale(1)}}

/* Spirit card resting countdown timer badge */
.spirit-card-rest-timer{display:inline-flex;align-items:center;gap:3px;font-size:.42rem;color:var(--special);font-family:‚ÄòJetBrains Mono‚Äô,monospace;background:rgba(200,136,255,.08);border:1px solid rgba(200,136,255,.15);border-radius:8px;padding:1px 5px;margin-top:2px}

/* Hatch-ready pulse on Items tab */
.tab-btn[data-tab=‚Äúpills‚Äù]{position:relative}
.tab-btn[data-tab=‚Äúpills‚Äù].hatch-ready::after{content:‚Äòüê£‚Äô;position:absolute;top:2px;right:4px;font-size:.55rem;animation:hatchBounce .6s ease-in-out infinite alternate}
@keyframes hatchBounce{from{transform:translateY(0)}to{transform:translateY(-2px)}}

/* Dojo XP float */
.xp-float{position:absolute;pointer-events:none;font-size:.65rem;font-weight:700;color:var(--positive);font-family:‚ÄòJetBrains Mono‚Äô,monospace;z-index:50;white-space:nowrap;animation:xpFloat 1.4s cubic-bezier(.2,.8,.4,1) forwards}
@keyframes xpFloat{0%{opacity:1;transform:translateY(0) scale(1)}60%{opacity:1;transform:translateY(-28px) scale(1.05)}100%{opacity:0;transform:translateY(-48px) scale(.9)}}

/* Building tier badge */
.building-tier-badge{font-size:.42rem;padding:1px 6px;border-radius:8px;font-weight:600;letter-spacing:.04em;flex-shrink:0}
.building-tier-badge.tier-1{color:var(--t3);border:1px solid var(--border)}
.building-tier-badge.tier-2{color:#8ab4ff;border:1px solid rgba(138,180,255,.3);background:rgba(138,180,255,.06)}
.building-tier-badge.tier-3{color:#ffd480;border:1px solid rgba(255,212,128,.3);background:rgba(255,212,128,.06)}

/* Building upgrade panel in modal */
.bm-upgrade{margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
.bm-upgrade-cost{display:flex;flex-wrap:wrap;gap:4px;margin:6px 0}
.bm-upgrade-mat{font-size:.48rem;padding:3px 8px;border-radius:8px;border:1px solid var(--border);display:flex;align-items:center;gap:3px}
.bm-upgrade-mat.has{color:var(--positive);border-color:rgba(102,187,153,.2)}
.bm-upgrade-mat.missing{color:var(--t4)}
.bm-upgrade-btn{width:100%;padding:10px;border:none;border-radius:var(--radius-sm);font-family:inherit;font-size:.65rem;font-weight:600;cursor:pointer;transition:all .2s;margin-top:6px}
.bm-upgrade-btn.ready{background:linear-gradient(135deg,#8ab4ff,#a0c8ff);color:#0a0e1a}
.bm-upgrade-btn.maxed{background:rgba(255,212,128,.08);border:1px solid rgba(255,212,128,.2);color:#ffd480;cursor:default}
.bm-upgrade-btn:disabled{opacity:.25;cursor:not-allowed}
.bm-tier-benefit{font-size:.48rem;color:var(--t3);padding:2px 0}

/* Library research UI */
.library-research-grid{display:flex;flex-direction:column;gap:5px;margin:8px 0}
.library-research-loc{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:8px 10px;cursor:pointer;transition:all .15s}
.library-research-loc:hover:not(.researched):not(.researching){border-color:var(--border-l)}
.library-research-loc.researched{border-color:rgba(200,136,255,.25);background:rgba(200,136,255,.04);cursor:default}
.library-research-loc.researching{border-color:rgba(138,180,255,.25);background:rgba(138,180,255,.04);cursor:default}
.library-research-loc.locked{opacity:.35;cursor:default;pointer-events:none}
.library-research-header{display:flex;align-items:center;gap:8px}
.library-research-emoji{font-size:.9rem;flex-shrink:0}
.library-research-name{font-size:.62rem;font-weight:600;flex:1;color:var(--t1)}
.library-research-status{font-size:.42rem;padding:2px 7px;border-radius:8px;font-weight:500}
.library-research-status.done{color:var(--special);background:rgba(200,136,255,.08);border:1px solid rgba(200,136,255,.15)}
.library-research-status.active{color:#8ab4ff;background:rgba(138,180,255,.08);border:1px solid rgba(138,180,255,.15)}
.library-research-status.idle{color:var(--t4);border:1px solid var(--border)}
.library-research-bar-wrap{margin-top:5px;display:flex;align-items:center;gap:6px}
.library-research-bar{flex:1;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.library-research-fill{height:100%;background:#8ab4ff;border-radius:2px;transition:width .5s ease}
.library-research-time{font-size:.42rem;color:var(--t4);font-family:‚ÄòJetBrains Mono‚Äô,monospace;flex-shrink:0}
.library-loot-preview{margin-top:5px;display:flex;flex-wrap:wrap;gap:3px}
.library-loot-tag{font-size:.42rem;padding:1px 5px;border-radius:6px;background:rgba(200,136,255,.06);border:1px solid rgba(200,136,255,.12);color:var(--t3)}
.library-loot-tag.rare{color:var(--special);border-color:rgba(200,136,255,.2)}
</style>

</head>
<body>

<div class="evo-ceremony" id="evoCeremony"><div class="evo-ceremony-flash" id="evoCeremonyFlash"></div><div class="evo-particles" id="evoCeremonyParticles"></div><div class="evo-ceremony-ring" id="evoCeremonyRing"></div><div class="evo-ceremony-ring-2"></div><div class="evo-ceremony-content"><div class="evo-ceremony-label">Evolution</div><div class="evo-ceremony-portrait" id="evoCeremonyPortrait"><img id="evoCeremonyImg" src=""></div><div class="evo-ceremony-name" id="evoCeremonyName"></div><div class="evo-ceremony-stage" id="evoCeremonyStage"></div><div class="evo-ceremony-traits" id="evoCeremonyTraits"></div></div><div class="evo-ceremony-tap">tap to continue</div></div>
<div class="onboard gone" id="onboard"><div class="ob-inner"><div class="ob-icon" id="obIcon"></div><div class="ob-title" id="obTitle"></div><div class="ob-desc" id="obDesc"></div><div class="ob-dots"><div class="ob-dot on" id="obD0"></div><div class="ob-dot" id="obD1"></div><div class="ob-dot" id="obD2"></div></div><button class="ob-btn" id="obBtn" onclick="nextOnboard()">Next</button><button class="ob-skip" onclick="finishOnboard()">Skip</button></div></div>

<div class="wb-overlay gone" id="welcomeBack"><div class="wb-inner"><div class="wb-portrait" id="wbPortrait"></div><div class="wb-msg" id="wbMsg"></div><div class="wb-gains" id="wbGains"></div><button class="wb-btn" onclick="dismissWB()">Enter Village</button></div></div>
<div class="guest-banner" id="guestBanner"><span class="guest-banner-text"><b>Create an Account</b> for a free spirit and newbie pack!</span><button class="guest-banner-btn" onclick="showLogin()">Sign Up</button></div>
<div class="toast" id="toast"><div class="toast-icon" id="toastI"></div><div><div class="toast-text" id="toastT"></div><div class="toast-sub" id="toastS"></div></div></div>
<div class="modal-bg" id="modal" onclick="if(event.target===this)closeModal()"><div class="modal-box" id="modalBox"></div></div>
<div class="hatch-overlay" id="hatchOverlay" onclick="closeHatchAnim()"><div class="hatch-egg-anim" id="hatchEgg">&#x1F95A;</div><div class="hatch-reveal" id="hatchReveal"><img id="hatchImg" src=""><div class="hatch-reveal-name" id="hatchName"></div><div class="hatch-reveal-rarity" id="hatchRarity"></div><div class="hatch-reveal-bonus" id="hatchBonusXp"></div><div class="hatch-reveal-tap">tap anywhere to continue</div></div></div>
<div class="loot-reveal-overlay" id="lootRevealOverlay" onclick="closeLootReveal()"></div>
<div class="reconnect-overlay gone" id="reconnectOverlay"><div class="reconnect-inner"><div class="reconnect-icon">üîÑ</div><div class="reconnect-title">Reconnecting‚Ä¶</div><div class="reconnect-sub" id="reconnectMsg">Trying to reach Ehoro Village servers</div></div></div>
<div class="spirit-arrival" id="spiritArrival"><div class="sa-inner"><div class="sa-portrait" id="saPortrait"></div><div class="sa-name" id="saName"></div><div class="sa-bio" id="saBio"></div><div class="sa-welcome" id="saWelcome">found their way to your village</div><button class="sa-btn" onclick="dismissSpiritArrival()">Welcome Home</button></div></div>
<div class="prof-overlay" id="profOverlay"><div class="prof-inner"><div class="prof-portrait"><img src="sprites/mowang_3.png"></div><div class="prof-name">Professor Mowang</div><div class="prof-role">Village Elder</div><div class="prof-bubble"><div class="prof-bubble-text" id="profText"></div></div><div id="profExtra"></div><div class="prof-dots" id="profDots"></div><button class="prof-btn" id="profBtn" onclick="nextProfStep()">Next</button><button class="prof-skip" onclick="finishProf()">Skip tutorial</button></div></div>
<div class="settings-drop" id="settingsDrop"><div class="sd-item" onclick="toggleTheme()"><span class="sd-item-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg> Theme</span><div class="sd-toggle" id="themeToggle"></div></div><div class="sd-divider"></div><div class="sd-item" onclick="showPrivacy()"><span class="sd-item-label">Privacy</span></div><div class="sd-divider"></div><div class="sd-item" onclick="showPatchNotes()"><span class="sd-item-label">Patch Notes</span></div><div class="sd-divider sdLogoutDiv"></div><div class="sd-item sdLogoutItem" onclick="doLogout()"><span class="sd-item-label">Logout</span></div></div>
<div class="patch-overlay" id="patchNotes"><button class="patch-close" onclick="closePatchNotes()">‚úï Close</button><div class="patch-inner">
<div class="patch-banner"><div><div class="patch-banner-text">Ehoro Village<br>Patch V2.3</div><div class="patch-banner-sub">Sakura Jazz</div></div></div>
<div class="patch-author"><div class="patch-author-img"><img src="sprites/mowang_3.png"></div><div><div class="patch-author-name">Purple Prince</div><div class="patch-author-role">Lead Designer</div></div><span class="patch-date">February 17, 2026</span></div>
<div class="patch-body">
<p>Hello villagers! V2.0 is our biggest infrastructure update. Everything is more secure, faster, and ready for 1,000+ players.</p>
<div class="patch-heading">Security Hardening üõ°Ô∏è</div>
<p><b>Row Level Security is now live.</b> Every database table is locked down ‚Äî your data is yours alone. All game actions (sacrificing spirits, crafting pills, claiming expeditions) now run through server-validated functions, preventing any client-side tampering.</p>
<div class="patch-heading">Server-Side Validation ‚ö°</div>
<p><b>Six new server functions</b> replace client-side mutations. The Cultivation Jar, Spirit Dismiss, Wicked Pills, Heavenly Pills, Expeditions, and Cultivation Advancement are all validated server-side. No more trusting the client with math.</p>
<div class="patch-heading">Database Migration üíæ</div>
<p><b>Wicked pills, spirit alignment, streaks, and achievements</b> now live in the database instead of localStorage. Your progress syncs across devices and can't be tampered with.</p>
<div class="patch-heading">Performance at Scale üöÄ</div>
<p><b>Smarter data loading.</b> Instead of reloading all 8 tables after every action, the app now does targeted reloads ‚Äî only fetching what changed. Polling intervals are tuned for 1,000+ users. Database indexes speed up every query.</p>
<div class="patch-heading">XSS Protection</div>
<p><b>All user-generated content is now sanitized.</b> Content Security Policy headers prevent script injection. Your village is safe.</p>
<div class="patch-heading">Previous Updates</div>
<p><b>V1.5:</b> Cultivation Jar, Spirit Essence, Heavenly Pills, alignment, spirit interactions.</p>
<p><b>V1.4:</b> Trait effects, spirit moods, daily streak, achievements, rarity hatch animations.</p>
<p><b>V1.3:</b> Visual polish ‚Äî typography, spacing, transitions, accessibility.</p>
<p><b>V1.0‚Äì1.2:</b> Professor Mowang tutorial, expeditions, spirit cultivation, offline progression.</p>
<div class="patch-heading">What's Next</div>
<p>More spirits, social features, and cosmetic customization. Thank you for being part of Ehoro Village.</p>
<div class="patch-heading">V2.3 ‚Äî Sakura Jazz üå∏</div>
<p><b>Two streams, one village.</b> Sakura Jazz is now the featured stream ‚Äî a cherry blossom piano lo-fi mix to set the mood. Your classic <b>Ehoro Village Lo-Fi Tape V1</b> is still here, selectable anytime via the stream switcher below the player. Sakura Jazz loads first by default.</p>
<div class="patch-heading">V2.2 ‚Äî Ehoro Village Radio üìª</div>
<p><b>Our own lo-fi music is here.</b> Ehoro Village Radio is now the sole audio source ‚Äî no more embedding someone else's stream. The video loops seamlessly for a clean, cozy listening experience. This is our sound now.</p>
<p style="color:var(--t3);font-style:italic">‚Äî Purple Prince</p>
</div>
<div class="patch-social"><a href="https://www.instagram.com/ehorovillage?igsh=cTBuaGpoaWVpdXQy&utm_source=qr" target="_blank">Instagram</a><a href="https://x.com/purpleprinceev?s=21" target="_blank">X (Twitter)</a><a href="https://www.facebook.com/share/1DGDwJyMcN/?mibextid=wwXIfr" target="_blank">Facebook</a></div>
</div></div>
<div class="spirit-overlay gone" id="spiritOverlay" onclick="if(event.target===this)closeSpiritDetail()">
<div class="spirit-overlay-inner" id="spiritOverlayInner"></div>
</div>
<div class="building-modal-overlay" id="buildingModalOverlay" onclick="if(event.target===this)closeBuildingModal()">
<div class="building-modal-sheet" id="buildingModalSheet"></div>
</div>
<div class="login gone" id="login"><div class="login-inner"><div class="login-brand"><h1>Ehoro Village</h1><p class="sub">lo-fi &middot; spirits &middot; cultivate</p></div><div class="login-field" id="usernameField" style="display:none"><label>Username</label><input type="text" id="inUser" placeholder="pick a username"></div><div class="login-field"><label>Email</label><input type="email" id="inEmail" placeholder="you@email.com"></div><div class="login-field"><label>Password</label><input type="password" id="inPass" placeholder="&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;" minlength="6"></div><button class="l-btn" id="authBtn" onclick="doAuth()">Sign In</button><div class="l-error" id="authError"></div><div class="l-div">or</div><button class="l-secondary" onclick="doGoogleAuth()" style="display:flex;align-items:center;justify-content:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18A11.96 11.96 0 0 0 0 12c0 1.94.46 3.77 1.28 5.4l3.56-2.77.01-.54z" fill="#FBBC05"/><path d="M12 4.75c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 1.09 14.97 0 12 0 7.7 0 3.99 2.47 2.18 6.07l3.66 2.84c.87-2.6 3.3-4.16 6.16-4.16z" fill="#EA4335"/></svg> Continue with Google</button><button class="l-secondary" onclick="enterGuest()" style="margin-top:8px">Watch as Guest</button><button class="l-toggle" id="authToggle" onclick="toggleAuthMode()">Need an account? Sign up</button></div></div>
<div class="shell on" id="shell">
<div class="topbar"><div class="tb-brand">Ehoro Village</div><div class="tb-right"><div class="tb-rank" id="tbRank" onmouseenter="showRankTooltip()" onmouseleave="hideRankTooltip()" onclick="toggleRankTooltip()"><span class="tb-rank-name" id="tbRankName">Ember</span><span class="tb-rank-pts" id="tbRankPts">0 pts</span><div class="rank-tooltip" id="rankTooltip"></div></div><button class="tb-gear" onclick="toggleSettings()" title="Settings"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></button><div id="tbAuth"><button class="tb-signin" onclick="showLogin()">Sign In</button></div></div></div>
<div class="content">
<div class="video-area"><div class="video-embed" id="videoEmbed"><div class="video-placeholder" id="videoPlaceholder" onclick="startStream()"><div class="vp-play">&#x25B6;</div><div class="vp-text" id="vpText">üåô Ehoro Village Radio</div></div></div><div class="player-strip"><button class="ps-play" id="psPlay" onclick="startStream()">&#x25B6;</button><div class="ps-info"><div class="ps-title" id="psTitle">Ehoro Village Radio</div><div class="ps-sub"><span class="ps-live-dot"></span> <span id="psSub">lo-fi beats to study to</span></div></div></div><div class="stream-switcher"><button class="stream-pill active" id="pillEhoro" onclick="switchStream('ehoro')">üåô Ehoro Radio</button><button class="stream-pill" id="pillSakura" onclick="switchStream('sakura')">üå∏ Sakura Jazz</button><button class="stream-pill" id="pillLofi" onclick="switchStream('lofi')">üìº Lo-Fi Tape</button></div></div>
<div class="sidebar"><div class="egg-progress" id="eggProgress"><span class="egg-progress-label">Next egg</span><div class="egg-progress-bar"><div class="egg-progress-fill" id="eggFill"></div></div><span class="egg-progress-time" id="eggTimer">&mdash;</span></div><div class="tab-nav"><button class="tab-btn on" id="tabBtnSpirits" data-tab="spirits" onclick="switchTab(this)">Spirits</button><button class="tab-btn" id="tabBtnPills" data-tab="pills" onclick="switchTab(this)">Items</button><button class="tab-btn" id="tabBtnVillage" data-tab="village" onclick="switchTab(this)">Village</button></div><div class="tab-panels"><div class="tab-panel on" id="tab-spirits"></div><div class="tab-panel" id="tab-pills"></div><div class="tab-panel" id="tab-village"></div></div></div>
</div></div>

<script>
const SUPABASE_URL='https://eyqddqtlgthgkiqjavyx.supabase.co';
const SUPABASE_ANON_KEY='sb_publishable_CsTLSJj1YwgiHMxUTa685Q_2TVvZa2Q';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{auth:{autoRefreshToken:true,persistSession:true,detectSessionInUrl:true}});
// V2.0: XSS sanitizer ‚Äî use everywhere user data goes into innerHTML
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/\x3c/g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
// V2.0: Debounced UI update
let _uiDebounce=null;
function debouncedUpdateAllUI(){if(_uiDebounce)clearTimeout(_uiDebounce);_uiDebounce=setTimeout(()=>{updateAllUI()},100)}
// V2.0: Selective reload helpers (avoid full 8-table reload after every action)
async function reloadSpiritsAndTraits(){if(!S.user)return;const sIds=(await sb.from('spirits').select('id').eq('user_id',S.user.id)).data?.map(s=>s.id)||[];const[{data:spirits},{data:traits}]=await Promise.all([sb.from('spirits').select('*').eq('user_id',S.user.id),sb.from('spirit_traits').select('*').in('spirit_id',sIds.length?sIds:['00000000-0000-0000-0000-000000000000'])]);if(spirits)S.spirits=spirits.map(sp=>({...sp,cultivation_stage:sp.cultivation_stage||0}));S.traits={};if(traits)traits.forEach(t=>{if(!S.traits[t.spirit_id])S.traits[t.spirit_id]=[];S.traits[t.spirit_id].push(t)})}
async function reloadEmblems(){if(!S.user)return;const{data:emb}=await sb.from('emblems').select('*').eq('user_id',S.user.id);if(emb)emb.forEach(e=>{S.emblems[e.emblem_type]=e.quantity})}
async function reloadHatchery(){if(!S.user)return;const[{data:hatch},{data:eggs}]=await Promise.all([sb.from('hatchery').select('*').eq('user_id',S.user.id).order('slot_number'),sb.from('eggs').select('*').eq('user_id',S.user.id).in('status',['pending','incubating']).limit(30)]);if(hatch)S.hatchery=hatch;const allEggs=eggs||[];S.pendingEggs=allEggs.filter(e=>e.status==='pending');S.allEggs=allEggs}
async function reloadExpeditions(){if(!S.user)return;const{data:expeds}=await sb.from('expeditions').select('*').eq('user_id',S.user.id);if(expeds!==undefined)S.expeditions=expeds||[]}
async function reloadWickedPills(){if(!S.user||S.isGuest)return;const{data}=await sb.from('wicked_pills').select('*').eq('user_id',S.user.id).order('id');S._wickedPills=data||[]}

// ‚ïê‚ïê‚ïê V2.5: BUILDINGS RELOAD ‚ïê‚ïê‚ïê
async function reloadBuildings(){
  if(!S.user||S.isGuest)return;
  const[{data:blds},{data:staff},{data:inv}]=await Promise.all([
    sb.from('buildings').select('*').eq('user_id',S.user.id),
    sb.from('building_staff').select('*').eq('user_id',S.user.id),
    sb.from('building_inventory').select('*').eq('user_id',S.user.id).order('id',{ascending:false})
  ]);
  S.buildings=blds||[];
  S.buildingStaff=staff||[];
  S.buildingInventory=inv||[];
}

// ‚ïê‚ïê‚ïê V2.5: MATERIAL HELPERS ‚ïê‚ïê‚ïê
function getMaterials(){return S.materials||{}}
function getMaterialCount(id){return(S.materials||{})[id]||0}
function hasMaterial(id,qty=1){return getMaterialCount(id)>=qty}
// Materials are stored in building_inventory with type='material'
function syncMaterialsFromInventory(){
  const mats={};
  (S.buildingInventory||[]).filter(i=>i.item_type==='material').forEach(i=>{
    // V3.2: key off item_id (e.g. 'grinder_stone'), fall back to item_name for legacy rows
    const key=i.item_id||i.item_name;
    mats[key]=(mats[key]||0)+(i.quantity||1);
  });
  S.materials=mats;
}

// ‚ïê‚ïê‚ïê V2.5: BUILDING HELPERS ‚ïê‚ïê‚ïê
function getBuildingData(type){return S.buildings.find(b=>b.building_type===type)||null}
function buildingUnlocked(type){return !!getBuildingData(type)}
function getBuildingStaff(type){return S.buildingStaff.filter(s=>s.building_type===type)}
function getManagerFor(type){return S.buildingStaff.find(s=>s.building_type===type&&s.role==='manager')||null}
function getWorkersFor(type){return S.buildingStaff.filter(s=>s.building_type===type&&s.role==='worker')}
function spiritAssigned(spiritId){return S.buildingStaff.some(s=>s.spirit_id===spiritId)}
function spiritAssignedTo(spiritId){return S.buildingStaff.find(s=>s.spirit_id===spiritId)||null}
// Manager craft level = spirit level (simplified for now, trait trees deepen this in 2.6)
function getCraftLevel(spiritId){
  const sp=S.spirits.find(s=>s.id===spiritId);
  if(!sp)return 0;
  return Math.min(5,Math.floor((sp.xp||0)/S.XP_PER_LEVEL)+1);
}
function getCafeDrinkForLevel(level){
  const cfg=BUILDING_CONFIGS.cafe;
  const drinks=cfg.craftItems.filter(d=>d.minCraftLevel<=level);
  return drinks.length?drinks[drinks.length-1]:cfg.craftItems[0];
}
// Check if building can be unlocked (all materials present)
function canUnlockBuilding(type){
  if(buildingUnlocked(type))return false;
  const cfg=BUILDING_CONFIGS[type];if(!cfg)return false;
  return Object.entries(cfg.unlockMaterials).every(([mat,qty])=>{
    if(['cafe_bean','wild_essence','focus_shard','ashe_essence','spirit_essence'].includes(mat)){
      return(S.emblems[mat]||0)>=qty;
    }
    return hasMaterial(mat,qty);
  });
}
// Utility: wrap any promise with a timeout to prevent hangs
function withTimeout(promise,ms=8000){return Promise.race([promise,new Promise((_,reject)=>setTimeout(()=>reject(new Error('Request timed out ‚Äî check your connection')),ms))])}
// Basic connectivity check (non-blocking)
async function checkSupabaseConnectivity(){try{await fetch(SUPABASE_URL+'/rest/v1/',{method:'HEAD',headers:{'apikey':SUPABASE_ANON_KEY}})}catch(e){console.warn('Network connectivity issue detected. Some features may not work properly.')}}
checkSupabaseConnectivity();
const STREAM_EHORO='VrnORnrOphA';   // üåô Ehoro Village Radio ‚Äî new primary stream
const STREAM_SAKURA='rESYC5ikn58'; // üå∏ Sakura Jazz
const STREAM_LOFI='ojyT8dK0ZiA';   // üìº Ehoro Village Lo-Fi Tape V1
const STREAM_YT=STREAM_EHORO;      // legacy alias
const RARITY_COLORS={mundane:'#888',adept:'#8ab',refined:'#7a7',illustrious:'#ba8',sovereign:'#a8c',celestial:'#8cf',transcendent:'#fc8',mysterious:'#c8f',ancestral:'#f88',paradox:'#fff'};
const INCUB_MINS={mundane:3,adept:7,refined:14,illustrious:20,sovereign:30,celestial:45,transcendent:60,mysterious:90,ancestral:90,paradox:90};
const VILLAGE_RANKS=[{name:'Ember',min:0,desc:'Your village is a spark.',color:'#a08070'},{name:'Stone',min:50,desc:'Solid foundation.',color:'#909090'},{name:'Bronze',min:120,desc:'A real village.',color:'#cd8c52'},{name:'Silver',min:280,desc:'Respected.',color:'#b8c0cc'},{name:'Gold',min:550,desc:'Prosperous.',color:'#d4a843'},{name:'Emerald',min:950,desc:'A beacon.',color:'#4cba8a'},{name:'Celestial',min:1800,desc:'Transcendent.',color:'#7cb8f0'}];
const SLOT_UNLOCK={3:50,4:150,5:400};

// ‚ïê‚ïê‚ïê V1.5: SPIRIT INTERACTION QUIPS ‚ïê‚ïê‚ïê
const SPIRIT_QUIPS={
  timi:{
    short:['*tilts head*','Mrrp?','*tails flicker*','...heard that?','*curious sniff*','Hm?'],
    long:['Timi tilts her head and studies you curiously. "Do you ever wonder what\'s beyond the village?"','Her nine tails shimmer faintly. "I feel like I\'ve been here before... in another life."','*She paws at something invisible.* "The melodies here... they remind me of home."','Timi\'s ears perk up. "Stay a while. The music is better with company."']
  },
  bayo:{
    short:['*soft chirp*','...hi.','*peeks out*','*gentle wave*','Mm.','*blinks slowly*'],
    long:['Bayo looks up shyly. "It\'s nice here. Quieter than the zoo."','He adjusts his bubbles carefully. "I\'m still learning... what freedom tastes like."','*He sits beside you quietly.* Sometimes silence is enough.','Bayo smiles softly. "You came back. I wasn\'t sure you would."']
  },
  mowang:{
    short:['Hmph.','*mech whir*','...pathetic.','*glares*','Tch.','*sparks*'],
    long:['Mowang crosses his mechanical arms. "Don\'t mistake my presence for affection."','His eye glows brighter. "One day, my steel will be unrivaled. You\'ll see."','*Grudgingly:* "...the music isn\'t terrible, I suppose."','Mowang looks away. "That adventurer was a fool. But... this village isn\'t so bad."']
  },
  florita:{
    short:['*sways gently*','~‚ô™','*ribbon flutter*','Oh, hi~','*bows*','Hmm~'],
    long:['Florita sways to the music. "Pink was never really my color, you know."','She wraps her ribbon closer. "Being forgotten hurts. But being found again... that\'s nice."','*She hums along softly.* "This melody makes me feel like myself."','Florita looks at you warmly. "Thank you for not forgetting me."']
  },
  simi:{
    short:['Hehe!','*bounces*','Cheese?','Friend!','*squeaks*','Yay!'],
    long:['Simi bounces excitedly. "Every day here is a cheese day! Wait, is that a thing?"','He rolls around happily. "I came looking for friends and found a whole village!"','*Whispers conspiratorially:* "I heard there\'s cheese in the next expedition..."','Simi beams at you. "You\'re my favorite person! Don\'t tell the others."']
  },
  basu_basu:{
    short:['...','*straw slurp*','Hmm.','*grumbles*','Boba.','...fine.'],
    long:['Basu Basu stares into his empty cup. "I used to feel hollow inside. Now I feel... less hollow."','He takes a long sip. "Friends are like boba pearls. Small but they make everything better."','*Quietly:* "Don\'t leave, okay? It gets quiet when you\'re gone."','Basu Basu almost smiles. Almost. "...this is fine. This is good."']
  }
};
// ‚ïê‚ïê‚ïê V1.5: WICKED PILL TIERS ‚ïê‚ïê‚ïê
const WICKED_TIERS=[
  {id:'minor_wicked',name:'Minor Wicked Pill',xp:75,icon:'ü©∏',desc:'75 XP to one spirit',check:(sp)=>{const lvl=Math.floor((sp.xp||0)/150)+1;return lvl<=2&&sp.evo_stage===0}},
  {id:'wicked',name:'Wicked Pill',xp:150,icon:'ü©∏',desc:'150 XP to one spirit',check:(sp)=>{const lvl=Math.floor((sp.xp||0)/150)+1;return lvl>=3&&lvl<=4}},
  {id:'greater_wicked',name:'Greater Wicked Pill',xp:250,icon:'ü©∏',desc:'250 XP to one spirit',check:(sp)=>{const lvl=Math.floor((sp.xp||0)/150)+1;return lvl>=5&&sp.evo_stage>=1&&sp.evo_stage<2}},
  {id:'supreme_wicked',name:'Supreme Wicked Pill',xp:500,icon:'ü©∏',desc:'500 XP to one spirit',check:(sp)=>{const lvl=Math.floor((sp.xp||0)/150)+1;return lvl>=5&&sp.evo_stage>=2}}
];
function getWickedTier(sp){
  // Return highest matching tier
  for(let i=WICKED_TIERS.length-1;i>=0;i--){if(WICKED_TIERS[i].check(sp))return WICKED_TIERS[i]}
  return WICKED_TIERS[0]; // fallback to minor
}
// ‚ïê‚ïê‚ïê V1.5: HEAVENLY PILL RECIPES ‚ïê‚ïê‚ïê
const HEAVENLY_RECIPES=[
  {id:'minor_heavenly',name:'Minor Heavenly Pill',xp:60,icon:'‚ú¶',desc:'60 XP to one spirit',cost_essence:3,cost_cafe:3,cost_wild:3,cost_focus:3},
  {id:'heavenly',name:'Heavenly Pill',xp:120,icon:'‚ú¶',desc:'120 XP to one spirit',cost_essence:6,cost_cafe:5,cost_wild:5,cost_focus:5},
  {id:'greater_heavenly',name:'Greater Heavenly Pill',xp:200,icon:'‚ú¶',desc:'200 XP to one spirit',cost_essence:12,cost_cafe:8,cost_wild:8,cost_focus:8},
  {id:'supreme_heavenly',name:'Supreme Heavenly Pill',xp:350,icon:'‚ú¶',desc:'350 XP to one spirit',cost_essence:20,cost_cafe:12,cost_wild:12,cost_focus:12}
];
// ‚ïê‚ïê‚ïê V1.5: SPIRIT ESSENCE FROM DISMISS ‚ïê‚ïê‚ïê
function calcDismissEssence(sp){
  const lvl=Math.floor((sp.xp||0)/100)+1;
  let base=lvl<=2?2:lvl<=4?4:6;
  if(sp.evo_stage>=1)base+=3;
  if(sp.evo_stage>=2)base+=3; // total +6 for Ascended
  return base;
}
// ‚ïê‚ïê‚ïê V1.5: MILESTONE DEFINITIONS ‚ïê‚ïê‚ïê
const MILESTONES=[
  {id:'first_evo',check:()=>S.spirits.some(s=>s.evo_stage>=1),msg:'First Evolution!',sub:'Your spirit has awakened!',icon:'‚ú®'},
  {id:'first_ascend',check:()=>S.spirits.some(s=>s.evo_stage>=2),msg:'Ascension!',sub:'A spirit has reached its final form!',icon:'üëë'},
  {id:'ten_spirits',check:()=>S.spirits.length>=10,msg:'Village Growing!',sub:'10 spirits call this home',icon:'üèòÔ∏è'},
  {id:'egg_50',check:()=>(S.profile?.total_eggs||0)>=50,msg:'50 Eggs!',sub:'A dedicated collector',icon:'ü•ö'},
  {id:'egg_100',check:()=>(S.profile?.total_eggs||0)>=100,msg:'100 Eggs!',sub:'An egg empire!',icon:'ü•ö'},
  {id:'listen_24h',check:()=>(S.profile?.total_listen_seconds||0)>=86400,msg:'24 Hours Listened!',sub:'A full day of lo-fi',icon:'üéß'},
  {id:'all_types',check:()=>{const t=new Set(S.spirits.map(s=>spiritKey(s.spirit_type)));return t.size>=6},msg:'Full Collection!',sub:'One of every spirit type',icon:'‚ú®'},
  {id:'first_wicked',check:()=>S.spirits.some(s=>getSpiritAlignment(s.id)==='wicked'),msg:'Dark Path!',sub:'A spirit embraced the wicked arts',icon:'ü©∏'},
  {id:'first_heavenly',check:()=>S.spirits.some(s=>getSpiritAlignment(s.id)==='heavenly'),msg:'Heavenly Path!',sub:'A spirit achieved enlightenment',icon:'‚ú¶'}
];
const SPIRIT_DATA={timi:{name:'Timi',bio:'Pulled into the spirit realm by a terrible accident. Curious and restless, she believes there\'s more to Ehoro Village than meets the eye.',img:['sprites/timi_1.png','sprites/timi_2.png','sprites/timi_3.png']},bayo:{name:'Bayo',bio:'Arrived after a life behind glass at the zoo. Shy but deeply intelligent, he\'s learning what it means to be free.',img:['sprites/bayo_1.png','sprites/bayo_2.png','sprites/bayo_3.png']},mowang:{name:'Mowang',bio:'Banished by a foolish adventurer, Mowang harbors fierce ambition for gleaming steel.',img:['sprites/mowang_1.png','sprites/mowang_2.png','sprites/mowang_3.png']},florita:{name:'Florita',bio:'Forgotten by accident, she drifted quietly into the spirit realm. Her old owner loved pink, but Florita always felt different on the inside.',img:['sprites/florita_1.png','sprites/florita_2.png','sprites/florita_3.png']},simi:{name:'Simi',bio:'One wrong piece of cheese sent him tumbling into the spirit realm. Endlessly cheerful, he came to Ehoro Village sure he\'d find a world full of friends.',img:['sprites/simi_1.png','sprites/simi_2.png','sprites/simi_3.png']},basu_basu:{name:'Basu Basu',bio:'Felt empty for a long time before finding his way to the village. He hopes that making new friends will finally make him feel whole again.',img:['sprites/basu_basu_1.png','sprites/basu_basu_2.png','sprites/basu_basu_3.png']}};
const TYPE_MAP={fox_lavender:'timi',fox_fire:'timi',panda:'bayo',slime:'mowang',timi:'timi',bayo:'bayo',mowang:'mowang',florita:'florita',simi:'simi',basu_basu:'basu_basu'};
function spiritKey(t){return TYPE_MAP[t]||t}
function spiritImg(t,s){const k=spiritKey(t),d=SPIRIT_DATA[k];return d?d.img[Math.min(s,2)]:'sprites/timi_1.png'}
function spiritName(t){return SPIRIT_DATA[spiritKey(t)]?.name||t}
function spiritBio(t){return SPIRIT_DATA[spiritKey(t)]?.bio||''}
const EVO_LABELS=['Seedling','Awakened','Ascended'];

// ‚ïê‚ïê‚ïê V1.4: SPIRIT MOOD SYSTEM ‚ïê‚ïê‚ïê
// Derived from existing data ‚Äî no DB changes needed
function getSpiritMood(sp){
  // Energized: just returned from expedition (resting)
  if(spiritResting(sp.id))return{mood:'energized',emoji:'‚ö°',label:'Energized'};
  // On expedition
  if(spiritOnExpedition(sp.id))return{mood:'away',emoji:'üß≠',label:'Exploring'};
  // Happy: gained XP recently (check if XP is not a round level ‚Äî implies recent activity)
  // We'll use a simpler heuristic: if spirit has >0 XP and was recently interacted with
  const lvl=Math.floor((sp.xp||0)/100)+1;
  const xpInLevel=(sp.xp||0)%100;
  // If spirit has cultivation stage or is evolved, they're "content" at least
  if(xpInLevel>0&&xpInLevel>50)return{mood:'happy',emoji:'‚ú®',label:'Happy'};
  // Sleepy: low level with 0 progress in current level
  if(lvl<=1&&xpInLevel===0&&(sp.cultivation_stage||0)===0)return{mood:'sleepy',emoji:'üí§',label:'Sleepy'};
  // Default: content
  return{mood:'content',emoji:'‚ò∫',label:'Content'};
}
const CULT_STAGES=['Unrefined','Qi Condensation','Foundation','Core Formation','Nascent Soul','Spirit Sovereign'];
const CULT_COSTS=[3,8,15,25,40]; // √Ä·π£·∫π Essence cost per advancement
const CULT_LVL_REQ=[3,6,10,12,16]; // Min spirit level per advancement
const EXPED_CONFIG={short:{label:'Short',minutes:10,restMinutes:3,baseMats:[2,4],bonusXp:8,asheChance:0.01},medium:{label:'Medium',minutes:20,restMinutes:15,baseMats:[4,8],bonusXp:10,asheChance:0.04},long:{label:'Long',minutes:45,restMinutes:25,baseMats:[8,14],bonusXp:25,asheChance:0.10}};
const EXPED_SLOT_UNLOCK={2:400};

// ‚ïê‚ïê‚ïê V2.5: EXPEDITION LOCATIONS ‚ïê‚ïê‚ïê
const EXPED_LOCATIONS={
  night_market:{
    id:'night_market',label:'Night Market',emoji:'üèÆ',
    desc:'Busy, loud, full of deals if you know where to look.',
    minLevel:1,minEvoStage:0,
    durations:{short:true,medium:true,long:false},
    lootTable:[
      {id:'cafe_bean',label:'Caf√© Bean',emoji:'‚òï',type:'emblem',rarity:'common',weight:30},
      {id:'wild_essence',label:'Wild Essence',emoji:'üåø',type:'emblem',rarity:'common',weight:28},
      {id:'focus_shard',label:'Focus Shard',emoji:'‚ö°',type:'emblem',rarity:'common',weight:25},
      {id:'canvas_roll',label:'Canvas Roll',emoji:'üé®',type:'material',rarity:'uncommon',weight:10},
      {id:'mystery_egg',label:'Mystery Egg',emoji:'ü•ö',type:'egg',rarity:'rare',weight:5},
      {id:'ashe_essence',label:'√Ä·π£·∫π Essence',emoji:'üîÆ',type:'emblem',rarity:'uncommon',weight:16},
    ],
    bonusTraits:['Market Sharp'],
    flavorLines:["Your spirits return smelling of spices and street food.","They navigated the crowds with ease.","Something glints in their satchel..."]
  },
  bamboo_highlands:{
    id:'bamboo_highlands',label:'Bamboo Highlands',emoji:'üéã',
    desc:'Quiet slopes, old trees, things that take time to find.',
    minLevel:2,minEvoStage:1,
    durations:{short:false,medium:true,long:true},
    lootTable:[
      {id:'wild_essence',label:'Wild Essence',emoji:'üåø',type:'emblem',rarity:'common',weight:35},
      {id:'focus_shard',label:'Focus Shard',emoji:'‚ö°',type:'emblem',rarity:'common',weight:20},
      {id:'grinder_stone',label:'Grinder Stone',emoji:'ü™®',type:'material',rarity:'uncommon',weight:12},
      {id:'ancient_tome',label:'Ancient Tome',emoji:'üìñ',type:'material',rarity:'uncommon',weight:10},
      {id:'training_scroll',label:'Training Scroll',emoji:'üìú',type:'material',rarity:'uncommon',weight:10},
      {id:'highland_orchid',label:'Highland Orchid',emoji:'üå∏',type:'material',rarity:'rare',weight:6},
      {id:'ashe_essence',label:'√Ä·π£·∫π Essence',emoji:'üîÆ',type:'emblem',rarity:'uncommon',weight:7},
    ],
    bonusTraits:['Highlands Reader','Patient'],
    flavorLines:["The highlands were quiet. Your spirits found things the untrained eye would miss.","Bamboo rustled as they passed. They listened.","The old trees remember. So do your spirits."]
  },
  frozen_ruins:{
    id:'frozen_ruins',label:'Frozen Ruins',emoji:'üßä',
    desc:"Nobody knows what stood here. Something did.",
    minLevel:4,minEvoStage:2,
    durations:{short:false,medium:false,long:true},
    lootTable:[
      {id:'focus_shard',label:'Focus Shard',emoji:'‚ö°',type:'emblem',rarity:'common',weight:25},
      {id:'ashe_essence',label:'√Ä·π£·∫π Essence',emoji:'üîÆ',type:'emblem',rarity:'uncommon',weight:25},
      {id:'training_scroll',label:'Training Scroll',emoji:'üìú',type:'material',rarity:'uncommon',weight:18},
      {id:'ruin_fragment',label:'Ruin Fragment',emoji:'üèöÔ∏è',type:'material',rarity:'uncommon',weight:15},
      {id:'wardens_crest',label:"Warden's Crest",emoji:'üëÅÔ∏è',type:'material',rarity:'rare',weight:8},
      {id:'rare_egg',label:'Illustrious Egg',emoji:'ü•ö',type:'egg',rarity:'rare',weight:6},
    ],
    bonusTraits:['Frost-Hardened','Disciplined'],
    flavorLines:["The cold didn't break them. They brought something back.","Ruins have a way of teaching what comfort cannot.","Whatever stood here once ‚Äî your spirits felt it."]
  }
};

// ‚ïê‚ïê‚ïê V2.5: BUILDING CONFIGS ‚ïê‚ïê‚ïê
const BUILDING_CONFIGS={
  cafe:{
    id:'cafe',label:'The Caf√©',emoji:'‚òï',
    desc:'Where the village starts its day.',
    unlockMaterials:{grinder_stone:1,cafe_bean:30},
    roles:{manager:{label:'Head Barista',slots:1},worker:{label:'Barista',slots:2}},
    passiveBuff:{desc:'5% XP to all spirits',type:'village_xp',value:0.05},
    staffedBuff:{desc:'Daily drink production',type:'daily_craft'},
    tiers:[
      {tier:1,label:'Tier 1',desc:'Head Barista crafts up to House Brew',upgradeCost:{cafe_bean:20,wild_essence:10}},
      {tier:2,label:'Tier 2',desc:'Unlocks Village Blend & Reserve Roast',upgradeCost:{grinder_stone:2,focus_shard:15}},
      {tier:3,label:'Tier 3',desc:'Unlocks Grand Cru & Signature Reserve',upgradeCost:null},
    ],
    craftItems:[
      {tier:1,name:'House Brew',emoji:'‚òï',desc:'+20 XP to one spirit',xpBonus:20,durationHrs:48,minCraftLevel:1},
      {tier:2,name:'Village Blend',emoji:'‚òï',desc:'+40 XP, +10% XP rate 2hrs',xpBonus:40,durationHrs:48,minCraftLevel:2},
      {tier:3,name:'Reserve Roast',emoji:'‚òï',desc:'+75 XP, +15% XP rate 4hrs',xpBonus:75,durationHrs:48,minCraftLevel:3},
      {tier:4,name:'Grand Cru',emoji:'‚òï',desc:'+150 XP, +25% XP rate 6hrs',xpBonus:150,durationHrs:48,minCraftLevel:4},
      {tier:5,name:'Signature Reserve',emoji:'‚òï',desc:'+300 XP, +30% everything 12hrs',xpBonus:300,durationHrs:48,minCraftLevel:5},
    ]
  },
  dojo:{
    id:'dojo',label:'The Dojo',emoji:'‚öîÔ∏è',
    desc:'Discipline sharpens what talent starts.',
    unlockMaterials:{training_scroll:1,ashe_essence:25},
    roles:{manager:{label:'Sensei',slots:1},worker:{label:'Trainee',slots:2}},
    passiveBuff:{desc:'Expedition rest time -10%',type:'rest_reduction',value:0.10},
    staffedBuff:{desc:'Trainees gain Discipline XP daily',type:'daily_train'},
    tiers:[
      {tier:1,label:'Tier 1',desc:'Trainees gain +5 XP per tick (5min)',upgradeCost:{training_scroll:2,focus_shard:12}},
      {tier:2,label:'Tier 2',desc:'Trainees gain +10 XP per tick',upgradeCost:{training_scroll:3,ashe_essence:15}},
      {tier:3,label:'Tier 3',desc:'+15 XP per tick + rare trait scroll chance',upgradeCost:null},
    ],
    craftItems:[]
  },
  library:{
    id:'library',label:'Village Library',emoji:'üìö',
    desc:'Every secret the village has ever learned lives here.',
    unlockMaterials:{ancient_tome:1,ashe_essence:40},
    roles:{manager:{label:'Head Archivist',slots:1},worker:{label:'Researcher',slots:2}},
    passiveBuff:{desc:'Passive XP rate +10%',type:'passive_xp',value:0.10},
    staffedBuff:{desc:'Research reveals expedition loot tables',type:'research'},
    tiers:[
      {tier:1,label:'Tier 1',desc:'Research time: 60min listen. Reveals loot table.',upgradeCost:{ancient_tome:2,wild_essence:15}},
      {tier:2,label:'Tier 2',desc:'Research time: 45min listen. Reveals drop rates.',upgradeCost:{ancient_tome:3,ashe_essence:20}},
      {tier:3,label:'Tier 3',desc:'Research time: 30min listen. Reveals all rates + rare bonus.',upgradeCost:null},
    ],
    craftItems:[]
  },
  garden:{
    id:'garden',label:'The Garden',emoji:'üåø',
    desc:'Patient hands grow the best things.',
    unlockMaterials:{highland_orchid:1,wild_essence:25},
    roles:{manager:{label:'Head Gardener',slots:1},worker:{label:'Farmer',slots:2}},
    passiveBuff:{desc:'Ingredient drops +15%',type:'ingredient_boost',value:0.15},
    staffedBuff:{desc:'Daily rare ingredient harvest',type:'daily_harvest'},
    tiers:[
      {tier:1,label:'Tier 1',desc:'Harvests 3‚Äì5 ingredients per cycle',upgradeCost:{highland_orchid:2,wild_essence:20}},
      {tier:2,label:'Tier 2',desc:'Harvests 5‚Äì8 ingredients + rare mat chance',upgradeCost:{highland_orchid:3,focus_shard:20}},
      {tier:3,label:'Tier 3',desc:'Harvests 8‚Äì12 ingredients + guaranteed rare mat',upgradeCost:null},
    ],
    craftItems:[]
  },
  studio:{
    id:'studio',label:'The Studio',emoji:'üé®',
    desc:'Where spirits make something that lasts.',
    unlockMaterials:{canvas_roll:1,spirit_essence:20},
    roles:{manager:{label:'Lead Artist',slots:1},worker:{label:'Artist',slots:2}},
    passiveBuff:{desc:'XP from listening +10%',type:'listen_xp',value:0.10},
    staffedBuff:{desc:'Daily Village Record production',type:'daily_record'},
    tiers:[
      {tier:1,label:'Tier 1',desc:'Produces 1 Village Record per cycle',upgradeCost:{canvas_roll:2,spirit_essence:10}},
      {tier:2,label:'Tier 2',desc:'Produces 2 Village Records + canvas chance',upgradeCost:{canvas_roll:3,wild_essence:20}},
      {tier:3,label:'Tier 3',desc:'Produces 3 Village Records + guaranteed canvas',upgradeCost:null},
    ],
    craftItems:[]
  }
};

// ‚ïê‚ïê‚ïê V2.5: BUILDING MATERIAL DISPLAY ‚ïê‚ïê‚ïê
const MATERIAL_INFO={
  grinder_stone:{label:'Grinder Stone',emoji:'ü™®',desc:'Forged in expeditions'},
  ancient_tome:{label:'Ancient Tome',emoji:'üìñ',desc:'Knowledge from the Highlands'},
  training_scroll:{label:'Training Scroll',emoji:'üìú',desc:'Discipline made legible'},
  highland_orchid:{label:'Highland Orchid',emoji:'üå∏',desc:'Rare bloom from the Highlands'},
  canvas_roll:{label:'Canvas Roll',emoji:'üé®',desc:'Found at the Night Market'},
  ruin_fragment:{label:'Ruin Fragment',emoji:'üèöÔ∏è',desc:'A piece of what was'},
  wardens_crest:{label:"Warden's Crest",emoji:'üëÅÔ∏è',desc:'From the depths of the Frozen Ruins'},
  village_record:{label:'Village Record',emoji:'üéµ',desc:'Created in the Studio'},
};
const WB_MESSAGES=['The village rested while you were away...','Your spirits kept watch in the quiet hours...','The lo-fi played on while you were gone...','A gentle hum welcomes you home...','The spirits sensed your return...'];

let S={user:null,profile:null,spirits:[],traits:{},emblems:{cafe_bean:0,wild_essence:0,focus_shard:0,ashe_essence:0,spirit_essence:0},hatchery:[],pendingEggs:[],allEggs:[],pillRecipes:[],expeditions:[],_wickedPills:[],buildings:[],buildingStaff:[],buildingInventory:[],materials:{},journal:{},playing:false,currentStream:'ehoro',eggT:0,eggAnchor:null,EGG_SEC:3600,FIRST_EGG_SEC:240,GUEST_EGG_SEC:30,XP_PER_LEVEL:150,XP_ACTIVE_INTERVAL:300,sessionId:null,sessionStartedAt:null,ticker:null,hatchTicker:null,cultTicker:null,jiggleTicker:null,expedTicker:null,authMode:'login',isGuest:true,guestEggGiven:false,theme:'dark',obStep:0,settingsOpen:false,selectedSpirit:null,firstIngredientGiven:false,craftHintShown:false,wbTimer:null,profStep:0,chosenStarter:null,asheListenAccum:0,asheListenTimer:0};
let _guestDemoTicker=null; // Hoisted ‚Äî used in signOut before guest demo section
let _reconnectRetry=null;  // Hoisted ‚Äî used in hideReconnectOverlay before declaration

// ‚ïê‚ïê‚ïê V2.0: WICKED PILL INVENTORY (now DB-backed) ‚ïê‚ïê‚ïê
function getWickedPills(){return S._wickedPills||[]}
// addWickedPill and removeWickedPill now handled by RPCs
// ‚ïê‚ïê‚ïê V2.0: SPIRIT ALIGNMENT (now DB-backed on spirits.alignment column) ‚ïê‚ïê‚ïê
function getSpiritAlignment(spiritId){
  const sp=S.spirits.find(s=>s.id===spiritId);
  return sp?.alignment||'neutral';
}
// setSpiritAlignment now handled by RPCs (use_wicked_pill, craft_heavenly_pill set it server-side)
// ‚ïê‚ïê‚ïê V2.0: MILESTONE TRACKER (now DB-backed via profiles.milestones_shown) ‚ïê‚ïê‚ïê
function checkMilestones(){
  if(S.isGuest||!S.user||!S.profile)return;
  const shown=S.profile.milestones_shown||{};
  for(const m of MILESTONES){
    if(shown[m.id])continue;
    try{if(m.check()){shown[m.id]=true;S.profile.milestones_shown=shown;sb.from('profiles').update({milestones_shown:shown}).eq('id',S.user.id).then(()=>{}).catch(e=>console.warn('milestone save err',e));showMilestoneToast(m);return}}catch(e){}
  }
}
function showMilestoneToast(m){
  const t=document.getElementById('toast');
  t.classList.add('milestone');
  document.getElementById('toastI').textContent=m.icon;
  document.getElementById('toastT').textContent=m.msg;
  document.getElementById('toastS').textContent=m.sub;
  t.classList.add('show');
  setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.classList.remove('milestone'),400)},4000);
}

// ‚ïê‚ïê‚ïê DEBOUNCE FLAGS ‚Äî prevent double-clicks ‚ïê‚ïê‚ïê
let _busy={};
function setBusy(key,ms){_busy[key]=true;setTimeout(()=>{_busy[key]=false},ms||3000)}
function isBusy(key){return !!_busy[key]}

// ‚ïê‚ïê‚ïê V2.6: TRAIT DEFINITIONS ‚Äî 3 categories, slot-based system ‚ïê‚ïê‚ïê
// Slots: Seedling=1, Awakened=2, Ascended=3
// Category: expedition, cultivation, affinity
const TRAIT_DEFS={
  // EXPEDITION TRAITS ‚Äî boost time in the field
  'Wild':          {cat:'expedition',evoReq:0,desc:'A restless energy that finds more in every trip.',effect:'exped_bonus_mats',value:0.15,display:'+15% expedition drops'},
  'Adventurous':   {cat:'expedition',evoReq:0,desc:'They just love to go.',effect:'exped_bonus_mats',value:0.10,display:'+10% expedition drops'},
  'Resilient':     {cat:'expedition',evoReq:0,desc:'Shakes off the long road.',effect:'rest_reduction',value:0.20,display:'-20% expedition rest time'},
  'Scout':         {cat:'expedition',evoReq:1,desc:'Reads terrain others overlook.',effect:'exped_bonus_mats',value:0.20,display:'+20% expedition drops'},
  'Highlands Reader':{cat:'expedition',evoReq:1,desc:'Something about the old slopes feels like home. They move through quiet terrain with ease, returning with more than the others find.',effect:'location_bonus',location:'bamboo_highlands',value:0.30,display:'+30% drops in Bamboo Highlands'},
  'Market Sharp':  {cat:'expedition',evoReq:1,desc:'They\'ve always had an eye for value. In any crowd, they spot what others walk past ‚Äî and walk back with something worth keeping.',effect:'location_bonus',location:'night_market',value:0.30,display:'+30% drops in Night Market'},
  'Frost-Hardened':{cat:'expedition',evoReq:2,desc:'The cold stopped bothering them a long time ago. They\'ve been to places that would turn others back, and they carry something from each one.',effect:'location_bonus',location:'frozen_ruins',value:0.40,display:'+40% drops in Frozen Ruins'},
  'Patient':       {cat:'expedition',evoReq:1,desc:'Never in a hurry. They rest quickly, recover fully, and are ready again before anyone expects them to be.',effect:'rest_reduction',value:0.35,display:'-35% away rest time'},
  'Wanderer':      {cat:'expedition',evoReq:0,desc:'Has always been drawn toward the unfamiliar. Wherever they\'re sent, they make it count.',effect:'xp_bonus',value:0.10,display:'+10% XP from journeys'},
  'Lucky':         {cat:'expedition',evoReq:0,desc:'Some things can\'t be explained. They come back with something good more often than they should.',effect:'loot_bonus',value:0.08,display:'+8% rare find chance'},
  'Resilient':     {cat:'expedition',evoReq:1,desc:'Doesn\'t complain. Doesn\'t slow down. Returns from hard places no worse for the wear.',effect:'rest_reduction',value:0.20,display:'-20% away rest time'},
  'Instinctive':   {cat:'expedition',evoReq:2,desc:'Acts on feeling more than thought. Finds things others wouldn\'t think to look for.',effect:'loot_bonus',value:0.15,display:'+15% rare find chance'},
  // GROWTH TRAITS ‚Äî XP, leveling, pills
  'Focused':       {cat:'cultivation',evoReq:0,desc:'The music does something to them. It\'s like their thoughts unsnarl and everything comes more easily while it plays.',effect:'xp_bonus',value:0.10,display:'+10% XP gain'},
  'Studious':      {cat:'cultivation',evoReq:0,desc:'Every pill, every lesson ‚Äî they take it in fully. The results show.',effect:'xp_bonus',value:0.05,display:'+5% XP from pills'},
  'Calm':          {cat:'cultivation',evoReq:0,desc:'Stillness isn\'t emptiness for them. They grow steadily, even when nothing seems to be happening.',effect:'passive_xp_bonus',value:0.15,display:'+15% passive XP'},
  'Disciplined':   {cat:'cultivation',evoReq:2,desc:'Whatever they commit to, they see through. No shortcuts, no complaints ‚Äî just results.',effect:'xp_bonus',value:0.25,display:'+25% XP gain'},
  'Deep Roots':    {cat:'cultivation',evoReq:1,desc:'Growth doesn\'t rattle them. They absorb it steadily, like a tree in slow rain.',effect:'cult_cost_reduction',value:0.10,display:'-10% evolution cost'},
  'Meditative':    {cat:'cultivation',evoReq:1,desc:'They listen differently. The music isn\'t background noise ‚Äî it\'s practice.',effect:'listen_xp',value:0.15,display:'+15% XP from listening'},
  // AFFINITY TRAITS ‚Äî social, village, building
  'Gentle':        {cat:'affinity',evoReq:0,desc:'Something about them makes the eggs feel safe. They\'re patient with fragile things.',effect:'hatch_speed',value:0.05,display:'-5% hatch time'},
  'Warm':          {cat:'affinity',evoReq:0,desc:'The village feels more lived-in when they\'re around. Other spirits relax. The whole place breathes a little easier.',effect:'village_presence',value:1,display:'Village +1 prestige/day'},
  'Head Barista':  {cat:'affinity',evoReq:1,desc:'They learned to make drinks that taste like something. When they run the caf√©, the quality shows.',effect:'cafe_tier',value:2,display:'Caf√© drinks Tier 2+'},
  'Archivist':     {cat:'affinity',evoReq:1,desc:'Can\'t help but organize. When they work in the library, the research moves faster ‚Äî they seem to know exactly where to look.',effect:'research_speed',value:0.25,display:'+25% research speed'},
  'Sensei':        {cat:'affinity',evoReq:2,desc:'They\'ve been through enough to teach. When they work in the dojo, the others don\'t just train ‚Äî they learn.',effect:'dojo_multiplier',value:2,display:'Dojo trainees 2√ó XP'},
};

// Trait slots per evo stage
const TRAIT_SLOTS={0:1,1:2,2:3};

// Category display
const TRAIT_CATS={
  expedition:{label:'Expedition',color:'#8ab4ff',emoji:'üß≠'},
  cultivation:{label:'Growth',color:'var(--positive)',emoji:'üå±'},
  affinity:{label:'Affinity',color:'var(--special)',emoji:'‚ú¶'},
};

// ‚ïê‚ïê‚ïê TRAIT EFFECTS CONFIG ‚Äî minimal gameplay impact ‚ïê‚ïê‚ïê
// TRAIT_EFFECTS ‚Äî derived from TRAIT_DEFS for backward compatibility
// Maps trait_name ‚Üí {type, value, desc} (same shape as before)
const TRAIT_EFFECTS=Object.fromEntries(
  Object.entries(TRAIT_DEFS).map(([name,def])=>[name,{type:def.effect,value:def.value,desc:def.display}])
);

function spiritHasTraitEffect(spiritId,effectType){
  const tr=S.traits[spiritId]||[];
  return tr.some(t=>TRAIT_EFFECTS[t.trait_name]?.type===effectType);
}
function spiritTraitBonus(spiritId,effectType){
  const tr=S.traits[spiritId]||[];
  let bonus=0;
  tr.forEach(t=>{const eff=TRAIT_EFFECTS[t.trait_name];if(eff&&eff.type===effectType)bonus+=eff.value});
  return bonus;
}

// ‚ïê‚ïê‚ïê V1.5: CULTIVATION JAR ‚Äî sacrifice spirit for Wicked Pill ‚ïê‚ïê‚ïê
function openJarModal(){
  if(S.isGuest||S.spirits.length<=1)return;
  const avail=S.spirits.filter(sp=>!spiritUnavailable(sp.id));
  const box=document.getElementById('modalBox');
  let h='<div class="modal-title">üè∫ Cultivation Jar</div>';
  h+='<div class="modal-desc">Sacrifice a spirit to create a <b style="color:#c77">Wicked Spirit Pill</b>. The pill\'s power scales with the spirit\'s level and evolution. <b>This cannot be undone.</b></div>';
  h+='<div class="modal-select-grid">';
  avail.forEach(sp=>{
    const lvl=Math.floor((sp.xp||0)/100)+1;
    const tier=getWickedTier(sp);
    const align=getSpiritAlignment(sp.id);
    const alignTag=align!=='neutral'?' ¬∑ <span style="color:'+(align==='wicked'?'#c77':'#daa520')+'">'+align+'</span>':'';
    h+='<div class="modal-select-row" onclick="confirmJar(\''+sp.id+'\')"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'" style="width:28px;height:28px;border-radius:50%"><div style="flex:1;text-align:left"><div style="font-size:.65rem;font-weight:500">'+sp.name+'</div><div style="font-size:.45rem;color:var(--t3)">Lv.'+lvl+' ¬∑ '+EVO_LABELS[sp.evo_stage]+alignTag+'</div></div><div style="font-size:.45rem;color:#c77;text-align:right">‚Üí '+tier.name+'<br><span style="font-size:.4rem">'+tier.xp+' XP</span></div></div>';
  });
  h+='</div><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';
  box.innerHTML=h;document.getElementById('modal').classList.add('open');
}
function confirmJar(spiritId){
  const sp=S.spirits.find(s=>s.id===spiritId);if(!sp||S.spirits.length<=1)return;
  const tier=getWickedTier(sp);
  const box=document.getElementById('modalBox');
  let evoBonus='';
  if(sp.evo_stage>=1)evoBonus+=' +1 √Ä·π£·∫π Essence';
  if(sp.evo_stage>=2)evoBonus=' +3 √Ä·π£·∫π Essence';
  box.innerHTML='<div class="modal-title">‚ö†Ô∏è Confirm Sacrifice</div><div class="modal-desc"><b>'+sp.name+'</b> will be gone forever.<br>You will receive: <b style="color:#c77">'+tier.name+'</b> ('+tier.xp+' XP)'+(evoBonus?' and <b style="color:var(--special)">'+evoBonus+'</b>':'')+'</div><button class="modal-btn" style="background:#c77" onclick="executeJar(\''+spiritId+'\')">Sacrifice '+sp.name+'</button><button class="modal-btn secondary" onclick="openJarModal()">Go Back</button>';
}
async function executeJar(spiritId){
  if(isBusy('jar'))return;setBusy('jar',4000);closeModal();
  const sp=S.spirits.find(s=>s.id===spiritId);if(!sp||S.spirits.length<=1){showToast('error');return}
  try{
    const{data,error}=await sb.rpc('sacrifice_spirit_jar',{p_spirit_id:spiritId});
    if(error)throw error;
    if(data?.error){console.warn('jar rpc error:',data.error);showToast('error');return}
    if(S.selectedSpirit===spiritId)S.selectedSpirit=null;
    await Promise.all([reloadSpiritsAndTraits(),reloadEmblems(),reloadWickedPills()]);
    debouncedUpdateAllUI();renderPillsTab();
    showToast('jar_success');
  }catch(e){console.warn('jar sacrifice error:',e);showToast('error')}
}

// ‚ïê‚ïê‚ïê V1.5: DISMISS SPIRIT ‚Äî release for Spirit Essence ‚ïê‚ïê‚ïê
function openDismissModal(spiritId){
  if(S.isGuest||S.spirits.length<=1)return;
  const sp=S.spirits.find(s=>s.id===spiritId);if(!sp)return;
  if(spiritUnavailable(sp.id))return;
  const essence=calcDismissEssence(sp);
  const box=document.getElementById('modalBox');
  box.innerHTML='<div class="modal-title">Release Spirit?</div><div style="margin:12px auto;width:56px;height:56px;border-radius:50%;overflow:hidden;border:2px solid var(--card-border)"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'" style="width:100%;height:100%;object-fit:cover"></div><div class="modal-desc"><b>'+sp.name+'</b> will leave your village permanently.</div><div style="font-size:.6rem;color:var(--negative);text-align:center;margin:8px 0;line-height:1.5;font-weight:500">‚ö†Ô∏è This cannot be undone.</div><div style="font-size:.6rem;color:var(--t2);text-align:center;margin:8px 0;line-height:1.5">You will receive: <b style="color:var(--special)">'+essence+' Spirit Essence üí†</b></div><button class="modal-btn" style="background:var(--negative)" onclick="confirmDismiss(\''+spiritId+'\')">Yes, Release '+sp.name+'</button><button class="modal-btn secondary" onclick="closeModal()">Keep '+sp.name+'</button>';
  document.getElementById('modal').classList.add('open');
}
async function confirmDismiss(spiritId){
  // Second confirmation
  const sp=S.spirits.find(s=>s.id===spiritId);if(!sp||S.spirits.length<=1){closeModal();return}
  const box=document.getElementById('modalBox');
  box.innerHTML='<div class="modal-title" style="color:var(--negative)">Are you sure?</div><div class="modal-desc"><b>'+sp.name+'</b> will be gone forever. Really release them?</div><button class="modal-btn" style="background:var(--negative)" onclick="executeDismiss(\''+spiritId+'\')">Release Forever</button><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';
}
async function executeDismiss(spiritId){
  if(isBusy('dismiss'))return;setBusy('dismiss',4000);closeModal();
  const sp=S.spirits.find(s=>s.id===spiritId);if(!sp||S.spirits.length<=1){showToast('error');return}
  try{
    const{data,error}=await sb.rpc('dismiss_spirit',{p_spirit_id:spiritId});
    if(error)throw error;
    if(data?.error){console.warn('dismiss rpc error:',data.error);showToast('error');return}
    if(S.selectedSpirit===spiritId)S.selectedSpirit=null;
    await Promise.all([reloadSpiritsAndTraits(),reloadEmblems()]);
    debouncedUpdateAllUI();renderPillsTab();
    showToast('dismiss_success');
  }catch(e){console.warn('dismiss error:',e);showToast('error')}
}

// ‚ïê‚ïê‚ïê V1.5: USE WICKED PILL ‚Äî pick target spirit ‚ïê‚ïê‚ïê
function openUseWickedModal(pillIndex){
  if(S.isGuest||!S.spirits.length)return;
  const pills=getWickedPills();
  const pill=pills[pillIndex];if(!pill)return;
  const box=document.getElementById('modalBox');
  let h='<div class="modal-title" style="color:#c77">Use '+esc(pill.pill_name)+'</div>';
  h+='<div class="modal-desc">Choose a spirit to receive <b>'+pill.xp_value+' XP</b>.<br>The spirit will become <b style="color:#c77">Wicked</b>.</div>';
  h+='<div class="modal-select-grid">';
  S.spirits.forEach(sp=>{
    const lvl=Math.floor((sp.xp||0)/100)+1;
    const align=getSpiritAlignment(sp.id);
    const alignTag=align!=='neutral'?' <span style="color:'+(align==='wicked'?'#c77':'#daa520')+'">‚óè</span>':'';
    h+='<div class="modal-select-row" onclick="useWickedPill(\''+pill.id+'\',\''+sp.id+'\')"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'" style="width:28px;height:28px;border-radius:50%"><span style="font-size:.7rem">'+esc(sp.name)+alignTag+'</span><span style="font-size:.5rem;color:var(--t4);margin-left:auto">Lv.'+lvl+'</span></div>';
  });
  h+='</div><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';
  box.innerHTML=h;document.getElementById('modal').classList.add('open');
}
async function useWickedPill(pillId,spiritId){
  if(isBusy('use_wicked'))return;setBusy('use_wicked',3000);closeModal();
  try{
    const{data,error}=await sb.rpc('use_wicked_pill',{p_pill_id:pillId,p_spirit_id:spiritId});
    if(error)throw error;
    if(data?.error){console.warn('use wicked rpc error:',data.error);showToast('error');return}
    await Promise.all([reloadSpiritsAndTraits(),reloadWickedPills()]);
    debouncedUpdateAllUI();renderPillsTab();
    showToast('wicked_used');
    checkMilestones();
  }catch(e){console.warn('use wicked pill error:',e);showToast('error')}
}

// ‚ïê‚ïê‚ïê V1.5: HEAVENLY PILL CRAFTING ‚ïê‚ïê‚ïê
function openCraftHeavenlyModal(recipeIndex){
  if(S.isGuest||!S.spirits.length)return;
  const recipe=HEAVENLY_RECIPES[recipeIndex];if(!recipe)return;
  const box=document.getElementById('modalBox');
  let h='<div class="modal-title" style="color:#daa520">Use '+recipe.name+'</div>';
  h+='<div class="modal-desc">Choose a spirit to receive <b>'+recipe.xp+' XP</b>.<br>The spirit will become <b style="color:#daa520">Heavenly</b>.</div>';
  h+='<div class="modal-select-grid">';
  S.spirits.forEach(sp=>{
    const lvl=Math.floor((sp.xp||0)/100)+1;
    const align=getSpiritAlignment(sp.id);
    const alignTag=align!=='neutral'?' <span style="color:'+(align==='wicked'?'#c77':'#daa520')+'">‚óè</span>':'';
    h+='<div class="modal-select-row" onclick="craftAndUseHeavenly('+recipeIndex+',\''+sp.id+'\')"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'" style="width:28px;height:28px;border-radius:50%"><span style="font-size:.7rem">'+sp.name+alignTag+'</span><span style="font-size:.5rem;color:var(--t4);margin-left:auto">Lv.'+lvl+'</span></div>';
  });
  h+='</div><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';
  box.innerHTML=h;document.getElementById('modal').classList.add('open');
}
async function craftAndUseHeavenly(recipeIndex,spiritId){
  if(isBusy('craft_heavenly'))return;setBusy('craft_heavenly',3000);closeModal();
  const recipe=HEAVENLY_RECIPES[recipeIndex];if(!recipe)return;
  const sp=S.spirits.find(s=>s.id===spiritId);if(!sp){showToast('error');return}
  try{
    const{data,error}=await sb.rpc('craft_heavenly_pill',{p_recipe_id:recipe.id,p_spirit_id:spiritId});
    if(error)throw error;
    if(data?.error){console.warn('craft heavenly rpc error:',data.error);showToast('error');return}
    await Promise.all([reloadSpiritsAndTraits(),reloadEmblems()]);
    debouncedUpdateAllUI();renderPillsTab();
    showToast('heavenly_used');
    checkMilestones();
  }catch(e){console.warn('craft heavenly error:',e);showToast('error');await reloadEmblems();debouncedUpdateAllUI()}
}

// ‚ïê‚ïê‚ïê V1.5: SPIRIT INTERACTION ‚Äî tap for quips ‚ïê‚ïê‚ïê
let _quipTimeout=null;
function triggerQuip(spiritId,isDetail){
  const sp=S.spirits.find(s=>s.id===spiritId);if(!sp)return;
  const k=spiritKey(sp.spirit_type);
  const quips=SPIRIT_QUIPS[k];if(!quips)return;
  if(isDetail){
    // Long quip in detail view
    const pool=quips.long;
    const text=pool[Math.floor(Math.random()*pool.length)];
    const el=document.getElementById('sdInteractText');
    if(el){el.textContent=text;el.classList.add('show');if(_quipTimeout)clearTimeout(_quipTimeout);_quipTimeout=setTimeout(()=>el.classList.remove('show'),5000)}
  }else{
    // Short quip on card
    const pool=quips.short;
    const text=pool[Math.floor(Math.random()*pool.length)];
    const card=document.querySelector('.spirit-card[data-sid="'+spiritId+'"]');
    if(!card)return;
    const existing=card.querySelector('.spirit-quip');if(existing)existing.remove();
    const bubble=document.createElement('div');bubble.className='spirit-quip';bubble.textContent=text;
    card.appendChild(bubble);
    requestAnimationFrame(()=>bubble.classList.add('show'));
    setTimeout(()=>{bubble.classList.remove('show');setTimeout(()=>bubble.remove(),300)},2500);
  }
}

// ‚ïê‚ïê‚ïê ONBOARDING (legacy ‚Äî kept for old refs) ‚ïê‚ïê‚ïê
function showGiftToastIfClaimed(){if(S.isGuest||!S.profile?.newbie_gift_claimed)return;const key='gift_toast_shown_'+S.user.id;if(localStorage.getItem(key))return;showToast('gift');localStorage.setItem(key,'1')}

// ‚ïê‚ïê‚ïê PROFESSOR MOWANG TUTORIAL ‚ïê‚ïê‚ïê
const PROF_STEPS=[
{text:'Welcome to <b>Ehoro Village</b>! I\'m <b>Professor Mowang</b>, the village elder. I arrived here long ago as a humble slime, but this village changed me. Let me show you how things work around here.'},
{text:'In this village, <b>spirits</b> are your companions. Each one has a unique personality and story. They grow alongside you ‚Äî the more time you spend here, the stronger they become. You don\'t need to do anything special. Just <span class="prof-highlight">be present</span>.'},
{text:'While you listen to lo-fi music, <b>eggs</b> will drop over time. Place them in your <b>hatchery</b> and they\'ll incubate on their own ‚Äî even when you\'re away. When they\'re ready, hatch them to discover new spirits!'},
{text:'As your spirits grow, they gain <b>spirit levels</b>. You\'ll also collect <b>ingredients</b> ‚Äî Caf√© Beans ‚òï, Wild Essence üåø, and Focus Shards ‚ö°. Use these to craft <b>spirit pills</b> that boost your spirits\' XP. Send spirits on <b>expeditions</b> to gather rarer materials and build out your village.'},
{text:'When a spirit reaches the right level and you have enough ingredients, you can <b>evolve</b> them into a stronger form. Stage 1 at Level 3, Stage 2 at Level 5. Each evolution unlocks new <b>traits</b> ‚Äî passive bonuses that make your spirits better at expeditions, village work, and growing faster.'},
{text:'Now then ‚Äî every new villager gets to choose their <b>first spirit companion</b>. Take your time. Each one is special.',extra:'picker'},
{text:'Excellent choice! Your starter spirit, your first ingredients, and your first egg are all ready. The village awaits you. Remember ‚Äî <span class="prof-highlight">just be here</span>. That\'s all your spirits need.',extra:'final'}
];
function showProfTutorial(){S.profStep=0;S.chosenStarter=null;renderProfStep();document.getElementById('profOverlay').classList.add('show')}
function renderProfStep(){
  const step=PROF_STEPS[S.profStep],total=PROF_STEPS.length;
  document.getElementById('profText').innerHTML=step.text;
  let dots='';for(let i=0;i<total;i++)dots+='<div class="prof-dot'+(i===S.profStep?' on':'')+'"></div>';
  document.getElementById('profDots').innerHTML=dots;
  const extra=document.getElementById('profExtra');
  if(step.extra==='picker'){
    const types=['timi','bayo','mowang','florita','simi','basu_basu'];
    let grid='<div class="prof-spirit-grid">';
    types.forEach(t=>{const d=SPIRIT_DATA[t];grid+='<div class="prof-spirit-pick'+(S.chosenStarter===t?' selected':'')+'" onclick="pickStarter(\''+t+'\')" id="profPick_'+t+'"><img src="'+d.img[0]+'"><div class="prof-spirit-pick-name">'+d.name+'</div><div class="prof-spirit-pick-bio">'+d.bio.slice(0,60)+'...</div></div>'});
    grid+='</div>';extra.innerHTML=grid;
    document.getElementById('profBtn').textContent=S.chosenStarter?'Choose '+SPIRIT_DATA[S.chosenStarter].name:'Pick a spirit';
    document.getElementById('profBtn').disabled=!S.chosenStarter;
  }else if(step.extra==='final'){
    extra.innerHTML='';document.getElementById('profBtn').textContent='Enter the Village';document.getElementById('profBtn').disabled=false;
  }else{
    extra.innerHTML='';document.getElementById('profBtn').textContent='Next';document.getElementById('profBtn').disabled=false;
  }
}
function pickStarter(type){
  S.chosenStarter=type;
  document.querySelectorAll('.prof-spirit-pick').forEach(el=>el.classList.remove('selected'));
  const el=document.getElementById('profPick_'+type);if(el)el.classList.add('selected');
  document.getElementById('profBtn').textContent='Choose '+SPIRIT_DATA[type].name;
  document.getElementById('profBtn').disabled=false;
  const d=SPIRIT_DATA[type];
  document.getElementById('profText').innerHTML='Now then ‚Äî every new villager gets to choose their <b>first spirit companion</b>. Take your time. Each one is special.<br><br><b>'+d.name+'</b> ‚Äî <i>'+d.bio+'</i>';
}
async function nextProfStep(){
  const step=PROF_STEPS[S.profStep];
  if(step.extra==='picker'&&!S.chosenStarter)return;
  if(step.extra==='final'||S.profStep>=PROF_STEPS.length-1){finishProf();return}
  S.profStep++;renderProfStep();
}
async function finishProf(){
  document.getElementById('profOverlay').classList.remove('show');
  if(!S.isGuest&&S.user){
    const uid=S.user.id;
    // 1) Mark onboarding complete
    try{await sb.from('profiles').update({onboarding_done:true}).eq('id',uid)}catch(e){console.warn('finishProf: onboarding update failed',e)}
    if(S.profile)S.profile.onboarding_done=true;
    // 2) Grant chosen starter spirit ‚Äî multi-attempt with retries
    const pick=S.chosenStarter||['timi','bayo','mowang','florita','simi','basu_basu'][Math.floor(Math.random()*6)];
    const d=SPIRIT_DATA[pick];
    const{data:existing}=await sb.from('spirits').select('id').eq('user_id',uid);
    let spiritCreated=!!(existing&&existing.length>0);
    if(!spiritCreated){
      // Attempt 1: direct insert
      try{
        const{error:e1}=await withTimeout(sb.from('spirits').insert({user_id:uid,spirit_type:pick,name:d?.name||pick,evo_stage:0,xp:0}),6000);
        if(!e1)spiritCreated=true;
        else console.warn('finishProf: insert attempt 1 failed',e1);
      }catch(e){console.warn('finishProf: insert attempt 1 exception',e.message)}
      // Attempt 2: delay + retry
      if(!spiritCreated){
        await new Promise(r=>setTimeout(r,1500));
        try{
          const{error:e2}=await withTimeout(sb.from('spirits').insert({user_id:uid,spirit_type:pick,name:d?.name||pick,evo_stage:0,xp:0}),6000);
          if(!e2)spiritCreated=true;
          else console.warn('finishProf: insert attempt 2 failed',e2);
        }catch(e){console.warn('finishProf: insert attempt 2 exception',e.message)}
      }
      // Attempt 3: RPC (no params ‚Äî picks random spirit)
      if(!spiritCreated){
        try{
          const{data:rpcData,error:rpcErr}=await withTimeout(sb.rpc('claim_starter_spirit'),6000);
          if(!rpcErr&&rpcData&&!rpcData.error)spiritCreated=true;
          else console.warn('finishProf: RPC failed',rpcErr||rpcData?.error);
        }catch(e){console.warn('finishProf: RPC exception',e.message)}
      }
      if(spiritCreated){try{await sb.from('profiles').update({starter_claimed:true}).eq('id',uid)}catch(e){}}
    }
    // 3) Grant starter emblems (15 each)
    try{const{error}=await sb.rpc('ensure_newbie_pack');if(error)throw error}catch(e){
      for(const t of['cafe_bean','wild_essence','focus_shard']){try{await sb.from('emblems').upsert({user_id:uid,emblem_type:t,quantity:15},{onConflict:'user_id,emblem_type'})}catch(e2){}}
    }
    try{await sb.from('profiles').update({starter_claimed:true,newbie_gift_claimed:true}).eq('id',uid)}catch(e){}
    // 4) Grant starter egg + auto-place
    try{await sb.rpc('claim_egg_drop',{p_playlist:'cafe'})}catch(e){
      try{await sb.from('eggs').insert({user_id:uid,rarity:'mundane',playlist:'cafe',status:'pending'})}catch(e2){}
    }
    // 5) Reload everything
    await loadUserData();
    await autoPlaceEggs();
    updateAllUI();
    // V2.6: Check building production after login
    setTimeout(()=>{checkBuildingProduction();checkVillageNotif();checkHatchReady();},3500);
    localStorage.setItem('starter_pack_done_'+uid,'1');
    // 6) Show spirit arrival or error
    if(S.spirits.length>0){
      const sp=S.spirits.find(s=>s.spirit_type===pick)||S.spirits[0];
      showSpiritArrival(sp.spirit_type);
    }else{
      console.error('finishProf: Spirit creation failed after all attempts. User has 0 spirits');
      // Show user-facing error
      const errEl=document.getElementById('authError');
      if(errEl){errEl.textContent='Spirit creation failed ‚Äî please refresh and try again.';errEl.className='l-error'}
      showToast('new_user_gift');
    }
    // 7) Start all game tickers
    startHatcheryTicker();startCultivationTicker();startSpiritJiggle();startVillageTicker();startExpeditionTicker();
  }
}

// ‚ïê‚ïê‚ïê STARTER PACK ‚Äî bulletproof fallback (returning users only) ‚ïê‚ïê‚ïê
async function ensureStarterPack(){
  if(!S.user||S.isGuest)return;
  const uid=S.user.id;
  const lsKey='starter_pack_done_'+uid;
  if(localStorage.getItem(lsKey))return;
  try{
    // 1) Ensure profile exists (handle_new_user trigger may have failed)
    if(!S.profile||!S.profile.id){
      const uname=S.user.user_metadata?.username||'user_'+uid.slice(0,6);
      await sb.from('profiles').upsert({id:uid,username:uname,starter_claimed:false,newbie_gift_claimed:false,onboarding_done:false,total_eggs:0,total_listen_seconds:0,first_egg_claimed:false},{onConflict:'id'});
      const{data:p}=await sb.from('profiles').select('*').eq('id',uid).maybeSingle();
      S.profile=p||S.profile;
    }
    let gaveGifts=false;
    let starterSpiritType=null;
    // 2) Reload spirits fresh to avoid duplicates
    const{data:freshSpirits}=await sb.from('spirits').select('*').eq('user_id',uid);
    S.spirits=freshSpirits||[];
    // Only grant random starter if zero spirits AND onboarding already done (returning user edge case)
    if(S.spirits.length===0&&S.profile?.onboarding_done===true){
      try{
        const{data,error}=await sb.rpc('claim_starter_spirit');
        if(error)throw error;
        if(data&&!data.error){gaveGifts=true;starterSpiritType=data.spirit_type}
      }catch(e){
        // Re-check in case RPC partially succeeded
        const{data:recheck}=await sb.from('spirits').select('id').eq('user_id',uid);
        if(!recheck||recheck.length===0){
          const types=['timi','bayo','mowang','florita','simi','basu_basu'];
          const pick=types[Math.floor(Math.random()*types.length)];
          try{
            await sb.from('spirits').insert({user_id:uid,spirit_type:pick,name:SPIRIT_DATA[pick]?.name||pick,evo_stage:0,xp:0});
            gaveGifts=true;starterSpiritType=pick;
          }catch(e2){console.warn('ensureStarterPack: spirit insert failed',e2)}
        }
      }
    }
    // 3) Check emblems ‚Äî if any are below 15, top them up
    const low=S.emblems.cafe_bean<15||S.emblems.wild_essence<15||S.emblems.focus_shard<15;
    if(low){
      // Try RPC first
      try{
        const{data,error}=await sb.rpc('ensure_newbie_pack');
        if(error)throw error;
        if(data&&!data.error)gaveGifts=true;
      }catch(e){
        // RPC failed ‚Äî direct upsert fallback for each emblem type
        const types=['cafe_bean','wild_essence','focus_shard'];
        for(const t of types){
          if(S.emblems[t]<15){
            try{
              await sb.from('emblems').upsert({user_id:uid,emblem_type:t,quantity:15},{onConflict:'user_id,emblem_type'});
              gaveGifts=true;
            }catch(e2){console.warn('ensureStarterPack: emblem upsert failed for '+t,e2)}
          }
        }
      }
      // Mark profile flags
      try{await sb.from('profiles').update({starter_claimed:true,newbie_gift_claimed:true}).eq('id',uid)}catch(e){}
    }
    // 4) Ensure hatchery rows exist (trigger may have failed)
    if(!S.hatchery.length){
      try{
        // Check if rows exist in DB even though S.hatchery was empty at load time
        const{data:existingH}=await sb.from('hatchery').select('*').eq('user_id',uid).order('slot_number');
        if(!existingH||existingH.length===0){
          // Create the 5 default slots
          for(let sn=1;sn<=5;sn++){
            try{await sb.from('hatchery').insert({user_id:uid,slot_number:sn,unlocked:sn<=2,hatch_duration_minutes:5})}catch(e){}
          }
          const{data:h}=await sb.from('hatchery').select('*').eq('user_id',uid).order('slot_number');
          S.hatchery=h||[];
        }else{
          S.hatchery=existingH;
        }
      }catch(e){console.warn('ensureStarterPack: hatchery check failed',e)}
    }
    // 5) Ensure user has at least one egg ‚Äî if not, grant a mundane egg
    if(!S.pendingEggs.length&&S.hatchery.every(s=>!s.egg_id)){
      try{
        const{data,error}=await sb.rpc('claim_egg_drop',{p_playlist:'cafe'});
        if(!error&&data&&!data.error){gaveGifts=true;await loadUserData()}
      }catch(e){
        // Direct insert fallback
        try{await sb.from('eggs').insert({user_id:uid,rarity:'mundane',playlist:'cafe',status:'pending'});gaveGifts=true}catch(e2){}
      }
      // Auto-place it
      await loadUserData();
      await autoPlaceEggs();
    }
    // 5b) V2.8: Ensure Caf√© is unlocked for new users ‚Äî it's free to start
    if(!buildingUnlocked('cafe')){
      try{
        await sb.from('buildings').insert({user_id:uid,building_type:'cafe',is_unlocked:true,last_produced_at:new Date().toISOString()});
        await reloadBuildings();
      }catch(e){
        // Might already exist
        console.warn('ensureStarterPack: caf√© unlock failed (may already exist):',e);
        await reloadBuildings();
      }
    }
    // 6) Reload and show spirit arrival or gift toast
    if(gaveGifts){
      await loadUserData();
      updateAllUI();
      if(starterSpiritType){showSpiritArrival(starterSpiritType)}else{showToast('new_user_gift')}
    }
    // 5) Mark as done
    localStorage.setItem(lsKey,'1');
  }catch(e){console.warn('ensureStarterPack error:',e)}
}

// ‚ïê‚ïê‚ïê SPIRIT ARRIVAL SCREEN ‚ïê‚ïê‚ïê
function showSpiritArrival(spiritType){
  const k=spiritKey(spiritType),d=SPIRIT_DATA[k];
  if(!d)return showToast('new_user_gift');
  document.getElementById('saPortrait').innerHTML='<img src="'+d.img[0]+'">';
  document.getElementById('saName').textContent=d.name;
  document.getElementById('saBio').textContent=d.bio;
  document.getElementById('saWelcome').textContent=d.name+' found their way to your village';
  document.getElementById('spiritArrival').classList.add('show');
}
function dismissSpiritArrival(){document.getElementById('spiritArrival').classList.remove('show');showToast('new_user_gift')}

// ‚ïê‚ïê‚ïê WELCOME BACK ‚ïê‚ïê‚ïê
function showWelcomeBack(xpGained,hoursAway,spiritData){const wb=document.getElementById('welcomeBack');if(!wb)return;
  // Show the spirit that gained XP if available, else random
  const sp=spiritData||( S.spirits.length?S.spirits[Math.floor(Math.random()*S.spirits.length)]:null);
  const msg=WB_MESSAGES[Math.floor(Math.random()*WB_MESSAGES.length)];
  document.getElementById('wbMsg').textContent=msg;
  if(sp)document.getElementById('wbPortrait').innerHTML='<img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'">';
  let gains='';
  if(xpGained>0)gains+=(sp?sp.name+' gained':'Your spirits gained')+' +'+xpGained+' XP';
  if(hoursAway>0)gains+=(gains?' \u00b7 ':'')+Math.round(hoursAway)+'h away';
  // Village gift for 5+ hour returns ‚Äî atomic server-side grant
  if(hoursAway>=5&&!S.isGuest){
    const bonus=Math.min(Math.floor(hoursAway),8);
    gains+=' \u00b7 Village gift: +'+bonus+'\u00d7 each ingredient';
    sb.rpc('grant_village_gift',{p_hours_away:hoursAway}).then(()=>{
      reloadEmblems().then(()=>renderPillsTab());
    }).catch(e=>{
      // Fallback: optimistic update if RPC fails
      S.emblems.cafe_bean+=bonus;S.emblems.wild_essence+=bonus;S.emblems.focus_shard+=bonus;
      console.warn('village gift rpc err (optimistic fallback):',e);
      renderPillsTab();
    });
  }
  document.getElementById('wbGains').textContent=gains||'Everything is as you left it.';
  wb.classList.remove('gone');
  // Auto-dismiss after 10 seconds
  S.wbTimer=setTimeout(()=>dismissWB(),10000);
}
function dismissWB(){if(S.wbTimer)clearTimeout(S.wbTimer);document.getElementById('welcomeBack').classList.add('gone')}

// ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê
function toggleSettings(){S.settingsOpen=!S.settingsOpen;document.getElementById('settingsDrop').classList.toggle('open',S.settingsOpen)}
document.addEventListener('click',e=>{if(S.settingsOpen&&!e.target.closest('.settings-drop')&&!e.target.closest('.tb-gear')){S.settingsOpen=false;document.getElementById('settingsDrop').classList.remove('open')}});
function toggleTheme(){S.theme=S.theme==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',S.theme);document.getElementById('themeToggle').classList.toggle('on',S.theme==='light')}
function switchTab(btn){document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('on'));document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('on'));btn.classList.add('on');document.getElementById('tab-'+btn.dataset.tab).classList.add('on');if(btn.dataset.tab==='village')markVillageSeen();}
function showPrivacy(){toggleSettings();const box=document.getElementById('modalBox');box.innerHTML='<div class="modal-title">Privacy Policy</div><div class="pp-content"><h3>Super Ube LLC</h3><p>Ehoro Village is operated by Super Ube LLC, based in Georgia, United States.</p><h3>What We Collect</h3><p>When you create an account, we store your email address, username, and gameplay data (spirits, eggs, ingredients, listening time). We use Supabase for authentication and data storage.</p><h3>How We Use Your Data</h3><p>Your data is used solely to provide and improve the Ehoro Village experience. We do not sell, share, or distribute your personal information to third parties.</p><h3>Analytics</h3><p>We collect anonymized gameplay analytics to improve game balance. No personal information is included.</p><h3>Cookies</h3><p>We use essential cookies for authentication only. No tracking cookies.</p><h3>Data Deletion</h3><p>Request deletion of your account and data by contacting support@superube.com.</p><p style="color:var(--t4);margin-top:12px">Last updated: February 2026</p></div><button class="modal-btn secondary" onclick="closeModal()">Close</button>';document.getElementById('modal').classList.add('open')}
function showPatchNotes(){toggleSettings();document.getElementById('patchNotes').classList.add('show')}
function closePatchNotes(){document.getElementById('patchNotes').classList.remove('show')}

// ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
function showLogin(){document.getElementById('login').classList.remove('gone');S.authMode='signup';document.getElementById('authBtn').textContent='Create Account';document.getElementById('authToggle').textContent='Already have an account? Sign in';document.getElementById('usernameField').style.display=''}
function toggleAuthMode(){S.authMode=S.authMode==='login'?'signup':'login';const u=S.authMode==='signup';document.getElementById('authBtn').textContent=u?'Create Account':'Sign In';document.getElementById('authToggle').textContent=u?'Already have an account? Sign in':'Need an account? Sign up';document.getElementById('usernameField').style.display=u?'':'none';document.getElementById('authError').textContent=''}
async function doAuth(){const email=document.getElementById('inEmail').value.trim(),pass=document.getElementById('inPass').value,btn=document.getElementById('authBtn'),err=document.getElementById('authError');err.textContent='';err.className='l-error';if(!email||!pass){err.textContent='Email and password required';return}if(pass.length<6){err.textContent='Password must be 6+ characters';return}
btn.disabled=true;btn.textContent='Loading...';try{let r;if(S.authMode==='signup'){const un=document.getElementById('inUser').value.trim()||'user_'+Math.random().toString(36).slice(2,8);r=await withTimeout(sb.auth.signUp({email,password:pass,options:{data:{username:un}}}),10000);if(r.data?.user&&!r.data.session){err.className='l-error ok';err.textContent='Check email to confirm!';btn.disabled=false;btn.textContent='Create Account';return}}else{r=await withTimeout(sb.auth.signInWithPassword({email,password:pass}),10000)}if(r.error)throw r.error;S.user=r.data.user;S.isGuest=false;await loadUserData();updateTopBar();enterApp()}catch(e){const msg=e.message||'Auth failed';err.textContent=msg.includes('abort')||msg.includes('timed out')?'Connection issue ‚Äî please check your internet connection':msg}finally{btn.disabled=false;btn.textContent=S.authMode==='signup'?'Create Account':'Sign In'}}
async function doGoogleAuth(){try{const{error}=await sb.auth.signInWithOAuth({provider:'google',options:{redirectTo:window.location.origin}});if(error)throw error}catch(e){document.getElementById('authError').textContent=e.message||'Google sign-in failed'}}
function enterGuest(){document.getElementById('login').classList.add('gone');document.getElementById('shell').classList.add('on');S.isGuest=true;S.user=null;updateTopBar();loadGuestDefaults();startGuestDemo()}
function loadGuestDefaults(){S.spirits=[];S.traits={};S.emblems={cafe_bean:0,wild_essence:0,focus_shard:0,ashe_essence:0,spirit_essence:0};S.profile={total_eggs:0,total_listen_seconds:0,username:'guest'};S.hatchery=[{id:'gs1',slot_number:1,unlocked:true,egg_id:null},{id:'gs2',slot_number:2,unlocked:true,egg_id:null},{id:'gs3',slot_number:3,unlocked:false},{id:'gs4',slot_number:4,unlocked:false},{id:'gs5',slot_number:5,unlocked:false}];S.pendingEggs=[];S.expeditions=[];S.pillRecipes=[{id:'d1',pill_name:'Spirit Pill',pill_type:'growth',description:'Grants 50 XP to a spirit.',effect_type:'xp_flat',effect_value:50,cost_cafe_bean:4,cost_wild_essence:2,cost_focus_shard:2},{id:'d2',pill_name:'Greater Spirit Pill',pill_type:'clarity',description:'Grants 100 XP to a spirit.',effect_type:'xp_flat',effect_value:100,cost_cafe_bean:6,cost_wild_essence:6,cost_focus_shard:6},{id:'d3',pill_name:'Village Spirit Pill',pill_type:'harmony',description:'Grants 25 XP to ALL spirits.',effect_type:'xp_all',effect_value:25,cost_cafe_bean:3,cost_wild_essence:3,cost_focus_shard:8}];updateAllUI();document.getElementById('guestBanner').classList.add('show')}
async function doLogout(){toggleSettings();
// Persist listen time before logout
if(S.sessionStartedAt&&S.profile&&S.user&&!S.isGuest){const sec=Math.floor((Date.now()-S.sessionStartedAt)/1000);const newSec=(S.profile.total_listen_seconds||0)+sec;const newMin=Math.floor(newSec/60);try{await sb.from('profiles').update({total_listen_seconds:newSec,total_listen_minutes:newMin}).eq('id',S.user.id);S.profile.total_listen_seconds=newSec;S.profile.total_listen_minutes=newMin}catch(e){}}
if(S.sessionId){try{await sb.rpc('end_session',{p_session_id:S.sessionId})}catch(e){}S.sessionId=null}
await sb.auth.signOut();S.user=null;S.playing=false;S.isGuest=true;S.spirits=[];S.hatchery=[];S.pendingEggs=[];S.allEggs=[];S.expeditions=[];
S.emblems={cafe_bean:0,wild_essence:0,focus_shard:0,ashe_essence:0,spirit_essence:0};S.profile=null;S.sessionStartedAt=null;S.eggAnchor=null;S.profStep=0;S.chosenStarter=null;
[S.ticker,S.hatchTicker,S.cultTicker,S.jiggleTicker,S.expedTicker,_guestDemoTicker].forEach(t=>{if(t)clearInterval(t)});S.ticker=S.hatchTicker=S.cultTicker=S.jiggleTicker=S.expedTicker=null;_guestDemoTicker=null;
const em=document.getElementById('videoEmbed'),ifr=em.querySelector('iframe');if(ifr)ifr.remove();em.classList.remove('loaded');
// Reset stream switcher UI to Sakura Jazz default
S.currentStream='ehoro';
document.querySelectorAll('.stream-pill').forEach(p=>p.classList.remove('active'));
const pillDef=document.getElementById('pillEhoro');if(pillDef)pillDef.classList.add('active');
const psTitle=document.getElementById('psTitle');if(psTitle)psTitle.textContent='Ehoro Village Radio';
const psSub=document.getElementById('psSub');if(psSub)psSub.textContent='lo-fi beats to study to';
const vpText=document.getElementById('vpText');if(vpText)vpText.textContent='üåô Ehoro Village Radio';
document.getElementById('guestBanner').classList.remove('show');
document.getElementById('login').classList.remove('gone');updateTopBar()}
async function checkSession(){
  for(let attempt=0;attempt<2;attempt++){
    try{
      const{data:{session}}=await withTimeout(sb.auth.getSession(),5000);
      if(session?.user){S.user=session.user;S.isGuest=false;await loadUserData();enterApp();return true}
      return false;
    }catch(e){
      console.warn('checkSession attempt '+(attempt+1)+' error:',e.message);
      if(attempt<1)await new Promise(r=>setTimeout(r,1000));
    }
  }
  return false;
}
async function loadUserData(){if(!S.user)return;
  try{
  const sIds=(await sb.from('spirits').select('id').eq('user_id',S.user.id)).data?.map(s=>s.id)||[];
  const hasRealPills=S.pillRecipes.length&&S.pillRecipes[0].id&&S.pillRecipes[0].id.length>10;
  const fetchPills=hasRealPills?Promise.resolve({data:null}):sb.from('pill_recipes').select('*');
  const[{data:prof},{data:spirits},{data:emb},{data:hatch},{data:traits},{data:eggs},{data:pills},{data:expeds},{data:wpills}]=await Promise.all([sb.from('profiles').select('*').eq('id',S.user.id).maybeSingle(),sb.from('spirits').select('*').eq('user_id',S.user.id),sb.from('emblems').select('*').eq('user_id',S.user.id),sb.from('hatchery').select('*').eq('user_id',S.user.id).order('slot_number'),sb.from('spirit_traits').select('*').in('spirit_id',sIds.length?sIds:['00000000-0000-0000-0000-000000000000']),sb.from('eggs').select('*').eq('user_id',S.user.id).in('status',['pending','incubating']).limit(30),fetchPills,sb.from('expeditions').select('*').eq('user_id',S.user.id),sb.from('wicked_pills').select('*').eq('user_id',S.user.id).order('id')]);
  // Only overwrite S if we got valid data back (never overwrite with nulls from failed fetch)
  if(prof!==undefined)S.profile=prof||S.profile;
  if(S.profile&&S.profile.starter_claimed===undefined)S.profile.starter_claimed=false;
  if(spirits)S.spirits=spirits.map(sp=>({...sp,cultivation_stage:sp.cultivation_stage||0}));
  if(hatch)S.hatchery=hatch;
  const allEggs=eggs||[];S.pendingEggs=allEggs.filter(e=>e.status==='pending');S.allEggs=allEggs;
  if(pills)S.pillRecipes=pills.map(p=>({...p,pill_name:mapPillName(p.pill_name)}));
  if(expeds!==undefined)S.expeditions=expeds||[];
  if(emb)emb.forEach(e=>{S.emblems[e.emblem_type]=e.quantity});
  S.traits={};if(traits)traits.forEach(t=>{if(!S.traits[t.spirit_id])S.traits[t.spirit_id]=[];S.traits[t.spirit_id].push(t)});
  // V2.0: Wicked pills from DB
  S._wickedPills=wpills||[];
  // V2.5: Load buildings in parallel
  if(!S.isGuest)reloadBuildings().then(()=>{syncMaterialsFromInventory()}).catch(e=>console.warn('buildings reload err:',e));
  // V2.6: Load journal non-blocking
  if(!S.isGuest)reloadJournal().catch(e=>console.warn('journal reload err:',e));
  // Dismiss reconnect overlay on success
  hideReconnectOverlay();
  }catch(e){
    console.warn('loadUserData failed:',e);
    showReconnectOverlay();
    throw e; // Re-throw so callers know it failed
  }
}

// ‚ïê‚ïê‚ïê RECONNECTING OVERLAY ‚ïê‚ïê‚ïê
// _reconnectRetry hoisted to top
function showReconnectOverlay(){
  const ov=document.getElementById('reconnectOverlay');if(!ov)return;
  ov.classList.remove('gone');
  if(!_reconnectRetry){
    let attempts=0;
    _reconnectRetry=setInterval(async()=>{
      attempts++;
      const msg=document.getElementById('reconnectMsg');
      if(msg)msg.textContent='Retry attempt '+attempts+'‚Ä¶';
      try{
        await loadUserData();
        updateAllUI();
        // If we get here, it worked
        hideReconnectOverlay();
      }catch(e){/* still failing, keep retrying */}
    },4000);
  }
}
function hideReconnectOverlay(){
  const ov=document.getElementById('reconnectOverlay');if(ov)ov.classList.add('gone');
  if(_reconnectRetry){clearInterval(_reconnectRetry);_reconnectRetry=null}
}

// ‚ïê‚ïê‚ïê ENTER APP ‚ïê‚ïê‚ïê
async function enterApp(){
document.getElementById('login').classList.add('gone');
document.getElementById('shell').classList.add('on');
document.getElementById('guestBanner').classList.remove('show');
updateTopBar();updateAllUI();
// New user detection: profile doesn't exist OR onboarding_done is false/null
// AND user has no spirits yet
const hasNoProfile=!S.profile||!S.profile.id;
const onboardingNotDone=!S.profile||S.profile.onboarding_done===false||S.profile.onboarding_done===null;
const hasNoSpirits=!S.spirits||S.spirits.length===0;
const isNewUser=(hasNoProfile||onboardingNotDone)&&hasNoSpirits;
if(isNewUser){
  await ensureBasicsOnly();
  showProfTutorial();return}
// Returning user flow
await ensureStarterPack();
syncStreak(); // V2.0: DB-backed streak update
checkOfflineHatches();startHatcheryTicker();startCultivationTicker();startSpiritJiggle();startVillageTicker();startExpeditionTicker();
// Only show welcome back / passive cultivation for returning users
try{const{data}=await sb.rpc('claim_passive_cultivation');if(data&&data.xp_granted>0&&data.hours_away>=1){
// Trait effect: Calm spirits get bonus passive XP
for(const sp of S.spirits){const calmBonus=spiritTraitBonus(sp.id,'passive_xp_bonus');if(calmBonus>0){const bonusXp=Math.max(1,Math.floor(data.xp_granted*calmBonus));const newXp=(sp.xp||0)+bonusXp;sb.from('spirits').update({xp:newXp}).eq('id',sp.id).then(()=>{}).catch(e=>console.warn('calm bonus err',e))}}
await loadUserData();updateAllUI();
const topSpirit=S.spirits.length?S.spirits.reduce((a,b)=>(b.xp||0)>(a.xp||0)?b:a):null;showWelcomeBack(data.xp_granted,data.hours_away,topSpirit)}else{showToast('welcome')}}catch(e){console.warn('passive cultivation error:',e)}}

// Lightweight setup for new users ‚Äî profile + hatchery only, no spirits/eggs/emblems
async function ensureBasicsOnly(){
  if(!S.user||S.isGuest)return;const uid=S.user.id;
  try{
    if(!S.profile||!S.profile.id){
      const uname=S.user.user_metadata?.username||'user_'+uid.slice(0,6);
      await sb.from('profiles').upsert({id:uid,username:uname,starter_claimed:false,newbie_gift_claimed:false,onboarding_done:false,total_eggs:0,total_listen_seconds:0,first_egg_claimed:false},{onConflict:'id'});
      const{data:p}=await sb.from('profiles').select('*').eq('id',uid).maybeSingle();S.profile=p||S.profile;
    }
    if(!S.hatchery.length){
      const{data:existingH}=await sb.from('hatchery').select('*').eq('user_id',uid).order('slot_number');
      if(!existingH||existingH.length===0){
        for(let sn=1;sn<=5;sn++){try{await sb.from('hatchery').insert({user_id:uid,slot_number:sn,unlocked:sn<=2,hatch_duration_minutes:5})}catch(e){}}
        const{data:h}=await sb.from('hatchery').select('*').eq('user_id',uid).order('slot_number');S.hatchery=h||[];
      }else{S.hatchery=existingH}
    }
  }catch(e){console.warn('ensureBasicsOnly error:',e)}
}
// Village tab ticker for live listen time
// ‚ïê‚ïê‚ïê PILL NAME MAPPING (client-side rename) ‚ïê‚ïê‚ïê
function mapPillName(n){const m={'Cultivation Pill':'Spirit Pill','Greater Cultivation Pill':'Greater Spirit Pill','Village Cultivation Pill':'Village Spirit Pill'};return m[n]||n}

// ‚ïê‚ïê‚ïê EXPEDITION HELPERS ‚ïê‚ïê‚ïê
function spiritOnExpedition(spiritId){return S.expeditions.some(e=>{if(!e.spirit_ids)return false;const st=getExpedStatus(e);if(st==='idle')return false;const ids=Array.isArray(e.spirit_ids)?e.spirit_ids:[];return ids.includes(spiritId)})}
function spiritResting(spiritId){return S.expeditions.some(e=>{if(!e.spirit_ids)return false;if(getExpedStatus(e)!=='resting')return false;const ids=Array.isArray(e.spirit_ids)?e.spirit_ids:[];return ids.includes(spiritId)})}
function spiritUnavailable(spiritId){return spiritOnExpedition(spiritId)||spiritResting(spiritId)}

function getExpedStatus(exp){
  if(!exp.started_at)return'idle';
  const durMs=exp.duration_minutes*60*1000;
  const elapsed=Date.now()-new Date(exp.started_at).getTime();
  const isCompleted=!!exp.completed||!!exp.completed_at;
  if(!isCompleted&&elapsed>=durMs)return'ready';
  if(!isCompleted)return'active';
  if(exp.rest_until&&new Date(exp.rest_until).getTime()>Date.now())return'resting';
  return'idle';
}

function renderExpedSlot(exp,slotNum,locked){
  if(locked)return'<div class="exped-slot locked"><div class="exped-slot-header"><span class="exped-slot-title">Expedition Slot '+slotNum+'</span><span class="exped-slot-status">üîí</span></div><div style="font-size:.5rem;color:var(--t4);text-align:center">Unlocks at Silver rank (400 prestige)</div></div>';
  if(!exp||!exp.started_at||((exp.completed||exp.completed_at)&&(!exp.rest_until||new Date(exp.rest_until).getTime()<=Date.now()))){
    return'<div class="exped-slot"><div class="exped-slot-header"><span class="exped-slot-title">Expedition Slot '+slotNum+'</span><span class="exped-slot-status">Ready</span></div><button class="exped-btn" onclick="openExpedModal('+slotNum+')">Send Expedition</button></div>';
  }
  const status=getExpedStatus(exp);
  const ids=Array.isArray(exp.spirit_ids)?exp.spirit_ids:[];
  let spiritImgs=ids.map(sid=>{const sp=S.spirits.find(s=>s.id===sid);return sp?'<div class="exped-spirit-img"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'"></div>':''}).join('');
  if(status==='active'){
    const durMs=exp.duration_minutes*60*1000;const elapsed=Date.now()-new Date(exp.started_at).getTime();const pct=Math.min(100,(elapsed/durMs)*100);const remain=Math.max(0,durMs-elapsed);const rm=Math.floor(remain/60000),rs=Math.floor((remain%60000)/1000);
    const locId=exp.location||'night_market';const locLabel=(EXPED_LOCATIONS[locId]?.emoji||'üß≠')+' '+(EXPED_LOCATIONS[locId]?.label||'Expedition');
    return'<div class="exped-slot"><div class="exped-slot-header"><span class="exped-slot-title">Expedition Slot '+slotNum+'</span><span class="exped-slot-status">Exploring...</span></div><div class="exped-slot-location">'+locLabel+'</div><div class="exped-spirits">'+spiritImgs+'</div><div class="exped-bar"><div class="exped-bar-fill active" style="width:'+pct+'%"></div></div><div class="exped-timer">'+rm+'m '+rs+'s remaining</div></div>';
  }
  if(status==='ready'){
    return'<div class="exped-slot"><div class="exped-slot-header"><span class="exped-slot-title">Expedition Slot '+slotNum+'</span><span class="exped-slot-status" style="color:var(--positive)">Complete!</span></div><div class="exped-spirits">'+spiritImgs+'</div><button class="exped-btn claim" onclick="claimExpedition(\''+exp.id+'\')">Claim Rewards</button></div>';
  }
  if(status==='resting'){
    const restEnd=new Date(exp.rest_until).getTime();const remain=Math.max(0,restEnd-Date.now());const rm=Math.floor(remain/60000),rs=Math.floor((remain%60000)/1000);const cfgRest=Object.values(EXPED_CONFIG).find(c=>c.minutes===exp.duration_minutes);const restTotalMs=(cfgRest?cfgRest.restMinutes:5)*60*1000;const pct=Math.min(100,((restTotalMs-remain)/restTotalMs)*100);
    return'<div class="exped-slot"><div class="exped-slot-header"><span class="exped-slot-title">Expedition Slot '+slotNum+'</span><span class="exped-slot-status" style="color:var(--special)">Spirits resting</span></div><div class="exped-spirits">'+spiritImgs+'</div><div class="exped-bar"><div class="exped-bar-fill resting" style="width:'+pct+'%"></div></div><div class="exped-timer">'+rm+'m '+rs+'s rest</div></div>';
  }
  return'<div class="exped-slot"><div class="exped-slot-header"><span class="exped-slot-title">Expedition Slot '+slotNum+'</span></div><button class="exped-btn" onclick="openExpedModal('+slotNum+')">Send Expedition</button></div>';
}

// ‚ïê‚ïê‚ïê V2.5: EXPEDITION MODAL ‚Äî Location + Duration + Spirits ‚ïê‚ïê‚ïê
let _expedModal={slot:null,location:'night_market',duration:'medium',selectedSpirits:[]};

function openExpedModal(slotNum){
  if(S.isGuest||!S.spirits.length)return;
  const maxLvl=Math.max(...S.spirits.map(sp=>Math.floor((sp.xp||0)/S.XP_PER_LEVEL)+1));
  let defaultLoc='night_market';
  if(maxLvl>=4)defaultLoc='frozen_ruins';
  else if(maxLvl>=2)defaultLoc='bamboo_highlands';
  _expedModal={slot:slotNum,location:defaultLoc,duration:'medium',selectedSpirits:[]};
  const loc=EXPED_LOCATIONS[defaultLoc];
  if(!loc.durations.medium){_expedModal.duration=loc.durations.long?'long':'short';}
  const box=document.getElementById('modalBox');
  renderExpedModalContent(box);
  document.getElementById('modal').classList.add('open');
}

function renderExpedModalContent(box){
  const loc=EXPED_LOCATIONS[_expedModal.location];
  const maxLvl=Math.max(1,...S.spirits.map(sp=>Math.floor((sp.xp||0)/S.XP_PER_LEVEL)+1));
  const maxEvo=Math.max(0,...S.spirits.map(sp=>sp.evo_stage||0));
  let h='<div class="modal-title">Send Expedition</div>';
  h+='<div class="exped-section-label">Location</div>';
  h+='<div class="exped-loc-grid">';
  Object.values(EXPED_LOCATIONS).forEach(l=>{
    const meetsLvl=maxLvl>=l.minLevel;
    const meetsEvo=maxEvo>=(l.minEvoStage||0);
    const meetsReq=meetsLvl&&meetsEvo;
    const isSelected=_expedModal.location===l.id;
    const reqLabel=!meetsLvl?'Lv.'+l.minLevel+' required':!meetsEvo?EVO_LABELS[l.minEvoStage||0]+' spirit required':'';
    h+='<div class="exped-loc-opt'+(isSelected?' selected':'')+(meetsReq?'':' locked')+'" onclick="'+(meetsReq?"selectExpedLoc('"+l.id+"')":'showToast(\'no_eggs\')')+'">';
    h+='<div class="exped-loc-header"><span class="exped-loc-emoji">'+l.emoji+'</span><span class="exped-loc-name">'+l.label+'</span>'+(meetsReq?'':'<span class="exped-loc-req">'+reqLabel+'</span>')+'</div>';
    h+='<div class="exped-loc-desc">'+l.desc+'</div>';
    // V2.9: Show loot table if researched in library
    if(meetsReq&&locationIsLibraryResearched(l.id)){
      h+='<div class="exped-loot-items" style="margin-top:4px">';
      l.lootTable.forEach(item=>{
        h+='<span class="exped-loot-item rarity-'+item.rarity+' researched">'+item.emoji+' '+item.label+'</span>';
      });
      h+='</div>';
    }
    h+='</div>';
  });
  h+='</div>';
  h+='<div class="exped-section-label" style="margin-top:10px">Duration</div>';
  h+='<div class="exped-dur-grid">';
  Object.entries(EXPED_CONFIG).forEach(([key,cfg])=>{
    if(!loc.durations[key])return;
    const sel=_expedModal.duration===key;
    h+='<div class="exped-dur-opt'+(sel?' selected':'')+'" onclick="selectExpedDur(\''+key+'\')">';
    h+='<div class="exped-dur-label">'+cfg.label+'</div>';
    h+='<div class="exped-dur-time">'+cfg.minutes+'m ¬∑ '+cfg.restMinutes+'m rest</div>';
    h+='</div>';
  });
  h+='</div>';
  h+='<div class="exped-section-label" style="margin-top:10px">Spirits <span style="color:var(--t4);font-size:.45rem">(up to 3)</span></div>';
  h+='<div class="exped-spirit-select">';
  S.spirits.forEach(sp=>{
    const unavail=spiritUnavailable(sp.id);
    const sel=_expedModal.selectedSpirits.includes(sp.id);
    const lvl=Math.floor((sp.xp||0)/S.XP_PER_LEVEL)+1;
    const spTraits=S.traits[sp.id]||[];
    const expedHints=spTraits.map(t=>{const eff=TRAIT_EFFECTS[t.trait_name];if(!eff)return'';if(eff.type==='exped_bonus_mats')return t.trait_name+' +'+Math.round(eff.value*100)+'% mats';if(eff.type==='rest_reduction')return t.trait_name+' -'+Math.round(eff.value*100)+'% rest';return''}).filter(Boolean);
    h+='<div class="exped-spirit-opt'+(sel?' selected':'')+(unavail?' unavailable':'')+'" onclick="toggleExpedSpirit(\''+sp.id+'\')">';
    h+='<img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'">';
    h+='<div class="exped-spirit-opt-info"><div class="exped-spirit-opt-name">'+sp.name+'</div>';
    h+='<div class="exped-spirit-opt-lvl">Lv.'+lvl+(unavail?' ¬∑ Busy':'')+'</div>';
    if(expedHints.length)h+='<div class="exped-spirit-traits">'+expedHints.join(' ¬∑ ')+'</div>';
    h+='</div><div class="exped-spirit-opt-check">'+(sel?'‚úì':'')+'</div></div>';
  });
  h+='</div>';
  const cfg=EXPED_CONFIG[_expedModal.duration];
  const selCount=_expedModal.selectedSpirits.length;
  if(selCount>0){
    h+='<div class="exped-loot-preview"><div class="exped-loot-title">'+loc.emoji+' Possible loot</div><div class="exped-loot-items">';
    const deduped=loc.lootTable.filter((v,i,a)=>a.findIndex(x=>x.id===v.id)===i).slice(0,6);
    deduped.forEach(item=>{ h+='<div class="exped-loot-item rarity-'+item.rarity+'">'+item.emoji+' '+item.label+'</div>'; });
    h+='</div></div>';
  }
  const sendOk=selCount>0&&selCount<=3;
  // V2.8: Loot multiplier hint
  const LOOT_HINTS={1:'1 spirit ‚Üí base loot',2:'2 spirits ‚Üí +40% loot',3:'3 spirits ‚Üí +90% loot'};
  if(selCount>0)h+='<div class="exped-spirit-count-hint">'+LOOT_HINTS[selCount]+'</div>';
  h+='<button class="modal-btn" '+(sendOk?'':'disabled')+' onclick="sendExpedition()" style="margin-top:10px">Send '+selCount+' spirit'+(selCount!==1?'s':'')+' ‚Üí '+loc.label+'</button>';
  h+='<button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';
  box.innerHTML=h;
}

function selectExpedLoc(locId){
  _expedModal.location=locId;
  const loc=EXPED_LOCATIONS[locId];
  if(!loc.durations[_expedModal.duration]){_expedModal.duration=loc.durations.medium?'medium':loc.durations.long?'long':'short';}
  renderExpedModalContent(document.getElementById('modalBox'));
}
function selectExpedDur(key){_expedModal.duration=key;renderExpedModalContent(document.getElementById('modalBox'))}
function toggleExpedSpirit(sid){
  const idx=_expedModal.selectedSpirits.indexOf(sid);
  if(idx>=0)_expedModal.selectedSpirits.splice(idx,1);
  else if(_expedModal.selectedSpirits.length<3)_expedModal.selectedSpirits.push(sid);
  renderExpedModalContent(document.getElementById('modalBox'));
}

// ‚ïê‚ïê‚ïê SEND EXPEDITION (HARDENED) ‚ïê‚ïê‚ïê
async function sendExpedition() {
  if (S.isGuest || !_expedModal.selectedSpirits.length || isBusy('send_exped')) return;
  setBusy('send_exped', 4000);
  closeModal();
  try {
    const payload = {
      p_slot: _expedModal.slot,
      p_spirit_ids: _expedModal.selectedSpirits,
      p_duration: _expedModal.duration,
      p_location: _expedModal.location || 'night_market'
    };
    
    let res = await sb.rpc('send_expedition', payload);
    
    // Fallback if DB schema lacks p_location parameter
    if (res.error && (res.error.code === 'PGRST202' || res.error.message?.includes('p_location'))) {
      console.warn('send_expedition: p_location not in DB yet, falling back to 3-param');
      delete payload.p_location;
      res = await sb.rpc('send_expedition', payload);
    }
    
    if (res.error) throw res.error;
    if (res.data?.error) { console.warn('send exped rpc error:', res.data.error); showToast('error'); return; }
    
    await reloadExpeditions(); 
    debouncedUpdateAllUI();
    const locLabel = EXPED_LOCATIONS[_expedModal.location]?.label || 'the wilderness';
    showToastMsg('üß≠', 'Expedition sent!', 'Your spirits set off for ' + locLabel + '‚Ä¶');
  } catch (e) {
    console.warn('send expedition error:', e); 
    showToast('error');
  }
}

// ‚ïê‚ïê‚ïê V3.3: CLAIM EXPEDITION ‚Äî NUCLEAR LOCAL-FIRST REBUILD ‚ïê‚ïê‚ïê
// Loot is calculated entirely client-side. State updates instantly.
// DB write fires 1s later as fire-and-forget with retry.

function calculateExpeditionLoot(exp){
  const locId=exp.location||'night_market';
  const loc=EXPED_LOCATIONS[locId];
  if(!loc)return{loot_items:[],bonus_xp:0,got_ashe:false,total_mats:0,rest_minutes:0,emblem_deltas:{},material_items:[]};

  const durType=exp.duration_type||Object.keys(EXPED_CONFIG).find(k=>EXPED_CONFIG[k].minutes===exp.duration_minutes)||'medium';
  const cfg=EXPED_CONFIG[durType]||EXPED_CONFIG.medium;
  const spiritIds=Array.isArray(exp.spirit_ids)?exp.spirit_ids:[];
  const spirits=spiritIds.map(id=>S.spirits.find(s=>s.id===id)).filter(Boolean);

  // ‚îÄ‚îÄ Trait aggregation ‚îÄ‚îÄ
  let matMultiplier=1;
  let locMultiplier=1;
  let rareBonusChance=0;
  let restMultiplier=1;
  let xpMultiplier=1;
  let wickedCount=0;

  spiritIds.forEach(sid=>{
    const traits=S.traits[sid]||[];
    const sp=S.spirits.find(s=>s.id===sid);
    if(sp&&sp.alignment==='wicked')wickedCount++;
    traits.forEach(t=>{
      const def=TRAIT_DEFS[t.trait_name];
      if(!def)return;
      if(def.effect==='exped_bonus_mats')matMultiplier+=def.value;
      if(def.effect==='location_bonus'&&def.location===locId)locMultiplier+=def.value;
      if(def.effect==='loot_bonus')rareBonusChance+=def.value;
      if(def.effect==='rest_reduction')restMultiplier-=def.value;
      if(def.effect==='xp_bonus')xpMultiplier+=def.value;
    });
  });

  // Wicked alignment: +10% mats per wicked spirit
  matMultiplier+=wickedCount*0.10;

  // Spirit count multiplier: 1=1x, 2=1.4x, 3=1.9x
  const countMult=spiritIds.length===3?1.9:spiritIds.length===2?1.4:1;
  matMultiplier*=countMult;

  // Dojo rest reduction (if unlocked)
  const dojoData=getBuildingData('dojo');
  if(dojoData&&dojoData.is_unlocked)restMultiplier-=0.10;
  restMultiplier=Math.max(0.1,restMultiplier);

  // ‚îÄ‚îÄ Roll loot ‚îÄ‚îÄ
  const [minMats,maxMats]=cfg.baseMats;
  let totalMatsRaw=minMats+Math.floor(Math.random()*(maxMats-minMats+1));
  let totalMats=Math.round(totalMatsRaw*matMultiplier*locMultiplier);
  totalMats=Math.max(1,totalMats);

  // Build weighted pool from location loot table (exclude ashe ‚Äî handled separately)
  const pool=loc.lootTable.filter(l=>l.id!=='ashe_essence'&&l.type!=='egg');
  const totalWeight=pool.reduce((s,i)=>s+i.weight,0);

  const lootItems=[];
  const emblemDeltas={};
  const materialItems=[];

  for(let i=0;i<totalMats;i++){
    let roll=Math.random()*totalWeight;
    let picked=pool[0];
    for(const item of pool){roll-=item.weight;if(roll<=0){picked=item;break}}
    // Rare bonus: if item is rare, apply bonus chance to upgrade a common to rare
    if(picked.rarity!=='rare'&&rareBonusChance>0&&Math.random()<rareBonusChance){
      const rares=pool.filter(p=>p.rarity==='rare');
      if(rares.length)picked=rares[Math.floor(Math.random()*rares.length)];
    }
    // Aggregate
    const existing=lootItems.find(l=>l.id===picked.id);
    if(existing){existing.qty++}
    else{lootItems.push({id:picked.id,qty:1,rarity:picked.rarity,type:picked.type})}
    // Track for state mutation
    if(picked.type==='emblem'){emblemDeltas[picked.id]=(emblemDeltas[picked.id]||0)+1}
    else if(picked.type==='material'){materialItems.push(picked.id)}
  }

  // √Ä·π£·∫π Essence chance
  let asheChance=cfg.asheChance;
  const gotAshe=Math.random()<asheChance;
  if(gotAshe){
    emblemDeltas['ashe_essence']=(emblemDeltas['ashe_essence']||0)+1;
    lootItems.push({id:'ashe_essence',qty:1,rarity:'uncommon',type:'emblem'});
  }

  // Bonus XP
  const bonusXp=Math.round(cfg.bonusXp*xpMultiplier);

  // Rest duration
  const restMinutes=Math.max(1,Math.round(cfg.restMinutes*restMultiplier));

  return{loot_items:lootItems,bonus_xp:bonusXp,got_ashe:gotAshe,total_mats:totalMats,rest_minutes:restMinutes,emblem_deltas:emblemDeltas,material_items:materialItems,spirits:spirits};
}

function applyExpedLootToLocalState(exp,loot){
  // 1. Apply XP to each spirit
  const spiritIds=Array.isArray(exp.spirit_ids)?exp.spirit_ids:[];
  spiritIds.forEach(sid=>{
    const sp=S.spirits.find(s=>s.id===sid);
    if(sp)sp.xp=(sp.xp||0)+loot.bonus_xp;
  });
  // 2. Apply emblem deltas
  Object.entries(loot.emblem_deltas).forEach(([type,qty])=>{
    S.emblems[type]=(S.emblems[type]||0)+qty;
  });
  // 3. Apply material items to buildingInventory + S.materials
  const matCounts={};
  loot.material_items.forEach(id=>{matCounts[id]=(matCounts[id]||0)+1});
  Object.entries(matCounts).forEach(([id,qty])=>{
    // Add to S.materials directly
    S.materials[id]=(S.materials[id]||0)+qty;
    // Also insert into buildingInventory for consistency
    const existing=S.buildingInventory.find(bi=>bi.item_type==='material'&&(bi.item_id===id||bi.item_name===id));
    if(existing){existing.quantity=(existing.quantity||1)+qty}
    else{S.buildingInventory.push({id:'local_'+Date.now()+'_'+id,user_id:S.user?.id,item_type:'material',item_id:id,item_name:(MATERIAL_INFO[id]?.label||id),quantity:qty})}
  });
  // 4. Mark expedition as resting with calculated rest_until
  const restUntil=new Date(Date.now()+loot.rest_minutes*60*1000).toISOString();
  exp.completed_at=new Date().toISOString();
  exp.rest_until=restUntil;
  exp.started_at=exp.started_at; // keep for resting display
  // 5. Increment local expeds_completed
  if(S.profile)S.profile.expeds_completed=(S.profile.expeds_completed||0)+1;
}

async function persistExpeditionClaim(expedId,loot,retries=3){
  // Fire-and-forget DB write with retry
  for(let attempt=0;attempt<retries;attempt++){
    try{
      const _sess=await sb.auth.getSession();const _tok=_sess?.data?.session?.access_token;
      if(!_tok){console.warn('persist exped: no auth token');return}
      const res=await fetch(SUPABASE_URL+'/rest/v1/rpc/do_claim_expedition',{
        method:'POST',
        headers:{'Content-Type':'application/json','apikey':SUPABASE_ANON_KEY,'Authorization':'Bearer '+_tok},
        body:JSON.stringify({p_expedition_id_text:expedId})
      });
      if(res.ok){
        // Silently sync state from DB in background (non-blocking)
        setTimeout(()=>{
          Promise.all([reloadSpiritsAndTraits(),reloadEmblems(),reloadExpeditions(),reloadBuildings().then(()=>syncMaterialsFromInventory()),reloadJournal()]).then(()=>debouncedUpdateAllUI()).catch(e=>console.warn('post-claim sync:',e));
        },500);
        return;
      }
      const errData=await res.json().catch(()=>({}));
      console.warn('persist exped attempt '+(attempt+1)+' failed:',res.status,errData);
    }catch(e){console.warn('persist exped attempt '+(attempt+1)+' error:',e)}
    // Exponential backoff: 1s, 2s, 4s
    if(attempt<retries-1)await new Promise(r=>setTimeout(r,1000*Math.pow(2,attempt)));
  }
  console.warn('persist exped: all retries failed for',expedId,'‚Äî loot was already applied locally');
}



// ‚ïê‚ïê‚ïê PROPER RPC EXPEDITION CLAIM ‚ïê‚ïê‚ïê
async function claimExpedition(expedId) {
  if (S.isGuest || isBusy('claim_' + expedId)) return;
  setBusy('claim_' + expedId, 5000);
  try {
    const exp = S.expeditions.find(e => e.id === expedId);
    if (!exp) { console.warn('claim: expedition not found', expedId); return; }
    
    // Call the database function
    let { data, error } = await sb.rpc('do_claim_expedition', { p_expedition_id: expedId });
    
    // Safe Fallback: Try with text parameter if the UUID one fails
    if (error && error.code === 'PGRST202') {
      const retry = await sb.rpc('do_claim_expedition', { p_expedition_id_text: expedId });
      data = retry.data;
      error = retry.error;
    }

    if (error) throw error;
    if (data?.error) { console.warn('claim rpc error:', data.error); showToast('error'); return; }

    // Sync state quietly
    await Promise.all([
      reloadSpiritsAndTraits(),
      reloadEmblems(),
      reloadExpeditions(),
      reloadBuildings().then(() => syncMaterialsFromInventory()),
      reloadJournal()
    ]);
    debouncedUpdateAllUI();

    // Trigger first-expedition flag safely
    if (!S.isGuest && isFirstExpedToLoc(exp.location || 'night_market')) {
      markFirstExpedDone(exp.location || 'night_market');
    }

    // Show the animated loot reveal!
    const revealData = {
      bonus_xp: data?.bonus_xp || 0,
      got_ashe: data?.got_ashe || false,
      total_mats: data?.total_mats || 0,
      loot_items: data?.loot_items || []
    };
    showExpedLootReveal(revealData, exp);
    
    // Log to journal
    const sIds = Array.isArray(exp?.spirit_ids) ? exp.spirit_ids : [];
    const locLabel = (EXPED_LOCATIONS[exp?.location]?.label || 'expedition');
    sIds.forEach(sid => addJournalEntry(sid, 'expedition', 'Returned from ' + locLabel + (revealData.bonus_xp > 0 ? ' ¬∑ +' + revealData.bonus_xp + ' XP' : '')));

  } catch (e) {
    console.error('claim expedition error details:', JSON.stringify(e, null, 2)); 
    if (e.message) console.error("Message:", e.message);
    showToast('error');
  }
}
// ‚ïê‚ïê‚ïê V2.5: EXPEDITION LOOT REVEAL ‚ïê‚ïê‚ïê
// V2.8: First expedition to each location guarantees a building material drop shown in reveal
const LOCATION_FIRST_DROP={
  night_market:{mat:'canvas_roll',emoji:'üé®',label:'Canvas Roll',hint:'This material helps unlock Village Buildings!'},
  bamboo_highlands:{mat:'grinder_stone',emoji:'ü™®',label:'Grinder Stone',hint:'This material helps unlock Village Buildings!'},
  frozen_ruins:{mat:'ruin_fragment',emoji:'üèöÔ∏è',label:'Ruin Fragment',hint:'This material helps unlock Village Buildings!'}
};
// V3.2: First expedition flags stored on profiles table (cross-device)
const FIRST_EXPED_PROFILE_COL={
  night_market:'first_exped_night_market',
  bamboo_highlands:'first_exped_bamboo_highlands',
  frozen_ruins:'first_exped_frozen_ruins'
};
function isFirstExpedToLoc(locId){
  if(!S.profile)return false;
  const col=FIRST_EXPED_PROFILE_COL[locId];
  return col?!S.profile[col]:false;
}
// ‚ïê‚ïê‚ïê FIRST EXPEDITION TRACKING (CRASH-PROOF) ‚ïê‚ïê‚ïê
function markFirstExpedDone(locId) {
  const col = FIRST_EXPED_PROFILE_COL[locId];
  if (col && S.profile) S.profile[col] = true;
  
  // Fix: Supabase builder doesn't support .catch() directly. Use .then()
  if (S.user && col) {
    sb.rpc('set_first_expedition_flag', { p_location: locId }).then(res => {
      if (res.error) console.warn('first exped flag err:', res.error);
    });
  }
}

function showExpedLootReveal(data,exp){
  const ov=document.getElementById('lootRevealOverlay');
  if(!ov)return;
  const locId=exp?.location||'night_market';
  const loc=EXPED_LOCATIONS[locId]||EXPED_LOCATIONS.night_market;
  const spiritIds=Array.isArray(exp?.spirit_ids)?exp.spirit_ids:[];
  const spirits=spiritIds.map(id=>S.spirits.find(s=>s.id===id)).filter(Boolean);
  // Build loot items list
  const lootItems=[];
  if(data.bonus_xp>0)lootItems.push({emoji:'‚¨ÜÔ∏è',name:'+'+data.bonus_xp+' XP each',qty:'',isRare:false});
  if(data.got_ashe)lootItems.push({emoji:'üîÆ',name:'√Ä·π£·∫π Essence',qty:'+1',isRare:true});
  if(data.total_mats>0){
    // Parse actual materials if returned, otherwise show generic
    if(data.loot_items&&data.loot_items.length){
      data.loot_items.forEach(item=>{
        const info=MATERIAL_INFO[item.id]||{emoji:'üì¶',label:item.id};
        lootItems.push({emoji:info.emoji,name:info.label,qty:item.qty>1?'√ó'+item.qty:'',isRare:item.rarity==='rare'});
      });
    } else {
      // Fallback: pick items from location loot table visually
      const rolled=rollLootDisplay(loc,data.total_mats);
      rolled.forEach(r=>lootItems.push(r));
    }
  }
  // V2.8: First expedition to this location ‚Äî inject guaranteed building material
  let firstDropHint='';
  if(!S.isGuest&&isFirstExpedToLoc(locId)){
    const fd=LOCATION_FIRST_DROP[locId];
    if(fd){
      lootItems.push({emoji:fd.emoji,name:fd.label,qty:'√ó1',isRare:false,isFirstDrop:true});
      firstDropHint=fd.hint;
      markFirstExpedDone(locId);
    }
  }
  // Pick flavor line
  const flavor=loc.flavorLines[Math.floor(Math.random()*loc.flavorLines.length)];
  // Render
  let h='<div class="loot-reveal-inner">';
  h+='<div class="loot-reveal-header">';
  h+='<div class="loot-reveal-title">'+loc.emoji+' '+loc.label+'</div>';
  h+='<div class="loot-reveal-flavor">'+flavor+'</div>';
  h+='</div>';
  if(spirits.length){
    h+='<div class="loot-reveal-spirits">';
    spirits.forEach(sp=>{
      h+='<div class="loot-reveal-spirit"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'"><div class="loot-reveal-spirit-name">'+sp.name+'</div></div>';
    });
    h+='</div>';
  }
  h+='<div class="loot-reveal-items" id="lootRevealItems">';
  lootItems.forEach((item,i)=>{
    const firstDropClass=item.isFirstDrop?' style="border-color:rgba(255,212,128,.3);background:rgba(255,212,128,.06)"':'';
    h+='<div class="loot-reveal-item'+(item.isRare?' is-rare':'')+'" id="lootItem'+i+'"'+firstDropClass+'>';
    h+='<span class="loot-reveal-item-icon">'+item.emoji+'</span>';
    h+='<span class="loot-reveal-item-name">'+item.name+(item.isFirstDrop?' <span style="font-size:.42rem;color:#ffd480;margin-left:4px">‚ú¶ First visit</span>':'')+'</span>';
    if(item.qty)h+='<span class="loot-reveal-item-qty">'+item.qty+'</span>';
    h+='</div>';
  });
  h+='</div>';
  if(firstDropHint)h+='<div style="font-size:.48rem;color:var(--t3);text-align:center;padding:6px 8px;background:rgba(255,212,128,.05);border:1px solid rgba(255,212,128,.1);border-radius:var(--radius-sm);line-height:1.5">üèõÔ∏è '+firstDropHint+'</div>';
  h+='<div class="loot-reveal-tap">tap anywhere to continue</div>';
  h+='</div>';
  const inner=ov.querySelector('.loot-reveal-inner-wrap')||ov;
  ov.innerHTML=h;
  ov.classList.add('show');
  // Stagger item reveals
  lootItems.forEach((_,i)=>{
    setTimeout(()=>{
      const el=document.getElementById('lootItem'+i);
      if(el)el.classList.add('visible');
    },200+i*120);
  });
}

// Roll a visual display of loot based on the table (client-side approximation)
function rollLootDisplay(loc,totalMats){
  const results=[];
  const emblemItems=loc.lootTable.filter(l=>l.type==='emblem'&&l.id!=='ashe_essence');
  if(emblemItems.length&&totalMats>0){
    // Show 2-3 representative items
    const picks=emblemItems.sort(()=>Math.random()-.5).slice(0,Math.min(3,totalMats));
    picks.forEach(p=>{
      const EMBLEM_INFO={cafe_bean:{emoji:'‚òï',label:'Caf√© Bean'},wild_essence:{emoji:'üåø',label:'Wild Essence'},focus_shard:{emoji:'‚ö°',label:'Focus Shard'}};
      const info=EMBLEM_INFO[p.id]||{emoji:p.emoji,label:p.label};
      results.push({emoji:info.emoji,name:info.label,qty:'',isRare:p.rarity==='rare'});
    });
  }
  const matItems=loc.lootTable.filter(l=>l.type==='material');
  if(matItems.length&&Math.random()<0.4){
    const pick=matItems[Math.floor(Math.random()*matItems.length)];
    const info=MATERIAL_INFO[pick.id]||{emoji:pick.emoji,label:pick.label};
    results.push({emoji:info.emoji,name:info.label,qty:'',isRare:pick.rarity==='rare'});
  }
  return results;
}

function closeLootReveal(){
  const ov=document.getElementById('lootRevealOverlay');
  if(ov)ov.classList.remove('show');
}

// ‚ïê‚ïê‚ïê EXPEDITION TICKER ‚ïê‚ïê‚ïê
function startExpeditionTicker(){
  if(S.expedTicker)return;
  // Wall-clock based: recalculate every 500ms, no chunking
  S.expedTicker=setInterval(()=>{if(!S.isGuest){renderVillageTab();checkHatchReady();}},500);
}

// ‚ïê‚ïê‚ïê V2.0: DAILY STREAK SYSTEM (now DB-backed via profiles.streak_days/streak_last_date) ‚ïê‚ïê‚ïê
function getStreak(){
  if(S.isGuest||!S.user||!S.profile)return{days:0,bonus:0,asheBonus:false};
  const days=S.profile.streak_days||0;
  return{days:days,bonus:getStreakBonus(days),asheBonus:days>=7};
}
// Called on enterApp to update streak server-side
async function syncStreak(){
  if(S.isGuest||!S.user)return;
  try{
    const{data}=await sb.rpc('update_streak');
    if(data){S.profile.streak_days=data.days;S.profile.streak_last_date=new Date().toISOString().slice(0,10)}
  }catch(e){console.warn('streak sync error:',e)}
}
function getStreakBonus(days){if(days>=7)return 3;if(days>=5)return 2;if(days>=3)return 1;return 0}
function renderStreakCard(){
  const s=getStreak();
  const maxDots=7;
  let dots='';for(let i=0;i<maxDots;i++)dots+='<div class="streak-dot'+(i<Math.min(s.days,maxDots)?' on':'')+'"></div>';
  let bonusText='';
  if(s.bonus>0)bonusText='+'+s.bonus+' bonus materials per egg';
  if(s.asheBonus)bonusText+=' ¬∑ +1% √Ä·π£·∫π chance';
  return'<div class="streak-card"><div class="streak-fire">'+(s.days>=3?'üî•':'üïØÔ∏è')+'</div><div class="streak-info"><div class="streak-count">'+s.days+' day'+(s.days!==1?'s':'')+'</div><div class="streak-label">Daily Streak</div>'+(bonusText?'<div class="streak-bonus">'+bonusText+'</div>':'')+'</div><div class="streak-dots">'+dots+'</div></div>';
}

// ‚ïê‚ïê‚ïê V1.4: ACHIEVEMENTS SYSTEM ‚ïê‚ïê‚ïê
const ACHIEVEMENTS=[
  {id:'first_steps',name:'First Steps',emoji:'üê£',desc:'Hatch your first spirit',check:()=>S.spirits.length>=1},
  {id:'full_house',name:'Full House',emoji:'üè†',desc:'Have 5+ spirits',check:()=>S.spirits.length>=5},
  {id:'alchemist',name:'Alchemist',emoji:'üíä',desc:'Craft 10 pills',check:()=>getAchieveCounter('pills_crafted')>=10},
  {id:'explorer',name:'Explorer',emoji:'üß≠',desc:'Complete 5 expeditions',check:()=>getAchieveCounter('expeds_completed')>=5},
  {id:'cultivator',name:'Cultivator',emoji:'üîÆ',desc:'Reach Foundation stage',check:()=>S.spirits.some(sp=>(sp.cultivation_stage||0)>=2)},
  {id:'devoted',name:'Devoted',emoji:'üéß',desc:'Listen 10+ hours',check:()=>(S.profile?.total_listen_seconds||0)>=36000},
  {id:'collector',name:'Collector',emoji:'‚ú®',desc:'Own all 6 spirit types',check:()=>{const types=new Set(S.spirits.map(s=>spiritKey(s.spirit_type)));return types.size>=6}},
  {id:'ascended',name:'Ascended',emoji:'üëë',desc:'Fully evolve a spirit',check:()=>S.spirits.some(sp=>sp.evo_stage>=2)},
  {id:'streaker',name:'Dedicated',emoji:'üî•',desc:'7-day streak',check:()=>getStreak().days>=7}
];
function getAchieveCounter(key){
  if(!S.profile)return 0;
  return S.profile[key]||0;
}
function incAchieveCounter(key){
  // Now handled server-side by RPCs (craft_heavenly_pill increments pills_crafted, claim_expedition increments expeds_completed)
}
function renderAchievements(){
  let h='<div class="section-label" style="margin-top:12px">Achievements</div><div class="achieve-grid">';
  ACHIEVEMENTS.forEach(a=>{
    const earned=a.check();
    h+='<div class="achieve-badge'+(earned?' earned':'')+'" title="'+a.desc+'"><span class="achieve-icon">'+a.emoji+'</span><span class="achieve-name">'+a.name+'</span></div>';
  });
  h+='</div>';return h;
}

// ‚ïê‚ïê‚ïê CULTIVATION ADVANCE ‚ïê‚ïê‚ïê
async function openCultivateModal(spiritId){
  if(S.isGuest)return;
  const sp=S.spirits.find(s=>s.id===spiritId);if(!sp)return;
  const stage=sp.cultivation_stage||0;
  if(stage>=5)return;
  const cost=CULT_COSTS[stage];
  const reqLvl=CULT_LVL_REQ[stage];
  const lvl=Math.floor((sp.xp||0)/S.XP_PER_LEVEL)+1;
  const listenReq=getCultListenReq(stage);
  const hasAshe=(S.emblems.ashe_essence||0)>=cost;
  const hasLvl=lvl>=reqLvl;
  const hasListen=meetsListenReq(stage);
  const totalMin=getTotalListenMinutes();
  const cultRedux=spiritTraitBonus(spiritId,'cult_cost_reduction');
  const actualCost=Math.max(1,Math.floor(cost*(1-cultRedux)));
  const can=hasAshe&&hasLvl&&hasListen;
  const box=document.getElementById('modalBox');
  let h='<div class="modal-title">Advance Cultivation</div>';
  h+='<div class="modal-desc"><b>'+sp.name+'</b></div>';
  h+='<div class="cult-modal-path"><span class="cult-modal-from">'+CULT_STAGES[stage]+'</span><span class="cult-modal-arrow"> ‚Üí </span><span class="cult-modal-to">'+CULT_STAGES[stage+1]+'</span></div>';
  h+='<div class="cult-modal-reqs">';
  h+='<div class="cult-modal-req '+(hasLvl?'met':'unmet')+'"><span>Level required</span><span>Lv.'+reqLvl+(hasLvl?'':' ¬∑ need Lv.'+reqLvl)+'</span></div>';
  if(listenReq>0){
    const listenPct=Math.min(100,Math.round((totalMin/listenReq)*100));
    h+='<div class="cult-modal-req '+(hasListen?'met':'unmet')+'"><span>Listen time</span><span>'+totalMin+'m / '+listenReq+'m</span></div>';
    if(!hasListen)h+='<div class="cult-modal-listen-bar"><div class="cult-modal-listen-fill" style="width:'+listenPct+'%"></div></div>';
  }
  h+='<div class="cult-modal-req '+(hasAshe?'met':'unmet')+'"><span>√Ä·π£·∫π Essence</span><span>'+actualCost+' üîÆ (have '+(S.emblems.ashe_essence||0)+')</span></div>';
  h+='</div>';
  if(cultRedux>0)h+='<div style="font-size:.48rem;color:var(--positive);text-align:center;margin-bottom:6px">Deep Roots: -'+Math.round(cultRedux*100)+'% cost</div>';
  h+='<button class="modal-btn" '+(can?'':'disabled')+' onclick="doCultivate(\''+spiritId+'\')">Advance to '+CULT_STAGES[stage+1]+'</button>';
  h+='<button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';
  box.innerHTML=h;
  document.getElementById('modal').classList.add('open');
}
async function doCultivate(spiritId){
  closeModal();
  const sp=S.spirits.find(s=>s.id===spiritId);
  const oldStage=sp?.cultivation_stage||0;
  try{
    const{data,error}=await sb.rpc('advance_cultivation',{p_spirit_id:spiritId});
    if(error)throw error;
    if(data?.error){console.warn('cultivation rpc error:',data.error);showToast('error');return}
    await Promise.all([reloadSpiritsAndTraits(),reloadEmblems()]);
    debouncedUpdateAllUI();
    showToast('cultivation');
    // V2.6: Write journal entry
    const newStage=oldStage+1;
    addJournalEntry(spiritId,'cultivation','Reached '+CULT_STAGES[newStage]+' cultivation stage');
    if(S.selectedSpirit===spiritId)showSpiritDetail(spiritId);
  }catch(e){console.warn('cultivation advance error:',e);showToast('error')}
}

function startVillageTicker(){
  setInterval(()=>{if(!S.isGuest&&S.playing)renderVillageTab()},10000);
  // V2.9: Production check every 4 hours, plus research progress on each listen tick
  if(!S.isGuest){
    setInterval(()=>{
      if(!S.isGuest){checkBuildingProduction();checkResearchProgress();checkVillageNotif();}
    },4*60*60*1000); // 4 hours
  }
}

// ‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê
function updateTopBar(){
  const p=calcPrestige();
  const rank=VILLAGE_RANKS.slice().reverse().find(r=>p>=r.min)||VILLAGE_RANKS[0];
  document.getElementById('tbRankName').textContent=rank.name;
  document.getElementById('tbRankName').style.color=rank.color||'';
  document.getElementById('tbRankPts').textContent=p+' pts';
  const authArea=document.getElementById('tbAuth');
  if(S.isGuest){authArea.innerHTML='<button class="tb-signin" onclick="showLogin()">Sign In</button>'}
  else{const uname=S.profile?.username||S.user?.user_metadata?.username||S.user?.email?.split('@')[0]||'user';authArea.innerHTML='<span class="tb-user">'+esc(uname)+'</span>'}
  document.querySelectorAll('.sdLogoutDiv,.sdLogoutItem').forEach(el=>el.style.display=S.isGuest?'none':'');
}

// ‚ïê‚ïê‚ïê V2.4: RANK TOOLTIP ‚ïê‚ïê‚ïê
const RANK_BENEFITS={
  'Ember':'Starting rank. Your village is just a spark.',
  'Stone':'Expedition slot 1 unlocked. Village taking shape.',
  'Silver':'Expedition slot 2 unlocked (400 pts). Respected.',
  'Bronze':'Hatchery slot 3 unlocked (150 pts). Growing.',
  'Gold':'Hatchery slot 4 unlocked (400 pts). Prosperous.',
  'Emerald':'Hatchery slot 5 unlocked. A beacon.',
  'Celestial':'Maximum rank. Transcendent.'
};
let _rankTooltipOpen=false;
function showRankTooltip(){
  const tt=document.getElementById('rankTooltip');if(!tt)return;
  const p=calcPrestige();
  const rank=VILLAGE_RANKS.slice().reverse().find(r=>p>=r.min)||VILLAGE_RANKS[0];
  let h='<div class="rank-tooltip-title">Village Ranks</div>';
  VILLAGE_RANKS.forEach(r=>{
    const isCurrent=r.name===rank.name;
    const achieved=p>=r.min;
    h+='<div class="rank-tooltip-row'+(isCurrent?' current':'')+'" style="'+(achieved?'':'opacity:.4')+'">';
    h+='<span class="rank-tooltip-rank" style="color:'+(r.color||'var(--t3)')+'">'+r.name+'</span>';
    h+='<span style="font-size:.48rem;color:var(--t3);flex:1;padding:0 6px">'+r.desc+'</span>';
    h+='<span class="rank-tooltip-pts">'+r.min+'</span>';
    h+='</div>';
  });
  tt.innerHTML=h;
  tt.classList.add('show');
  _rankTooltipOpen=true;
}
function hideRankTooltip(){
  const tt=document.getElementById('rankTooltip');if(!tt)return;
  tt.classList.remove('show');
  _rankTooltipOpen=false;
}
function toggleRankTooltip(){
  if(_rankTooltipOpen)hideRankTooltip();else showRankTooltip();
}
// Close rank tooltip on outside click
document.addEventListener('click',e=>{
  if(_rankTooltipOpen&&!e.target.closest('#tbRank'))hideRankTooltip();
});
function updateAllUI(){updateTopBar();renderSpiritsTab();renderPillsTab();renderVillageTab();checkMilestones();checkVillageNotif();checkHatchReady()}

// ‚ïê‚ïê‚ïê SPIRITS TAB ‚ïê‚ïê‚ïê
function renderSpiritsTab(){
  const el=document.getElementById('tab-spirits');
  if(!S.spirits.length){
    el.innerHTML='<div class="spirit-empty"><div class="spirit-empty-msg">No spirits yet</div><div class="spirit-empty-hint">Hatch eggs to discover spirits<br>They\'ll grow as you listen</div><button class="empty-action" onclick="switchTab(document.querySelector(\'[data-tab=pills]\'))">Go to Hatchery ‚Üí</button></div>';
    return;
  }
  let h='<div class="spirits-grid">';
  S.spirits.forEach(sp=>{
    const lvl=Math.floor((sp.xp||0)/S.XP_PER_LEVEL)+1;
    const xpP=(sp.xp||0)%S.XP_PER_LEVEL;
    const xpPct=Math.round((xpP/S.XP_PER_LEVEL)*100);
    const evoClass=sp.evo_stage>0?'evo-'+sp.evo_stage:'';
    const evoText=sp.evo_stage===1?'evo-text-1':sp.evo_stage===2?'evo-text-2':'';
    const onExp=spiritUnavailable(sp.id);
    const mood=getSpiritMood(sp);
    const moodClass=mood.mood!=='content'?' mood-'+mood.mood:'';
    // Resting countdown ‚Äî V2.9: use timer badge
    let restBadge='';
    if(mood.mood==='energized'&&spiritResting(sp.id)){
      const restExp=S.expeditions.find(e=>{const ids=Array.isArray(e.spirit_ids)?e.spirit_ids:[];return ids.includes(sp.id)&&getExpedStatus(e)==='resting'});
      if(restExp&&restExp.rest_until){
        const rm=Math.max(0,new Date(restExp.rest_until).getTime()-Date.now());
        const rMin=Math.floor(rm/60000),rSec=Math.floor((rm%60000)/1000);
        restBadge='<div class="spirit-card-rest-timer">üí§ '+rMin+'m '+String(rSec).padStart(2,'0')+'s</div>';
      }
    }
    const align=getSpiritAlignment(sp.id);
    const alignDot=align!=='neutral'?' <span style="color:'+(align==='wicked'?'#c77':'#daa520')+'">'+(align==='wicked'?'ü©∏':'‚ú¶')+'</span>':'';
    // Stars: ‚òÖ filled, ‚òÜ empty
    const stars=[0,1,2].map(i=>i<=sp.evo_stage?'‚òÖ':'‚òÜ').join('');
    const starColor=sp.evo_stage===2?'#ffd480':sp.evo_stage===1?'#8ab4ff':'var(--t4)';
    h+='<div class="spirit-card'+(onExp?' on-expedition':'')+'" data-sid="'+sp.id+'" onclick="spiritCardTap(event,\''+sp.id+'\')">';
    h+='<div class="spirit-card-img '+evoClass+moodClass+'"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'"></div>';
    h+='<div class="spirit-card-info">';
    h+='<div class="spirit-card-name">'+sp.name+alignDot+'</div>';
    h+='<div class="spirit-card-meta"><span class="'+evoText+'">'+EVO_LABELS[sp.evo_stage]+'</span> ¬∑ Lv.'+lvl+'</div>';
    h+='<div class="spirit-card-mood">'+mood.emoji+' '+mood.label+'</div>';
    if(restBadge)h+=restBadge;
    h+='<div class="spirit-card-xp-wrap"><div class="spirit-card-xp"><div class="spirit-card-xp-fill" style="width:'+xpPct+'%"></div></div><span class="spirit-card-xp-num">'+xpP+'/'+S.XP_PER_LEVEL+'</span></div>';
    h+='</div>';
    h+='<div class="spirit-card-right"><div class="spirit-card-stars" style="color:'+starColor+'">'+stars+'</div><div class="spirit-card-lvl">Lv.'+lvl+'</div></div>';
    h+='</div>';
  });
  h+='</div>';
  el.innerHTML=h;
  if(S.selectedSpirit)showSpiritDetail(S.selectedSpirit);
}
// V1.5: Spirit card tap ‚Äî short quip then open detail
let _lastCardTap={};
function spiritCardTap(event,id){
  const now=Date.now();
  if(_lastCardTap[id]&&now-_lastCardTap[id]<400){/* double-tap: just open detail */selectSpirit(id);return}
  _lastCardTap[id]=now;
  triggerQuip(id,false);
  setTimeout(()=>{if(Date.now()-_lastCardTap[id]>=380)selectSpirit(id)},400);
}
function selectSpirit(id){S.selectedSpirit=id;showSpiritDetail(id)}
function showSpiritDetail(id){
  const sp=S.spirits.find(s=>s.id===id);if(!sp)return;
  const lvl=Math.floor((sp.xp||0)/S.XP_PER_LEVEL)+1;
  const xpP=(sp.xp||0)%S.XP_PER_LEVEL;
  const xpPct=Math.round((xpP/S.XP_PER_LEVEL)*100);
  const tr=S.traits[sp.id]||[];
  const cultRedux=spiritTraitBonus(sp.id,'cult_cost_reduction');
  const cost=sp.evo_stage===0?5:12;
  const displayCost=Math.max(1,Math.floor(cost*(1-cultRedux)));
  const reqLvl=sp.evo_stage===0?3:5;
  const reqXp=(reqLvl-1)*S.XP_PER_LEVEL;
  const meetsLvl=(sp.xp||0)>=reqXp;
  const meetsMats=S.emblems.cafe_bean>=displayCost&&S.emblems.wild_essence>=displayCost&&S.emblems.focus_shard>=displayCost;
  const can=sp.evo_stage<2&&!S.isGuest&&meetsLvl&&meetsMats;
  const evoText=sp.evo_stage===1?'evo-text-1':sp.evo_stage===2?'evo-text-2':'';
  const onExped=spiritOnExpedition(sp.id);
  const isResting=spiritResting(sp.id);
  let statusLine='';
  if(onExped)statusLine='<div style="font-size:.5rem;color:var(--positive);margin:4px 0">üß≠ On expedition</div>';
  else if(isResting){
    const restExp=S.expeditions.find(e=>{const ids=Array.isArray(e.spirit_ids)?e.spirit_ids:[];return ids.includes(sp.id)&&getExpedStatus(e)==='resting'});
    let timerStr='';
    if(restExp?.rest_until){const rm=Math.max(0,new Date(restExp.rest_until).getTime()-Date.now());const rMin=Math.floor(rm/60000),rSec=Math.floor((rm%60000)/1000);timerStr=' ¬∑ '+rMin+'m '+String(rSec).padStart(2,'0')+'s';}
    statusLine='<div style="font-size:.5rem;color:var(--special);margin:4px 0">üí§ Resting'+timerStr+'</div>';
  }
  // Evolution requirements
  let evoReqs='';
  if(sp.evo_stage<2){
    const reqs=[];
    if(!meetsLvl)reqs.push('<span style="color:var(--negative)">Requires Lv.'+reqLvl+' (currently Lv.'+lvl+')</span>');
    const costLabel=cultRedux>0?displayCost+'√ó each <span style="color:var(--positive);font-size:.42rem">Deep Roots -'+Math.round(cultRedux*100)+'%</span>':displayCost+'√ó each';
    reqs.push('Cost: '+costLabel+' (‚òï'+S.emblems.cafe_bean+' üåø'+S.emblems.wild_essence+' ‚ö°'+S.emblems.focus_shard+')');
    evoReqs='<button class="sd-evolve-btn" '+(can?'':'disabled')+' onclick="doEvolve(\''+sp.id+'\')">Evolve to '+EVO_LABELS[sp.evo_stage+1]+'</button><div class="sd-evolve-cost">'+reqs.join(' ¬∑ ')+'</div>';
  }else{
    evoReqs='<div style="text-align:center;font-size:.6rem;color:var(--special);margin-top:10px">‚ú® Fully Ascended</div>';
  }
  // Alignment badge
  const align=getSpiritAlignment(sp.id);
  let alignBadge='';
  if(align==='wicked')alignBadge='<div class="sd-alignment wicked" title="+10% expedition materials">ü©∏ Wicked <span style="font-size:.38rem;opacity:.7">+10% mats</span></div>';
  else if(align==='heavenly')alignBadge='<div class="sd-alignment heavenly" title="+15% passive XP per tick">‚ú¶ Heavenly <span style="font-size:.38rem;opacity:.7">+15% XP</span></div>';
  // Stars
  const stars=[0,1,2].map(i=>i<=sp.evo_stage?'‚òÖ':'‚òÜ').join('');
  const starColor=sp.evo_stage===2?'#ffd480':sp.evo_stage===1?'#8ab4ff':'var(--t4)';
  const ov=document.getElementById('spiritOverlay');ov.classList.remove('gone');
  const el=document.getElementById('spiritOverlayInner');
  el.innerHTML=
    '<div class="sd-header">'+
    '<div class="sd-interact-area" onclick="triggerQuip(\''+sp.id+'\',true)">'+
    '<div class="sd-portrait"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'"></div>'+
    '</div>'+
    '<div class="sd-info">'+
    '<div style="display:flex;align-items:baseline;gap:8px;margin-bottom:3px">'+
    '<div class="sd-name">'+sp.name+'</div>'+
    '<div style="font-size:.7rem;color:'+starColor+'">'+stars+'</div>'+
    '</div>'+
    '<div class="sd-stage"><span class="'+evoText+'">'+EVO_LABELS[sp.evo_stage]+'</span> ¬∑ '+spiritName(sp.spirit_type)+'</div>'+
    '<div style="font-size:.52rem;color:var(--t4);margin-bottom:2px">Level '+lvl+'</div>'+
    alignBadge+
    '<div class="sd-bio">'+spiritBio(sp.spirit_type)+'</div>'+
    '</div>'+
    '<button class="sd-close" onclick="closeSpiritDetail()">‚úï</button>'+
    '</div>'+
    '<div class="sd-interact-text" id="sdInteractText"></div>'+
    statusLine+
    // Name edit button
    '<div style="text-align:center;margin:6px 0 10px"><button class="sd-rename-btn" onclick="openRenameModal(\''+sp.id+'\')">‚úèÔ∏è Rename '+esc(sp.name)+'</button></div>'+
    '<div class="sd-section">XP ‚Äî Level '+lvl+'</div>'+
    '<div class="sd-bar-wrap">'+
    '<div class="sd-bar"><div class="sd-bar-fill" style="width:'+xpPct+'%"></div></div>'+
    '<span class="sd-lvl">'+xpP+' / '+S.XP_PER_LEVEL+'</span>'+
    '</div>'+
    buildSpiritTraitSection(sp,tr)+
    evoReqs+
    buildJournalSection(sp.id)+
    (!S.isGuest&&S.spirits.length>1&&!spiritUnavailable(sp.id)?
      '<div class="sd-section" style="margin-top:16px;color:var(--t4)">Release</div>'+
      '<div style="text-align:center;padding:8px;background:rgba(204,119,119,.04);border:1px solid rgba(204,119,119,.08);border-radius:var(--radius-sm)">'+
      '<div style="font-size:.45rem;color:var(--t4);margin-bottom:6px">Release this spirit to earn Spirit Essence</div>'+
      '<button class="dismiss-btn" onclick="openDismissModal(\''+sp.id+'\')">Release '+sp.name+' (+'+calcDismissEssence(sp)+' üí†)</button>'+
      '</div>':'');
}
function closeSpiritDetail(){S.selectedSpirit=null;const ov=document.getElementById('spiritOverlay');if(ov)ov.classList.add('gone')}
function toggleTraitDesc(id){const el=document.getElementById(id);if(!el)return;const wasOpen=el.classList.contains('show');document.querySelectorAll('.trait-desc.show').forEach(d=>d.classList.remove('show'));if(!wasOpen)el.classList.add('show')}

// ‚ïê‚ïê‚ïê V2.8: RENAME SPIRIT ‚ïê‚ïê‚ïê
function openRenameModal(spiritId){
  const sp=S.spirits.find(s=>s.id===spiritId);if(!sp)return;
  const box=document.getElementById('modalBox');
  box.innerHTML=
    '<div class="modal-title">Rename Spirit</div>'+
    '<div class="modal-desc">Give <b>'+esc(sp.name)+'</b> a new name.</div>'+
    '<div class="login-field" style="margin:12px 0">'+
    '<input type="text" id="renameInput" maxlength="24" placeholder="'+esc(sp.name)+'" value="'+esc(sp.name)+'" style="width:100%;background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius-sm);padding:12px 16px;color:var(--t1);font-family:inherit;font-size:.85rem;outline:none">'+
    '</div>'+
    '<button class="modal-btn" onclick="doRename(\''+spiritId+'\')">Save Name</button>'+
    '<button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';
  document.getElementById('modal').classList.add('open');
  setTimeout(()=>{const inp=document.getElementById('renameInput');if(inp){inp.focus();inp.select()}},80);
}
async function doRename(spiritId){
  const inp=document.getElementById('renameInput');
  if(!inp)return;
  const newName=inp.value.trim().slice(0,24);
  if(!newName){inp.focus();return}
  closeModal();
  const sp=S.spirits.find(s=>s.id===spiritId);if(!sp)return;
  const oldName=sp.name;
  sp.name=newName; // optimistic
  debouncedUpdateAllUI();
  if(S.selectedSpirit===spiritId)showSpiritDetail(spiritId);
  try{
    const{error}=await sb.from('spirits').update({name:newName}).eq('id',spiritId);
    if(error){sp.name=oldName;debouncedUpdateAllUI();console.warn('rename error:',error)}
    else showToastMsg('‚úèÔ∏è','Renamed!',newName+' will remember that.');
  }catch(e){sp.name=oldName;debouncedUpdateAllUI();console.warn('rename error:',e)}
}

// ‚ïê‚ïê‚ïê V2.8: PROMPT NAME AT HATCH ‚ïê‚ïê‚ïê
function showNameAtHatch(spiritId,spiritType,defaultName){
  const box=document.getElementById('modalBox');
  const k=spiritKey(spiritType);
  const d=SPIRIT_DATA[k];
  box.innerHTML=
    '<div style="text-align:center;margin-bottom:8px"><img src="'+(d?.img[0]||'sprites/timi_1.png')+'" style="width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid var(--card-border)"></div>'+
    '<div class="modal-title">A new spirit arrived!</div>'+
    '<div class="modal-desc">Give them a name. You can always rename them later.</div>'+
    '<div class="login-field" style="margin:12px 0">'+
    '<input type="text" id="hatchNameInput" maxlength="24" placeholder="'+esc(defaultName)+'" value="'+esc(defaultName)+'" style="width:100%;background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius-sm);padding:12px 16px;color:var(--t1);font-family:inherit;font-size:.85rem;outline:none">'+
    '</div>'+
    '<button class="modal-btn" onclick="confirmHatchName(\''+spiritId+'\')">Welcome to the Village</button>';
  document.getElementById('modal').classList.add('open');
  setTimeout(()=>{const inp=document.getElementById('hatchNameInput');if(inp){inp.focus();inp.select()}},80);
}
async function confirmHatchName(spiritId){
  const inp=document.getElementById('hatchNameInput');
  const newName=inp?inp.value.trim().slice(0,24):'';
  closeModal();
  if(newName&&spiritId){
    const sp=S.spirits.find(s=>s.id===spiritId);
    if(sp&&newName!==sp.name){
      sp.name=newName;
      sb.from('spirits').update({name:newName}).eq('id',spiritId).catch(e=>console.warn('hatch name err:',e));
    }
  }
  debouncedUpdateAllUI();
  showToast('new_spirit');
}

// ‚ïê‚ïê‚ïê V2.6: TRAIT SECTION BUILDER ‚ïê‚ïê‚ïê
function buildSpiritTraitSection(sp,tr){
  const slots=TRAIT_SLOTS[sp.evo_stage]||1;
  const filled=tr.length;
  let h='<div class="sd-section">Traits <span class="sd-trait-slots">'+filled+'/'+slots+' slots</span></div>';
  h+='<div class="sd-traits">';
  if(filled===0){
    h+='<div class="sd-traits-empty">Traits unlock through evolution ‚Äî they boost XP, expeditions, and building work</div>';
  }else{
    const byCat={expedition:[],cultivation:[],affinity:[]};
    tr.forEach(t=>{const def=TRAIT_DEFS[t.trait_name];const cat=def?.cat||'expedition';byCat[cat].push(t)});
    Object.entries(byCat).forEach(([cat,traits])=>{
      if(!traits.length)return;
      const catDef=TRAIT_CATS[cat];
      h+='<div class="sd-trait-cat"><span class="sd-trait-cat-label" style="color:'+catDef.color+'">'+catDef.emoji+' '+catDef.label+'</span>';
      traits.forEach(t=>{
        const def=TRAIT_DEFS[t.trait_name]||{};
        const did='td-'+t.trait_name.toLowerCase().replace(/\s/g,'');
        h+='<div class="sd-trait-row" onclick="toggleTraitDesc(\''+did+'\')"><span class="sd-trait-name" style="color:'+catDef.color+'">'+t.trait_name+'</span><span class="sd-trait-effect">'+def.display+'</span></div>';
        if(def.desc)h+='<div class="trait-desc sd-trait-desc" id="'+did+'">'+def.desc+'</div>';
      });
      h+='</div>';
    });
  }
  const emptySlots=slots-filled;
  if(emptySlots>0&&filled>0){for(let i=0;i<emptySlots;i++)h+='<div class="sd-trait-slot-empty">+ Empty trait slot</div>';}
  else if(slots<3)h+='<div style="font-size:.42rem;color:var(--t4);margin-top:4px">Evolve to unlock more trait slots ('+slots+'/3)</div>';
  h+='</div>';
  return h;
}

// ‚ïê‚ïê‚ïê V2.6: SPIRIT JOURNAL ‚ïê‚ïê‚ïê
function getJournalFor(spiritId){return(S.journal||{})[spiritId]||[]}
function buildJournalSection(spiritId){
  const entries=getJournalFor(spiritId);
  let h='<div class="sd-section" style="margin-top:14px">Journal</div>';
  if(!entries.length){
    h+='<div class="sd-journal-empty">Nothing recorded yet. Evolutions, expeditions, and milestones will appear here.</div>';
    return h;
  }
  h+='<div class="sd-journal">';
  entries.slice(0,8).forEach(e=>{
    const d=new Date(e.ts||e.created_at);
    const dStr=d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const icons={evolution:'‚ú®',expedition:'üß≠',cultivation:'üìø',release:'üí†',drink:'‚òï'};
    const ico=icons[e.event_type]||'¬∑';
    h+='<div class="sd-journal-entry"><span class="sd-journal-ico">'+ico+'</span><span class="sd-journal-desc">'+esc(e.description||e.desc||'')+'</span><span class="sd-journal-date">'+dStr+'</span></div>';
  });
  h+='</div>';
  return h;
}

// ‚ïê‚ïê‚ïê V2.5: INVENTORY TAB ‚ïê‚ïê‚ïê
function renderPillsTab(){
  const el=document.getElementById('tab-pills');if(!el)return;
  const prest=calcPrestige(),pendCount=S.pendingEggs.filter(e=>e.status==='pending').length;
  let h='';

  // ‚îÄ‚îÄ Hatchery ‚îÄ‚îÄ
  h+='<div class="inv-section-label">Hatchery ü•ö</div><div class="hatchery-grid">';
  const slots=S.hatchery.length?S.hatchery:[{id:'def1',slot_number:1,unlocked:true,egg_id:null},{id:'def2',slot_number:2,unlocked:true,egg_id:null},{id:'def3',slot_number:3,unlocked:false},{id:'def4',slot_number:4,unlocked:false},{id:'def5',slot_number:5,unlocked:false}];
  slots.forEach(slot=>{if(!slot.unlocked){const req=SLOT_UNLOCK[slot.slot_number],canU=req&&prest>=req;h+='<div class="hatch-slot '+(canU?'unlockable':'locked')+'" '+(canU?'onclick="unlockSlot('+slot.slot_number+')"':'')+'><div class="hatch-slot-icon">'+(canU?'\uD83D\uDD13':'\uD83D\uDD12')+'</div><div class="hatch-slot-label">'+(canU?'Unlock!':req?req+' prestige':'Locked')+'</div></div>';return}if(!slot.egg_id){h+='<div class="hatch-slot" onclick="openPlaceEggModal(\''+slot.id+'\')"><div class="hatch-slot-icon">\uFF0B</div><div class="hatch-slot-label">Place Egg</div>'+(pendCount>0?'<div class="hatch-slot-eggs">('+pendCount+' available)</div>':'')+'</div>';return}const egg=(S.allEggs||S.pendingEggs).find(e=>e.id===slot.egg_id)||{rarity:'mundane'},started=new Date(slot.started_at),baseDurMs=(slot.hatch_duration_minutes||INCUB_MINS[egg.rarity]||3)*60*1000;
  let gentleReduction=0;S.spirits.forEach(sp=>{const g=spiritTraitBonus(sp.id,'hatch_speed');if(g>gentleReduction)gentleReduction=g});
  const durMs=Math.floor(baseDurMs*(1-gentleReduction));const elapsed=Date.now()-started.getTime(),ready=elapsed>=durMs,pct=Math.min(elapsed/durMs*100,100),rem=Math.max(0,Math.ceil((durMs-elapsed)/1000)),rs=rem>60?Math.ceil(rem/60)+'m':rem+'s';
  const isRare=['illustrious','sovereign','celestial','transcendent','mysterious','ancestral','paradox'].includes(egg.rarity);
  h+='<div class="hatch-slot'+(ready?' ready':'')+(isRare&&!ready?' rare-shimmer':'')+'" onclick="'+(ready?'doHatch(\''+slot.id+'\')':'')+'" ><div class="hatch-slot-icon">'+(ready?'\uD83D\uDC23':'\uD83E\uDD5A')+'</div><div class="hatch-slot-rarity" style="color:'+(RARITY_COLORS[egg.rarity]||'#888')+'">'+(egg.rarity||'')+'</div>'+(ready?'<div class="hatch-slot-label" style="color:var(--positive)">Hatch!</div>':'<div class="hatch-slot-timer">'+rs+'</div><div class="hatch-slot-bar"><div class="hatch-slot-bar-fill" style="width:'+pct+'%"></div></div>')+'</div>'});
  h+='</div>';

  // ‚îÄ‚îÄ Drinks from Caf√© ‚îÄ‚îÄ
  h+='<div class="inv-section-label">Drinks ‚òï</div>';
  const drinks=(S.buildingInventory||[]).filter(i=>i.item_type==='drink');
  if(drinks.length){
    h+='<div class="inv-drinks-grid">';
    drinks.forEach(d=>{
      const expires=d.expires_at?new Date(d.expires_at):null;
      const expiresIn=expires?Math.max(0,Math.floor((expires.getTime()-Date.now())/3600000)):null;
      const expStr=expiresIn!==null?(expiresIn>1?expiresIn+'h left':expiresIn===1?'<1h left':'Expired!'):'';
      h+='<div class="inv-drink-row" onclick="useDrink(\''+d.id+'\')">';
      h+='<span class="inv-drink-icon">‚òï</span>';
      h+='<div class="inv-drink-info"><div class="inv-drink-name">'+esc(d.item_name)+'</div>';
      h+='<div class="inv-drink-desc">'+getDrinkDesc(d.item_name)+'</div>';
      if(expStr)h+='<div class="inv-drink-expiry">'+expStr+'</div>';
      h+='</div><span class="inv-drink-use">Use ‚Üí</span></div>';
    });
    h+='</div>';
  }else{
    h+='<div class="inv-empty">';
    if(buildingUnlocked('cafe')){
      const mgr=getManagerFor('cafe');
      h+=mgr?'Your barista is brewing... check back soon.':'Assign a Head Barista to start brewing.';
    }else{
      h+='Build the Caf√© to produce drinks.';
    }
    h+='</div>';
  }

  // ‚îÄ‚îÄ Ingredients ‚îÄ‚îÄ
  h+='<div class="inv-section-label">Ingredients</div>';
  h+='<div class="ing-grid">';
  h+='<div class="ing-row"><span class="ing-icon">‚òï</span><span class="ing-name">Caf√© Bean</span><span class="ing-count">'+S.emblems.cafe_bean+'</span><button class="ing-swap" onclick="openConvertModal(\'cafe_bean\')" title="Convert">‚áå</button></div>';
  h+='<div class="ing-row"><span class="ing-icon">üåø</span><span class="ing-name">Wild Essence</span><span class="ing-count">'+S.emblems.wild_essence+'</span><button class="ing-swap" onclick="openConvertModal(\'wild_essence\')" title="Convert">‚áå</button></div>';
  h+='<div class="ing-row"><span class="ing-icon">‚ö°</span><span class="ing-name">Focus Shard</span><span class="ing-count">'+S.emblems.focus_shard+'</span><button class="ing-swap" onclick="openConvertModal(\'focus_shard\')" title="Convert">‚áå</button></div>';
  h+='<div class="ing-row" style="border-color:rgba(200,136,255,.15)"><span class="ing-icon">üîÆ</span><span class="ing-name">√Ä·π£·∫π Essence</span><span class="ing-count">'+(S.emblems.ashe_essence||0)+'</span><span style="font-size:.42rem;color:var(--special);padding:0 4px">Expeditions</span></div>';
  h+='<div class="ing-row" style="border-color:rgba(140,180,255,.15)"><span class="ing-icon">üí†</span><span class="ing-name">Spirit Essence</span><span class="ing-count">'+(S.emblems.spirit_essence||0)+'</span><span style="font-size:.42rem;color:var(--t4);padding:0 4px">Release spirits</span></div>';
  h+='</div>';

  // ‚îÄ‚îÄ Building Materials ‚îÄ‚îÄ
  const mats=Object.entries(MATERIAL_INFO).filter(([id])=>getMaterialCount(id)>0);
  if(mats.length){
    h+='<div class="inv-section-label">Materials üèóÔ∏è</div>';
    h+='<div class="inv-materials-grid">';
    mats.forEach(([id,info])=>{
      const qty=getMaterialCount(id);
      h+='<div class="inv-mat-row"><span class="inv-mat-icon">'+info.emoji+'</span><div class="inv-mat-info"><div class="inv-mat-name">'+info.label+'</div></div><span class="inv-mat-qty">√ó'+qty+'</span></div>';
    });
    h+='</div>';
  }

  // ‚îÄ‚îÄ Wicked Pills (legacy ‚Äî keep functional) ‚îÄ‚îÄ
  const wickedPills=S.isGuest?[]:getWickedPills();
  if(wickedPills.length){
    h+='<div class="inv-section-label">Wicked Pills <span style="color:#c77">ü©∏</span></div>';
    h+='<div class="pill-grid">';
    wickedPills.forEach((p,i)=>{
      h+='<div class="pill-row" onclick="openUseWickedModal('+i+')"><span class="pill-icon">ü©∏</span><div class="pill-info"><div class="pill-name" style="color:#c77">'+esc(p.pill_name)+'</div><div class="pill-desc">'+p.xp_value+' XP ¬∑ Wicked alignment</div></div><div style="font-size:.45rem;color:var(--t3)">Use ‚Üí</div></div>';
    });
    h+='</div>';
  }

  // ‚îÄ‚îÄ Cultivation Jar + Heavenly Presser (condensed, still accessible) ‚îÄ‚îÄ
  h+='<div class="inv-section-label">Alchemy</div>';
  h+='<div class="pill-grid">';
  h+='<div class="pill-row'+(S.isGuest||S.spirits.length<=1?' disabled':'')+'" onclick="openJarModal()"><span class="pill-icon">üè∫</span><div class="pill-info"><div class="pill-name">Cultivation Jar</div><div class="pill-desc">Sacrifice a spirit ‚Üí Wicked Pill</div></div></div>';
  S.pillRecipes.forEach(p=>{
    const ok=S.emblems.cafe_bean>=p.cost_cafe_bean&&S.emblems.wild_essence>=p.cost_wild_essence&&S.emblems.focus_shard>=p.cost_focus_shard;
    const pIcons={growth:'üíä',clarity:'‚ú®',harmony:'üéµ'};
    h+='<div class="pill-row'+(ok?'':' disabled')+'" onclick="openCraftModal(\''+p.id+'\',\''+p.pill_name+'\',\''+p.effect_type+'\')"><span class="pill-icon">'+(pIcons[p.pill_type]||'üíä')+'</span><div class="pill-info"><div class="pill-name">'+p.pill_name+'</div><div class="pill-desc">'+p.description+'</div></div><div class="pill-cost">‚òï'+p.cost_cafe_bean+' üåø'+p.cost_wild_essence+' ‚ö°'+p.cost_focus_shard+'</div></div>';
  });
  h+='</div>';

  el.innerHTML=h;
}

function getDrinkDesc(name){
  const descs={'House Brew':'+20 XP to one spirit','Village Blend':'+40 XP ¬∑ +10% XP rate 2hrs','Reserve Roast':'+75 XP ¬∑ +15% XP rate 4hrs','Grand Cru':'+150 XP ¬∑ +25% XP rate 6hrs','Signature Reserve':'+300 XP ¬∑ +30% everything 12hrs'};
  return descs[name]||'A village special';
}

async function useDrink(invId){
  if(S.isGuest||!S.spirits.length)return;
  // Pick a spirit to receive the drink
  const item=S.buildingInventory.find(i=>i.id===invId);if(!item)return;
  const box=document.getElementById('modalBox');
  let h='<div class="modal-title">Use '+esc(item.item_name)+'</div>';
  h+='<div class="modal-desc">'+getDrinkDesc(item.item_name)+'</div>';
  h+='<div class="modal-desc" style="margin-top:4px">Choose a spirit:</div>';
  h+='<div class="modal-select-grid">';
  S.spirits.forEach(sp=>{
    const lvl=Math.floor((sp.xp||0)/S.XP_PER_LEVEL)+1;
    h+='<div class="modal-select-row" onclick="confirmUseDrink(\''+invId+'\',\''+sp.id+'\')"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'" style="width:28px;height:28px;border-radius:50%"><span style="font-size:.7rem">'+esc(sp.name)+'</span><span style="font-size:.5rem;color:var(--t4);margin-left:auto">Lv.'+lvl+'</span></div>';
  });
  h+='</div><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';
  box.innerHTML=h;document.getElementById('modal').classList.add('open');
}

async function confirmUseDrink(invId,spiritId){
  if(isBusy('drink'))return;setBusy('drink',3000);closeModal();
  try{
    const{data,error}=await sb.rpc('use_drink',{p_inv_id:invId,p_spirit_id:spiritId});
    if(error)throw error;
    if(data?.error){
  alert("The Database rejected the evolution! Reason: " + data.error);
  console.warn("DB Rejection Reason:", data.error);
  showToast('error');
  return;
}
    await Promise.all([reloadSpiritsAndTraits(),reloadBuildings().then(()=>syncMaterialsFromInventory())]);
    debouncedUpdateAllUI();
    showToastMsg('‚òï','Drink consumed!','Your spirit feels refreshed.');
  }catch(e){console.warn('use drink error:',e);showToast('error')}
}
// ‚ïê‚ïê‚ïê VILLAGE TAB ‚ïê‚ïê‚ïê
function renderVillageTab(){
  const el=document.getElementById('tab-village');
  const p=calcPrestige();
  const rank=VILLAGE_RANKS.slice().reverse().find(r=>p>=r.min)||VILLAGE_RANKS[0];
  const next=VILLAGE_RANKS[VILLAGE_RANKS.indexOf(rank)+1];
  const fromPts=rank.min;
  const toPts=next?next.min:rank.min;
  const pct=next?Math.min(100,Math.round(((p-fromPts)/(toPts-fromPts))*100)):100;
  let h='<div class="village-rank-card">';
  h+='<div class="village-rank-label">Village Rank</div>';
  h+='<div class="village-rank-name" style="color:'+(rank.color||'var(--t1)')+'">'+rank.name+'</div>';
  h+='<div class="village-rank-desc">'+rank.desc+'</div>';
  if(next){
    h+='<div class="village-rank-progress"><div class="village-rank-bar"><div class="village-rank-bar-fill" style="width:'+pct+'%;background:'+(rank.color||'var(--t2)')+'"></div></div>';
    h+='<div class="village-rank-next">'+p+' / '+next.min+' pts ¬∑ Next: <span style="color:'+(next.color||'var(--t2)')+'">'+next.name+'</span></div></div>';
  }else{
    h+='<div style="font-size:.5rem;color:var(--special);margin-top:8px">‚ú¶ Maximum rank achieved</div>';
  }
  h+='</div>';
  // Expeditions section (above buildings)
  h+='<div class="section-label">Expeditions</div><div class="exped-section">';
  const slot1Exp=S.expeditions.find(e=>e.slot_number===1&&(getExpedStatus(e)!=='idle'));
  h+=renderExpedSlot(slot1Exp,1,false);
  const slot2Unlocked=p>=400;
  const slot2Exp=S.expeditions.find(e=>e.slot_number===2&&(getExpedStatus(e)!=='idle'));
  h+=renderExpedSlot(slot2Exp,2,!slot2Unlocked);
  h+='</div>';
  // Buildings section
  h+='<div class="section-label" style="margin-top:14px">Village Buildings</div>';
  h+=renderBuildingsSection();
  el.innerHTML=h;
}

// ‚ïê‚ïê‚ïê V2.8: BUILDINGS SECTION ‚Äî grid tiles ‚ïê‚ïê‚ïê
function renderBuildingsSection(){
  let h='<div class="buildings-grid-v2">';
  Object.values(BUILDING_CONFIGS).forEach(cfg=>{
    const unlocked=buildingUnlocked(cfg.id);
    const mgr=unlocked?getManagerFor(cfg.id):null;
    const mgrSp=mgr?S.spirits.find(s=>s.id===mgr.spirit_id):null;
    const workers=unlocked?getWorkersFor(cfg.id):[];
    const tier=unlocked?getBuildingTier(cfg.id):1;
    // Staff pips
    let staffPips='';
    if(unlocked){
      if(mgrSp)staffPips+='<div class="building-tile-staff-pip"><img src="'+spiritImg(mgrSp.spirit_type,mgrSp.evo_stage)+'"></div>';
      else staffPips+='<div class="building-tile-staff-pip empty">+</div>';
      for(let i=0;i<cfg.roles.worker.slots;i++){
        const w=workers[i]?S.spirits.find(s=>s.id===workers[i].spirit_id):null;
        if(w)staffPips+='<div class="building-tile-staff-pip"><img src="'+spiritImg(w.spirit_type,w.evo_stage)+'"></div>';
        else staffPips+='<div class="building-tile-staff-pip empty">+</div>';
      }
    }
    const isCafeDefault=cfg.id==='cafe'&&unlocked;
    h+='<div class="building-tile '+(unlocked?'unlocked':'locked')+(isCafeDefault?' cafe-default':'')+'" onclick="openBuildingModal(\''+cfg.id+'\')">';
    h+='<span class="building-tile-badge '+(unlocked?'open':'locked')+'">'+(unlocked?'Open':'Locked')+'</span>';
    if(unlocked)h+='<span class="building-tier-badge tier-'+tier+'" style="position:absolute;top:8px;right:8px">T'+tier+'</span>';
    h+='<div class="building-tile-emoji">'+cfg.emoji+'</div>';
    h+='<div class="building-tile-name">'+cfg.label+'</div>';
    h+='<div class="building-tile-desc">'+cfg.desc+'</div>';
    if(unlocked&&staffPips)h+='<div class="building-tile-staff">'+staffPips+'</div>';
    if(!unlocked){
      const canUnlock=canUnlockBuilding(cfg.id);
      if(canUnlock)h+='<div style="font-size:.42rem;color:var(--positive);margin-top:2px">Ready to unlock</div>';
    }
    h+='</div>';
  });
  h+='</div>';
  return h;
}

// ‚ïê‚ïê‚ïê V2.8/V2.9: BUILDING MODAL ‚ïê‚ïê‚ïê
function openBuildingModal(buildingId){
  const cfg=BUILDING_CONFIGS[buildingId];if(!cfg)return;
  const unlocked=buildingUnlocked(buildingId);
  const canUnlock=canUnlockBuilding(buildingId);
  const sheet=document.getElementById('buildingModalSheet');
  const tier=unlocked?getBuildingTier(buildingId):1;
  const tierDef=cfg.tiers?cfg.tiers[tier-1]:null;
  let h='<div class="building-modal-header">';
  h+='<span class="building-modal-emoji">'+cfg.emoji+'</span>';
  h+='<div><div class="building-modal-title">'+cfg.label;
  if(unlocked)h+=' <span class="building-tier-badge tier-'+tier+'">T'+tier+'</span>';
  h+='</div>';
  h+='<div class="building-modal-subtitle">'+cfg.desc+'</div></div>';
  h+='<button class="building-modal-close" onclick="closeBuildingModal()">‚úï</button>';
  h+='</div>';
  h+='<div class="building-modal-body">';
  if(unlocked){
    // Passive buff + current tier benefit
    h+='<div class="bm-buff">‚ú¶ '+cfg.passiveBuff.desc+'</div>';
    if(tierDef)h+='<div class="bm-buff" style="color:var(--t3);font-size:.48rem">'+tierDef.desc+'</div>';
    // Staff section
    h+='<div class="bm-section">Staff</div>';
    const mgr=getManagerFor(buildingId);
    const mgrSp=mgr?S.spirits.find(s=>s.id===mgr.spirit_id):null;
    h+='<div class="bm-staff-row" onclick="openAssignStaffModal(\''+buildingId+'\',\'manager\')">';
    h+='<span class="bm-staff-role">'+cfg.roles.manager.label+'</span>';
    if(mgrSp){
      const cl=buildingId==='cafe'?getCraftLevel(mgrSp.id):0;
      h+='<div class="bm-staff-avatar"><img src="'+spiritImg(mgrSp.spirit_type,mgrSp.evo_stage)+'"></div>';
      h+='<div style="flex:1"><div class="bm-staff-name">'+mgrSp.name+'</div>';
      if(buildingId==='cafe'&&cl>0){const drink=getCafeDrinkForLevel(cl);h+='<div class="bm-staff-detail">crafts '+drink.name+'</div>';}
      h+='</div>';
    }else{
      h+='<div class="bm-staff-avatar empty">+</div>';
      h+='<span class="bm-staff-name" style="color:var(--t3)">Assign '+cfg.roles.manager.label+'</span>';
    }
    h+='</div>';
    const workers=getWorkersFor(buildingId);
    for(let i=0;i<cfg.roles.worker.slots;i++){
      const wrkStaff=workers[i]||null;
      const wrkSp=wrkStaff?S.spirits.find(s=>s.id===wrkStaff.spirit_id):null;
      h+='<div class="bm-staff-row" onclick="openAssignStaffModal(\''+buildingId+'\',\'worker\''+(wrkStaff?',\''+wrkStaff.id+'\'':'')+' )">';
      h+='<span class="bm-staff-role">'+cfg.roles.worker.label+'</span>';
      if(wrkSp){
        h+='<div class="bm-staff-avatar"><img src="'+spiritImg(wrkSp.spirit_type,wrkSp.evo_stage)+'"></div>';
        h+='<span class="bm-staff-name">'+wrkSp.name+'</span>';
      }else{
        h+='<div class="bm-staff-avatar empty">+</div>';
        h+='<span class="bm-staff-name" style="color:var(--t3)">Assign '+cfg.roles.worker.label+'</span>';
      }
      h+='</div>';
    }
    // Caf√© drink menu
    if(buildingId==='cafe'){
      h+='<div class="bm-section" style="margin-top:14px">Drink Menu</div>';
      const cafeTier=getBuildingTier('cafe');
      // Head Barista trait: manager with this trait unlocks T2 drinks even at T1 building
      const hasHeadBarista=mgrSp&&spiritHasTraitEffect(mgrSp.id,'cafe_tier');
      const effectiveCafeTier=hasHeadBarista?Math.max(cafeTier,2):cafeTier;
      if(hasHeadBarista&&cafeTier<2)h+='<div style="font-size:.45rem;color:var(--positive);margin-bottom:6px">‚ú¶ '+mgrSp.name+'\'s Head Barista trait unlocks T2 drinks</div>';
      cfg.craftItems.forEach(drink=>{
        const mgrLevel=mgrSp?getCraftLevel(mgrSp.id):0;
        const available=mgrLevel>=drink.minCraftLevel;
        const tierLocked=(effectiveCafeTier<2&&drink.tier>1)||(effectiveCafeTier<3&&drink.tier>3);
        h+='<div class="bm-cafe-drink" style="'+(tierLocked?'opacity:.2':available?'':'opacity:.4')+'">';
        h+='<div style="flex:1"><div class="bm-cafe-drink-name">'+drink.name+(tierLocked?' üîí':'')+'</div>';
        h+='<div class="bm-cafe-drink-desc">'+drink.desc+'</div></div>';
        h+='<span class="bm-cafe-drink-tier">T'+drink.tier+'</span>';
        h+='</div>';
      });
    }
    // Library research UI
    if(buildingId==='library'){
      h+='<div class="bm-section" style="margin-top:14px">Research</div>';
      const libMgr=getManagerFor('library');
      if(!libMgr){
        h+='<div style="font-size:.5rem;color:var(--t3);margin-bottom:8px">Assign a Head Archivist to begin research.</div>';
      }else{
        h+='<div style="font-size:.5rem;color:var(--t3);margin-bottom:8px">Research reveals what spirits bring back from each location. Progresses while you listen.</div>';
        const researchData=getLibraryResearch();
        const durationMin=getResearchDurationMin('library');
        const totalListenMin=getTotalListenMinutes();
        h+='<div class="library-research-grid">';
        Object.values(EXPED_LOCATIONS).forEach(loc=>{
          const r=researchData[loc.id]||{status:'idle'};
          const isDone=r.status==='done';
          const isActive=r.status==='researching';
          const isActive2=isActive;
          let pct=0,remaining=durationMin;
          if(isActive2){
            const elapsed=totalListenMin-(r.startedListenMin||0);
            pct=Math.min(100,Math.round((elapsed/durationMin)*100));
            remaining=Math.max(0,durationMin-elapsed);
          }
          let statusClass=isDone?'done':isActive2?'active':'idle';
          let statusLabel=isDone?'Researched':isActive2?'Researching...':'Not started';
          h+='<div class="library-research-loc '+(isDone?'researched':isActive2?'researching':'')+'"'+(isDone||isActive2?'':' onclick="startResearch(\''+loc.id+'\')"')+'>';
          h+='<div class="library-research-header">';
          h+='<span class="library-research-emoji">'+loc.emoji+'</span>';
          h+='<span class="library-research-name">'+loc.label+'</span>';
          h+='<span class="library-research-status '+statusClass+'">'+statusLabel+'</span>';
          h+='</div>';
          if(isActive2){
            h+='<div class="library-research-bar-wrap">';
            h+='<div class="library-research-bar"><div class="library-research-fill" style="width:'+pct+'%"></div></div>';
            h+='<span class="library-research-time">'+remaining+'m left</span>';
            h+='</div>';
          }
          if(isDone){
            // Show loot table preview
            h+='<div class="library-loot-preview">';
            loc.lootTable.forEach(item=>{
              h+='<span class="library-loot-tag'+(item.rarity==='rare'?' rare':'')+'">'+item.emoji+' '+item.label+'</span>';
            });
            h+='</div>';
          }
          if(!isDone&&!isActive2){
            h+='<div style="font-size:.42rem;color:var(--t4);margin-top:3px">Tap to begin ¬∑ ~'+durationMin+'min listening</div>';
          }
          h+='</div>';
        });
        h+='</div>';
      }
    }
    // V2.9: Tier upgrade section
    if(cfg.tiers&&tier<3){
      const nextTierDef=cfg.tiers[tier]; // index = current tier (0-based)
      if(nextTierDef&&nextTierDef.upgradeCost){
        const canUp=canUpgradeBuilding(buildingId);
        h+='<div class="bm-upgrade">';
        h+='<div class="bm-section">Upgrade to Tier '+(tier+1)+'</div>';
        h+='<div class="bm-tier-benefit">'+nextTierDef.desc+'</div>';
        h+='<div class="bm-upgrade-cost">';
        Object.entries(nextTierDef.upgradeCost).forEach(([mat,qty])=>{
          let has,emoji,label;
          if(['cafe_bean','wild_essence','focus_shard','ashe_essence','spirit_essence'].includes(mat)){
            has=(S.emblems[mat]||0)>=qty;
            const EMBL={cafe_bean:['‚òï','Caf√© Bean'],wild_essence:['üåø','Wild Essence'],focus_shard:['‚ö°','Focus Shard'],ashe_essence:['üîÆ','√Ä·π£·∫π Essence'],spirit_essence:['üí†','Spirit Essence']};
            [emoji,label]=EMBL[mat];
          }else{
            has=hasMaterial(mat,qty);
            const info=MATERIAL_INFO[mat]||{emoji:'üì¶',label:mat};
            emoji=info.emoji;label=info.label;
          }
          h+='<div class="bm-upgrade-mat '+(has?'has':'missing')+'">'+emoji+' '+qty+'√ó '+label+(has?' ‚úì':' (need more)')+'</div>';
        });
        h+='</div>';
        h+='<button class="bm-upgrade-btn '+(canUp?'ready':'')+'" '+(canUp?'':'disabled')+' onclick="upgradeBuilding(\''+buildingId+'\')">'+(canUp?'Upgrade to Tier '+(tier+1):'Need more materials')+'</button>';
        h+='</div>';
      }else if(tier>=3){
        h+='<div class="bm-upgrade"><div class="bm-upgrade-btn maxed" style="width:100%;text-align:center;padding:10px;border-radius:var(--radius-sm);font-size:.65rem">‚ú¶ Tier 3 ‚Äî Fully Upgraded</div></div>';
      }
    }else if(cfg.tiers&&tier>=3){
      h+='<div class="bm-upgrade"><div style="text-align:center;font-size:.48rem;color:#ffd480;padding:8px 0">‚ú¶ Tier 3 ‚Äî Fully Upgraded</div></div>';
    }
  }else{
    // Locked: unlock panel
    h+='<div class="bm-section">Passive Benefit</div>';
    h+='<div style="font-size:.55rem;color:var(--t2);margin-bottom:10px">'+cfg.passiveBuff.desc+'</div>';
    h+='<div class="bm-section">Unlock Cost</div>';
    h+='<div class="bm-unlock-cost">';
    Object.entries(cfg.unlockMaterials).forEach(([mat,qty])=>{
      let has,label,emoji;
      if(['cafe_bean','wild_essence','focus_shard','ashe_essence','spirit_essence'].includes(mat)){
        has=(S.emblems[mat]||0)>=qty;
        const EMBL={cafe_bean:['‚òï','Caf√© Bean'],wild_essence:['üåø','Wild Essence'],focus_shard:['‚ö°','Focus Shard'],ashe_essence:['üîÆ','√Ä·π£·∫π Essence'],spirit_essence:['üí†','Spirit Essence']};
        [emoji,label]=EMBL[mat];
      }else{
        has=hasMaterial(mat,qty);
        const info=MATERIAL_INFO[mat]||{emoji:'üì¶',label:mat};
        emoji=info.emoji;label=info.label;
      }
      h+='<div class="bm-unlock-mat '+(has?'has':'missing')+'">'+emoji+' '+qty+'√ó '+label+'<span style="font-size:.4rem;margin-left:4px;color:var(--t4)">'+(has?'‚úì':'need more')+'</span></div>';
    });
    h+='</div>';
    h+='<button class="bm-unlock-btn" '+(canUnlock?'':'disabled')+' onclick="openUnlockBuildingModal(\''+buildingId+'\')">'+(canUnlock?'Unlock '+cfg.label:'Gather materials on expeditions')+'</button>';
    if(!canUnlock){
      h+='<div style="font-size:.48rem;color:var(--t4);text-align:center;margin-top:10px;line-height:1.6">Materials drop during expeditions.<br>Night Market, Bamboo Highlands &amp; Frozen Ruins each carry different supplies.</div>';
    }
  }
  h+='</div>';
  sheet.innerHTML=h;
  document.getElementById('buildingModalOverlay').classList.add('open');
}
function closeBuildingModal(){
  document.getElementById('buildingModalOverlay').classList.remove('open');
}
function calcPrestige(){const xpl=S.XP_PER_LEVEL||150;let p=0;S.spirits.forEach(sp=>{const evoBonus=[15,30,50][sp.evo_stage]||15;p+=evoBonus;p+=Math.floor((sp.xp||0)/xpl)*7});p+=Math.floor((S.profile?.total_listen_seconds||0)/3600)*4;return p}

// ‚ïê‚ïê‚ïê HATCH ‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê HATCH EGG (SAFELY VALIDATED) ‚ïê‚ïê‚ïê
async function doHatch(slotId) {
  if (S.isGuest || isBusy('hatch_' + slotId)) return;
  setBusy('hatch_' + slotId, 5000);
  const slotIdx = S.hatchery.findIndex(s => s.id === slotId);
  if (slotIdx >= 0) { S.hatchery[slotIdx]._hatching = true; renderPillsTab(); }
  
  try {
    const { data, error } = await sb.rpc('hatch_egg', { p_slot_id: slotId });
    if (error) throw error;
    // Fix: Strict null check before accessing .error
    if (!data || data.error) { 
      console.warn('hatch rpc error:', data?.error || 'No data returned');
      showToast('error'); 
      if (slotIdx >= 0) S.hatchery[slotIdx]._hatching = false; 
      renderPillsTab(); 
      return; 
    }
    
    _lastHatchData = data;
    await loadUserData(); 
    updateAllUI(); 
    
    // Ensure animation never crashes on missing properties
    const safeData = {
      rarity: data.rarity || 'mundane',
      spirit_type: data.spirit_type || 'timi',
      evo_stage: data.evo_stage || 0
    };
    showHatchAnimation(safeData);
  } catch (e) {
    console.warn('hatch error:', e); 
    showToast('error'); 
    if (slotIdx >= 0) S.hatchery[slotIdx]._hatching = false; 
    renderPillsTab();
  }
}

  
function showHatchAnimation(data){const ov=document.getElementById('hatchOverlay'),eg=document.getElementById('hatchEgg'),rv=document.getElementById('hatchReveal');
// V1.4: Rarity-themed overlay background
ov.className='hatch-overlay rarity-'+(data.rarity||'mundane');
eg.style.display='block';eg.className='hatch-egg-anim';rv.className='hatch-reveal';ov.classList.add('show');const spiritType=data.spirit_type||null;const sk=['timi','bayo','mowang','florita','simi','basu_basu'];const rk=spiritType?spiritKey(spiritType):sk[Math.floor(Math.random()*3)];const st=data.evo_stage||0;document.getElementById('hatchImg').src=SPIRIT_DATA[rk]?.img[st]||'sprites/timi_1.png';document.getElementById('hatchName').textContent=SPIRIT_DATA[rk]?.name||'Spirit';const r=data.rarity||'mundane';document.getElementById('hatchRarity').textContent=r.charAt(0).toUpperCase()+r.slice(1);document.getElementById('hatchRarity').style.color=RARITY_COLORS[r]||'#888';
// V1.4: Show rarity bonus XP
const RARITY_BONUS_XP={mundane:0,adept:10,refined:25,illustrious:50,sovereign:75,celestial:100,transcendent:150,mysterious:200,ancestral:200,paradox:250};
const bonusXp=RARITY_BONUS_XP[r]||0;
const bonusEl=document.getElementById('hatchBonusXp');if(bonusEl){bonusEl.textContent=bonusXp>0?'+'+bonusXp+' bonus XP':'';bonusEl.style.display=bonusXp>0?'':'none'}
setTimeout(()=>eg.classList.add('crack'),1800);setTimeout(()=>{eg.style.display='none';spawnRarityParticles(ov,r);rv.classList.add('show')},2500)}
function spawnParticles(parent,type){const colors=type==='evo'?['#ffd700','#ff6b35','#fff']:['#fff','#8ab4ff','#c8f'];for(let i=0;i<12;i++){const p=document.createElement('div');p.style.cssText='position:absolute;width:6px;height:6px;border-radius:50%;pointer-events:none;z-index:999;left:50%;top:50%;background:'+colors[i%3];const a=Math.random()*Math.PI*2,d=60+Math.random()*80,dur=600+Math.random()*400;p.animate([{transform:'translate(-50%,-50%) translate(0,0) scale(1)',opacity:1},{transform:'translate(-50%,-50%) translate('+Math.cos(a)*d+'px,'+Math.sin(a)*d+'px) scale(0)',opacity:0}],{duration:dur,easing:'cubic-bezier(.34,1.56,.64,1)'});parent.appendChild(p);setTimeout(()=>p.remove(),dur)}}

// V1.4: Rarity-themed particles for hatch animation
function spawnRarityParticles(parent,rarity){
  const RARITY_PARTICLES={
    mundane:{colors:['#aaa','#ccc','#888'],count:10},
    adept:{colors:['#8ab4ff','#a8ccff','#fff'],count:12},
    refined:{colors:['#7ac77a','#a8e6a8','#fff'],count:12},
    illustrious:{colors:['#ffd480','#ffe0a0','#fff5e0'],count:14},
    sovereign:{colors:['#c8a0e8','#e0c8f0','#fff'],count:14},
    celestial:{colors:['#80ccff','#a0e0ff','#e0f4ff'],count:16},
    transcendent:{colors:['#ffc880','#ffe0b0','#fff8e8'],count:18},
    mysterious:{colors:['#d080f0','#e0a0ff','#f0d0ff'],count:18},
    ancestral:{colors:['#ff8080','#ffa0a0','#ffe0e0'],count:18},
    paradox:{colors:['#fff','#e0e0ff','#ffe0f0','#e0ffe0','#ffe0e0'],count:22}
  };
  const cfg=RARITY_PARTICLES[rarity]||RARITY_PARTICLES.mundane;
  for(let i=0;i<cfg.count;i++){
    const p=document.createElement('div');
    const size=4+Math.random()*4;
    p.style.cssText='position:absolute;width:'+size+'px;height:'+size+'px;border-radius:50%;pointer-events:none;z-index:999;left:50%;top:50%;background:'+cfg.colors[i%cfg.colors.length];
    const a=Math.random()*Math.PI*2,d=50+Math.random()*100,dur=500+Math.random()*600;
    p.animate([
      {transform:'translate(-50%,-50%) translate(0,0) scale(1)',opacity:1},
      {transform:'translate(-50%,-50%) translate('+Math.cos(a)*d+'px,'+Math.sin(a)*d+'px) scale(0)',opacity:0}
    ],{duration:dur,easing:'cubic-bezier(.34,1.56,.64,1)'});
    parent.appendChild(p);setTimeout(()=>p.remove(),dur);
  }
  // Second burst for rare+ eggs
  if(cfg.count>=14){
    setTimeout(()=>{
      for(let i=0;i<Math.floor(cfg.count/2);i++){
        const p=document.createElement('div');const size=3+Math.random()*3;
        p.style.cssText='position:absolute;width:'+size+'px;height:'+size+'px;border-radius:50%;pointer-events:none;z-index:999;left:50%;top:50%;background:'+cfg.colors[i%cfg.colors.length];
        const a=Math.random()*Math.PI*2,d=40+Math.random()*70,dur=400+Math.random()*500;
        p.animate([{transform:'translate(-50%,-50%) translate(0,0) scale(1)',opacity:.8},{transform:'translate(-50%,-50%) translate('+Math.cos(a)*d+'px,'+Math.sin(a)*d+'px) scale(0)',opacity:0}],{duration:dur,easing:'cubic-bezier(.34,1.56,.64,1)'});
        parent.appendChild(p);setTimeout(()=>p.remove(),dur);
      }
    },300);
  }
}
function closeHatchAnim(){const ov=document.getElementById('hatchOverlay');ov.classList.remove('show');ov.className='hatch-overlay';
// Feature: Rarity bonus XP ‚Äî higher rarity eggs give spirits bonus starting XP
if(_lastHatchData&&!S.isGuest){const RARITY_BONUS_XP={mundane:0,adept:10,refined:25,illustrious:50,sovereign:75,celestial:100,transcendent:150,mysterious:200,ancestral:200,paradox:250};const bonus=RARITY_BONUS_XP[_lastHatchData.rarity]||0;if(bonus>0){
// Find the newest spirit (most recently created, lowest XP, matches type)
const target=S.spirits.filter(s=>s.spirit_type===(_lastHatchData.spirit_type||'')&&(s.xp||0)<=bonus).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at))[0]||S.spirits[S.spirits.length-1];
if(target){const newXp=(target.xp||0)+bonus;sb.from('spirits').update({xp:newXp}).eq('id',target.id).then(()=>loadUserData().then(()=>updateAllUI())).catch(e=>console.warn('rarity bonus err',e))}}}
// V2.8: Prompt user to name the newly hatched spirit
if(_lastHatchData&&!S.isGuest){
  const spiritType=_lastHatchData.spirit_type||'timi';
  const k=spiritKey(spiritType);
  const defaultName=SPIRIT_DATA[k]?.name||'Spirit';
  // Find the most recently added spirit of this type
  const newSp=S.spirits.filter(s=>spiritKey(s.spirit_type)===k).sort((a,b)=>new Date(b.created_at||0)-new Date(a.created_at||0))[0];
  if(newSp)showNameAtHatch(newSp.id,spiritType,defaultName);
  else showToast('new_spirit');
}else showToast('new_spirit')}

// ‚ïê‚ïê‚ïê SLOT UNLOCK ‚ïê‚ïê‚ïê
async function unlockSlot(num){if(S.isGuest)return;try{const{data}=await sb.rpc('unlock_hatchery_slot',{p_slot_number:num});if(data?.error){showToast('error');return}await loadUserData();updateAllUI();showToast('unlock')}catch(e){showToast('error')}}

// ‚ïê‚ïê‚ïê PLACE EGG ‚ïê‚ïê‚ïê
function openPlaceEggModal(slotId){const pend=S.pendingEggs.filter(e=>e.status==='pending');if(!pend.length){showToast('no_eggs');return}const box=document.getElementById('modalBox');box.innerHTML='<div class="modal-title">Place an Egg</div><div class="modal-select-grid">'+pend.map(e=>'<div class="modal-select-row" onclick="placeEgg(\''+e.id+'\',\''+slotId+'\')"><span>\uD83E\uDD5A</span><span style="color:'+(RARITY_COLORS[e.rarity]||'#888')+'">'+e.rarity+'</span><span style="font-size:.5rem;color:var(--t4);margin-left:auto">'+(INCUB_MINS[e.rarity]||5)+'m</span></div>').join('')+'</div><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';document.getElementById('modal').classList.add('open')}
async function placeEgg(eId, sId) {
  if (S.isGuest || isBusy('place_' + eId)) return;
  setBusy('place_' + eId, 3000);
  closeModal();
  
  const eggIdx = S.pendingEggs.findIndex(e => e.id === eId);
  const slotIdx = S.hatchery.findIndex(s => s.id === sId);
  if (eggIdx >= 0 && slotIdx >= 0) {
    S.hatchery[slotIdx].egg_id = eId;
    S.hatchery[slotIdx].started_at = new Date().toISOString();
    S.pendingEggs.splice(eggIdx, 1);
    renderPillsTab();
  }
  
  try {
    const { data, error } = await sb.rpc('place_egg_in_slot', { p_egg_id: eId, p_slot_id: sId });
    if (error) throw error;
    if (data?.error) console.warn('place egg error:', data.error);
    await loadUserData();
    updateAllUI();
  } catch (e) {
    console.warn('placeEgg error:', e);
    showToast('error');
    await loadUserData();
    updateAllUI();
  }
}

  
function startHatcheryTicker(){if(S.hatchTicker)return;S.hatchTicker=setInterval(()=>{if(!S.isGuest){renderPillsTab();checkHatchReady();}},15000)}

// ‚ïê‚ïê‚ïê CRAFT PILLS ‚ïê‚ïê‚ïê
function openCraftModal(recipeId,pillName,effectType){if(S.isGuest)return;if(effectType==='xp_all'){doCraft(recipeId,null);return}const box=document.getElementById('modalBox');box.innerHTML='<div class="modal-title">Use '+pillName+'</div><div class="modal-desc">Choose a spirit:</div><div class="modal-select-grid">'+S.spirits.map(sp=>'<div class="modal-select-row" onclick="doCraft(\''+recipeId+'\',\''+sp.id+'\')"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'" style="width:28px;height:28px;border-radius:50%"><span style="font-size:.7rem">'+sp.name+'</span><span style="font-size:.5rem;color:var(--t4);margin-left:auto">Lv.'+(Math.floor((sp.xp||0)/S.XP_PER_LEVEL)+1)+'</span></div>').join('')+'</div><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';document.getElementById('modal').classList.add('open')}
async function doCraft(recipeId,spiritId){closeModal();if(isBusy('craft'))return;setBusy('craft',3000);
const recipe=S.pillRecipes.find(p=>p.id===recipeId);
// Optimistic: deduct ingredients immediately
if(recipe){S.emblems.cafe_bean=Math.max(0,S.emblems.cafe_bean-recipe.cost_cafe_bean);S.emblems.wild_essence=Math.max(0,S.emblems.wild_essence-recipe.cost_wild_essence);S.emblems.focus_shard=Math.max(0,S.emblems.focus_shard-recipe.cost_focus_shard);renderPillsTab();renderSpiritsTab()}
try{const{data,error}=await sb.rpc('craft_pill',{p_recipe_id:recipeId,p_spirit_id:spiritId});if(error)throw error;if(data?.error){showToast('error');await loadUserData();updateAllUI();return}
// Trait effect: Studious gives +5% pill XP to the targeted spirit
if(spiritId){const studBonus=spiritTraitBonus(spiritId,'xp_bonus');if(studBonus>0&&recipe){const bonusXp=Math.floor((recipe.effect_value||0)*studBonus);if(bonusXp>0){const sp=S.spirits.find(s=>s.id===spiritId);if(sp){const newXp=(sp.xp||0)+bonusXp;sb.from('spirits').update({xp:newXp}).eq('id',spiritId).then(()=>{}).catch(e=>console.warn('studious bonus err',e))}}}}
await loadUserData();updateAllUI();showToast(data.leveled_up?'levelup':'craft');incAchieveCounter('pills_crafted')}catch(e){console.warn('craft error:',e);showToast('error');await loadUserData();updateAllUI()}}

// ‚ïê‚ïê‚ïê CONVERT ‚ïê‚ïê‚ïê
function openConvertModal(from){if(S.isGuest)return;const n={cafe_bean:'Caf\u00e9 Bean',wild_essence:'Wild Essence',focus_shard:'Focus Shard'},ic={cafe_bean:'\u2615',wild_essence:'\uD83C\uDF3F',focus_shard:'\u26A1'},oth=Object.keys(n).filter(k=>k!==from);const box=document.getElementById('modalBox');box.innerHTML='<div class="modal-title">Convert '+ic[from]+'</div><div class="modal-desc">3 <b>'+n[from]+'</b> \u2192 1 other. You have: <b>'+S.emblems[from]+'</b></div><div class="modal-select-grid">'+oth.map(to=>'<div class="modal-select-row'+(S.emblems[from]<3?' style="opacity:.3;pointer-events:none"':'')+'" onclick="doConvert(\''+from+'\',\''+to+'\')"><span>'+ic[to]+' '+n[to]+'</span></div>').join('')+'</div><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';document.getElementById('modal').classList.add('open')}
async function doConvert(from,to){closeModal();try{const{data}=await sb.rpc('convert_ingredient',{p_from:from,p_to:to,p_amount:1});if(data?.error){showToast('error');return}S.emblems[from]-=3;S.emblems[to]+=1;renderPillsTab();renderSpiritsTab()}catch(e){showToast('error')}}
function closeModal(){document.getElementById('modal').classList.remove('open')}

// ‚ïê‚ïê‚ïê ACTIVE CULTIVATION TICKER ‚ïê‚ïê‚ïê
function startCultivationTicker(){if(S.cultTicker||S.isGuest)return;S.cultTicker=setInterval(async()=>{if(!S.playing||S.isGuest)return;
  // V2.5: √Ä·π£·∫π from listening ‚Äî 2 √†·π£·∫π per 30 min continuous listening
  S.asheListenTimer=(S.asheListenTimer||0)+300; // 5 min per tick
  if(S.asheListenTimer>=1800){ // 30 min
    S.asheListenTimer=0;
    try{
      await sb.from('emblems').upsert({user_id:S.user.id,emblem_type:'ashe_essence',quantity:(S.emblems.ashe_essence||0)+2},{onConflict:'user_id,emblem_type'});
      S.emblems.ashe_essence=(S.emblems.ashe_essence||0)+2;
      showToastMsg('üîÆ','√Ä·π£·∫π flows‚Ä¶','+2 √Ä·π£·∫π Essence from listening');
      debouncedUpdateAllUI();
    }catch(e){console.warn('ashe listen tick error:',e)}
  }
  // V2.9: Check library research progress every listen tick
  checkResearchProgress();
  // V2.6: Dojo passive XP for assigned workers
  applyDojoXP();
  try{const{data}=await sb.rpc('tick_active_cultivation');if(data?.success){
// V3.2: Trait XP bonuses (Focused, Disciplined, Meditative, Calm) and drink buffs
// are now applied server-side inside tick_active_cultivation RPC. No client-side override needed.
await loadUserData();updateAllUI()}}catch(e){console.warn('cultivation tick error:',e)}},300000)}

// ‚ïê‚ïê‚ïê EVOLUTION ‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê EVOLUTION ‚ïê‚ïê‚ïê
async function doEvolve(spiritId) {
  if (S.isGuest || isBusy('evolve_' + spiritId)) return;
  setBusy('evolve_' + spiritId, 5000);
  const sp = S.spirits.find(s => s.id === spiritId);
  try {
    const { data, error } = await sb.rpc('evolve_spirit', { p_spirit_id: spiritId });
    if (error) throw error;
    // Fix: Use optional chaining to prevent crash if data is null
    if (data?.error) { showToast('error'); return; }
    
    await loadUserData();
    updateAllUI();
    closeSpiritDetail();
    
    const newSp = S.spirits.find(s => s.id === spiritId) || sp;
    if (newSp) {
      showEvoCeremony(newSp);
      addJournalEntry(spiritId, 'evolution', 'Evolved to ' + EVO_LABELS[newSp.evo_stage]);
    } else {
      showToast('evolution');
    }
    checkMilestones();
  } catch (e) {
    console.warn('evolve error:', e);
    showToast('error');
  }
}

// ‚ïê‚ïê‚ïê V2.4/V2.8: EVOLUTION CEREMONY ‚Äî enhanced ‚ïê‚ïê‚ïê
function showEvoCeremony(sp){
  const ov=document.getElementById('evoCeremony');
  if(!ov)return showToast('evolution');
  // Set content
  document.getElementById('evoCeremonyImg').src=spiritImg(sp.spirit_type,sp.evo_stage);
  document.getElementById('evoCeremonyName').textContent=sp.name;
  const stageColors=['','#8ab4ff','#ffd480'];
  const stageEl=document.getElementById('evoCeremonyStage');
  stageEl.textContent=EVO_LABELS[sp.evo_stage];
  stageEl.style.color=stageColors[sp.evo_stage]||'var(--t2)';
  // Show new trait slots
  const traitsEl=document.getElementById('evoCeremonyTraits');
  if(traitsEl){
    const slots=TRAIT_SLOTS[sp.evo_stage]||1;
    traitsEl.innerHTML=slots+' trait slot'+(slots>1?'s':'')+' unlocked';
  }
  // Big flash then show
  const flash=document.getElementById('evoCeremonyFlash');
  flash.style.opacity='1';
  flash.style.transition='opacity 0.08s';
  setTimeout(()=>{
    flash.style.transition='opacity 0.8s';
    flash.style.opacity='0';
  },80);
  ov.classList.add('show');
  // Multi-wave particles
  const pContainer=document.getElementById('evoCeremonyParticles');
  pContainer.innerHTML='';
  const colors=sp.evo_stage===2?['#ffd700','#ff9500','#fff','#ffd480','#ffb340']:['#8ab4ff','#c8f','#fff','#b0d0ff','#a0c8ff'];
  function burstWave(count,delay,spread){
    setTimeout(()=>{
      for(let i=0;i<count;i++){
        const p=document.createElement('div');
        const size=3+Math.random()*8;
        p.style.cssText='position:absolute;width:'+size+'px;height:'+size+'px;border-radius:50%;pointer-events:none;left:50%;top:40%;background:'+colors[i%colors.length];
        const a=Math.random()*Math.PI*2,d=spread+Math.random()*spread,dur=700+Math.random()*900;
        p.animate([
          {transform:'translate(-50%,-50%) translate(0,0) scale(1)',opacity:1},
          {transform:'translate(-50%,-50%) translate('+Math.cos(a)*d+'px,'+Math.sin(a)*d+'px) scale(0)',opacity:0}
        ],{duration:dur,easing:'cubic-bezier(.34,1.56,.64,1)'});
        pContainer.appendChild(p);setTimeout(()=>p.remove(),dur+delay+100);
      }
    },delay);
  }
  burstWave(32,100,120);
  burstWave(20,600,80);
  burstWave(16,1200,60);
  // Portrait glow ring
  const portrait=document.getElementById('evoCeremonyPortrait');
  if(portrait){
    const glowColor=sp.evo_stage===2?'rgba(255,212,128,.4)':'rgba(138,180,255,.4)';
    portrait.style.boxShadow='0 0 0 3px '+glowColor+', 0 0 40px '+glowColor;
    portrait.style.transition='box-shadow .6s ease .3s';
  }
}
function closeEvoCeremony(){
  document.getElementById('evoCeremony').classList.remove('show');
  const portrait=document.getElementById('evoCeremonyPortrait');
  if(portrait)portrait.style.boxShadow='';
  if(S.selectedSpirit)showSpiritDetail(S.selectedSpirit);
}
// Tap anywhere on ceremony to close
document.addEventListener('click',e=>{
  const ov=document.getElementById('evoCeremony');
  if(ov&&ov.classList.contains('show'))closeEvoCeremony();
});
function showEvoAnimation(){const ov=document.createElement('div');ov.style.cssText='position:fixed;inset:0;z-index:200;pointer-events:none;';document.body.appendChild(ov);spawnParticles(ov,'evo');for(let w=0;w<3;w++){setTimeout(()=>spawnParticles(ov,'evo'),w*300)}setTimeout(()=>ov.remove(),2000)}

// ‚ïê‚ïê‚ïê STREAM META ‚ïê‚ïê‚ïê
const STREAM_META={
  ehoro:{id:STREAM_EHORO,label:'Ehoro Village Radio',sub:'lo-fi beats to study to',playlist:'ehoro_radio'},
  sakura:{id:STREAM_SAKURA,label:'Sakura Jazz',sub:'lo-fi jazz mix',playlist:'sakura_jazz'},
  lofi:{id:STREAM_LOFI,label:'Lo-Fi Tape V1',sub:'ehoro village classics',playlist:'ehoro_lofi'}
};
function getStreamMeta(){return STREAM_META[S.currentStream]||STREAM_META.ehoro}

// ‚ïê‚ïê‚ïê SWITCH STREAM ‚Äî swap between Sakura Jazz and Lo-Fi Tape V1 ‚ïê‚ïê‚ïê
function switchStream(key){
  if(!STREAM_META[key])return;
  const wasPlaying=S.playing;
  S.currentStream=key;
  // Update pill active state
  document.querySelectorAll('.stream-pill').forEach(p=>p.classList.remove('active'));
  const pill=document.getElementById('pill'+key.charAt(0).toUpperCase()+key.slice(1));
  if(pill)pill.classList.add('active');
  // Update player strip labels
  const meta=getStreamMeta();
  const psTitle=document.getElementById('psTitle');if(psTitle)psTitle.textContent=meta.label;
  const psSub=document.getElementById('psSub');if(psSub)psSub.textContent=meta.sub;
  const vpText=document.getElementById('vpText');if(vpText)vpText.textContent=(key==='ehoro'?'üåô ':key==='sakura'?'üå∏ ':'üìº ')+meta.label;
  // If already playing, tear down iframe and restart with new stream
  if(wasPlaying){
    S.playing=false;document.body.classList.remove('music-playing');S.asheListenTimer=0;
    const embed=document.getElementById('videoEmbed');
    const ifr=embed.querySelector('iframe');if(ifr)ifr.remove();
    embed.classList.remove('loaded');
    // End old session before restarting
    if(S.sessionId&&!S.isGuest){sb.rpc('end_session',{p_session_id:S.sessionId}).catch(e=>console.warn('end_session err:',e));S.sessionId=null}
    startStream();
  }
}

// ‚ïê‚ïê‚ïê STREAM ‚Äî uses S.currentStream ‚ïê‚ïê‚ïê
let _lastHatchData=null;
async function startStream(){if(S.playing)return;S.playing=true;document.body.classList.add('music-playing');S.sessionStartedAt=Date.now();S.eggAnchor=Date.now();const meta=getStreamMeta();const embed=document.getElementById('videoEmbed');const iframe=document.createElement('iframe');iframe.src='https://www.youtube.com/embed/'+meta.id+'?autoplay=1&rel=0&loop=1&playlist='+meta.id;iframe.allow='autoplay; encrypted-media';iframe.allowFullscreen=true;
// YouTube fallback ‚Äî if iframe fails to load
iframe.onerror=function(){showYTFallback()};
// Also set a timeout in case iframe silently fails
const ytTimeout=setTimeout(()=>{if(!embed.classList.contains('loaded')){showYTFallback()}},12000);
iframe.onload=function(){clearTimeout(ytTimeout)};
embed.insertBefore(iframe,embed.firstChild);embed.classList.add('loaded');document.getElementById('psPlay').textContent='\u23F8';
// Update player strip to reflect current stream
const activeMeta=getStreamMeta();
const psTitle=document.getElementById('psTitle');if(psTitle)psTitle.textContent=activeMeta.label;
const psSub=document.getElementById('psSub');if(psSub)psSub.textContent=activeMeta.sub;
if(!S.isGuest){try{const{data}=await sb.rpc('start_session',{p_playlist:activeMeta.playlist});S.sessionId=data}catch(e){console.warn('start_session error:',e)}}startTicker()}
function showYTFallback(){
  const embed=document.getElementById('videoEmbed');
  const existing=embed.querySelector('.yt-fallback');if(existing)return;
  const ifr=embed.querySelector('iframe');if(ifr)ifr.remove();
  embed.classList.remove('loaded');
  const fb=document.createElement('div');fb.className='yt-fallback';
  fb.innerHTML='<div class="yt-fallback-msg">Video couldn\'t load.<br>Check your connection and try again.</div><button class="yt-fallback-btn" onclick="retryStream()">Retry</button>';
  embed.appendChild(fb);
}
function retryStream(){const fb=document.querySelector('.yt-fallback');if(fb)fb.remove();S.playing=false;document.body.classList.remove('music-playing');startStream()}

// ‚ïê‚ïê‚ïê SHARE HATCH ‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê VISIBILITY CHANGE ‚Äî pause/resume timers on background ‚ïê‚ïê‚ïê
document.addEventListener('visibilitychange',()=>{
  if(document.hidden){
    // Tab went to background ‚Äî record the anchor time so we catch up on return
    S._hiddenAt=Date.now();
  }else{
    // Tab came back ‚Äî catch up wall-clock based timers
    if(S.playing&&S.eggAnchor){
      // eggT is re-derived from eggAnchor every tick, so it auto-catches-up already
      // Just force an immediate render
      if(!S.isGuest)renderPillsTab();
      renderVillageTab();
    }
    // Refresh expedition/hatchery display
    if(!S.isGuest&&S.user){
      renderPillsTab();renderVillageTab();
    }
  }
});

// ‚ïê‚ïê‚ïê GAME TICK ‚ïê‚ïê‚ïê
function startTicker(){if(S.ticker)return;if(!S.eggAnchor)S.eggAnchor=Date.now();const eggTime=()=>S.isGuest&&!S.guestEggGiven?S.GUEST_EGG_SEC:(!S.profile?.first_egg_claimed?S.FIRST_EGG_SEC:S.EGG_SEC);S.ticker=setInterval(async()=>{if(!S.playing)return;const now=Date.now();S.eggT=(now-S.eggAnchor)/1000;const total=eggTime();const pct=Math.min((S.eggT/total)*100,100);document.getElementById('eggFill').style.width=pct+'%';const rem=Math.max(0,Math.ceil(total-S.eggT));const mins=Math.floor(rem/60),secs=rem%60;document.getElementById('eggTimer').textContent=mins>0?mins+'m '+secs+'s':secs+'s';
// V1.3 POLISH: Egg progress glow at 90%+
const eggProg=document.getElementById('eggProgress');if(pct>=90){eggProg.classList.add('near-ready')}else{eggProg.classList.remove('near-ready')}
if(S.sessionStartedAt&&S.profile){S.profile._sessionSeconds=Math.floor((now-S.sessionStartedAt)/1000)}const ingChance=(!S.isGuest&&!S.firstIngredientGiven&&S.eggT>30)?0.03:0.002;if(!S.isGuest&&Math.random()<ingChance){const types=['cafe_bean','wild_essence','focus_shard'];const mat=types[Math.floor(Math.random()*3)];S.emblems[mat]++;S.firstIngredientGiven=true;renderPillsTab();showToast('ing_'+mat);checkCraftHint();try{sb.from('emblems').upsert({user_id:S.user.id,emblem_type:mat,quantity:S.emblems[mat]},{onConflict:'user_id,emblem_type'}).then(()=>{}).catch(e=>console.warn('ing persist err',e))}catch(e){}}if(S.eggT>=total){S.eggAnchor=Date.now();S.eggT=0;if(S.isGuest){if(!S.guestEggGiven){S.guestEggGiven=true;showToast('mundane')}}else{try{const streakData2=getStreak();const{data,error}=await sb.rpc('claim_egg_drop',{p_playlist:'cafe',p_streak_bonus:streakData2.bonus||0});if(error)throw error;if(data.error==='too_fast')return;if(data.error==='pending_full'){showToast('full');return}if(!S.profile.first_egg_claimed){S.profile.first_egg_claimed=true;sb.from('profiles').update({first_egg_claimed:true}).eq('id',S.user.id)}S.profile.total_eggs=data.total_eggs;const types=['cafe_bean','wild_essence','focus_shard'];const mat=types[Math.floor(Math.random()*3)];S.emblems[mat]++;
// V2.6: Streak bonus now passed to server ‚Äî no client-side add needed
await loadUserData();updateAllUI();showToast(data.rarity);autoPlaceEggs();try{sb.rpc('log_event',{p_event:'egg_drop',p_data:{rarity:data.rarity}})}catch(e){}}catch(e){console.warn('egg drop error:',e)}}}},1000)}

// ‚ïê‚ïê‚ïê CRAFT HINT ‚Äî pulse Items tab when user first has enough materials ‚ïê‚ïê‚ïê
function checkCraftHint(){if(S.craftHintShown||S.isGuest)return;const r=S.pillRecipes[0];if(!r)return;if(S.emblems.cafe_bean>=r.cost_cafe_bean&&S.emblems.wild_essence>=r.cost_wild_essence&&S.emblems.focus_shard>=r.cost_focus_shard){S.craftHintShown=true;const tab=document.querySelector('[data-tab="pills"]');if(tab){tab.classList.add('hint');setTimeout(()=>tab.classList.remove('hint'),6000)}}}

// ‚ïê‚ïê‚ïê GUEST DEMO LOOP ‚Äî give guests a taste of the gameplay loop ‚ïê‚ïê‚ïê
// _guestDemoTicker hoisted to top
function startGuestDemo(){if(_guestDemoTicker)return;let demoDrops=0;_guestDemoTicker=setInterval(()=>{if(!S.isGuest||!S.playing)return;demoDrops++;const types=['cafe_bean','wild_essence','focus_shard'];const mat=types[Math.floor(Math.random()*3)];S.emblems[mat]++;renderPillsTab();showToast('ing_'+mat);
// After enough drops, hint at crafting
if(demoDrops>=3){const r=S.pillRecipes[0];if(r&&S.emblems.cafe_bean>=r.cost_cafe_bean&&S.emblems.wild_essence>=r.cost_wild_essence&&S.emblems.focus_shard>=r.cost_focus_shard){const tab=document.querySelector('[data-tab="pills"]');if(tab&&!tab.classList.contains('hint')){tab.classList.add('hint');setTimeout(()=>tab.classList.remove('hint'),6000)}}}
},45000)}

// ‚ïê‚ïê‚ïê TOAST ‚Äî simplified, handles all types ‚ïê‚ïê‚ïê
function showToast(type){const t=document.getElementById('toast');const ING_NAMES={cafe_bean:{i:'\u2615',n:'Caf√© Bean'},wild_essence:{i:'\uD83C\uDF3F',n:'Wild Essence'},focus_shard:{i:'\u26A1',n:'Focus Shard'}};const msgs={welcome:{i:'\uD83D\uDC4B',t:'Welcome back'},gift:{i:'\uD83C\uDF81',t:'Welcome Gift!',s:'+15 of each ingredient'},evolution:{i:'\u2728',t:'Evolution!'},craft:{i:'\uD83D\uDC8A',t:'Pill used!'},levelup:{i:'\u2B06',t:'Level up!'},unlock:{i:'\uD83D\uDD13',t:'Slot unlocked!'},ingredient:{i:'\u2728',t:'Ingredient found'},error:{i:'\u274C',t:'Something went wrong'},no_eggs:{i:'\uD83E\uDD5A',t:'No pending eggs'},full:{i:'\uD83D\uDCE6',t:'Hatch some eggs first'},new_user_gift:{i:'\uD83C\uDF81',t:'New user gifts!',s:'Starter spirit + 15√ó each ingredient'},new_spirit:{i:'\uD83C\uDF1F',t:'New spirit joined!'},village_gift:{i:'\uD83C\uDFE0',t:'Village gift!',s:'Welcome back bonus'},expedition_sent:{i:'üß≠',t:'Expedition sent!',s:'Your spirits set off...'},cultivation:{i:'üîÆ',t:'Cultivation advanced!',s:'A breakthrough!'},jar_success:{i:'üè∫',t:'Spirit dissolved...',s:'Wicked Pill created'},dismiss_success:{i:'üí†',t:'Spirit released',s:'Spirit Essence gained'},wicked_used:{i:'ü©∏',t:'Wicked Pill consumed!',s:'The spirit embraces darkness'},heavenly_used:{i:'‚ú¶',t:'Heavenly Pill consumed!',s:'The spirit radiates light'}};
// Named ingredient toasts
if(type.startsWith('ing_')){const key=type.slice(4);const ing=ING_NAMES[key];document.getElementById('toastI').textContent=ing?.i||'\u2728';document.getElementById('toastT').textContent='Found '+(ing?.n||'ingredient')+'!';document.getElementById('toastS').textContent='';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);return}
const rr=RARITY_COLORS[type];if(rr){document.getElementById('toastI').textContent='\uD83E\uDD5A';document.getElementById('toastT').textContent=type.charAt(0).toUpperCase()+type.slice(1)+' Egg';document.getElementById('toastS').textContent=S.isGuest?'Sign up to keep!':''}else{const m=msgs[type]||msgs.welcome;document.getElementById('toastI').textContent=m.i;document.getElementById('toastT').textContent=m.t;document.getElementById('toastS').textContent=m.s||''}t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}

// ‚ïê‚ïê‚ïê V2.6: JOURNAL RELOAD ‚ïê‚ïê‚ïê
async function reloadJournal(){
  if(!S.user||S.isGuest)return;
  const sIds=S.spirits.map(s=>s.id);
  if(!sIds.length)return;
  const{data}=await sb.from('spirit_journal').select('*').in('spirit_id',sIds).order('created_at',{ascending:false}).limit(80);
  S.journal={};
  (data||[]).forEach(e=>{
    if(!S.journal[e.spirit_id])S.journal[e.spirit_id]=[];
    if(S.journal[e.spirit_id].length<10)S.journal[e.spirit_id].push(e);
  });
}

async function addJournalEntry(spiritId,eventType,description){
  if(!S.user||S.isGuest)return;
  try{
    await sb.from('spirit_journal').insert({spirit_id:spiritId,user_id:S.user.id,event_type:eventType,description});
    if(!S.journal[spiritId])S.journal[spiritId]=[];
    S.journal[spiritId].unshift({spirit_id:spiritId,event_type:eventType,description,created_at:new Date().toISOString()});
    if(S.journal[spiritId].length>10)S.journal[spiritId].length=10;
  }catch(e){console.warn('journal write err:',e)}
}

// ‚ïê‚ïê‚ïê V2.6: BUILDING PRODUCTION ‚ïê‚ïê‚ïê
// Called on login + every 4hrs via ticker to check if buildings have produced
async function checkBuildingProduction(){
  if(!S.user||S.isGuest)return;
  try{
    const{data,error}=await sb.rpc('check_building_production');
    if(error)throw error;
    if(data?.produced&&data.produced.length){
      await Promise.all([reloadBuildings().then(()=>syncMaterialsFromInventory()),reloadEmblems()]);
      debouncedUpdateAllUI();
      checkVillageNotif(); // V2.9: update notification dot
      data.produced.forEach(p=>{
        showToastMsg(BUILDING_CONFIGS[p.building]?.emoji||'üèóÔ∏è',BUILDING_CONFIGS[p.building]?.label+' produced!',p.item_name);
      });
    }
  }catch(e){console.warn('building production check err:',e)}
}

// Dojo passive XP: called from cultivation ticker for any spirits assigned as workers
function applyDojoXP(){
  if(!buildingUnlocked('dojo'))return;
  const workers=getWorkersFor('dojo');
  if(!workers.length)return;
  const mgr=getManagerFor('dojo');
  const mgrSp=mgr?S.spirits.find(s=>s.id===mgr.spirit_id):null;
  const multiplier=mgrSp&&spiritHasTraitEffect(mgrSp.id,'dojo_multiplier')?2:1;
  // V2.9: Tier-based XP per tick
  const tier=getBuildingTier('dojo');
  const baseGain=tier>=3?15:tier>=2?10:5; // V2.9: was hardcoded 8
  workers.forEach(w=>{
    const sp=S.spirits.find(s=>s.id===w.spirit_id);
    if(!sp)return;
    const gain=baseGain*multiplier;
    sp.xp=(sp.xp||0)+gain;
    // Persist to DB quietly
    sb.from('spirits').update({xp:sp.xp}).eq('id',sp.id).then(()=>{}).catch(()=>{});
    // V2.9: Spawn XP float on spirit card
    spawnDojoXPFloat(sp.id,gain);
  });
}

// Library: get researched locations
function getResearchedLocations(){
  const libraryData=getBuildingData('library');
  if(!libraryData||!libraryData.research_data)return[];
  try{return JSON.parse(libraryData.research_data)||[];}catch(e){return[];}
}
function locationIsResearched(locId){return getResearchedLocations().includes(locId)}

// ‚ïê‚ïê‚ïê V2.9: BUILDING TIER SYSTEM ‚ïê‚ïê‚ïê
// V3.2: Tier now stored in buildings.tier column ‚Äî read from S.buildings
function getBuildingTier(buildingId){
  const bld=S.buildings.find(b=>b.building_type===buildingId);
  return bld?Math.max(1,parseInt(bld.tier||1)):1;
}
function canUpgradeBuilding(buildingId){
  const cfg=BUILDING_CONFIGS[buildingId];if(!cfg||!cfg.tiers)return false;
  const currentTier=getBuildingTier(buildingId);
  if(currentTier>=3)return false;
  const nextTierDef=cfg.tiers[currentTier]; // index = tier-1, so tiers[1] = tier 2 cost
  if(!nextTierDef||!nextTierDef.upgradeCost)return false;
  return Object.entries(nextTierDef.upgradeCost).every(([mat,qty])=>{
    if(['cafe_bean','wild_essence','focus_shard','ashe_essence','spirit_essence'].includes(mat))
      return (S.emblems[mat]||0)>=qty;
    return hasMaterial(mat,qty);
  });
}
async function upgradeBuilding(buildingId){
  if(S.isGuest||!canUpgradeBuilding(buildingId))return;
  if(isBusy('upgrade_'+buildingId))return;
  setBusy('upgrade_'+buildingId,5000);
  const cfg=BUILDING_CONFIGS[buildingId];
  const currentTier=getBuildingTier(buildingId);
  const nextTierDef=cfg.tiers[currentTier];
  if(!nextTierDef||!nextTierDef.upgradeCost)return;
  // Deduct costs client-side (optimistic) then call RPC to persist tier
  Object.entries(nextTierDef.upgradeCost).forEach(([mat,qty])=>{
    if(['cafe_bean','wild_essence','focus_shard','ashe_essence','spirit_essence'].includes(mat)){
      S.emblems[mat]=Math.max(0,(S.emblems[mat]||0)-qty);
      sb.from('emblems').upsert({user_id:S.user.id,emblem_type:mat,quantity:S.emblems[mat]},{onConflict:'user_id,emblem_type'}).catch(e=>console.warn('tier upgrade emblem err:',e));
    }else{
      deductMaterial(mat,qty);
    }
  });
  try{
    const{data,error}=await sb.rpc('upgrade_building',{p_building_type:buildingId});
    if(error)throw error;
    if(data?.error){console.warn('upgrade building rpc error:',data.error);showToast('error');return}
    await reloadBuildings();syncMaterialsFromInventory();
    const newTier=getBuildingTier(buildingId);
    closeBuildingModal();
    showToastMsg(cfg.emoji,'Upgraded!',cfg.label+' is now Tier '+newTier);
    debouncedUpdateAllUI();
    openBuildingModal(buildingId);
  }catch(e){console.warn('upgrade building error:',e);showToast('error')}
}

// ‚ïê‚ïê‚ïê V3.2: LIBRARY RESEARCH STATE ‚Äî stored in buildings.research_data (DB, cross-device) ‚ïê‚ïê‚ïê
function getLibraryResearch(){
  const bld=S.buildings.find(b=>b.building_type==='library');
  if(!bld)return{};
  try{return JSON.parse(bld.research_data||'{}')}catch(e){return{}}
}
async function setLibraryResearch(data){
  const bld=S.buildings.find(b=>b.building_type==='library');
  if(!bld||!S.user)return;
  const json=JSON.stringify(data);
  // Update in-memory immediately
  bld.research_data=json;
  // Persist to DB
  try{
    await sb.from('buildings').update({research_data:json}).eq('id',bld.id).eq('user_id',S.user.id);
  }catch(e){console.warn('library research save err:',e)}
}
function getResearchDurationMin(buildingId){
  const tier=getBuildingTier(buildingId||'library');
  let base=tier>=3?30:tier>=2?45:60;
  // Archivist trait: -25% research time if library manager has it
  const mgr=getManagerFor('library');
  if(mgr&&spiritHasTraitEffect(mgr.spirit_id,'research_speed'))base=Math.max(10,Math.round(base*0.75));
  return base;
}
function startResearch(locId){
  if(S.isGuest)return;
  if(!buildingUnlocked('library'))return;
  const mgr=getManagerFor('library');if(!mgr)return; // need staff to research
  const data=getLibraryResearch();
  // Only one active at a time
  const alreadyActive=Object.values(data).some(v=>v.status==='researching');
  if(alreadyActive){showToastMsg('üìö','Already researching','Finish current research first');return}
  if(data[locId]?.status==='done')return;
  const totalMin=getTotalListenMinutes();
  data[locId]={status:'researching',startedListenMin:totalMin,durationMin:getResearchDurationMin('library')};
  setLibraryResearch(data); // async, no await needed here ‚Äî in-memory update is instant
  // Immediately refresh the modal view
  openBuildingModal('library');
  showToastMsg('üìö','Research started!','Listen to progress the research');
}
function checkResearchProgress(){
  if(S.isGuest)return;
  const data=getLibraryResearch();
  let changed=false;
  const totalMin=getTotalListenMinutes();
  Object.entries(data).forEach(([locId,r])=>{
    if(r.status==='researching'){
      const elapsed=totalMin-(r.startedListenMin||0);
      if(elapsed>=(r.durationMin||60)){
        data[locId]={status:'done'};
        changed=true;
        showToastMsg('üìö','Research complete!',EXPED_LOCATIONS[locId]?.label+' loot table revealed');
      }
    }
  });
  if(changed){setLibraryResearch(data);debouncedUpdateAllUI();}
}
function locationIsLibraryResearched(locId){
  const data=getLibraryResearch();
  return data[locId]?.status==='done';
}

// ‚ïê‚ïê‚ïê V2.9: NOTIFICATION DOT ‚ïê‚ïê‚ïê
function checkVillageNotif(){
  // Show dot when a building has produced something since last visit
  // We detect this by comparing last_produced_at to a stored "last seen" timestamp
  if(S.isGuest)return;
  const lastSeen=parseInt(localStorage.getItem('village_last_seen_'+(S.user?.id||'')))||0;
  const hasNew=S.buildings.some(b=>{
    if(!b.last_produced_at)return false;
    return new Date(b.last_produced_at).getTime()>lastSeen;
  });
  const btn=document.getElementById('tabBtnVillage');
  if(btn)btn.classList.toggle('has-notif',hasNew);
}
function markVillageSeen(){
  if(S.user)localStorage.setItem('village_last_seen_'+(S.user.id),String(Date.now()));
  const btn=document.getElementById('tabBtnVillage');
  if(btn)btn.classList.remove('has-notif');
}

// ‚ïê‚ïê‚ïê V2.9: HATCH-READY PULSE ‚ïê‚ïê‚ïê
function checkHatchReady(){
  const ready=S.hatchery.some(slot=>{
    if(!slot.egg_id||!slot.started_at)return false;
    const egg=(S.allEggs||S.pendingEggs).find(e=>e.id===slot.egg_id)||{rarity:'mundane'};
    const baseDur=(slot.hatch_duration_minutes||5)*60*1000;
    return Date.now()-new Date(slot.started_at).getTime()>=baseDur;
  });
  const btn=document.getElementById('tabBtnPills');
  if(btn)btn.classList.toggle('hatch-ready',ready);
}

// ‚ïê‚ïê‚ïê V2.9: DOJO XP FLOAT ‚ïê‚ïê‚ïê
function spawnDojoXPFloat(spiritId,xp){
  const card=document.querySelector('.spirit-card[data-sid="'+spiritId+'"]');
  if(!card)return;
  const float=document.createElement('div');
  float.className='xp-float';
  float.textContent='+'+xp+' XP';
  // Position relative to card
  card.style.position='relative';
  float.style.left=(Math.random()*40+20)+'%';
  float.style.top='20%';
  card.appendChild(float);
  float.addEventListener('animationend',()=>float.remove());
}

// Material deduction helper (for tier upgrades using physical materials)
function deductMaterial(matId,qty){
  if(!S.materials[matId])return;
  const items=S.buildingInventory.filter(i=>i.item_type==='material'&&i.item_id===matId).slice(0,qty);
  items.forEach(item=>{
    sb.from('building_inventory').delete().eq('id',item.id).catch(e=>console.warn('deduct mat err:',e));
    const idx=S.buildingInventory.indexOf(item);
    if(idx>=0)S.buildingInventory.splice(idx,1);
  });
  S.materials[matId]=Math.max(0,(S.materials[matId]||0)-qty);
}

// ‚ïê‚ïê‚ïê V2.6: CULTIVATION REWORK ‚Äî listen time gate ‚ïê‚ïê‚ïê
// Total listen time in minutes tracked via profile.total_listen_minutes
// Cultivation stage requirements (in listen minutes)
const CULT_LISTEN_REQ=[0,30,90,180,0,0]; // minutes per stage (stages 4-5 gate removed ‚Äî √Ä·π£·∫π cost is gate enough)
function getCultListenReq(stage){return CULT_LISTEN_REQ[stage]||0}
function getTotalListenMinutes(){return Math.floor((S.profile?.total_listen_minutes||0))}
function meetsListenReq(stage){return getTotalListenMinutes()>=getCultListenReq(stage)}

// ‚ïê‚ïê‚ïê V2.5: BUILDING UNLOCK MODAL ‚ïê‚ïê‚ïê
function openUnlockBuildingModal(buildingType){
  if(S.isGuest)return;
  const cfg=BUILDING_CONFIGS[buildingType];if(!cfg)return;
  if(!canUnlockBuilding(buildingType))return;
  const box=document.getElementById('modalBox');
  let h='<div class="modal-title">'+cfg.emoji+' Unlock '+cfg.label+'</div>';
  h+='<div class="modal-desc"><i>'+cfg.desc+'</i></div>';
  h+='<div class="modal-desc" style="margin-top:8px"><b>This will consume:</b></div>';
  h+='<div class="building-unlock-cost" style="margin:8px 0">';
  Object.entries(cfg.unlockMaterials).forEach(([mat,qty])=>{
    const EMBL={cafe_bean:['‚òï','Caf√© Bean'],wild_essence:['üåø','Wild Essence'],focus_shard:['‚ö°','Focus Shard'],ashe_essence:['üîÆ','√Ä·π£·∫π Essence'],spirit_essence:['üí†','Spirit Essence']};
    const info=EMBL[mat]||(MATERIAL_INFO[mat]?[MATERIAL_INFO[mat].emoji,MATERIAL_INFO[mat].label]:['üì¶',mat]);
    h+='<div class="building-unlock-mat has">'+info[0]+' '+qty+'√ó '+info[1]+'</div>';
  });
  h+='</div>';
  h+='<div style="font-size:.55rem;color:var(--t2);line-height:1.6;margin:8px 0">';
  h+='‚ú¶ '+cfg.passiveBuff.desc+'<br>';
  h+='‚ú¶ '+cfg.staffedBuff.desc+' when staffed';
  h+='</div>';
  h+='<button class="modal-btn" onclick="executeUnlockBuilding(&apos;'+buildingType+'&apos;)">Unlock '+cfg.label+'</button>';
  h+='<button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';
  box.innerHTML=h;document.getElementById('modal').classList.add('open');
}

async function executeUnlockBuilding(buildingType){
  if(isBusy('unlock_bld'))return;setBusy('unlock_bld',4000);closeModal();
  const cfg=BUILDING_CONFIGS[buildingType];
  try{
    const{data,error}=await sb.rpc('unlock_building',{p_building_type:buildingType});
    if(error)throw error;
    if(data?.error){console.warn('unlock building rpc error:',data.error);showToast('error');return}
    await Promise.all([reloadBuildings().then(()=>syncMaterialsFromInventory()),reloadEmblems()]);
    debouncedUpdateAllUI();
    showToastMsg(cfg.emoji,cfg.label+' unlocked!','Your village grows.');
  }catch(e){console.warn('unlock building error:',e);showToast('error')}
}

// ‚ïê‚ïê‚ïê V2.5: STAFF ASSIGN MODAL ‚ïê‚ïê‚ïê
function openAssignStaffModal(buildingType,role,currentStaffId=null){
  if(S.isGuest)return;
  const cfg=BUILDING_CONFIGS[buildingType];if(!cfg)return;
  const roleLabel=role==='manager'?cfg.roles.manager.label:cfg.roles.worker.label;
  const box=document.getElementById('modalBox');
  // Available spirits: not on expedition, not already assigned to another building
  const avail=S.spirits.filter(sp=>{
    if(spiritUnavailable(sp.id))return false;
    const assignment=spiritAssignedTo(sp.id);
    if(!assignment)return true;
    // Allow reassigning within the same building
    if(assignment.building_type===buildingType)return false;
    return false; // Spirits can only work one building at a time
  });
  let h='<div class="modal-title">Assign '+roleLabel+'</div>';
  h+='<div class="staff-modal-role">'+cfg.emoji+' '+cfg.label+' ¬∑ '+roleLabel+'</div>';
  // Current staff ‚Äî show unassign option
  if(currentStaffId){
    const cur=S.buildingStaff.find(s=>s.id===currentStaffId);
    const curSp=cur?S.spirits.find(s=>s.id===cur.spirit_id):null;
    if(curSp){
      h+='<div class="staff-modal-current"><img src="'+spiritImg(curSp.spirit_type,curSp.evo_stage)+'"><span style="font-size:.65rem;font-weight:500">'+curSp.name+' currently assigned</span><span class="staff-modal-unassign" onclick="unassignStaff(&apos;'+currentStaffId+'&apos;)">Remove</span></div>';
    }
  }
  if(avail.length){
    h+='<div class="modal-select-grid">';
    avail.forEach(sp=>{
      const lvl=Math.floor((sp.xp||0)/S.XP_PER_LEVEL)+1;
      let extra='';
      if(buildingType==='cafe'&&role==='manager'){const cl=getCraftLevel(sp.id);const drink=getCafeDrinkForLevel(cl);extra=' ‚Üí '+drink.name;}
      h+='<div class="modal-select-row" onclick="assignStaff(&apos;'+buildingType+'&apos;,&apos;'+role+'&apos;,&apos;'+sp.id+'&apos;)">';
      h+='<img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'" style="width:28px;height:28px;border-radius:50%">';
      h+='<div style="flex:1"><div style="font-size:.65rem;font-weight:500">'+sp.name+'</div>';
      h+='<div style="font-size:.45rem;color:var(--t3)">Lv.'+lvl+extra+'</div></div>';
      h+='</div>';
    });
    h+='</div>';
  }else{
    h+='<div style="font-size:.55rem;color:var(--t3);text-align:center;padding:12px 0">All available spirits are busy.<br>Return spirits from expeditions first.</div>';
  }
  h+='<button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';
  box.innerHTML=h;document.getElementById('modal').classList.add('open');
}

async function assignStaff(buildingType,role,spiritId){
  if(isBusy('assign_staff'))return;setBusy('assign_staff',3000);closeModal();
  try{
    const{data,error}=await sb.rpc('assign_building_staff',{p_building_type:buildingType,p_spirit_id:spiritId,p_role:role});
    if(error)throw error;
    if(data?.error){console.warn('assign staff rpc error:',data.error);showToast('error');return}
    await reloadBuildings();
    debouncedUpdateAllUI();
    const sp=S.spirits.find(s=>s.id===spiritId);
    const cfg=BUILDING_CONFIGS[buildingType];
    showToastMsg(cfg.emoji,sp?.name+' assigned!','Reporting for duty.');
  }catch(e){console.warn('assign staff error:',e);showToast('error')}
}

async function unassignStaff(staffId){
  if(isBusy('unassign_staff'))return;setBusy('unassign_staff',2000);closeModal();
  try{
    const{data,error}=await sb.rpc('unassign_building_staff',{p_staff_id:staffId});
    if(error)throw error;
    await reloadBuildings();
    debouncedUpdateAllUI();
    showToastMsg('üëã','Spirit unassigned','They\'re free again.');
  }catch(e){console.warn('unassign staff error:',e);showToast('error')}
}

// ‚ïê‚ïê‚ïê V2.5: TOAST HELPER (named args) ‚ïê‚ïê‚ïê
function showToastMsg(icon,title,sub=''){
  const t=document.getElementById('toast');
  document.getElementById('toastI').textContent=icon;
  document.getElementById('toastT').textContent=title;
  document.getElementById('toastS').textContent=sub;
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3500);
}

// ‚ïê‚ïê‚ïê PAGE CLOSE ‚Äî persist session + listen time ‚ïê‚ïê‚ïê
window.addEventListener('beforeunload',()=>{if(S.user&&!S.isGuest){
const token=sb.auth?.session?.()?.access_token||sb.realtime?.accessToken||'';
const headers={'Content-Type':'application/json','apikey':SUPABASE_ANON_KEY,'Authorization':'Bearer '+token};
if(S.sessionId){try{fetch(SUPABASE_URL+'/rest/v1/rpc/end_session',{method:'POST',headers,body:JSON.stringify({p_session_id:S.sessionId}),keepalive:true})}catch(e){}}
if(S.sessionStartedAt&&S.profile){const sec=Math.floor((Date.now()-S.sessionStartedAt)/1000);const newTotal=(S.profile.total_listen_seconds||0)+sec;try{fetch(SUPABASE_URL+'/rest/v1/profiles?id=eq.'+S.user.id,{method:'PATCH',headers,body:JSON.stringify({total_listen_seconds:newTotal}),keepalive:true})}catch(e){}}}});
// Periodic listen time save every 5 minutes (V2.0: increased from 2min)
setInterval(()=>{if(S.playing&&!S.isGuest&&S.sessionStartedAt&&S.user&&S.profile){const sec=Math.floor((Date.now()-S.sessionStartedAt)/1000);const newSec=(S.profile.total_listen_seconds||0)+sec;const newMin=Math.floor(newSec/60);sb.from('profiles').update({total_listen_seconds:newSec,total_listen_minutes:newMin}).eq('id',S.user.id).then(()=>{S.profile.total_listen_seconds=newSec;S.profile.total_listen_minutes=newMin}).catch(e=>console.warn('listen save error:',e))}},300000);

// ‚ïê‚ïê‚ïê SAFETY CHECK ‚Äî auto-place eggs if slots available ‚ïê‚ïê‚ïê
async function autoPlaceEggs(){if(S.isGuest)return;const pend=S.pendingEggs.filter(e=>e.status==='pending');const empty=S.hatchery.filter(s=>s.unlocked&&!s.egg_id);if(pend.length&&empty.length){for(let i=0;i<Math.min(pend.length,empty.length);i++){try{await sb.rpc('place_egg_in_slot',{p_egg_id:pend[i].id,p_slot_id:empty[i].id})}catch(e){}}await loadUserData();updateAllUI()}}

// ‚ïê‚ïê‚ïê OFFLINE EGG HATCH CHECK ‚ïê‚ïê‚ïê
async function checkOfflineHatches(){if(S.isGuest)return;
  const ready=S.hatchery.filter(s=>{if(!s.egg_id||!s.started_at)return false;const dur=(s.hatch_duration_minutes||INCUB_MINS['mundane'])*60*1000;return Date.now()-new Date(s.started_at).getTime()>=dur});
  for(const slot of ready){try{await sb.rpc('hatch_egg',{p_slot_id:slot.id})}catch(e){}}
  if(ready.length){await loadUserData();updateAllUI()}}

// ‚ïê‚ïê‚ïê SPIRIT JIGGLE ‚Äî subtle random wiggle every 15-20s ‚ïê‚ïê‚ïê
function startSpiritJiggle(){if(S.jiggleTicker)return;S.jiggleTicker=setInterval(()=>{const cards=document.querySelectorAll('.spirit-card-img');if(!cards.length)return;const pick=cards[Math.floor(Math.random()*cards.length)];pick.classList.add('spirit-jiggle');setTimeout(()=>pick.classList.remove('spirit-jiggle'),500)},15000+Math.random()*5000)}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
let _appEntered=false;
let _wasLoggedIn=false; // Track if user was actually logged in (prevents spurious SIGNED_OUT)
// Listen for auth state changes (OAuth redirect, cross-tab, token refresh)
sb.auth.onAuthStateChange(async(event,session)=>{
  if((event==='SIGNED_IN'||event==='TOKEN_REFRESHED')&&session?.user){
    _wasLoggedIn=true;
    // Recover from guest/stuck state
    if(!_appEntered||S.isGuest){
      S.user=session.user;S.isGuest=false;
      document.getElementById('guestBanner').classList.remove('show');
      await loadUserData();updateTopBar();
      if(!_appEntered){_appEntered=true;enterApp()}
      else{updateAllUI()}
    }
  }
  // Only handle SIGNED_OUT if user was actually logged in (ignore spurious events)
  if(event==='SIGNED_OUT'&&_wasLoggedIn){
    _wasLoggedIn=false;_appEntered=false;
    S.user=null;S.isGuest=true;
    S.playing=false;S.spirits=[];S.hatchery=[];S.pendingEggs=[];S.allEggs=[];S.expeditions=[];
    S.emblems={cafe_bean:0,wild_essence:0,focus_shard:0,ashe_essence:0,spirit_essence:0};S.profile=null;
    S.sessionStartedAt=null;S.eggAnchor=null;S.profStep=0;S.chosenStarter=null;
    [S.ticker,S.hatchTicker,S.cultTicker,S.jiggleTicker,S.expedTicker,_guestDemoTicker].forEach(t=>{if(t)clearInterval(t)});
    S.ticker=S.hatchTicker=S.cultTicker=S.jiggleTicker=S.expedTicker=null;_guestDemoTicker=null;
    document.getElementById('guestBanner').classList.remove('show');
    document.getElementById('login').classList.remove('gone');
  }
});
// Initial session check ‚Äî show guest mode quickly if session check is slow
let _sessionResolved=false;
const _guestTimeout=setTimeout(()=>{
  if(!_sessionResolved&&!S.user){enterGuest()}
},1500); // Show guest mode after 1.5s max if session hasn't loaded
checkSession().then(ok=>{
  _sessionResolved=true;clearTimeout(_guestTimeout);
  if(ok){_appEntered=true;_wasLoggedIn=true}
  else if(!S.user&&!_appEntered){enterGuest()}
});

</script>

</body>
</html>
