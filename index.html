<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Ehoro Village</title>
<link rel="icon" type="image/png" href="sprites/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,300&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
[data-theme="dark"]{--bg:#080808;--surface:#0f0f0f;--elevated:#171717;--raised:#1e1e1e;--border:#1c1c1c;--border-l:#282828;--t1:#f0f0f0;--t2:#8a8a8a;--t3:#5a5a5a;--t4:#3a3a3a;--accent-dim:rgba(255,255,255,.04);--accent-soft:rgba(255,255,255,.08);--logo-color:#f0f0f0;--toast-bg:#171717;--positive:#6b9;--negative:#c77;--special:#c8f}
[data-theme="light"]{--bg:#f5f3ef;--surface:#ebe8e2;--elevated:#e0ddd6;--raised:#d6d3cc;--border:#d0cdc6;--border-l:#c5c2bb;--t1:#1a1816;--t2:#6b6660;--t3:#9a958e;--t4:#b8b3ac;--accent-dim:rgba(0,0,0,.03);--accent-soft:rgba(0,0,0,.06);--logo-color:#1a1816;--toast-bg:#e0ddd6;--positive:#3a7;--negative:#b55;--special:#a6c}
*{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;overflow:hidden;overflow-x:hidden;max-width:100vw}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--t1);-webkit-font-smoothing:antialiased;transition:background .4s,color .4s;overflow-x:hidden}
.onboard{position:fixed;inset:0;z-index:200;background:var(--bg);display:flex;align-items:center;justify-content:center;transition:opacity .4s}.onboard.gone{opacity:0;pointer-events:none}
.ob-inner{width:100%;max-width:380px;padding:0 28px;text-align:center}
.ob-icon{width:80px;height:80px;margin:0 auto 16px;border-radius:50%;overflow:hidden}.ob-icon img{width:100%;height:100%;object-fit:cover}
.ob-title{font-family:'Fraunces',serif;font-size:1.6rem;font-weight:500;margin-bottom:8px}.ob-desc{font-size:.85rem;color:var(--t2);line-height:1.5;margin-bottom:28px}
.ob-dots{display:flex;gap:6px;justify-content:center;margin-bottom:24px}.ob-dot{width:8px;height:8px;border-radius:50%;background:var(--t4);transition:all .2s}.ob-dot.on{background:var(--t1);width:20px;border-radius:4px}
.ob-btn{padding:13px 32px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer}
.ob-skip{display:block;margin:12px auto 0;background:none;border:none;color:var(--t4);font-family:inherit;font-size:.7rem;cursor:pointer}
.guest-banner{position:fixed;bottom:0;left:0;right:0;z-index:60;background:var(--surface);border-top:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;justify-content:center;gap:16px;transform:translateY(100%);transition:transform .4s}.guest-banner.show{transform:translateY(0)}
.guest-banner-text{font-size:.8rem;color:var(--t2)}.guest-banner-text b{color:var(--t1)}.guest-banner-btn{padding:8px 20px;background:var(--t1);color:var(--bg);border:none;border-radius:6px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer}
.login{position:fixed;inset:0;z-index:100;background:var(--bg);display:flex;align-items:center;justify-content:center;transition:opacity .5s,transform .5s}.login.gone{opacity:0;pointer-events:none;transform:scale(1.02)}
.login-inner{width:100%;max-width:360px;padding:0 28px}.login-brand{text-align:center;margin-bottom:48px}
.login-brand h1{font-family:'Fraunces',serif;font-size:2rem;font-weight:300;font-style:italic;color:var(--logo-color);letter-spacing:-.02em;margin-bottom:4px}
.login-brand .sub{font-size:.6rem;color:var(--t3);letter-spacing:.25em;text-transform:uppercase;font-weight:300}
.login-field{margin-bottom:16px}.login-field label{display:block;font-size:.65rem;color:var(--t3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:7px;font-weight:500}
.login-field input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--t1);font-family:inherit;font-size:.85rem;outline:none;transition:border-color .2s;max-width:100%}.login-field input:focus{border-color:var(--t3)}
.l-btn{width:100%;padding:13px;margin-top:8px;background:var(--t1);color:var(--bg);border:none;border-radius:8px;font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer}.l-btn:disabled{opacity:.35;cursor:wait}
.l-div{display:flex;align-items:center;gap:14px;margin:22px 0;color:var(--t4);font-size:.6rem;text-transform:uppercase;letter-spacing:.15em}.l-div::before,.l-div::after{content:'';flex:1;height:1px;background:var(--border)}
.l-secondary{width:100%;padding:12px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--t2);font-family:inherit;font-size:.85rem;cursor:pointer;transition:all .15s}.l-secondary:hover{border-color:var(--t3);color:var(--t1)}
.l-toggle{display:block;text-align:center;margin-top:20px;background:none;border:none;color:var(--t3);font-family:inherit;font-size:.75rem;cursor:pointer;text-decoration:underline;text-underline-offset:3px}
.l-error{color:#e55;font-size:.75rem;text-align:center;margin-top:12px;min-height:18px}.l-error.ok{color:#5b5}
.shell{height:100vh;height:100dvh;display:flex;flex-direction:column;opacity:0;transition:opacity .4s .2s;max-width:100vw;overflow-x:hidden}.shell.on{opacity:1}
.topbar{height:46px;min-height:46px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:10;flex-shrink:0}
.tb-brand{font-family:'Fraunces',serif;font-size:1rem;font-weight:300;font-style:italic;color:var(--logo-color)}.tb-right{display:flex;align-items:center;gap:8px}
.tb-egg-badge{display:flex;align-items:center;gap:5px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;padding:5px 12px}
.tb-egg-badge-icon{font-size:.8rem}.tb-egg-badge-num{font-family:'JetBrains Mono',monospace;font-size:.75rem;font-weight:500}.tb-egg-badge-label{font-size:.6rem;color:var(--t3)}
.tb-gear{background:none;border:none;color:var(--t3);cursor:pointer;font-size:.95rem;padding:4px;transition:color .15s;line-height:1}.tb-gear:hover{color:var(--t1)}.tb-user{font-size:.7rem;color:var(--t3)}
.settings-drop{position:fixed;top:46px;right:12px;z-index:40;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:8px;min-width:180px;box-shadow:0 8px 24px rgba(0,0,0,.4);opacity:0;transform:translateY(-6px);pointer-events:none;transition:all .2s}.settings-drop.open{opacity:1;transform:translateY(0);pointer-events:all}
.sd-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:6px;cursor:pointer;font-size:.75rem;color:var(--t2);transition:background .1s}.sd-item:hover{background:var(--accent-dim)}.sd-item-label{display:flex;align-items:center;gap:8px}
.sd-toggle{width:34px;height:18px;border-radius:9px;background:var(--border);position:relative;transition:background .2s;cursor:pointer}.sd-toggle.on{background:var(--t2)}.sd-toggle::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:var(--t1);transition:transform .2s}.sd-toggle.on::after{transform:translateX(16px)}.sd-divider{height:1px;background:var(--border);margin:4px 0}
.content{flex:1;display:flex;overflow:hidden;min-height:0;max-width:100vw}
.video-area{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden}
.video-embed{flex:1;background:#000;position:relative;min-height:0;overflow:hidden}.video-embed iframe{position:absolute;inset:0;width:100%;height:100%;border:none}
.video-placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;background:var(--bg);cursor:pointer;transition:background .3s}.video-placeholder:hover{background:var(--surface)}
.vp-play{width:64px;height:64px;border-radius:50%;border:1.5px solid var(--t4);display:flex;align-items:center;justify-content:center;font-size:1.3rem;color:var(--t3);transition:all .3s}.video-placeholder:hover .vp-play{border-color:var(--t2);color:var(--t1);transform:scale(1.05)}.vp-text{font-size:.7rem;color:var(--t4);letter-spacing:.15em;text-transform:uppercase}.video-embed.loaded .video-placeholder{display:none}
.player-strip{height:50px;min-height:50px;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 18px;gap:12px;flex-shrink:0}
.ps-play{width:32px;height:32px;background:var(--t1);color:var(--bg);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.7rem;cursor:pointer;flex-shrink:0}
.ps-info{flex:1;min-width:0}.ps-title{font-size:.8rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.ps-sub{font-size:.6rem;color:var(--t3);margin-top:1px}
.ps-pills{display:flex;gap:5px}.ps-pill{padding:5px 14px;border-radius:16px;border:1px solid var(--border);background:transparent;color:var(--t3);font-family:inherit;font-size:.7rem;cursor:pointer;transition:all .15s}.ps-pill:hover{border-color:var(--t3);color:var(--t2)}.ps-pill.on{border-color:var(--t2);color:var(--t1);background:var(--accent-soft)}
.mobile-pl-bar{display:none;height:36px;min-height:36px;background:var(--surface);border-top:1px solid var(--border);align-items:center;justify-content:center;gap:6px;padding:0 16px}
.mobile-pl-btn{flex:1;padding:6px 0;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--t3);font-family:inherit;font-size:.7rem;cursor:pointer;text-align:center}.mobile-pl-btn.on{border-color:var(--t2);color:var(--t1);background:var(--accent-soft)}
.sidebar{width:320px;min-width:320px;background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.egg-mini{padding:10px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.egg-mini-label{font-size:.6rem;color:var(--t4);flex-shrink:0}.egg-mini-bar{flex:1;height:2px;background:var(--border);border-radius:2px;overflow:hidden}.egg-mini-fill{height:100%;background:var(--t1);border-radius:2px;transition:width .5s linear;width:0%}.egg-mini-time{font-family:'JetBrains Mono',monospace;font-size:.55rem;color:var(--t4);min-width:40px;text-align:right}
.tab-nav{display:flex;border-bottom:1px solid var(--border);padding:0 12px}.tab-btn{flex:1;padding:10px 0;background:none;border:none;border-bottom:2px solid transparent;color:var(--t3);font-family:inherit;font-size:.65rem;font-weight:500;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;transition:all .15s;text-align:center}.tab-btn:hover{color:var(--t2)}.tab-btn.on{color:var(--t1);border-bottom-color:var(--t1)}
.tab-panels{flex:1;overflow:hidden;position:relative}.tab-panel{position:absolute;inset:0;overflow-y:auto;padding:14px;opacity:0;pointer-events:none;transition:opacity .2s}.tab-panel.on{opacity:1;pointer-events:all}.tab-panel::-webkit-scrollbar{width:3px}.tab-panel::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.spirits-grid{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:14px}
.spirit-circle{width:90px;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;padding:10px 4px;border-radius:12px;transition:background .15s}.spirit-circle:hover{background:var(--accent-dim)}
.spirit-circle-ring{width:64px;height:64px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;transition:border-color .2s}.spirit-circle-ring img{width:100%;height:100%;object-fit:cover}.spirit-circle:hover .spirit-circle-ring{border-color:var(--t3)}
.spirit-circle-name{font-size:.7rem;font-weight:500;text-align:center}.spirit-circle-meta{font-size:.55rem;color:var(--t4);text-align:center}
.spirit-evo-dots{display:flex;gap:3px;justify-content:center}.spirit-evo-dot{width:4px;height:4px;border-radius:50%;background:var(--t4)}.spirit-evo-dot.on{background:var(--t1)}
.spirit-detail{background:var(--elevated);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:10px;display:none}.spirit-detail.open{display:block;animation:fadeIn .2s ease-out}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:none}}
.sd-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}.sd-portrait{width:56px;height:56px;border-radius:12px;overflow:hidden;border:1px solid var(--border);flex-shrink:0}.sd-portrait img{width:100%;height:100%;object-fit:cover}
.sd-info{flex:1}.sd-name{font-size:.95rem;font-weight:600}.sd-stage{font-size:.65rem;color:var(--t3)}.sd-bio{font-size:.6rem;color:var(--t3);margin-top:3px;font-style:italic;line-height:1.3}
.sd-close{background:none;border:none;color:var(--t4);cursor:pointer;font-size:.85rem;padding:4px;align-self:flex-start}
.sd-section{font-size:.55rem;color:var(--t4);text-transform:uppercase;letter-spacing:.1em;margin:10px 0 6px;font-weight:500}
.sd-bar-wrap{display:flex;align-items:center;gap:8px}.sd-bar{flex:1;height:3px;background:var(--border);border-radius:3px;overflow:hidden}.sd-bar-fill{height:100%;background:var(--t2);border-radius:3px;transition:width .3s}.sd-lvl{font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--t4)}
.trait-tags{display:flex;flex-wrap:wrap;gap:4px}.trait-tag{padding:3px 10px;border-radius:10px;font-size:.6rem;font-weight:500;background:var(--accent-dim);color:var(--t2);border:1px solid var(--border)}.trait-tag.positive{color:var(--positive);border-color:rgba(102,187,153,.15)}.trait-tag.negative{color:var(--negative);border-color:rgba(204,119,119,.15)}
.sd-evolve-btn{width:100%;margin-top:12px;padding:10px;border-radius:8px;border:none;background:var(--t1);color:var(--bg);font-family:inherit;font-size:.75rem;font-weight:600;cursor:pointer}.sd-evolve-btn:disabled{opacity:.2;cursor:not-allowed}.sd-evolve-cost{font-size:.65rem;color:var(--t3);text-align:center;margin-top:6px}
.section-label{font-size:.55rem;color:var(--t4);text-transform:uppercase;letter-spacing:.12em;margin-bottom:8px;font-weight:500}
.hatchery-grid{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.hatch-slot{flex:1;min-width:55px;background:var(--elevated);border:1px solid var(--border);border-radius:10px;padding:10px 6px;text-align:center;cursor:pointer;transition:all .2s;min-height:74px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px}.hatch-slot:hover{border-color:var(--border-l)}.hatch-slot.locked{opacity:.35;cursor:default}.hatch-slot.ready{border-color:var(--positive);animation:readyPulse 2s infinite}
@keyframes readyPulse{0%,100%{box-shadow:0 0 0 0 rgba(102,187,153,0)}50%{box-shadow:0 0 12px rgba(102,187,153,.15)}}
.hatch-slot-icon{font-size:1.1rem}.hatch-slot-label{font-size:.5rem;color:var(--t4)}.hatch-slot-timer{font-family:'JetBrains Mono',monospace;font-size:.5rem;color:var(--t3)}.hatch-slot-rarity{font-size:.5rem;font-weight:500}
.hatch-slot-bar{width:80%;height:2px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:2px}.hatch-slot-bar-fill{height:100%;background:var(--t2);border-radius:2px;transition:width 1s linear}
.pending-label{font-size:.55rem;color:var(--t4);margin:4px 0}.pending-list{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:14px}
.pending-egg{padding:4px 10px;border-radius:8px;font-size:.6rem;background:var(--elevated);border:1px solid var(--border);cursor:pointer}.pending-egg:hover{border-color:var(--t3)}
.ing-grid{display:flex;flex-direction:column;gap:6px;margin-bottom:14px}.ing-row{display:flex;align-items:center;gap:10px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;padding:9px 12px}
.ing-icon{font-size:.9rem;flex-shrink:0}.ing-name{font-size:.7rem;color:var(--t2);flex:1}.ing-count{font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:500}
.convert-row{display:flex;gap:6px;margin-bottom:14px}.convert-btn{flex:1;padding:8px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;color:var(--t3);font-family:inherit;font-size:.6rem;cursor:pointer;text-align:center}.convert-btn:hover{border-color:var(--border-l);color:var(--t2)}
.village-rank-card{background:var(--elevated);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center;margin-bottom:14px}
.village-rank-label{font-size:.55rem;color:var(--t4);text-transform:uppercase;letter-spacing:.12em;margin-bottom:6px}.village-rank-name{font-family:'Fraunces',serif;font-size:1.3rem;font-weight:500;margin-bottom:3px}.village-rank-desc{font-size:.65rem;color:var(--t3)}
.village-stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:14px}.village-stat{background:var(--elevated);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center}
.village-stat-num{font-family:'JetBrains Mono',monospace;font-size:.9rem;font-weight:500;margin-bottom:1px}.village-stat-label{font-size:.55rem;color:var(--t4);text-transform:uppercase;letter-spacing:.05em}
.feed-section{border-top:1px solid var(--border);display:flex;flex-direction:column;max-height:35%;min-height:90px}.feed-head{padding:8px 14px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.feed-head-label{font-size:.55rem;color:var(--t4);text-transform:uppercase;letter-spacing:.1em;font-weight:500}.feed-scroll{flex:1;overflow-y:auto;padding:2px 8px}
.fi{display:flex;gap:7px;padding:5px;border-radius:5px;animation:fiIn .3s ease-out}@keyframes fiIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:none}}
.fi-icon{width:20px;height:20px;border-radius:5px;background:var(--accent-dim);display:flex;align-items:center;justify-content:center;font-size:.6rem;flex-shrink:0}
.fi-body{flex:1;min-width:0}.fi-text{font-size:.65rem;color:var(--t2);line-height:1.3}.fi-text b{color:var(--t1);font-weight:600}.fi-time{font-family:'JetBrains Mono',monospace;font-size:.45rem;color:var(--t4);margin-top:1px}
.fi.major .fi-icon{background:var(--accent-soft)}.fi.minor{opacity:.5}
.toast{position:fixed;top:56px;left:16px;z-index:50;background:var(--toast-bg);border:1px solid var(--border);border-radius:10px;padding:12px 16px;display:flex;align-items:center;gap:10px;box-shadow:0 12px 40px rgba(0,0,0,.4);opacity:0;transform:translateX(-20px);transition:all .4s cubic-bezier(.34,1.56,.64,1);pointer-events:none}.toast.show{opacity:1;transform:translateX(0)}.toast-icon{font-size:1.2rem}.toast-text{font-size:.8rem;font-weight:500}.toast-sub{font-size:.55rem;color:var(--t3)}
.modal-bg{position:fixed;inset:0;z-index:50;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}.modal-bg.open{opacity:1;pointer-events:all}
.modal-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;width:90%;max-width:360px;padding:24px;text-align:center;transform:scale(.95);transition:transform .25s}.modal-bg.open .modal-box{transform:scale(1)}
.modal-title{font-family:'Fraunces',serif;font-size:1.2rem;font-weight:500;margin-bottom:12px}.modal-desc{font-size:.75rem;color:var(--t3);margin-bottom:14px;line-height:1.5}.modal-desc b{color:var(--t2)}
.modal-btn{padding:10px 20px;border-radius:8px;border:none;background:var(--t1);color:var(--bg);font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;margin:4px}.modal-btn:disabled{opacity:.2;cursor:not-allowed}.modal-btn.secondary{background:transparent;border:1px solid var(--border);color:var(--t2)}
.modal-select-grid{display:flex;flex-direction:column;gap:6px;margin:10px 0;text-align:left}.modal-select-row{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:border-color .15s}.modal-select-row:hover{border-color:var(--t3)}
/* HATCH ANIMATION */
.hatch-overlay{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;opacity:0;pointer-events:none;transition:opacity .4s}.hatch-overlay.show{opacity:1;pointer-events:all}
.hatch-egg-anim{width:120px;height:120px;position:relative;animation:eggShake 0.3s ease-in-out infinite;display:flex;align-items:center;justify-content:center;font-size:4rem}
@keyframes eggShake{0%,100%{transform:rotate(0)}25%{transform:rotate(-5deg)}75%{transform:rotate(5deg)}}
.hatch-egg-anim.crack{animation:eggCrack .6s ease-out forwards}
@keyframes eggCrack{0%{transform:scale(1)}30%{transform:scale(1.15)}60%{transform:scale(1.3);opacity:.8}100%{transform:scale(1.6);opacity:0}}
.hatch-reveal{opacity:0;transform:scale(.5);transition:all .6s cubic-bezier(.34,1.56,.64,1)}.hatch-reveal.show{opacity:1;transform:scale(1)}
.hatch-reveal img{width:128px;height:128px;border-radius:50%;border:3px solid var(--t1)}
.hatch-reveal-name{font-family:'Fraunces',serif;font-size:1.4rem;margin-top:12px;color:var(--t1)}.hatch-reveal-rarity{font-size:.7rem;margin-top:4px;font-weight:500}.hatch-reveal-tap{font-size:.6rem;color:var(--t4);margin-top:16px}
@media(max-width:768px){.content{flex-direction:column}.video-area{flex:none;height:44vw;min-height:180px}.sidebar{width:100%;min-width:unset;flex:1;border-left:none;border-top:1px solid var(--border)}.player-strip{height:44px;min-height:44px;padding:0 12px;gap:8px}.ps-pills{display:none}.mobile-pl-bar{display:flex}.topbar{height:42px;min-height:42px;padding:0 12px}.tb-brand{font-size:.9rem}.feed-section{max-height:30%;min-height:80px}.toast{top:48px;left:8px}.spirit-circle{width:80px;padding:8px 2px}.spirit-circle-ring{width:50px;height:50px}}
@media(max-width:420px){.video-area{height:42vw;min-height:160px}}
</style>
</head>
<body>

<div class="onboard gone" id="onboard"><div class="ob-inner"><div class="ob-icon" id="obIcon"></div><div class="ob-title" id="obTitle"></div><div class="ob-desc" id="obDesc"></div><div class="ob-dots"><div class="ob-dot on" id="obD0"></div><div class="ob-dot" id="obD1"></div><div class="ob-dot" id="obD2"></div></div><button class="ob-btn" id="obBtn" onclick="nextOnboard()">Next</button><button class="ob-skip" onclick="finishOnboard()">Skip</button></div></div>
<div class="guest-banner" id="guestBanner"><span class="guest-banner-text">You got an egg! <b>Create an account</b> to keep it</span><button class="guest-banner-btn" onclick="showLogin()">Sign Up</button></div>
<div class="toast" id="toast"><div class="toast-icon" id="toastI">ü•ö</div><div><div class="toast-text" id="toastT"></div><div class="toast-sub" id="toastS"></div></div></div>
<div class="modal-bg" id="modal" onclick="if(event.target===this)closeModal()"><div class="modal-box" id="modalBox"></div></div>
<div class="hatch-overlay" id="hatchOverlay" onclick="closeHatchAnim()"><div class="hatch-egg-anim" id="hatchEgg">ü•ö</div><div class="hatch-reveal" id="hatchReveal"><img id="hatchImg" src=""><div class="hatch-reveal-name" id="hatchName"></div><div class="hatch-reveal-rarity" id="hatchRarity"></div><div class="hatch-reveal-tap">tap anywhere to continue</div></div></div>
<div class="settings-drop" id="settingsDrop"><div class="sd-item" onclick="toggleTheme()"><span class="sd-item-label">‚òÄ Theme</span><div class="sd-toggle" id="themeToggle"></div></div><div class="sd-divider"></div><div class="sd-item" onclick="doLogout()"><span class="sd-item-label">‚Ü© Logout</span></div></div>
<div class="login gone" id="login"><div class="login-inner"><div class="login-brand"><h1>Ehoro Village</h1><p class="sub">lo-fi ¬∑ spirits ¬∑ cultivate</p></div><div class="login-field" id="usernameField" style="display:none"><label>Username</label><input type="text" id="inUser" placeholder="pick a username"></div><div class="login-field"><label>Email</label><input type="email" id="inEmail" placeholder="you@email.com"></div><div class="login-field"><label>Password</label><input type="password" id="inPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6"></div><button class="l-btn" id="authBtn" onclick="doAuth()">Sign In</button><div class="l-error" id="authError"></div><div class="l-div">or</div><button class="l-secondary" onclick="enterGuest()">Watch as Guest</button><button class="l-toggle" id="authToggle" onclick="toggleAuthMode()">Need an account? Sign up</button></div></div>
<div class="shell on" id="shell">
<div class="topbar"><div class="tb-brand">Ehoro Village</div><div class="tb-right"><div class="tb-egg-badge"><span class="tb-egg-badge-icon">ü•ö</span><span class="tb-egg-badge-num" id="eggCount">0</span><span class="tb-egg-badge-label">eggs</span></div><button class="tb-gear" onclick="toggleSettings()" title="Settings">‚öô</button><span class="tb-user" id="userName">guest</span></div></div>
<div class="content">
<div class="video-area"><div class="video-embed" id="videoEmbed"><div class="video-placeholder" id="videoPlaceholder" onclick="startStream()"><div class="vp-play">‚ñ∂</div><div class="vp-text">Start Lo-Fi Stream</div></div></div><div class="player-strip"><button class="ps-play" id="psPlay" onclick="startStream()">‚ñ∂</button><div class="ps-info"><div class="ps-title" id="psTitle">lo-fi hip hop radio</div><div class="ps-sub" id="psSub">Caf√© vibes</div></div><div class="ps-pills"><button class="ps-pill on" data-pl="cafe" onclick="setPl(this)">Caf√©</button><button class="ps-pill" data-pl="outdoors" onclick="setPl(this)">Outdoors</button><button class="ps-pill" data-pl="focus" onclick="setPl(this)">Focus</button></div></div><div class="mobile-pl-bar"><button class="mobile-pl-btn on" data-pl="cafe" onclick="setPlMobile(this)">‚òï Caf√©</button><button class="mobile-pl-btn" data-pl="outdoors" onclick="setPlMobile(this)">üåø Outdoors</button><button class="mobile-pl-btn" data-pl="focus" onclick="setPlMobile(this)">‚ö° Focus</button></div></div>
<div class="sidebar"><div class="egg-mini"><span class="egg-mini-label">Next egg</span><div class="egg-mini-bar"><div class="egg-mini-fill" id="eggFill"></div></div><span class="egg-mini-time" id="eggTimer">‚Äî</span></div><div class="tab-nav"><button class="tab-btn on" data-tab="spirits" onclick="switchTab(this)">Spirits</button><button class="tab-btn" data-tab="items" onclick="switchTab(this)">Items</button><button class="tab-btn" data-tab="village" onclick="switchTab(this)">Village</button></div><div class="tab-panels"><div class="tab-panel on" id="tab-spirits"></div><div class="tab-panel" id="tab-items"></div><div class="tab-panel" id="tab-village"></div></div><div class="feed-section"><div class="feed-head"><span class="feed-head-label">Activity</span></div><div class="feed-scroll" id="feed"></div></div></div>
</div></div>
<script>

const SUPABASE_URL='https://eyqddqtlgthgkiqjavyx.supabase.co';
const SUPABASE_ANON_KEY='sb_publishable_CsTLSJj1YwgiHMxUTa685Q_2TVvZa2Q';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

// Playlists ‚Äî Lofi Girl caf√©, Chillhop for outdoors, Lofi Girl sleep for focus
const PL={
  cafe:{yt:'jfKfPfyJRdk',title:'lofi hip hop radio ‚Äî beats to relax/study to',sub:'Caf√© vibes'},
  outdoors:{yt:'rUxyKA_-grg',title:'chillhop radio ‚Äî jazzy & chill beats',sub:'Outdoors'},
  focus:{yt:'jfKfPfyJRdk',title:'lofi hip hop radio ‚Äî beats to sleep/chill to',sub:'Deep Focus'}
};
const PL_ORDER=['cafe','outdoors','focus'];

// Rarity
const RARITY_COLORS={mundane:'#888',adept:'#8ab',refined:'#7a7',illustrious:'#ba8',sovereign:'#a8c',celestial:'#8cf',transcendent:'#fc8',mysterious:'#c8f',ancestral:'#f88',paradox:'#fff'};
const INCUB_MINS={mundane:5,adept:10,refined:20,illustrious:30,sovereign:45,celestial:60,transcendent:90,mysterious:120,ancestral:120,paradox:120};

// Village ranks
const VILLAGE_RANKS=[{name:'Ember',min:0,desc:'Your village is a spark.'},{name:'Stone',min:50,desc:'Solid foundation.'},{name:'Bronze',min:150,desc:'A real village is forming.'},{name:'Silver',min:400,desc:'Respected and growing.'},{name:'Gold',min:800,desc:'Prosperous and admired.'},{name:'Emerald',min:1500,desc:'A beacon of cultivation.'},{name:'Celestial',min:3000,desc:'Transcendent.'}];

// Spirit data ‚Äî maps DB spirit_type to display info
const SPIRIT_DATA = {
  timi: {name:'Timi',bio:'Pulled into the spirit realm by a terrible accident. Curious and restless, she believes there\'s more to Ehoro Village than meets the eye.',img:['sprites/timi_1.png','sprites/timi_2.png','sprites/timi_3.png']},
  bayo: {name:'Bayo',bio:'Arrived after a life behind glass at the zoo. Shy but deeply intelligent, he\'s learning what it means to be free.',img:['sprites/bayo_1.png','sprites/bayo_2.png','sprites/bayo_3.png']},
  mowang: {name:'Mowang',bio:'Banished by a foolish adventurer, Mowang harbors fierce ambition. Where others see a simple slime, Mowang sees a future in gleaming steel.',img:['sprites/mowang_1.png','sprites/mowang_2.png','sprites/mowang_3.png']}
};
// Map DB types to our keys
const TYPE_MAP = {fox_lavender:'timi',fox_fire:'timi',panda:'bayo',slime:'mowang',timi:'timi',bayo:'bayo',mowang:'mowang'};
function spiritKey(dbType){return TYPE_MAP[dbType]||dbType;}
function spiritImg(dbType,stage){const k=spiritKey(dbType);const d=SPIRIT_DATA[k];return d?d.img[Math.min(stage,2)]:'sprites/timi_1.png';}
function spiritName(dbType){const k=spiritKey(dbType);return SPIRIT_DATA[k]?.name||dbType;}
function spiritBio(dbType){const k=spiritKey(dbType);return SPIRIT_DATA[k]?.bio||'';}

const EVO_LABELS=['Seedling','Awakened','Ascended'];

// State
let S={user:null,profile:null,spirits:[],traits:{},emblems:{cafe_bean:0,wild_essence:0,focus_shard:0},hatchery:[],pendingEggs:[],playing:false,pl:'cafe',plIndex:0,eggT:0,EGG_SEC:3600,GUEST_EGG_SEC:30,sessionId:null,ticker:null,hatchTicker:null,authMode:'login',isGuest:true,guestEggGiven:false,theme:'dark',obStep:0,settingsOpen:false,selectedSpirit:null};

// Onboarding with spirit art
const OB_STEPS=[
  {img:'sprites/timi_1.png',title:'Listen to Lo-Fi',desc:'Stream curated lo-fi playlists while you study, work, or chill. The music never stops.'},
  {img:'sprites/mowang_1.png',title:'Collect Eggs & Spirits',desc:'Eggs drop while you listen. Hatch them in your hatchery to discover spirits of different rarities.'},
  {img:'sprites/bayo_1.png',title:'Grow Your Village',desc:'Cultivate your spirits, evolve them, and watch your village rank rise. No pay-to-win, ever.'}
];
function showOnboard(){S.obStep=0;renderOnboard();document.getElementById('onboard').classList.remove('gone');}
function renderOnboard(){const s=OB_STEPS[S.obStep];document.getElementById('obIcon').innerHTML='<img src="'+s.img+'">';document.getElementById('obTitle').textContent=s.title;document.getElementById('obDesc').textContent=s.desc;document.getElementById('obBtn').textContent=S.obStep<2?'Next':'Get Started';[0,1,2].forEach(i=>{document.getElementById('obD'+i).className='ob-dot'+(i===S.obStep?' on':'');});}
function nextOnboard(){if(S.obStep<2){S.obStep++;renderOnboard();}else finishOnboard();}
function finishOnboard(){document.getElementById('onboard').classList.add('gone');if(!S.isGuest){sb.from('profiles').update({onboarding_done:true}).eq('id',S.user.id).then(()=>{});claimNewbieGift();}}
async function claimNewbieGift(){if(S.profile?.newbie_gift_claimed)return;try{const{data,error}=await sb.rpc('claim_newbie_gift');if(error||data?.error)return;S.emblems.cafe_bean+=6;S.emblems.wild_essence+=6;S.emblems.focus_shard+=6;S.profile.newbie_gift_claimed=true;renderItemsTab();showToast('gift');feed('üéÅ','<b>Welcome Gift!</b> +6 of each ingredient','major');}catch(e){}}

// Settings
function toggleSettings(){S.settingsOpen=!S.settingsOpen;document.getElementById('settingsDrop').classList.toggle('open',S.settingsOpen);}
document.addEventListener('click',e=>{if(S.settingsOpen&&!e.target.closest('.settings-drop')&&!e.target.closest('.tb-gear')){S.settingsOpen=false;document.getElementById('settingsDrop').classList.remove('open');}});
function toggleTheme(){S.theme=S.theme==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',S.theme);document.getElementById('themeToggle').classList.toggle('on',S.theme==='light');}
function switchTab(btn){document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('on'));document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('on'));btn.classList.add('on');document.getElementById('tab-'+btn.dataset.tab).classList.add('on');}

// Auth
function showLogin(){document.getElementById('login').classList.remove('gone');S.authMode='signup';document.getElementById('authBtn').textContent='Create Account';document.getElementById('authToggle').textContent='Already have an account? Sign in';document.getElementById('usernameField').style.display='';}
function toggleAuthMode(){S.authMode=S.authMode==='login'?'signup':'login';const up=S.authMode==='signup';document.getElementById('authBtn').textContent=up?'Create Account':'Sign In';document.getElementById('authToggle').textContent=up?'Already have an account? Sign in':'Need an account? Sign up';document.getElementById('usernameField').style.display=up?'':'none';document.getElementById('authError').textContent='';}
async function doAuth(){const email=document.getElementById('inEmail').value.trim();const pass=document.getElementById('inPass').value;const btn=document.getElementById('authBtn');const errEl=document.getElementById('authError');errEl.textContent='';errEl.className='l-error';if(!email||!pass){errEl.textContent='Email and password required';return;}if(pass.length<6){errEl.textContent='Password must be 6+ characters';return;}btn.disabled=true;try{let result;if(S.authMode==='signup'){const username=document.getElementById('inUser').value.trim()||'user_'+Math.random().toString(36).slice(2,8);result=await sb.auth.signUp({email,password:pass,options:{data:{username}}});if(result.data?.user&&!result.data.session){errEl.className='l-error ok';errEl.textContent='Check your email to confirm!';btn.disabled=false;return;}}else{result=await sb.auth.signInWithPassword({email,password:pass});}if(result.error)throw result.error;S.user=result.data.user;S.isGuest=false;await loadUserData();enterApp();}catch(e){errEl.textContent=e.message||'Auth failed';}finally{btn.disabled=false;}}
function enterGuest(){document.getElementById('login').classList.add('gone');S.isGuest=true;S.user=null;document.getElementById('userName').textContent='guest';loadGuestDefaults();feed('üëã','Welcome! Hit play to start the stream','major');}
function loadGuestDefaults(){S.spirits=[{id:'g1',spirit_type:'timi',name:'Timi',evo_stage:0,xp:0},{id:'g2',spirit_type:'bayo',name:'Bayo',evo_stage:0,xp:0},{id:'g3',spirit_type:'mowang',name:'Mowang',evo_stage:0,xp:0}];S.traits={g1:[{trait_name:'Curious',trait_type:'neutral'}],g2:[{trait_name:'Shy',trait_type:'neutral'}],g3:[{trait_name:'Challant',trait_type:'neutral'}]};S.emblems={cafe_bean:0,wild_essence:0,focus_shard:0};S.profile={total_eggs:0,total_listen_seconds:0,username:'guest'};S.hatchery=[{id:'gs1',slot_number:1,unlocked:true,egg_id:null},{id:'gs2',slot_number:2,unlocked:true,egg_id:null},{id:'gs3',slot_number:3,unlocked:false},{id:'gs4',slot_number:4,unlocked:false},{id:'gs5',slot_number:5,unlocked:false}];S.pendingEggs=[];updateAllUI();}
async function doLogout(){toggleSettings();if(S.sessionId){try{await sb.rpc('end_session',{p_session_id:S.sessionId});}catch(e){}S.sessionId=null;}await sb.auth.signOut();S.user=null;S.playing=false;S.isGuest=true;if(S.ticker){clearInterval(S.ticker);S.ticker=null;}if(S.hatchTicker){clearInterval(S.hatchTicker);S.hatchTicker=null;}const embed=document.getElementById('videoEmbed');const iframe=embed.querySelector('iframe');if(iframe)iframe.remove();embed.classList.remove('loaded');document.getElementById('userName').textContent='guest';loadGuestDefaults();}
async function checkSession(){const{data:{session}}=await sb.auth.getSession();if(session){S.user=session.user;S.isGuest=false;await loadUserData();enterApp();}}
async function loadUserData(){if(!S.user)return;const spiritIds=(await sb.from('spirits').select('id').eq('user_id',S.user.id)).data?.map(s=>s.id)||[];const[{data:profile},{data:spirits},{data:emblems},{data:hatchery},{data:traits},{data:pending}]=await Promise.all([sb.from('profiles').select('*').eq('id',S.user.id).single(),sb.from('spirits').select('*').eq('user_id',S.user.id),sb.from('emblems').select('*').eq('user_id',S.user.id),sb.from('hatchery').select('*').eq('user_id',S.user.id).order('slot_number'),sb.from('spirit_traits').select('*').in('spirit_id',spiritIds.length?spiritIds:['00000000-0000-0000-0000-000000000000']),sb.from('eggs').select('*').eq('user_id',S.user.id).eq('status','pending').order('created_at',{ascending:false}).limit(10)]);S.profile=profile;S.spirits=spirits||[];S.hatchery=hatchery||[];S.pendingEggs=pending||[];if(emblems)emblems.forEach(e=>{S.emblems[e.emblem_type]=e.quantity;});S.traits={};if(traits)traits.forEach(t=>{if(!S.traits[t.spirit_id])S.traits[t.spirit_id]=[];S.traits[t.spirit_id].push(t);});}
function enterApp(){document.getElementById('login').classList.add('gone');document.getElementById('guestBanner').classList.remove('show');document.getElementById('userName').textContent=S.profile?.username||'user';updateAllUI();feed('üëã','Welcome back, <b>'+(S.profile?.username||'user')+'</b>','major');if(!S.profile?.onboarding_done)showOnboard();startHatcheryTicker();}

// UI renders
function updateAllUI(){document.getElementById('eggCount').textContent=S.profile?.total_eggs||0;renderSpiritsTab();renderItemsTab();renderVillageTab();}
function renderSpiritsTab(){const el=document.getElementById('tab-spirits');const order=['timi','bayo','mowang'];let html='<div class="spirits-grid">';S.spirits.forEach(sp=>{const lvl=Math.floor((sp.xp||0)/100)+1;html+='<div class="spirit-circle" onclick="selectSpirit(\''+sp.id+'\')"><div class="spirit-circle-ring"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'" alt="'+sp.name+'"></div><div class="spirit-circle-name">'+sp.name+'</div><div class="spirit-circle-meta">'+EVO_LABELS[sp.evo_stage]+' ¬∑ Lv.'+lvl+'</div><div class="spirit-evo-dots">'+[0,1,2].map(i=>'<div class="spirit-evo-dot'+(i<=sp.evo_stage?' on':'')+'"></div>').join('')+'</div></div>';});html+='</div><div id="spiritDetail" class="spirit-detail"></div>';el.innerHTML=html;if(S.selectedSpirit)showSpiritDetail(S.selectedSpirit);}
function selectSpirit(id){S.selectedSpirit=id;showSpiritDetail(id);}
function showSpiritDetail(id){const sp=S.spirits.find(s=>s.id===id);if(!sp)return;const el=document.getElementById('spiritDetail');const lvl=Math.floor((sp.xp||0)/100)+1;const xpPct=(sp.xp||0)%100;const traits=S.traits[sp.id]||[];const cost=sp.evo_stage===0?5:12;const canEvo=sp.evo_stage<2&&!S.isGuest&&S.emblems.cafe_bean>=cost&&S.emblems.wild_essence>=cost&&S.emblems.focus_shard>=cost;el.className='spirit-detail open';el.innerHTML='<div class="sd-header"><div class="sd-portrait"><img src="'+spiritImg(sp.spirit_type,sp.evo_stage)+'"></div><div class="sd-info"><div class="sd-name">'+sp.name+'</div><div class="sd-stage">'+EVO_LABELS[sp.evo_stage]+' ¬∑ '+spiritName(sp.spirit_type)+'</div><div class="sd-bio">'+spiritBio(sp.spirit_type)+'</div></div><button class="sd-close" onclick="closeSpiritDetail()">‚úï</button></div><div class="sd-section">Cultivation</div><div class="sd-bar-wrap"><div class="sd-bar"><div class="sd-bar-fill" style="width:'+xpPct+'%"></div></div><span class="sd-lvl">Lv.'+lvl+' ('+xpPct+'/100)</span></div><div class="sd-section">Traits</div><div class="trait-tags">'+(traits.length?traits.map(t=>'<span class="trait-tag '+t.trait_type+'">'+t.trait_name+'</span>').join(''):'<span style="font-size:.6rem;color:var(--t4)">No traits yet</span>')+'</div>'+(sp.evo_stage<2?'<button class="sd-evolve-btn" '+(canEvo?'':'disabled')+' onclick="doEvolve(\''+sp.id+'\')">Evolve to '+EVO_LABELS[sp.evo_stage+1]+'</button><div class="sd-evolve-cost">Cost: '+cost+'√ó each (‚òï'+S.emblems.cafe_bean+' üåø'+S.emblems.wild_essence+' ‚ö°'+S.emblems.focus_shard+')</div>':'<div style="text-align:center;font-size:.7rem;color:var(--t3);margin-top:12px">‚ú® Fully Ascended</div>');}
function closeSpiritDetail(){S.selectedSpirit=null;document.getElementById('spiritDetail').className='spirit-detail';}
function renderItemsTab(){const el=document.getElementById('tab-items');let html='<div class="section-label">Hatchery</div><div class="hatchery-grid">';S.hatchery.forEach(slot=>{if(!slot.unlocked){html+='<div class="hatch-slot locked"><div class="hatch-slot-icon">üîí</div><div class="hatch-slot-label">Locked</div></div>';return;}if(!slot.egg_id){html+='<div class="hatch-slot" onclick="openPlaceEggModal(\''+slot.id+'\')"><div class="hatch-slot-icon">Ôºã</div><div class="hatch-slot-label">Empty</div></div>';return;}const egg=S.pendingEggs.find(e=>e.id===slot.egg_id)||{rarity:'mundane'};const started=new Date(slot.started_at);const durMs=(slot.hatch_duration_minutes||5)*60*1000;const elapsed=Date.now()-started.getTime();const ready=elapsed>=durMs;const pct=Math.min(elapsed/durMs*100,100);const remainSec=Math.max(0,Math.ceil((durMs-elapsed)/1000));const remainStr=remainSec>60?Math.ceil(remainSec/60)+'m':remainSec+'s';html+='<div class="hatch-slot'+(ready?' ready':'')+'" onclick="'+(ready?"doHatch(\'"+slot.id+"\')":'')+'"><div class="hatch-slot-icon">'+(ready?'üê£':'ü•ö')+'</div><div class="hatch-slot-rarity" style="color:'+(RARITY_COLORS[egg.rarity]||'#888')+'">'+(egg.rarity?egg.rarity.charAt(0).toUpperCase()+egg.rarity.slice(1):'')+'</div>'+(ready?'<div class="hatch-slot-label" style="color:var(--positive)">Tap to hatch!</div>':'<div class="hatch-slot-timer">'+remainStr+'</div><div class="hatch-slot-bar"><div class="hatch-slot-bar-fill" style="width:'+pct+'%"></div></div>')+'</div>';});html+='</div>';const pendList=S.pendingEggs.filter(e=>e.status==='pending');if(pendList.length>0){html+='<div class="pending-label">Pending eggs (tap empty slot)</div><div class="pending-list">';pendList.forEach(egg=>{html+='<div class="pending-egg" style="color:'+(RARITY_COLORS[egg.rarity]||'#888')+'">'+(egg.rarity||'?')+'</div>';});html+='</div>';}html+='<div class="section-label">Ingredients</div><div class="ing-grid"><div class="ing-row"><span class="ing-icon">‚òï</span><span class="ing-name">Caf√© Bean</span><span class="ing-count">'+S.emblems.cafe_bean+'</span></div><div class="ing-row"><span class="ing-icon">üåø</span><span class="ing-name">Wild Essence</span><span class="ing-count">'+S.emblems.wild_essence+'</span></div><div class="ing-row"><span class="ing-icon">‚ö°</span><span class="ing-name">Focus Shard</span><span class="ing-count">'+S.emblems.focus_shard+'</span></div></div><div class="section-label">Convert (3‚Üí1)</div><div class="convert-row"><button class="convert-btn" onclick="openConvertModal(\'cafe_bean\')">‚òï‚Üí</button><button class="convert-btn" onclick="openConvertModal(\'wild_essence\')">üåø‚Üí</button><button class="convert-btn" onclick="openConvertModal(\'focus_shard\')">‚ö°‚Üí</button></div>';el.innerHTML=html;}
function renderVillageTab(){const el=document.getElementById('tab-village');const prestige=calcPrestige();const rank=VILLAGE_RANKS.slice().reverse().find(r=>prestige>=r.min)||VILLAGE_RANKS[0];const nextRank=VILLAGE_RANKS[VILLAGE_RANKS.indexOf(rank)+1];const totalListen=Math.floor((S.profile?.total_listen_seconds||0)/60);el.innerHTML='<div class="village-rank-card"><div class="village-rank-label">Village Rank</div><div class="village-rank-name">'+rank.name+'</div><div class="village-rank-desc">'+rank.desc+'</div>'+(nextRank?'<div style="font-size:.55rem;color:var(--t4);margin-top:6px">Next: '+nextRank.name+' ('+nextRank.min+' prestige)</div>':'')+'</div><div class="village-stat-grid"><div class="village-stat"><div class="village-stat-num">'+prestige+'</div><div class="village-stat-label">Prestige</div></div><div class="village-stat"><div class="village-stat-num">'+(S.profile?.total_eggs||0)+'</div><div class="village-stat-label">Eggs</div></div><div class="village-stat"><div class="village-stat-num">'+S.spirits.length+'</div><div class="village-stat-label">Spirits</div></div><div class="village-stat"><div class="village-stat-num">'+totalListen+'m</div><div class="village-stat-label">Listened</div></div></div><div class="section-label">Spirit Index</div><div style="font-size:.65rem;color:var(--t3);padding:6px 0">'+S.spirits.length+' / 3 collected</div>';}
function calcPrestige(){let p=0;S.spirits.forEach(sp=>{p+=(sp.evo_stage+1)*10;p+=Math.floor((sp.xp||0)/100)*5;});p+=(S.profile?.total_eggs||0)*2;p+=Math.floor((S.profile?.total_listen_seconds||0)/3600)*3;return p;}

// Hatchery
async function doHatch(slotId){if(S.isGuest)return;try{const{data,error}=await sb.rpc('hatch_egg',{p_slot_id:slotId});if(error)throw error;if(data.error==='not_ready'){feed('‚è≥','Egg not ready yet','minor');return;}if(data.error){feed('‚ùå',data.error,'minor');return;}await loadUserData();updateAllUI();showHatchAnimation(data.rarity);feed('üê£','<b>'+data.rarity.charAt(0).toUpperCase()+data.rarity.slice(1)+'</b> egg hatched!','major');}catch(e){feed('‚ùå','Hatch failed','minor');}}

// Hatch animation
function showHatchAnimation(rarity){const overlay=document.getElementById('hatchOverlay');const egg=document.getElementById('hatchEgg');const reveal=document.getElementById('hatchReveal');egg.style.display='block';egg.className='hatch-egg-anim';reveal.className='hatch-reveal';overlay.classList.add('show');
// Pick a random spirit image for the reveal
const spiritKeys=['timi','bayo','mowang'];const rk=spiritKeys[Math.floor(Math.random()*3)];const stage=Math.floor(Math.random()*3);document.getElementById('hatchImg').src=SPIRIT_DATA[rk].img[stage];document.getElementById('hatchName').textContent=SPIRIT_DATA[rk].name;document.getElementById('hatchRarity').textContent=rarity.charAt(0).toUpperCase()+rarity.slice(1);document.getElementById('hatchRarity').style.color=RARITY_COLORS[rarity]||'#888';
setTimeout(()=>{egg.classList.add('crack');},1500);setTimeout(()=>{egg.style.display='none';reveal.classList.add('show');},2100);}
function closeHatchAnim(){document.getElementById('hatchOverlay').classList.remove('show');}

function openPlaceEggModal(slotId){const pending=S.pendingEggs.filter(e=>e.status==='pending');if(pending.length===0){feed('ü•ö','No pending eggs','minor');return;}const box=document.getElementById('modalBox');box.innerHTML='<div class="modal-title">Place an Egg</div><div class="modal-desc">Choose an egg to incubate:</div><div class="modal-select-grid">'+pending.map(egg=>'<div class="modal-select-row" onclick="placeEgg(\''+egg.id+'\',\''+slotId+'\')"><span style="font-size:1.1rem">ü•ö</span><span style="font-size:.75rem;color:'+(RARITY_COLORS[egg.rarity]||'#888')+'">'+egg.rarity+'</span><span style="font-size:.6rem;color:var(--t4);margin-left:auto">'+INCUB_MINS[egg.rarity]+'m</span></div>').join('')+'</div><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';document.getElementById('modal').classList.add('open');}
async function placeEgg(eggId,slotId){if(S.isGuest)return;closeModal();try{const{data,error}=await sb.rpc('place_egg_in_slot',{p_egg_id:eggId,p_slot_id:slotId});if(error)throw error;await loadUserData();updateAllUI();feed('ü•ö','Egg placed','minor');}catch(e){feed('‚ùå','Failed','minor');}}
function startHatcheryTicker(){if(S.hatchTicker)return;S.hatchTicker=setInterval(()=>{if(!S.isGuest)renderItemsTab();},5000);}
function openConvertModal(fromType){if(S.isGuest){feed('üîí','Create an account to convert','minor');return;}const names={cafe_bean:'Caf√© Bean',wild_essence:'Wild Essence',focus_shard:'Focus Shard'};const icons={cafe_bean:'‚òï',wild_essence:'üåø',focus_shard:'‚ö°'};const others=Object.keys(names).filter(k=>k!==fromType);const box=document.getElementById('modalBox');box.innerHTML='<div class="modal-title">Convert '+icons[fromType]+'</div><div class="modal-desc">Trade 3 <b>'+names[fromType]+'</b> for 1 of another.<br>You have: <b>'+S.emblems[fromType]+'</b></div><div class="modal-select-grid">'+others.map(to=>'<div class="modal-select-row'+(S.emblems[fromType]<3?' style="opacity:.4;pointer-events:none"':'')+'" onclick="doConvert(\''+fromType+'\',\''+to+'\')"><span>'+icons[to]+' '+names[to]+'</span><span style="font-size:.6rem;color:var(--t4);margin-left:auto">3‚Üí1</span></div>').join('')+'</div><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>';document.getElementById('modal').classList.add('open');}
async function doConvert(from,to){closeModal();try{const{data,error}=await sb.rpc('convert_ingredient',{p_from:from,p_to:to,p_amount:1});if(error)throw error;if(data.error){feed('‚ùå',data.error==='insufficient'?'Not enough':'Failed','minor');return;}S.emblems[from]-=3;S.emblems[to]+=1;renderItemsTab();renderSpiritsTab();feed('üîÑ','Converted','minor');}catch(e){feed('‚ùå','Failed','minor');}}
function closeModal(){document.getElementById('modal').classList.remove('open');}
// ‚ïê‚ïê‚ïê EVOLUTION ‚ïê‚ïê‚ïê
async function doEvolve(spiritId){
  if(S.isGuest)return;
  try{
    const{data,error}=await sb.rpc('evolve_spirit',{p_spirit_id:spiritId});
    if(error)throw error;
    if(data.error){feed('‚ùå','Evolution failed: '+data.error,'minor');return;}
    await loadUserData();updateAllUI();
    const sp=S.spirits.find(s=>s.id===spiritId);
    feed('üåü','<b>'+(sp?.name||'Spirit')+'</b> evolved to '+EVO_LABELS[data.new_stage]+'!','major');
    if(data.trait_gained)feed('‚ú®','Gained trait: <b>'+data.trait_gained+'</b>','major');
    showToast('evolution');
    if(S.selectedSpirit===spiritId)showSpiritDetail(spiritId);
  }catch(e){feed('‚ùå','Evolution failed','minor');}
}

// ‚ïê‚ïê‚ïê STREAM ‚ïê‚ïê‚ïê
async function startStream(){
  if(S.playing)return;
  S.playing=true;
  const embed=document.getElementById('videoEmbed');
  const pl=PL[S.pl];
  const iframe=document.createElement('iframe');
  iframe.src='https://www.youtube.com/embed/'+pl.yt+'?autoplay=1&rel=0';
  iframe.allow='autoplay; encrypted-media';
  iframe.allowFullscreen=true;
  embed.insertBefore(iframe,embed.firstChild);
  embed.classList.add('loaded');
  document.getElementById('psPlay').textContent='‚è∏';
  feed('üéµ','Now streaming <b>'+pl.title+'</b>');
  if(!S.isGuest){
    try{const{data}=await sb.rpc('start_session',{p_playlist:S.pl});S.sessionId=data;}catch(e){}
  }
  startTicker();
}
async function swapStream(){
  if(S.sessionId){try{await sb.rpc('end_session',{p_session_id:S.sessionId});}catch(e){}S.sessionId=null;}
  const embed=document.getElementById('videoEmbed');
  const old=embed.querySelector('iframe');if(old)old.remove();
  if(S.playing){
    const pl=PL[S.pl];
    const iframe=document.createElement('iframe');
    iframe.src='https://www.youtube.com/embed/'+pl.yt+'?autoplay=1&rel=0';
    iframe.allow='autoplay; encrypted-media';
    iframe.allowFullscreen=true;
    embed.insertBefore(iframe,embed.firstChild);
    embed.classList.add('loaded');
    feed('üéµ','Switched to <b>'+PL[S.pl].title+'</b>');
    if(!S.isGuest){try{const{data}=await sb.rpc('start_session',{p_playlist:S.pl});S.sessionId=data;}catch(e){}}
  }
  document.getElementById('psTitle').textContent=PL[S.pl].title;
  document.getElementById('psSub').textContent=PL[S.pl].sub;
}
function setPl(el){
  document.querySelectorAll('.ps-pill').forEach(p=>p.classList.remove('on'));
  el.classList.add('on');
  S.pl=el.dataset.pl;S.plIndex=PL_ORDER.indexOf(S.pl);S.eggT=0;
  document.querySelectorAll('.mobile-pl-btn').forEach(b=>b.classList.toggle('on',b.dataset.pl===S.pl));
  swapStream();
}
function setPlMobile(el){
  document.querySelectorAll('.mobile-pl-btn').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  S.pl=el.dataset.pl;S.plIndex=PL_ORDER.indexOf(S.pl);S.eggT=0;
  document.querySelectorAll('.ps-pill').forEach(p=>p.classList.toggle('on',p.dataset.pl===S.pl));
  swapStream();
}

// ‚ïê‚ïê‚ïê GAME TICK ‚ïê‚ïê‚ïê
function startTicker(){
  if(S.ticker)return;
  const eggTime=()=>S.isGuest&&!S.guestEggGiven?S.GUEST_EGG_SEC:S.EGG_SEC;
  S.ticker=setInterval(async()=>{
    if(!S.playing)return;
    S.eggT+=0.5;
    const total=eggTime();
    const pct=Math.min((S.eggT/total)*100,100);
    document.getElementById('eggFill').style.width=pct+'%';
    const rem=Math.max(0,Math.ceil(total-S.eggT));
    const mins=Math.floor(rem/60);const secs=rem%60;
    document.getElementById('eggTimer').textContent=mins>0?mins+'m '+secs+'s':secs+'s';

    // Ingredient drops (~1 per 15 min = 0.00055 per 500ms tick)
    if(!S.isGuest&&Math.random()<0.00055){
      const mat=S.pl==='cafe'?'cafe_bean':S.pl==='outdoors'?'wild_essence':'focus_shard';
      S.emblems[mat]++;renderItemsTab();
      const names={cafe_bean:'‚òï Caf√© Bean',wild_essence:'üåø Wild Essence',focus_shard:'‚ö° Focus Shard'};
      feed('‚ú®','Found <b>'+names[mat]+'</b>','minor');
    }

    // Egg drop
    if(S.eggT>=total){
      S.eggT=0;
      if(S.isGuest){
        if(!S.guestEggGiven){
          S.guestEggGiven=true;
          const rarities=['mundane','mundane','adept','adept','refined'];
          const r=rarities[Math.floor(Math.random()*rarities.length)];
          showToast(r);
          feed('ü•ö','<b>'+r.charAt(0).toUpperCase()+r.slice(1)+'</b> egg dropped!','major');
          setTimeout(()=>{document.getElementById('guestBanner').classList.add('show');},2000);
        }
      }else{
        try{
          const{data,error}=await sb.rpc('claim_egg_drop',{p_playlist:S.pl});
          if(error)throw error;
          if(data.error==='too_fast')return;
          if(data.error==='pending_full'){feed('üì¶','Egg inventory full! Hatch some eggs first','major');return;}
          S.profile.total_eggs=data.total_eggs;
          S.emblems[data.emblem_granted]++;
          document.getElementById('eggCount').textContent=data.total_eggs;
          // Reload hatchery data to see new egg
          const{data:hatch}=await sb.from('hatchery').select('*').eq('user_id',S.user.id).order('slot_number');
          const{data:pending}=await sb.from('eggs').select('*').eq('user_id',S.user.id).eq('status','pending').order('created_at',{ascending:false}).limit(10);
          S.hatchery=hatch||[];S.pendingEggs=pending||[];
          updateAllUI();
          const rName=data.rarity.charAt(0).toUpperCase()+data.rarity.slice(1);
          showToast(data.rarity);
          feed('ü•ö','<b>'+rName+'</b> egg '+(data.auto_placed?'placed in hatchery!':'dropped! Place it in your hatchery.'),'major');
        }catch(e){feed('‚ùå','Egg drop failed','minor');}
      }
    }
  },500);
}

// ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê
function showToast(rarity){
  const t=document.getElementById('toast');
  const isEvo=rarity==='evolution';
  const isGift=rarity==='gift';
  document.getElementById('toastI').textContent=isEvo?'‚ú®':isGift?'üéÅ':'ü•ö';
  document.getElementById('toastT').textContent=isEvo?'Evolution!':isGift?'Welcome Gift!':rarity.charAt(0).toUpperCase()+rarity.slice(1)+' Egg';
  document.getElementById('toastS').textContent=isEvo||isGift?'':(S.isGuest?'Create account to keep!':'#'+(S.profile?.total_eggs||0));
  t.classList.add('show');
  if(!isEvo&&!isGift)setTimeout(()=>{document.getElementById('toastI').textContent='üê£';document.getElementById('toastT').textContent='Incubating...';},1200);
  setTimeout(()=>t.classList.remove('show'),3500);
}

// ‚ïê‚ïê‚ïê FEED ‚ïê‚ïê‚ïê
function feed(icon,text,importance){
  const f=document.getElementById('feed');
  const now=new Date();
  const ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  const el=document.createElement('div');
  el.className='fi'+(importance==='major'?' major':importance==='minor'?' minor':'');
  el.innerHTML='<div class="fi-icon">'+icon+'</div><div class="fi-body"><div class="fi-text">'+text+'</div><div class="fi-time">'+ts+'</div></div>';
  f.insertBefore(el,f.firstChild);
  while(f.children.length>40)f.removeChild(f.lastChild);
}

function closeModal(){document.getElementById('modal').classList.remove('open');}

// ‚ïê‚ïê‚ïê PAGE CLOSE ‚ïê‚ïê‚ïê
window.addEventListener('beforeunload',()=>{
  if(S.sessionId&&S.user){
    navigator.sendBeacon(SUPABASE_URL+'/rest/v1/rpc/end_session',
      new Blob([JSON.stringify({p_session_id:S.sessionId})],{type:'application/json'}));
  }
});

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
checkSession().then(()=>{if(!S.user)loadGuestDefaults();});

</script>
</body>
</html>


</body>
</html>
